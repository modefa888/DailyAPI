<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频搜索</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <!-- hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {

            .glass-effect {
                @apply backdrop-blur-md bg-white/80 border border-white/20;
            }
            
            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
            }
            
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-accent {
                @apply bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .input-primary {
                @apply bg-white/80 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary;
            }
            
            .blurred-bg {
                @apply filter blur-md pointer-events-none;
            }
            
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .scroll-offset {
                scroll-margin-top: 140px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 transition-colors duration-300">
    <!-- 导航头 -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 glass-effect shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- 左侧：应用标题 -->
                <div class="flex items-center space-x-2">
                    <i class="fa fa-play-circle text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold text-primary">视频搜索</h1>
                </div>
                
                <!-- 中间：搜索框 -->
                <div class="hidden md:flex items-center bg-white rounded-lg shadow-md max-w-xl w-full mx-4 relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="搜索视频..." 
                        class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button 
                        id="searchButton" 
                        onclick="searchData()"
                        class="btn-primary rounded-l-none"
                    >
                        <i class="fa fa-search mr-1"></i> <span id="searchButtonLabel">搜索</span>
                    </button>
                    <div 
                        id="searchHistoryBox" 
                        class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    ></div>
                </div>
                
                <!-- 右侧：更多下拉 -->
                <div class="flex items-center space-x-3 relative">
                    <button
                        id="mobileSearchToggle"
                        onclick="toggleMobileSearch()"
                        class="md:hidden btn-primary text-sm"
                        title="搜索"
                    >
                        <i class="fa fa-search"></i>
                    </button>
                    <button 
                        id="moreButton"
                        onclick="toggleMoreMenu()"
                        class="btn-secondary text-sm"
                        title="更多"
                    >
                        <i class="fa fa-ellipsis-h mr-1"></i> 更多
                    </button>
                    <div 
                        id="moreMenu"
                        class="absolute right-0 top-full mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    >
                        <button 
                            onclick="handleMoreAction('favorite')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-heart text-red-500"></i>
                            <span class="text-right flex-1">喜欢</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('history')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-history text-gray-600"></i>
                            <span class="text-right flex-1">历史</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('setting')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-cog text-gray-600"></i>
                            <span class="text-right flex-1">设置</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 移动端搜索框 -->
            <div id="mobileSearchBox" class="md:hidden mt-3 flex items-center bg-white rounded-lg shadow-md relative hidden">
                <input 
                    type="text" 
                    id="searchInputMobile" 
                    placeholder="搜索视频..." 
                    class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                    onkeypress="handleKeyPress(event)"
                >
                <button 
                    id="searchButtonMobile" 
                    onclick="searchData()"
                    class="btn-primary rounded-l-none"
                >
                    <i class="fa fa-search"></i> <span id="searchButtonLabelMobile">搜索</span>
                </button>
                <div 
                    id="searchHistoryBoxMobile" 
                    class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                ></div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-20">
        <!-- 视频列表 -->
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- 视频卡片将在这里动态生成 -->
        </div>
        
        <!-- 加载更多按钮 -->
        <div class="flex justify-center mt-8">
            <button 
                id="loadMoreButton" 
                onclick="loadMoreData()"
                class="btn-primary flex items-center space-x-2 hidden"
            >
                <span>加载更多</span>
                <i class="fa fa-refresh"></i>
            </button>
        </div>
        
        <!-- 空状态 -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
            <i class="fa fa-search text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">暂无搜索结果</h3>
            <p class="text-gray-600">请尝试其他搜索关键词</p>
        </div>
    </main>

    <!-- 播放历史面板 -->
    <div 
        id="historyPanel" 
        class="fixed top-0 right-0 bottom-0 w-full md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">播放历史</h3>
            <button onclick="toggleHistory()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="historyContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- 历史记录将在这里动态生成 -->
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearHistory()" class="w-full btn-secondary">
                <i class="fa fa-trash mr-1"></i> 清空历史
            </button>
        </div>
    </div>

    <!-- 喜欢面板 -->
    <div 
        id="favoritePanel" 
        class="fixed top-0 right-0 bottom-0 w-full md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">我的喜欢</h3>
            <button onclick="toggleFavorites()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="favoriteContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- 喜欢内容将在这里动态生成 -->
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearFavorites()" class="w-full btn-secondary">
                <i class="fa fa-trash mr-1"></i> 清空喜欢
            </button>
        </div>
    </div>

    <!-- 背景遮罩 -->
    <div 
        id="overlay" 
        class="fixed inset-0 bg-black/50 z-30 hidden"
        onclick="closeAllPanels()"
    ></div>

    <!-- 悬浮控制按钮 -->
    <div 
        id="floatingButtons" 
        class="fixed bottom-6 right-6 glass-effect rounded-lg shadow-lg p-2 hidden"
    >
        <button 
            onclick="scrollToTop()" 
            class="p-3 rounded-full hover:bg-gray-200 transition-colors"
            title="回到顶部"
        >
            <i class="fa fa-arrow-up"></i>
        </button>
    </div>

    <!-- 视频播放器模态框 -->
    <div 
        id="videoPlayerModal" 
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
    >
        <div class="relative w-full max-w-4xl h-[70vh] bg-black rounded-lg overflow-hidden">
            <div 
                id="playerTitle"
                class="absolute top-4 left-4 z-10 px-3 py-1.5 bg-black/60 text-white text-sm rounded-full max-w-[70%] truncate"
            ></div>
            <!-- 移动设备专用关闭按钮 -->
            <button 
                id="closeVideoButtonMobile" 
                onclick="closeVideoPlayer()"
                class="md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
            >
                <i class="fa fa-times text-xl"></i>
            </button>
            <button 
                id="shareVideoButtonMobile" 
                onclick="shareCurrentVideo()"
                class="md:hidden fixed top-4 right-20 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="分享"
            >
                <i class="fa fa-share-alt text-xl"></i>
            </button>
            <button 
                id="likeVideoButtonMobile" 
                onclick="toggleCurrentVideoFavorite()"
                class="md:hidden fixed top-4 right-36 bg-gray-600 hover:bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="喜欢"
            >
                <i class="fa fa-heart-o text-xl"></i>
            </button>
            
            <!-- 桌面端关闭按钮 -->
            <button 
                id="closeVideoButton" 
                onclick="closeVideoPlayer()"
                class="hidden md:flex absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
            >
                <i class="fa fa-times"></i>
            </button>
            <button 
                id="shareVideoButton" 
                onclick="shareCurrentVideo()"
                class="hidden md:flex absolute top-4 right-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="分享"
            >
                <i class="fa fa-share-alt"></i>
            </button>
            <button 
                id="likeVideoButton" 
                onclick="toggleCurrentVideoFavorite()"
                class="hidden md:flex absolute top-4 right-28 bg-gray-600 hover:bg-red-600 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="喜欢"
            >
                <i class="fa fa-heart-o"></i>
            </button>
            
            <div id="dplayer" class="w-full h-full"></div>
        </div>
    </div>

    <!-- Host设置面板 -->
    <div 
        id="hostModal" 
        class="fixed top-0 right-0 bottom-0 w-full md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">设置API Host</h3>
            <button onclick="toggleHostModal()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">当前API</label>
                    <input 
                        type="text" 
                        id="hostInput" 
                        class="input-primary w-full"
                        placeholder="请输入API Host地址"
                    >
                </div>
                <div class="flex space-x-3">
                    <button onclick="saveHost()" class="btn-primary flex-1">
                        <i class="fa fa-save mr-1"></i> 保存
                    </button>
                    <button onclick="resetHost()" class="btn-secondary flex-1">
                        <i class="fa fa-refresh mr-1"></i> 重置
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">聚合搜索</label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="aggregateSwitch" 
                            class="sr-only"
                            onchange="toggleAggregateSearch()"
                        >
                        <div class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 -mt-2">开启后会搜索官方推荐的所有接口</p>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">聚合接口选择</label>
                    <button 
                        type="button"
                        onclick="toggleAggregateApiSection()"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        展开/收起
                    </button>
                </div>
                <div id="aggregateApiSection" class="hidden space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="selectAllAggregateApis()" class="btn-secondary text-xs flex-1">全选</button>
                        <button onclick="clearAggregateApis()" class="btn-secondary text-xs flex-1">全不选</button>
                        <button onclick="resetAggregateApis()" class="btn-secondary text-xs flex-1">恢复默认</button>
                    </div>
                    <div id="aggregateApiList" class="space-y-2"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">官方推荐</label>
                    <button 
                        type="button"
                        onclick="toggleOfficialApiSection(); fetchOfficialApis(true)"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        展开/收起
                    </button>
                </div>
                <div id="officialApiSection" class="hidden space-y-2">
                    <div id="officialApiList" class="space-y-2"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">历史Host</label>
                    <button 
                        type="button"
                        onclick="toggleHostHistory()"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        切换显示
                    </button>
                </div>
                <div id="hostHistoryWrap" class="hidden space-y-2">
                    <div id="hostHistoryList" class="space-y-2"></div>
                </div>
                
                <div class="border-t border-gray-200 pt-4 mt-2"></div>

                <div class="flex space-x-3 pt-2">
                    <button onclick="exportUserData()" class="btn-secondary flex-1">
                        <i class="fa fa-download mr-1"></i> 导出
                    </button>
                    <label class="btn-primary flex-1 text-center cursor-pointer">
                        <i class="fa fa-upload mr-1"></i> 导入
                        <input id="importFileInput" type="file" accept="application/json" class="hidden" onchange="importUserData(event)">
                    </label>
                </div>
                <p class="text-xs text-gray-500">导出/导入：仅包含喜欢与播放历史</p>
                <div class="pt-2">
                    <label class="block text-sm font-medium mb-2">导入导出历史记录</label>
                    <div id="transferHistoryList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div 
        id="loadingIndicator" 
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30"
    >
        <div class="glass-effect rounded-lg p-6 flex flex-col items-center space-y-3">
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p id="loadingText" class="text-gray-700">加载中...</p>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let searchTerm = '';
        let host = '';
        let hostName = '';
        let dplayer = null;
        let isLoading = false;
        let hasMore = true;
        let currentVideoUrl = '';
        let currentVideoTitle = '';
        let currentVideoPic = '';
        let currentVideoSource = '';
        
        // DOM元素
        const videoList = document.getElementById('videoList');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const emptyState = document.getElementById('emptyState');
        const historyPanel = document.getElementById('historyPanel');
        const historyContent = document.getElementById('historyContent');
        const favoritePanel = document.getElementById('favoritePanel');
        const favoriteContent = document.getElementById('favoriteContent');
        const overlay = document.getElementById('overlay');
        const floatingButtons = document.getElementById('floatingButtons');
        const videoPlayerModal = document.getElementById('videoPlayerModal');
        const hostModal = document.getElementById('hostModal');
        const hostInput = document.getElementById('hostInput');
        const hostHistoryWrap = document.getElementById('hostHistoryWrap');
        const hostHistoryList = document.getElementById('hostHistoryList');
        const officialApiList = document.getElementById('officialApiList');
        const aggregateApiList = document.getElementById('aggregateApiList');
        const aggregateSwitch = document.getElementById('aggregateSwitch');
        const aggregateApiSection = document.getElementById('aggregateApiSection');
        const officialApiSection = document.getElementById('officialApiSection');
        const searchInput = document.getElementById('searchInput');
        const searchInputMobile = document.getElementById('searchInputMobile');
        const searchHistoryBox = document.getElementById('searchHistoryBox');
        const searchHistoryBoxMobile = document.getElementById('searchHistoryBoxMobile');
        const searchButtonMobile = document.getElementById('searchButtonMobile');
        let suppressHistoryClick = false;
        const transferHistoryList = document.getElementById('transferHistoryList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        
        // 初��化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载保存的Host
            host = localStorage.getItem('apiHost') || '';
            hostName = localStorage.getItem('apiHostName') || '';
            const aggregateEnabled = isAggregateSearchEnabled();
            if (aggregateSwitch) {
                aggregateSwitch.checked = aggregateEnabled;
                updateAggregateSwitchUI(aggregateEnabled);
            }
            updateSearchButtonLabel(aggregateEnabled);
            
            // 鼠标移出面板自动关闭
            historyPanel.addEventListener('mouseleave', closeAllPanels);
            favoritePanel.addEventListener('mouseleave', closeAllPanels);
            hostModal.addEventListener('mouseleave', () => {
                if (!hostModal.classList.contains('translate-x-full')) {
                    toggleHostModal();
                }
            });

            
            // 加载初始数据
            loadInitialData();
            
            // 监听滚动事件
            window.addEventListener('scroll', handleScroll);

            // 搜索历史提示
            bindSearchHistoryEvents();

            // 点击空白处关闭更多菜单
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('moreMenu');
                const button = document.getElementById('moreButton');
                if (!menu || !button) return;
                if (menu.contains(e.target) || button.contains(e.target)) return;
                menu.classList.add('hidden');
            });

            // 移动端搜索框打开时点击其他位置自动关闭
            document.addEventListener('click', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            });

            // 移动端搜索框打开时，滑动/触摸其他位置也关闭
            document.addEventListener('touchstart', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            }, { passive: true });

            // 点击导航栏任意位置关闭面板
            const header = document.getElementById('header');
            if (header) {
                header.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target && target.closest('button, input, select, textarea, a, label, #moreMenu')) {
                        return;
                    }
                    closeAllPanels();
                });
            }
        });
        
        // 加载初始数据
        function loadInitialData() {
            if (!host && !isAggregateSearchEnabled()) {
                // 如果没有设置Host，显示设置提示
                showHostModal();
                return;
            }
            
            showLoading('正在加载推荐视频...');
            hasMore = true;
            fetchData('', 1).finally(() => {
                hideLoading();
            });
        }
        
        // 获取代理URL
        function getProxyUrl(endpoint, params = {}) {
            const baseUrl = window.location.origin + '/proxy';
            const url = new URL(endpoint, baseUrl);
            
            // 添加查询参数
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null) {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            return url.toString();
        }
        
        // 获取数据
        async function fetchData(keyword, page) {
            if (isAggregateSearchEnabled()) {
                return fetchAggregatedData(keyword, page);
            }
            try {
                const params = {
                    wd: keyword,
                    pg: page,
                    url: host
                };
                
                const response = await fetch(getProxyUrl('', params));
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('数据加载完毕');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                // 普通搜索去重：相同标题只保留一条
                const seenTitles = new Set();
                const deduped = [];
                data.list.forEach(video => {
                    const title = (video.vod_name || '').trim();
                    if (!title) {
                        deduped.push(video);
                        return;
                    }
                    if (seenTitles.has(title)) return;
                    seenTitles.add(title);
                    deduped.push(video);
                });
                
                // 渲染数据
                if (page === 1) {
                    videoList.innerHTML = '';
                }
                
                renderVideos(deduped);
                
                // 更新分页状态
                currentPage = page;
                searchTerm = keyword;
                
                // 显示/隐藏加载更多按钮
                if (data.list.length < 20) {
                    hideLoadMoreButton();
                    hasMore = false;
                } else {
                    showLoadMoreButton();
                    hasMore = true;
                }
                
                return deduped;
            } catch (error) {
                console.error('获取数据失败:', error);
                if (page === 1) {
                    showErrorState('获取数据失败，请检查网络连接或Host设置');
                }
                return [];
            }
        }

        async function fetchAggregatedData(keyword, page) {
            try {
                const apis = await getOfficialApis();
                const selectedUrls = getAggregateApiSelection();
                const targetApis = selectedUrls.length > 0
                    ? apis.filter(item => selectedUrls.includes(item.url))
                    : apis;
                if (!targetApis || targetApis.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('数据加载完毕');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                let completed = 0;
                updateAggregateLoading(completed, targetApis.length);
                const results = await Promise.all(
                    targetApis.map(item => {
                        const params = {
                            wd: keyword,
                            pg: page,
                            url: item.url
                        };
                        return fetch(getProxyUrl('', params))
                            .then(res => res.json())
                            .then(data => ({
                                item,
                                list: Array.isArray(data.list) ? data.list : []
                            }))
                            .catch(() => ({ item, list: [] }))
                            .finally(() => {
                                completed += 1;
                                updateAggregateLoading(completed, targetApis.length);
                            });
                    })
                );
                
                const merged = [];
                results.forEach(({ item, list }) => {
                    const label = getOfficialLabel(item);
                    list.forEach(video => {
                        merged.push({
                            ...video,
                            _sourceLabel: label
                        });
                    });
                });

                // 去重：相同标题只保留一条
                const seenTitles = new Set();
                const deduped = [];
                merged.forEach(video => {
                    const title = (video.vod_name || '').trim();
                    if (!title) {
                        deduped.push(video);
                        return;
                    }
                    if (seenTitles.has(title)) return;
                    seenTitles.add(title);
                    deduped.push(video);
                });
                
                if (page === 1) {
                    videoList.innerHTML = '';
                }
                
                if (deduped.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('数据加载完毕');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                renderVideos(deduped);
                
                currentPage = page;
                searchTerm = keyword;
                
                const anyHasMore = results.some(r => r.list && r.list.length >= 20);
                if (anyHasMore) {
                    showLoadMoreButton();
                    hasMore = true;
                } else {
                    hideLoadMoreButton();
                    hasMore = false;
                }
                
                return deduped;
            } catch (error) {
                console.error('聚合搜索失败:', error);
                if (page === 1) {
                    showErrorState('获取数据失败，请检查网络连接或Host设置');
                }
                return [];
            }
        }

        function updateAggregateLoading(done, total) {
            if (!isAggregateSearchEnabled()) return;
            const text = `聚合搜索加载中... (${done}/${total})`;
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        
        // 渲染视频卡片
        function renderVideos(videos) {
            videos.forEach(video => {
                const favorited = isFavorited(video.vod_play_url);
                const sourceLabel = video._sourceLabel || getHostLabel();
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg overflow-hidden shadow-md card-hover scroll-offset';
                card.innerHTML = `
                    <div class="relative aspect-video overflow-hidden cursor-pointer" onclick="openFullScreenPreview('${video.vod_pic}', '${video.vod_name}')">
                        <img 
                            src="./loading.gif" 
                            data-src="${video.vod_pic}" 
                            alt="${video.vod_name}" 
                            class="w-full h-full object-cover lazy-image"
                        >
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end">
                            <div class="p-3 w-full">
                                <h3 class="text-white font-medium line-clamp-2">${video.vod_name}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold mb-2 line-clamp-1">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded mr-2">${sourceLabel}</span>
                            ${video.vod_name}
                        </h3>
                        <div class="flex justify-between items-center">
                            <button 
                                onclick="openVideoPlayer('${video.vod_play_url}', '${video.vod_name}', '${video.vod_pic}', '${sourceLabel}')"
                                class="btn-primary text-sm"
                            >
                                <i class="fa fa-play mr-1"></i> 播放
                            </button>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="toggleFavorite('${video.vod_name}', '${video.vod_play_url}', '${video.vod_pic}', this, '${sourceLabel}')"
                                    class="text-sm ${favorited ? 'text-red-500' : 'text-gray-500'} hover:text-red-500"
                                    title="喜欢"
                                >
                                    <i class="fa ${favorited ? 'fa-heart' : 'fa-heart-o'} mr-1"></i> 喜欢
                                </button>
                                <button 
                                    onclick="shareVideo('${video.vod_play_url}', '${video.vod_name}')"
                                    class="text-sm text-gray-500 hover:text-blue-500"
                                    title="分享视频"
                                >
                                    <i class="fa fa-share-alt mr-1"></i> 分享
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                videoList.appendChild(card);
            });
            
            // 初始化懒加载
            initLazyLoading();
        }
        
        // 初始化图片懒加载
        function initLazyLoading() {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy-image');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // 回退方案
                lazyImages.forEach(img => {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy-image');
                });
            }
        }
        
        // 搜索功能
        function searchData() {
            suppressHistoryInteractions(200);
            const isMobile = window.matchMedia('(max-width: 767px)').matches;
            const desktopValue = document.getElementById('searchInput').value.trim();
            const mobileValue = document.getElementById('searchInputMobile').value.trim();
            const input = isMobile ? mobileValue : (desktopValue || mobileValue);
            
            if (!input) {
                showToast('请输入搜索关键词');
                return;
            }
            
            if (!host && !isAggregateSearchEnabled()) {
                showToast('请先设置API Host');
                showHostModal();
                return;
            }
            
            searchTerm = input;
            currentPage = 1;
            hasMore = true;
            saveSearchHistory(input);
            hideSearchHistory();
            
            // 更新两个搜索框的值
            document.getElementById('searchInput').value = input;
            document.getElementById('searchInputMobile').value = input;
            
            showLoading('正在搜索...');
            fetchData(input, 1).then((list) => {
                if (list && list.length > 0) {
                    if (window.matchMedia('(max-width: 767px)').matches) {
                        setTimeout(() => {
                            const mobileBox = document.getElementById('mobileSearchBox');
                            if (mobileBox && !mobileBox.classList.contains('hidden')) {
                                mobileBox.classList.add('hidden');
                            }
                        }, 200);
                    }
                    setTimeout(() => {
                        const firstCard = videoList.firstElementChild;
                        if (firstCard) {
                            scrollToElementWithHeaderOffset(firstCard, 12);
                        }
                    }, 50);
                }
            }).finally(() => {
                hideLoading();
            });
        }

        // 搜索历史记录
        function getSearchHistory() {
            return JSON.parse(localStorage.getItem('searchHistory') || '[]');
        }

        function saveSearchHistory(term) {
            if (!term) return;
            const history = getSearchHistory();
            const existingIndex = history.findIndex(item => item === term);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(term);
            if (history.length > 20) {
                history.splice(20);
            }
            localStorage.setItem('searchHistory', JSON.stringify(history));
        }

        function renderSearchHistory() {
            const history = getSearchHistory().slice(0, 12);
            const box = searchHistoryBox;
            const boxMobile = searchHistoryBoxMobile;
            const html = history.length === 0
                ? `<div class="px-3 py-2 text-xs text-gray-500">暂无搜索历史</div>`
                : `
                    <div class="flex flex-wrap gap-2 p-2 max-h-[96px] overflow-hidden">
                        ${history.map(item => `
                            <button 
                                class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200"
                                onclick="selectSearchHistory('${item}')"
                                title="${item}"
                            >${item}</button>
                        `).join('')}
                    </div>
                `;
            if (box) box.innerHTML = html;
            if (boxMobile) boxMobile.innerHTML = html;
        }

        function showSearchHistory() {
            if (suppressHistoryClick) return;
            renderSearchHistory();
            if (searchHistoryBox) searchHistoryBox.classList.remove('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.remove('hidden');
        }

        function hideSearchHistory() {
            if (searchHistoryBox) searchHistoryBox.classList.add('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.add('hidden');
        }

        function selectSearchHistory(term) {
            if (suppressHistoryClick) return;
            if (!term) return;
            if (searchInput) searchInput.value = term;
            if (searchInputMobile) searchInputMobile.value = term;
            searchData();
        }

        function bindSearchHistoryEvents() {
            const bind = (input) => {
                if (!input) return;
                input.addEventListener('focus', showSearchHistory);
                input.addEventListener('blur', () => {
                    setTimeout(hideSearchHistory, 150);
                });
            };
            bind(searchInput);
            bind(searchInputMobile);

            // 移动端点击输入框时清空上次搜索内容
            if (searchInputMobile) {
                searchInputMobile.addEventListener('focus', () => {
                    searchInputMobile.value = '';
                });
            }
            if (searchButtonMobile) {
                const suppress = () => suppressHistoryInteractions(250);
                searchButtonMobile.addEventListener('mousedown', suppress);
                searchButtonMobile.addEventListener('pointerdown', suppress);
                searchButtonMobile.addEventListener('touchstart', suppress, { passive: true });
            }
        }

        function suppressHistoryInteractions(duration = 200) {
            suppressHistoryClick = true;
            hideSearchHistory();
            if (searchHistoryBox) searchHistoryBox.style.pointerEvents = 'none';
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = 'none';
            setTimeout(() => {
                suppressHistoryClick = false;
                if (searchHistoryBox) searchHistoryBox.style.pointerEvents = '';
                if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = '';
            }, duration);
        }

        // 滚动到元素并避开固定导航
        function scrollToElementWithHeaderOffset(element, extraOffset = 0) {
            if (!element) return;
            const header = document.getElementById('header');
            const headerHeight = header ? header.offsetHeight : 0;
            const rect = element.getBoundingClientRect();
            const targetTop = rect.top + window.pageYOffset - headerHeight - extraOffset;
            window.scrollTo({ top: Math.max(targetTop, 0), behavior: 'smooth' });
        }
        
        // 加载更多
        function loadMoreData() {
            if (isLoading || (!host && !isAggregateSearchEnabled()) || !hasMore) return;
            
            isLoading = true;
            showLoading('加载更多内容...');
            
            fetchData(searchTerm, currentPage + 1).finally(() => {
                hideLoading();
                isLoading = false;
            });
        }
        
        // 处理回车键搜索
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchData();
            }
        }
        
        // 显示全屏预览
        function openFullScreenPreview(imageUrl, title) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh]">
                    <button 
                        onclick="this.closest('.fixed').remove()"
                        class="absolute -top-12 right-0 text-white hover:text-gray-300"
                    >
                        <i class="fa fa-times text-xl"></i>
                    </button>
                    <img 
                        src="${imageUrl}" 
                        alt="${title}" 
                        class="max-w-full max-h-[90vh] object-contain rounded-lg"
                    >
                    <p class="text-white text-center mt-4">${title}</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            
            // 点击空白区域关闭
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    document.body.style.overflow = '';
                }
            });
        }
        
        // 打开视频播放器
        function openVideoPlayer(videoUrl, videoTitle, imageUrl = '', sourceLabel = '') {
            if (!host) {
                if (!isAggregateSearchEnabled()) {
                    showToast('请先设置API Host');
                    showHostModal();
                    return;
                }
            }
            
            showLoading('正在加载视频...');
            
            try {
                // 解析真实视频URL
                const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
                currentVideoUrl = realVideoUrl;
                currentVideoTitle = videoTitle || '视频播放';
                currentVideoPic = imageUrl || '';
                currentVideoSource = sourceLabel || getHostLabel();
                updatePlayerLikeButtons(isFavorited(realVideoUrl));
                const playerTitle = document.getElementById('playerTitle');
                if (playerTitle) {
                    const label = currentVideoSource || '未知来源';
                    playerTitle.innerHTML = `<span class="bg-white/20 text-white/90 text-[10px] px-2 py-0.5 rounded mr-2">${label}</span>${currentVideoTitle}`;
                }
                
                // 保存播放历史
                saveToHistory(videoTitle, realVideoUrl, imageUrl, currentVideoSource);
                
                // 显示播放器
                videoPlayerModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // 初始化DPlayer
                if (dplayer) {
                    dplayer.destroy();
                }
                
                dplayer = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: realVideoUrl,
                        type: 'hls',
                        pic: '',
                        thumbnails: '',
                        title: videoTitle || '视频播放'
                    },
                    autoplay: true,
                    theme: '#3b82f6',
                    loop: false,
                    screenshot: true,
                    hotkey: true,
                    preload: 'auto',
                    contextmenu: [
                        {
                            text: '在新窗口打开',
                            link: realVideoUrl,
                        }
                    ]
                });
                
                // 添加窗口播放按钮到控制栏
                setTimeout(() => {
                    const controller = document.querySelector('.dplayer-controller');
                    if (controller) {
                        const windowButton = document.createElement('button');
                        windowButton.className = 'dplayer-button dplayer-window-button';
                        windowButton.innerHTML = '<i class="fa fa-window-restore"></i>';
                        windowButton.title = '窗口播放';
                        windowButton.onclick = () => window.open(realVideoUrl, '_blank');
                        
                        // 插入到全屏按钮之前
                        const fullscreenButton = controller.querySelector('.dplayer-fullscreen-toggle');
                        if (fullscreenButton) {
                            controller.insertBefore(windowButton, fullscreenButton);
                        } else {
                            controller.appendChild(windowButton);
                        }
                    }
                }, 100);
                
                dplayer.on('play', () => {
                    hideLoading();
                    isLoading = false;
                });
                
                dplayer.on('error', (e) => {
                    // 只有在加载过程中发生错误才显示提示
                    if (isLoading) {
                        hideLoading();
                        showToast('视频加载失败，请尝试其他视频');
                    }
                    console.error('视频���放错误:', e);
                });
            } catch (error) {
                hideLoading();
                showToast('视频加载失败');
                console.error('视频播放器初始化失败:', error);
            }
        }
        
        // 关闭视频播放器
        function closeVideoPlayer() {
            if (dplayer) {
                dplayer.destroy();
                dplayer = null;
            }
            
            videoPlayerModal.classList.add('hidden');
            document.body.style.overflow = '';
            currentVideoUrl = '';
            currentVideoTitle = '';
            currentVideoPic = '';
            currentVideoSource = '';
            updatePlayerLikeButtons(false);
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = '';
            }
            
            // 隐藏移动设备关闭按钮
            const mobileCloseButton = document.getElementById('closeVideoButtonMobile');
            if (mobileCloseButton) {
                // 使用className重置所有样式，确保下次能正确显示
                mobileCloseButton.className = 'md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg';
                mobileCloseButton.style.cssText = '';
            }
        }
        
        // 保存到播放历史
        function saveToHistory(title, url, pic, source) {
            try {
                const history = JSON.parse(localStorage.getItem('playHistory') || '[]');
                
                // 检查是否已存在
                const existingIndex = history.findIndex(item => item.url === url);
                
                const historyItem = {
                    title,
                    url,
                    pic: pic || '',
                    source: source || '',
                    timestamp: Date.now(),
                    playCount: existingIndex >= 0 ? (history[existingIndex].playCount || 0) + 1 : 1
                };
                
                // 如果已存在，先移除
                if (existingIndex >= 0) {
                    history.splice(existingIndex, 1);
                }
                
                // 添加到开头
                history.unshift(historyItem);
                
                // 限制历史记录数量
                if (history.length > 50) {
                    history.splice(50);
                }
                
                localStorage.setItem('playHistory', JSON.stringify(history));
            } catch (error) {
                console.error('保存播放历史失败:', error);
            }
        }
        
        // 显示历史记录
        function toggleHistory() {
            const history = JSON.parse(localStorage.getItem('playHistory') || '[]');
            
            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-history text-4xl mb-3"></i>
                        <p>暂无播放历史</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = history.map(item => `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" class="w-full h-full object-cover">`
                                        : `<div class="w-full h-full bg-gray-200"></div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || '未知来源'}</span>
                                    ${item.title}
                                </h4>
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span>播放次数: ${item.playCount}</span>
                                    <span>${formatDate(item.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button 
                                onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                                class="btn-primary text-xs py-1 px-2 flex-1"
                            >
                                <i class="fa fa-play mr-1"></i> 播放
                            </button>
                            <button 
                                onclick="removeFromHistory('${item.url}')"
                                class="text-gray-500 hover:text-red-500 p-1"
                            >
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            historyPanel.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // 喜欢功能
        function getFavorites() {
            return JSON.parse(localStorage.getItem('favorites') || '[]');
        }

        function isFavorited(videoUrl) {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const favorites = getFavorites();
            return favorites.some(item => item.url === realVideoUrl);
        }

        function toggleFavorite(title, videoUrl, pic, buttonEl, sourceLabel = '') {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === realVideoUrl);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                showToast('已取消喜欢');
                updateFavoriteButton(buttonEl, false);
            } else {
                const source = sourceLabel || getHostLabel();
                favorites.unshift({
                    title,
                    url: realVideoUrl,
                    pic: pic || '',
                    source: source || '',
                    timestamp: Date.now()
                });
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                showToast('已加入喜欢');
                updateFavoriteButton(buttonEl, true);
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function updateFavoriteButton(buttonEl, isLiked) {
            if (!buttonEl) return;
            buttonEl.classList.toggle('text-red-500', isLiked);
            buttonEl.classList.toggle('text-gray-500', !isLiked);
            const icon = buttonEl.querySelector('i');
            if (icon) {
                icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'} mr-1`;
            }
        }

        function toggleFavorites() {
            const favorites = getFavorites();
            
            if (favorites.length === 0) {
                favoriteContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-heart text-4xl mb-3"></i>
                        <p>暂无喜欢内容</p>
                    </div>
                `;
            } else {
                favoriteContent.innerHTML = favorites.map(item => `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" class="w-full h-full object-cover">`
                                        : `<div class="w-full h-full bg-gray-200"></div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || '未知来源'}</span>
                                    ${item.title}
                                </h4>
                                <div class="text-xs text-gray-500">
                                    <span>${formatDate(item.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button 
                                onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                                class="btn-primary text-xs py-1 px-2 flex-1"
                            >
                                <i class="fa fa-play mr-1"></i> 播放
                            </button>
                            <button 
                                onclick="removeFavorite('${item.url}')"
                                class="text-gray-500 hover:text-red-500 p-1"
                            >
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            favoritePanel.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function removeFavorite(url) {
            try {
                const favorites = getFavorites().filter(item => item.url !== url);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                toggleFavorites();
                toggleFavorites();
            } catch (error) {
                console.error('移除喜欢失败:', error);
            }
        }

        function clearFavorites() {
            if (confirm('确定要清空所有喜欢内容吗？')) {
                localStorage.removeItem('favorites');
                toggleFavorites();
                toggleFavorites();
                showToast('喜欢内容已清空');
            }
        }
        
        // 从历史记录中移除
        function removeFromHistory(url) {
            try {
                const history = JSON.parse(localStorage.getItem('playHistory') || '[]');
                const filteredHistory = history.filter(item => item.url !== url);
                localStorage.setItem('playHistory', JSON.stringify(filteredHistory));
                
                // 重新渲染历史记录
                toggleHistory();
                toggleHistory();
            } catch (error) {
                console.error('移除历史记录失败:', error);
            }
        }
        
        // 清空历史记录
        function clearHistory() {
            if (confirm('确定要清空所有播放历史吗？')) {
                localStorage.removeItem('playHistory');
                toggleHistory();
                toggleHistory();
                showToast('历史记录已清空');
            }
        }
        
        // 切换Host设置模态框
        function toggleHostModal() {
            hostModal.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
            
            if (!hostModal.classList.contains('translate-x-full')) {
                hostInput.value = host;
                hostInput.focus();
                fetchOfficialApis(false);
                renderHostHistory();
                renderTransferHistory();
            }
        }
        
        // 保存Host设置
        function saveHost() {
            const input = hostInput.value.trim();
            
            if (!input) {
                showToast('请输入有效的Host地址');
                return;
            }
            
            // 验证URL格式
            try {
                new URL(input);
            } catch (e) {
                showToast('请输入有效的URL格式');
                return;
            }
            
            host = input;
            localStorage.setItem('apiHost', host);
            hostName = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            saveHostHistory(host);
            
            toggleHostModal();
            showToast('Host设置已保存');
            
            // 如果之前因为没有Host而无法加载数据，现在重新加载
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }
        
        // 重置Host设置
        function resetHost() {
            host = '';
            hostName = '';
            hostInput.value = '';
            localStorage.removeItem('apiHost');
            localStorage.removeItem('apiHostName');
            showToast('Host已重置');
        }

        // 聚合搜索开关
        function isAggregateSearchEnabled() {
            return localStorage.getItem('aggregateSearch') === '1';
        }

        function toggleAggregateSearch() {
            if (!aggregateSwitch) return;
            const enabled = !!aggregateSwitch.checked;
            localStorage.setItem('aggregateSearch', enabled ? '1' : '0');
            updateAggregateSwitchUI(enabled);
            if (enabled) {
                fetchOfficialApis(false);
                renderAggregateApiSelection(officialApiCache ? officialApiCache.data : []);
                showToast('已开启聚合搜索');
            } else {
                showToast('已关闭聚合搜索');
            }
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
        }

        function toggleAggregateApiSection() {
            if (!aggregateApiSection) return;
            fetchOfficialApis(false);
            aggregateApiSection.classList.toggle('hidden');
        }

        function toggleOfficialApiSection() {
            if (!officialApiSection) return;
            officialApiSection.classList.toggle('hidden');
        }

        function updateAggregateSwitchUI(enabled) {
            if (!aggregateSwitch) return;
            const track = aggregateSwitch.nextElementSibling;
            if (!track) return;
            const thumb = track.firstElementChild;
            track.classList.toggle('bg-primary', enabled);
            track.classList.toggle('bg-gray-300', !enabled);
            if (thumb) {
                thumb.classList.toggle('translate-x-4', enabled);
                thumb.classList.toggle('translate-x-0', !enabled);
            }
            updateSearchButtonLabel(enabled);
        }

        function updateSearchButtonLabel(aggregateEnabled) {
            const label = aggregateEnabled ? '聚合搜索' : '搜索';
            const desktopLabel = document.getElementById('searchButtonLabel');
            const mobileLabel = document.getElementById('searchButtonLabelMobile');
            if (desktopLabel) desktopLabel.textContent = label;
            if (mobileLabel) mobileLabel.textContent = label;
        }

        function toggleMobileSearch() {
            const box = document.getElementById('mobileSearchBox');
            if (!box) return;
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                if (searchInputMobile) searchInputMobile.focus();
            }
        }

        // 导出/导入喜欢和历史
        function exportUserData() {
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            const playHistory = JSON.parse(localStorage.getItem('playHistory') || '[]');
            const payload = {
                favorites,
                playHistory
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            a.download = `video-data-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            addTransferHistory('导出', a.download);
            showToast('导出成功');
        }

        function importUserData(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result || '{}');
                    if (data.favorites && Array.isArray(data.favorites)) {
                        localStorage.setItem('favorites', JSON.stringify(data.favorites));
                    } else {
                        localStorage.setItem('favorites', JSON.stringify([]));
                    }
                    if (data.playHistory && Array.isArray(data.playHistory)) {
                        localStorage.setItem('playHistory', JSON.stringify(data.playHistory));
                    } else {
                        localStorage.setItem('playHistory', JSON.stringify([]));
                    }
                    addTransferHistory('导入', file.name);
                    showToast('导入成功');
                } catch (e) {
                    showToast('导入失败：文件格式不正确');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function getTransferHistory() {
            return JSON.parse(localStorage.getItem('transferHistory') || '[]');
        }

        function addTransferHistory(type, filename) {
            const history = getTransferHistory();
            history.unshift({
                type,
                filename: filename || '',
                timestamp: Date.now()
            });
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('transferHistory', JSON.stringify(history));
            renderTransferHistory();
        }

        function renderTransferHistory() {
            if (!transferHistoryList) return;
            const history = getTransferHistory();
            if (history.length === 0) {
                transferHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">暂无记录</div>
                `;
                return;
            }
            transferHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.type} · ${formatDate(item.timestamp)}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.filename || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function handleActionSelect(value) {
            if (!value) return;
            if (value === 'favorite') {
                toggleFavorites();
            } else if (value === 'history') {
                toggleHistory();
            } else if (value === 'setting') {
                toggleHostModal();
            }
            const select = document.getElementById('actionSelect');
            if (select) select.value = '';
        }

        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            if (!menu) return;
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                menu.addEventListener('mouseleave', handleMoreMenuMouseLeave, { once: true });
            }
        }

        function handleMoreAction(action) {
            if (action === 'favorite') {
                toggleFavorites();
            } else if (action === 'history') {
                toggleHistory();
            } else if (action === 'setting') {
                toggleHostModal();
            }
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        function handleMoreMenuMouseLeave() {
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        // 官方推荐接口
        let officialApiCache = null;

        function fetchOfficialApis(force) {
            if (!officialApiList) return;
            if (officialApiCache && !force) {
                renderOfficialApis(officialApiCache);
                return;
            }
            
            officialApiList.innerHTML = `
                <div class="text-xs text-gray-500">正在获取官方推荐...</div>
            `;
            
            fetch('/apis/official')
                .then(res => res.json())
                .then(data => {
                    if (!data || data.code !== 200 || !Array.isArray(data.data)) {
                        throw new Error('官方接口返回异常');
                    }
                    officialApiCache = data;
                    try {
                        localStorage.setItem('officialApiList', JSON.stringify(data.data));
                    } catch (e) {
                        // ignore storage errors
                    }
                    renderOfficialApis(data);
                })
                .catch(err => {
                    console.error('获取官方接口失败:', err);
                    officialApiList.innerHTML = `
                        <div class="text-xs text-red-500">获取失败，请稍后再试</div>
                    `;
                });
        }

        function renderOfficialApis(data) {
            if (!data || !Array.isArray(data.data)) {
                officialApiList.innerHTML = `
                    <div class="text-xs text-gray-500">暂无官方推荐</div>
                `;
                if (aggregateApiList) {
                    aggregateApiList.innerHTML = `
                        <div class="text-xs text-gray-500">暂无可选接口</div>
                    `;
                }
                return;
            }
            
            const metaText = [data.title, data.subtitle].filter(Boolean).join(' · ');
            const metaHtml = metaText
                ? `<div class="text-xs text-gray-500 mb-2">${metaText}</div>`
                : '';
            
            const itemsHtml = data.data.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.name || '官方推荐'}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                    </div>
                    <button 
                        onclick="selectHost('${item.url || ''}', '${item.name || ''}')"
                        class="text-xs text-primary hover:underline"
                    >使用</button>
                </div>
            `).join('');
            
            officialApiList.innerHTML = `
                ${metaHtml}
                ${itemsHtml || '<div class="text-xs text-gray-500">暂无官方推荐</div>'}
            `;

            renderAggregateApiSelection(data.data);
        }

        async function getOfficialApis() {
            if (officialApiCache && Array.isArray(officialApiCache.data)) {
                return officialApiCache.data.filter(item => item && item.url);
            }
            try {
                const cached = localStorage.getItem('officialApiList');
                if (cached) {
                    const list = JSON.parse(cached);
                    if (Array.isArray(list)) {
                        return list.filter(item => item && item.url);
                    }
                }
            } catch (e) {
                // ignore cache errors
            }
            const res = await fetch('/apis/official');
            const data = await res.json();
            if (data && data.code === 200 && Array.isArray(data.data)) {
                officialApiCache = data;
                try {
                    localStorage.setItem('officialApiList', JSON.stringify(data.data));
                } catch (e) {
                    // ignore storage errors
                }
                renderAggregateApiSelection(data.data);
                return data.data.filter(item => item && item.url);
            }
            return [];
        }

        function getOfficialLabel(item) {
            if (item && item.name) return item.name;
            if (item && item.url) return getHostNameFromUrl(item.url);
            return '官方推荐';
        }

        function getAggregateApiSelection() {
            try {
                const raw = localStorage.getItem('aggregateApiSelection');
                const list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function setAggregateApiSelection(urls) {
            const unique = Array.from(new Set((urls || []).filter(Boolean)));
            localStorage.setItem('aggregateApiSelection', JSON.stringify(unique));
        }

        function ensureDefaultAggregateSelection(apis) {
            const current = getAggregateApiSelection();
            if (current.length > 0) return current;
            const defaults = (apis || []).slice(0, 3).map(item => item.url).filter(Boolean);
            setAggregateApiSelection(defaults);
            return defaults;
        }

        function renderAggregateApiSelection(apis) {
            if (!aggregateApiList) return;
            const list = (apis || []).filter(item => item && item.url);
            if (list.length === 0) {
                aggregateApiList.innerHTML = `
                    <div class="text-xs text-gray-500">暂无可选接口</div>
                `;
                return;
            }
            const selected = ensureDefaultAggregateSelection(list);
            aggregateApiList.innerHTML = list.map(item => {
                const checked = selected.includes(item.url) ? 'checked' : '';
                return `
                    <label class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                        <div class="min-w-0 mr-2">
                            <div class="text-xs text-gray-700 truncate">${item.name || '官方推荐'}</div>
                            <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                        </div>
                        <input 
                            type="checkbox" 
                            class="w-4 h-4"
                            ${checked}
                            onchange="toggleAggregateApi('${item.url}')"
                        >
                    </label>
                `;
            }).join('');
        }

        function toggleAggregateApi(url) {
            const selected = getAggregateApiSelection();
            const index = selected.indexOf(url);
            if (index >= 0) {
                selected.splice(index, 1);
            } else {
                selected.push(url);
            }
            setAggregateApiSelection(selected);
        }

        function selectAllAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const urls = list.map(item => item.url).filter(Boolean);
            setAggregateApiSelection(urls);
            renderAggregateApiSelection(list);
        }

        function clearAggregateApis() {
            setAggregateApiSelection([]);
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            renderAggregateApiSelection(list);
        }

        function resetAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const defaults = list.slice(0, 3).map(item => item.url).filter(Boolean);
            setAggregateApiSelection(defaults);
            renderAggregateApiSelection(list);
        }

        // Host历史记录
        function getHostHistory() {
            return JSON.parse(localStorage.getItem('hostHistory') || '[]');
        }

        function saveHostHistory(value) {
            const history = getHostHistory();
            const existingIndex = history.findIndex(item => item === value);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(value);
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('hostHistory', JSON.stringify(history));
        }

        function renderHostHistory() {
            const history = getHostHistory();
            if (history.length === 0) {
                hostHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">暂无历史记录</div>
                `;
                return;
            }
            hostHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="text-xs text-gray-700 truncate mr-2">${item}</div>
                    <div class="flex items-center space-x-2">
                        <button 
                            onclick="selectHost('${item}', '')"
                            class="text-xs text-primary hover:underline"
                        >使用</button>
                        <button 
                            onclick="removeHostHistory('${item}')"
                            class="text-xs text-gray-500 hover:text-red-500"
                        >删除</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleHostHistory() {
            hostHistoryWrap.classList.toggle('hidden');
            if (!hostHistoryWrap.classList.contains('hidden')) {
                renderHostHistory();
            }
        }

        function selectHost(value, name = '') {
            hostInput.value = value;
            host = value;
            localStorage.setItem('apiHost', host);
            hostName = name || getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            saveHostHistory(host);
            showToast('已切换Host');
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }

        function getHostNameFromUrl(url) {
            try {
                const hostname = new URL(url).hostname;
                return hostname.replace(/^www\./, '');
            } catch (e) {
                return '';
            }
        }

        function getHostLabel() {
            if (hostName) return hostName;
            const name = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            return name || '未知来源';
        }

        function getOfficialNameByUrl(url) {
            if (!url) return '';
            const list = officialApiCache && Array.isArray(officialApiCache.data)
                ? officialApiCache.data
                : (() => {
                    try {
                        const raw = localStorage.getItem('officialApiList');
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                })();
            const match = (list || []).find(item => item && item.url === url);
            return match && match.name ? match.name : '';
        }

        function removeHostHistory(value) {
            const history = getHostHistory().filter(item => item !== value);
            localStorage.setItem('hostHistory', JSON.stringify(history));
            renderHostHistory();
        }
        

        
        // 分享视频
        function shareVideo(videoUrl, videoTitle) {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            
            if (navigator.share) {
                // 使用Web Share API
                navigator.share({
                    title: videoTitle,
                    text: '分享一个精彩视频',
                    url: realVideoUrl
                }).catch(err => {
                    console.log('分享失败:', err);
                    fallbackShare(realVideoUrl);
                });
            } else {
                // 回退方案
                fallbackShare(realVideoUrl);
            }
        }

        // 播放器内分享当前视频
        function shareCurrentVideo() {
            if (!currentVideoUrl) {
                showToast('暂无可分享的视频');
                return;
            }
            shareVideo(currentVideoUrl, currentVideoTitle || '视频播放');
        }

        // 播放器内喜欢/取消喜欢
        function toggleCurrentVideoFavorite() {
            if (!currentVideoUrl) {
                showToast('暂无可操作的视频');
                return;
            }
            
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === currentVideoUrl);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                showToast('已取消喜欢');
                updatePlayerLikeButtons(false);
            } else {
                const source = currentVideoSource || getHostLabel();
                favorites.unshift({
                    title: currentVideoTitle || '视频播放',
                    url: currentVideoUrl,
                    pic: currentVideoPic || '',
                    source: source || '',
                    timestamp: Date.now()
                });
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                showToast('已加入喜欢');
                updatePlayerLikeButtons(true);
            }
            
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function updatePlayerLikeButtons(isLiked) {
            const desktopBtn = document.getElementById('likeVideoButton');
            const mobileBtn = document.getElementById('likeVideoButtonMobile');
            [desktopBtn, mobileBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.toggle('bg-red-600', isLiked);
                btn.classList.toggle('bg-gray-600', !isLiked);
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'}${btn.id === 'likeVideoButtonMobile' ? ' text-xl' : ''}`;
                }
            });
        }
        
        // 分享回退方案
        function fallbackShare(url) {
            try {
                // 尝试复制到剪贴板
                navigator.clipboard.writeText(url).then(() => {
                    showToast('视频链接已复制到剪贴板');
                }).catch(() => {
                    // 如果复制失败，显示提示
                    prompt('请复制视频链接:', url);
                });
            } catch (err) {
                prompt('请复制视频链接:', url);
            }
        }
        
        // 切换画中画模式
        function togglePictureInPicture() {
            if (!dplayer || !dplayer.video) return;
            
            if (document.pictureInPictureElement) {
                // 退出画中画模式
                document.exitPictureInPicture().then(() => {
                    showToast('已退出画中画模式');
                }).catch(err => {
                    console.error('退出画中画失败:', err);
                    showToast('退出画中画失败');
                });
            } else {
                // 进入画中画模式
                if (document.pictureInPictureEnabled) {
                    dplayer.video.requestPictureInPicture().then(() => {
                        showToast('已进入画中画模式');
                    }).catch(err => {
                        console.error('进入画中画失败:', err);
                        showToast('进入画中画失败');
                    });
                } else {
                    showToast('您的浏览器不支持画中画功能');
                }
            }
        }
        
        // 滚动处理
        function handleScroll() {
            // 显示/隐藏回到顶部按钮
            if (window.scrollY > 300) {
                floatingButtons.classList.remove('hidden');
            } else {
                floatingButtons.classList.add('hidden');
            }
            
            // 无限滚动加载更多
            if (window.innerHeight + window.scrollY >= document.body.scrollHeight - 200) {
                if (hasMore && !isLoading) {
                    loadMoreData();
                }
            }
        }
        
        // 回到顶部
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // 显示加载指示器
        function showLoading(text = '加载中...') {
            loadingText.textContent = text;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
        }
        
        // 隐藏加载指示器
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
        }
        
        // 显示空状态
        function showEmptyState() {
            videoList.innerHTML = '';
            emptyState.classList.remove('hidden');
            hideLoadMoreButton();
        }
        
        // 显示错误状态
        function showErrorState(message) {
            videoList.innerHTML = `
                <div class="col-span-full text-center py-16">
                    <i class="fa fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">加载失败</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button onclick="loadInitialData()" class="btn-primary">
                        <i class="fa fa-refresh mr-1"></i> 重试
                    </button>
                </div>
            `;
            hideLoadMoreButton();
        }
        
        // 显示加载更多按钮
        function showLoadMoreButton() {
            loadMoreButton.classList.remove('hidden');
        }
        
        // 隐藏加载更多按钮
        function hideLoadMoreButton() {
            loadMoreButton.classList.add('hidden');
        }
        
        // 关闭所有面板
        function closeAllPanels() {
            historyPanel.classList.add('translate-x-full');
            favoritePanel.classList.add('translate-x-full');
            hostModal.classList.add('translate-x-full');
            overlay.classList.add('hidden');
        }

        
        // 显示Toast提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // 格式化日期
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // 小于1小时
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return minutes <= 1 ? '刚刚' : `${minutes}分钟前`;
            }
            
            // 小于24小时
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}小时前`;
            }
            
            // 小于7天
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days}天前`;
            }
            
            // 其他情况显示具体日期
            return date.toLocaleDateString('zh-CN');
        }
        

    </script>
    <script>
      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
