<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/video/favicon.ico">
    <link rel="shortcut icon" href="/video/favicon.ico">
    <title>è§†é¢‘æœç´¢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <!-- hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {

            .glass-effect {
                @apply backdrop-blur-md bg-white/80 border border-white/20;
            }
            
            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
            }
            
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-accent {
                @apply bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .input-primary {
                @apply bg-white/80 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary;
            }
            
            .blurred-bg {
                @apply filter blur-md pointer-events-none;
            }
            
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .scroll-offset {
                scroll-margin-top: 140px;
            }

            .privacy-mask {
                @apply absolute inset-0 bg-black/80 opacity-0 transition-opacity duration-200;
            }
        }
    </style>

    <style>
        html {
            scrollbar-gutter: stable;
        }

        html.modal-open,
        body.modal-open {
            overflow: hidden;
        }

        body.modal-open {
            overscroll-behavior: none;
        }

        body.modal-open #appContent {
            pointer-events: none;
        }

        body.modal-open #videoPlayerModal {
            pointer-events: auto;
        }

        body.modal-open #shareModal,
        body.modal-open #shareModal * {
            pointer-events: auto;
        }

        body.modal-open #mathChallengeModal,
        body.modal-open #mathChallengeModal * {
            pointer-events: auto;
        }

        body.privacy-on .video-thumb img {
            filter: blur(12px);
            transform: scale(1.05);
            transition: filter 200ms ease, transform 200ms ease;
        }

        body.privacy-on .video-thumb:hover img {
            filter: blur(0);
            transform: scale(1);
        }

        body.privacy-on .video-thumb .privacy-mask {
            opacity: 1;
        }

        body.privacy-on .video-thumb:hover .privacy-mask {
            opacity: 0;
        }

        .dplayer-notice,
        .dplayer-notice * {
            writing-mode: horizontal-tb;
            text-orientation: mixed;
            white-space: nowrap;
        }

    </style>

</head>
<body class="bg-gray-100 transition-colors duration-300">
    <div id="appContent">
    <!-- å¯¼èˆªå¤´ -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 glass-effect shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- å·¦ä¾§ï¼šåº”ç”¨æ ‡é¢˜ -->
                <div class="flex items-center space-x-2">
                    <i class="fa fa-play-circle text-primary text-2xl"></i>
                    <h1 id="siteTitle" class="text-xl font-bold text-primary cursor-pointer select-none">è§†é¢‘æœç´¢</h1>
                </div>
                
                <!-- ä¸­é—´ï¼šæœç´¢æ¡† -->
                <div class="hidden md:flex items-center bg-white rounded-lg shadow-md max-w-xl w-full mx-4 relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="æœç´¢è§†é¢‘..." 
                        class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button 
                        id="searchButton" 
                        onclick="searchData()"
                        class="btn-primary rounded-l-none"
                    >
                        <i class="fa fa-search mr-1"></i> <span id="searchButtonLabel">æœç´¢</span>
                    </button>
                    <div 
                        id="searchHistoryBox" 
                        class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    ></div>
                </div>
                
                <!-- å³ä¾§ï¼šæ›´å¤šä¸‹æ‹‰ -->
                <div class="flex items-center space-x-3 relative">
                    <button
                        id="userAvatarButton"
                        onclick="toggleUserInfo()"
                        class="w-9 h-9 rounded-full bg-white shadow-md border border-gray-200 flex items-center justify-center overflow-hidden hover:shadow-lg transition"
                        title="ç”¨æˆ·ä¿¡æ¯"
                    >
                        <img id="userAvatarImg" src="" alt="avatar" class="w-full h-full object-cover hidden">
                        <span id="userAvatarText" class="text-primary font-semibold text-sm">U</span>
                    </button>
                    <button
                        id="mobileSearchToggle"
                        onclick="toggleMobileSearch()"
                        class="md:hidden btn-primary text-sm"
                        title="æœç´¢"
                    >
                        <i class="fa fa-search"></i>
                    </button>
                    <button 
                        id="moreButton"
                        onclick="toggleMoreMenu()"
                        class="btn-secondary text-sm"
                        title="æ›´å¤š"
                    >
                        <i class="fa fa-ellipsis-h mr-1"></i> æ›´å¤š
                    </button>
                    <div 
                        id="moreMenu"
                        class="absolute right-0 top-full mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    >
                        <button 
                            onclick="handleMoreAction('favorite')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-heart text-red-500"></i>
                            <span class="text-right flex-1">å–œæ¬¢</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('share')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-share-alt text-blue-500"></i>
                            <span class="text-right flex-1">åˆ†äº«</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('history')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-history text-gray-600"></i>
                            <span class="text-right flex-1">å†å²</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('setting')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-cog text-gray-600"></i>
                            <span class="text-right flex-1">è®¾ç½®</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('about')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-info-circle text-gray-600"></i>
                            <span class="text-right flex-1">å…³äº</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æœç´¢æ¡† -->
            <div id="mobileSearchBox" class="md:hidden mt-3 flex items-center bg-white rounded-lg shadow-md relative hidden">
                <input 
                    type="text" 
                    id="searchInputMobile" 
                    placeholder="æœç´¢è§†é¢‘..." 
                    class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                    onkeypress="handleKeyPress(event)"
                >
                <button 
                    id="searchButtonMobile" 
                    onclick="searchData()"
                    class="btn-primary rounded-l-none"
                >
                    <i class="fa fa-search"></i> <span id="searchButtonLabelMobile">æœç´¢</span>
                </button>
                <div 
                    id="searchHistoryBoxMobile" 
                    class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                ></div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 pt-20 pb-20">
        <!-- è§†é¢‘åˆ—è¡¨ -->
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- è§†é¢‘å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div class="flex justify-center mt-8">
            <button 
                id="loadMoreButton" 
                onclick="loadMoreData()"
                class="btn-primary flex items-center space-x-2 hidden"
            >
                <span>åŠ è½½æ›´å¤š</span>
                <i class="fa fa-refresh"></i>
            </button>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
            <i class="fa fa-search text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">æš‚æ— æœç´¢ç»“æœ</h3>
            <p class="text-gray-600">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</p>
        </div>
    </main>

    <!-- æ’­æ”¾å†å²é¢æ¿ -->
    <div 
        id="historyPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">æ’­æ”¾å†å²</h3>
            <button onclick="toggleHistory()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="historyContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearHistory()" class="w-full btn-secondary">
                <i class="fa fa-trash mr-1"></i> æ¸…ç©ºå†å²
            </button>
        </div>
    </div>

    <!-- å–œæ¬¢é¢æ¿ -->
    <div 
        id="favoritePanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">æˆ‘çš„å–œæ¬¢</h3>
            <button onclick="toggleFavorites()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="favoriteContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- å–œæ¬¢å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
            <div class="p-4 border-t border-gray-200 space-y-2">
                <button id="uploadFavoritesButton" onclick="uploadLocalFavorites()" class="w-full btn-primary hidden">
                    <i class="fa fa-cloud-upload mr-1"></i> ä¸€é”®ä¸Šä¼ æœ¬åœ°å–œæ¬¢
                </button>
            </div>
    </div>

    <!-- åˆ†äº«åˆ—è¡¨é¢æ¿ -->
    <div 
        id="sharePanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">åˆ†äº«åˆ—è¡¨</h3>
            <button onclick="toggleSharePanel()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="shareContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- åˆ†äº«å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="p-4 border-t border-gray-200 text-xs text-gray-500">
            åˆ†äº«é“¾æ¥ä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå¯åœ¨æ­¤ä¿®æ”¹æœ‰æ•ˆæœŸæˆ–å–æ¶ˆåˆ†äº«ã€‚
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
    <div 
        id="userPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">ç”¨æˆ·ä¿¡æ¯</h3>
            <button onclick="toggleUserInfo()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="userInfoContent" class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-4">
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-3">
                <div class="flex items-center space-x-3">
                    <button id="userAvatarButton" onclick="handleAvatarTripleClick()" class="w-14 h-14 rounded-full overflow-hidden bg-gray-100 border border-gray-200 focus:outline-none" title="è¿ç»­ç‚¹å‡»3æ¬¡éšæœºå¤´åƒ">
                        <img id="userAvatarPreview" src="" alt="avatar" class="w-full h-full object-cover hidden">
                    </button>
                    <div class="flex-1">
                        <div class="text-xs text-gray-500 mb-1">æ˜µç§°</div>
                        <button id="userNicknameButton" onclick="showNicknameEditor()" class="text-left text-sm font-semibold text-gray-800 hover:text-primary">
                            åŠ è½½ä¸­...
                        </button>
                    </div>
                    <div class="text-xs text-gray-400">è¿ç‚¹å¤´åƒ3æ¬¡éšæœº</div>
                </div>
                <div id="userNicknameEditor" class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 hidden">
                    <input 
                        id="userNicknameInput" 
                        type="text" 
                        placeholder="è¾“å…¥æ˜µç§°" 
                        class="input-primary w-full sm:flex-1 text-sm"
                        maxlength="20"
                    >
                    <button 
                        id="userNicknameSave" 
                        onclick="saveUserNickname()" 
                        class="btn-primary text-xs px-3 py-2 w-full sm:w-auto"
                    >
                        ä¿å­˜
                    </button>
                    <button 
                        id="userNicknameRandom" 
                        onclick="setRandomNickname()" 
                        class="btn-secondary text-xs px-3 py-2 w-full sm:w-auto"
                    >
                        éšæœº
                    </button>
                    <button 
                        type="button"
                        onclick="hideNicknameEditor()"
                        class="btn-secondary text-xs px-3 py-2 w-full sm:w-auto"
                    >
                        å–æ¶ˆ
                    </button>
                </div>
                <div class="space-y-2">
                    <div class="text-xs text-gray-500">å¤‡æ³¨</div>
                    <button id="userNoteDisplay" onclick="showNoteEditor()" class="w-full text-left text-sm text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-md px-3 py-2 min-h-[36px]">
                        -
                    </button>
                    <textarea
                        id="userNoteInput"
                        rows="2"
                        placeholder="å¡«å†™å¤‡æ³¨..."
                        class="input-primary w-full text-sm hidden"
                        maxlength="200"
                    ></textarea>
                </div>
                <button onclick="logoutUser()" class="w-full btn-secondary text-xs" data-action="logout" disabled>
                    <i class="fa fa-sign-out mr-1"></i> <span>é€€å‡ºç™»å½•</span>
                </button>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æ”¶è—æ•°é‡</span>
                    <span id="userFavoriteCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">åˆ†äº«æ•°é‡</span>
                    <span id="userShareCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æ’­æ”¾å†å²</span>
                    <span id="userHistoryCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æœç´¢å†å²</span>
                    <span id="userSearchCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">ä»Šæ—¥è§‚çœ‹æ—¶é•¿</span>
                    <span id="userWatchToday" class="font-medium text-gray-800">00:00</span>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2 text-sm">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500">æœ€è¿‘è®¿é—®</span>
                        <select id="visitRangeSelect" class="border rounded px-2 py-0.5 text-[11px] text-gray-600">
                            <option value="1">è¿‘1å¤©</option>
                            <option value="3">è¿‘3å¤©</option>
                            <option value="7" selected>è¿‘7å¤©</option>
                        </select>
                    </div>
                    <div id="userLastVisit" class="text-right text-xs text-gray-700 space-y-2 max-h-[6.5rem] overflow-y-auto pr-1">-</div>
                </div>
                <div class="text-xs text-gray-500">ç”¨æˆ·ä¿¡æ¯ä»¥è´¦å·ä¸ºå‡†</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-3">
                <div class="text-sm font-medium">å¯¼å…¥å¯¼å‡º</div>
                <div class="flex space-x-3">
                    <button onclick="exportUserData()" class="btn-secondary flex-1 text-sm">
                        <i class="fa fa-download mr-1"></i> å¯¼å‡º
                    </button>
                    <label class="btn-primary flex-1 text-center cursor-pointer text-sm">
                        <i class="fa fa-upload mr-1"></i> å¯¼å…¥
                        <input id="importFileInput" type="file" accept="application/json" class="hidden" onchange="importUserData(event)">
                    </label>
                </div>
                <p class="text-xs text-gray-500">å¯¼å‡º/å¯¼å…¥ï¼šåŒ…å«å–œæ¬¢ã€æ’­æ”¾å†å²ã€æœç´¢å†å²ã€æ’­æ”¾è¿›åº¦ä¸æ˜µç§°</p>
                <div>
                    <label class="block text-sm font-medium mb-2">å¯¼å…¥å¯¼å‡ºå†å²è®°å½•</label>
                    <div id="transferHistoryList" class="space-y-2 max-h-40 overflow-y-auto pr-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³äºé¢æ¿ -->
    <div 
        id="aboutPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">å…³äºæœ¬ç½‘ç«™</h3>
            <button onclick="toggleAboutPanel()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-4 text-sm">
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">åŠŸèƒ½æ¦‚è§ˆ</div>
                <div class="text-gray-600">è¿™æ˜¯ä¸€ä¸ªè§†é¢‘æœç´¢ä¸æ’­æ”¾å·¥å…·ï¼Œæ”¯æŒå¤šæ¥å£ä¸èšåˆæœç´¢ã€æ’­æ”¾ç»­æ’­ã€å–œæ¬¢ä¸å†å²ã€åˆ†äº«ç®¡ç†ã€éšç§æ¨¡å¼ï¼Œä»¥åŠç¼©ç•¥å›¾é¢„è§ˆæ”¾å¤§ä¸å¿«é€Ÿæ’­æ”¾ã€‚</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">ä½¿ç”¨æ–¹æ³•</div>
                <div class="space-y-1 text-gray-600">
                    <div>1. åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ï¼Œæˆ–å¼€å¯èšåˆæœç´¢åŒæ—¶æŸ¥è¯¢å¤šä¸ªæ¥å£ã€‚</div>
                    <div>2. åœ¨â€œè®¾ç½®â€ä¸­é€‰æ‹©æˆ–å¡«å†™æ¥å£åœ°å€ï¼Œå¿…è¦æ—¶å®Œæˆè®¿é—®éªŒè¯ã€‚</div>
                    <div>3. ç‚¹å‡»å¡ç‰‡å¯æ’­æ”¾ï¼Œæ”¯æŒæ–­ç‚¹ç»­æ’­ä¸è§‚çœ‹è®°å½•ã€‚</div>
                    <div>4. åœ¨æ›´å¤šèœå•ä¸­æŸ¥çœ‹â€œå–œæ¬¢â€â€œå†å²â€â€œåˆ†äº«â€åˆ—è¡¨ã€‚</div>
                    <div>5. åˆ†äº«é“¾æ¥å¯è®¾ç½®æœ‰æ•ˆæœŸï¼Œå¹¶åœ¨åˆ†äº«åˆ—è¡¨ä¸­ç®¡ç†ã€‚</div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">å°è´´å£«</div>
                <div class="text-gray-600">éšç§æ¨¡å¼ä¼šå¯¹ç¼©ç•¥å›¾æ‰“ç ï¼›ç¼©ç•¥å›¾æ”¯æŒæ”¾å¤§é¢„è§ˆã€å·¦å³åˆ‡æ¢ä¸æ‰‹åŠ¿ç¼©æ”¾ï¼›é¢„è§ˆä¸­å¯ä¸€é”®æ’­æ”¾ã€‚</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">æ•°æ®è¯´æ˜</div>
                <div class="text-gray-600">æ”¶è—ã€å†å²ã€æœç´¢è®°å½•ç­‰ä¿¡æ¯ä¼˜å…ˆä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œç™»å½•åå¯åŒæ­¥åˆ°è´¦å·ã€‚</div>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯é®ç½© -->
    <div 
        id="overlay" 
        class="fixed inset-0 bg-black/50 z-30 hidden"
        onclick="closeAllPanels()"
    ></div>

    <!-- åˆ†äº«å¼¹çª— -->
    <div id="shareModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">åˆ†äº«è§†é¢‘</h3>
                <button onclick="closeShareModal()" class="p-2 hover:bg-gray-100 rounded-full">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="flex flex-col items-center">
                <div class="w-full mt-2">
                    <label class="block text-xs text-gray-500 mb-2">åˆ†äº«é“¾æ¥æœ‰æ•ˆæ—¶é—´</label>
                    <select id="shareExpireSelect" class="input-primary w-full text-sm">
                        <option value="1800">30åˆ†é’Ÿ</option>
                        <option value="7200">2å°æ—¶</option>
                        <option value="86400">1å¤©</option>
                        <option value="604800">7å¤©</option>
                        <option value="0">æ°¸ä¹…</option>
                    </select>
                </div>
                <div id="shareEpisodeSection" class="w-full mt-4 hidden">
                    <label class="block text-xs text-gray-500 mb-2">é€‰é›†åˆ†äº«</label>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="shareEpisodeMode" value="all" checked>
                            <span>å…¨éƒ¨</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="shareEpisodeMode" value="current">
                            <span>ä»…å½“å‰é›†</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="shareEpisodeMode" value="custom">
                            <span>è‡ªå®šä¹‰é€‰é›†</span>
                        </label>
                    </div>
                    <div id="shareEpisodeList" class="mt-2 hidden max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-2 grid grid-cols-3 gap-2"></div>
                    <div id="shareEpisodeActions" class="mt-2 hidden flex items-center justify-between text-xs text-gray-500">
                        <button type="button" data-action="select-all" class="text-blue-600 hover:underline">å…¨é€‰</button>
                        <button type="button" data-action="clear-all" class="text-gray-500 hover:underline">å…¨ä¸é€‰</button>
                    </div>
                </div>
                <button id="shareConfirmButton" onclick="confirmShareSelection()" class="btn-primary w-full mt-4">
                    <i class="fa fa-check mr-1"></i> ç¡®è®¤ç”Ÿæˆåˆ†äº«
                </button>
                <button onclick="copyShareUrl()" class="btn-secondary w-full mt-2">
                    <i class="fa fa-copy mr-1"></i> ç‚¹å‡»å¤åˆ¶åœ°å€
                </button>
            </div>
        </div>
    </div>

    <!-- æ¸…ç©ºå–œæ¬¢å¯†ç éªŒè¯ -->
    <div id="clearFavoritesModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">éªŒè¯å¯†ç </h3>
                <button onclick="closeClearFavoritesModal()" class="p-2 hover:bg-gray-100 rounded-full">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="space-y-2">
                <input
                    id="clearFavoritesPassword"
                    type="password"
                    placeholder="è¯·è¾“å…¥è´¦å·å¯†ç "
                    class="input-primary w-full"
                    autocomplete="current-password"
                >
                <div id="clearFavoritesError" class="text-xs text-red-500 hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
            </div>
            <button onclick="confirmClearFavorites()" class="btn-primary w-full mt-4">
                <i class="fa fa-check-square-o mr-1"></i> ç¡®è®¤æ¸…ç©º
            </button>
        </div>
    </div>

    <!-- è®¡ç®—éªŒè¯å¼¹çª— -->
    <div id="mathChallengeModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <div class="text-lg font-semibold text-gray-800 mb-2">æ“ä½œè¿‡å¿«ï¼Œè¯·å®Œæˆè®¡ç®—</div>
            <div id="mathChallengeQuestion" class="text-2xl font-bold text-center text-gray-900 my-4">0 + 0 = ?</div>
            <input
                id="mathChallengeInput"
                type="text"
                inputmode="numeric"
                placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                class="input-primary w-full text-center text-lg"
                autocomplete="off"
            >
            <div id="mathChallengeError" class="text-xs text-red-500 mt-2 hidden">ç­”æ¡ˆé”™è¯¯ï¼Œè¯·é‡è¯•</div>
            <button
                id="mathChallengeSubmit"
                class="btn-primary w-full mt-4"
            >
                æäº¤ç­”æ¡ˆ
            </button>
        </div>
    </div>

    <!-- æ‚¬æµ®æ§åˆ¶æŒ‰é’® -->
    <div 
        id="floatingButtons" 
        class="fixed bottom-6 right-6 glass-effect rounded-lg shadow-lg p-2 hidden"
    >
        <div class="flex flex-col space-y-2">
            <div class="text-xs text-gray-600 text-center px-2 py-1 bg-white/80 rounded-full">
                æ€»æ•° <span id="loadedTotalCount" class="font-semibold text-gray-800">0</span>
            </div>
            <button 
                onclick="playRandomVideo()" 
                class="p-3 rounded-full hover:bg-gray-200 transition-colors"
                title="éšæœºæ’­æ”¾"
            >
                <i class="fa fa-random"></i>
            </button>
            <button 
                onclick="scrollToTop()" 
                class="p-3 rounded-full hover:bg-gray-200 transition-colors"
                title="å›åˆ°é¡¶éƒ¨"
            >
                <i class="fa fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
    <div 
        id="videoPlayerModal" 
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
    >
        <div class="relative w-full max-w-4xl h-[70vh] bg-black rounded-lg overflow-hidden flex flex-col">
            <div 
                id="playerTitle"
                class="absolute top-4 left-4 z-10 px-3 py-1.5 bg-black/60 text-white text-sm rounded-full max-w-[70%] truncate"
            ></div>
            <!-- ç§»åŠ¨è®¾å¤‡ä¸“ç”¨å…³é—­æŒ‰é’® -->
            <button 
                id="closeVideoButtonMobile" 
                onclick="closeVideoPlayer()"
                class="md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
            >
                <i class="fa fa-times text-xl"></i>
            </button>
            <button 
                id="shareVideoButtonMobile" 
                onclick="shareCurrentVideo()"
                class="md:hidden fixed top-4 right-20 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="åˆ†äº«"
            >
                <i class="fa fa-share-alt text-xl"></i>
            </button>
            <button 
                id="likeVideoButtonMobile" 
                onclick="toggleCurrentVideoFavorite()"
                class="md:hidden fixed top-4 right-36 bg-gray-600 hover:bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="å–œæ¬¢"
            >
                <i class="fa fa-heart-o text-xl"></i>
            </button>
            
            <!-- æ¡Œé¢ç«¯å…³é—­æŒ‰é’® -->
            <button 
                id="closeVideoButton" 
                onclick="closeVideoPlayer()"
                class="hidden md:flex absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
            >
                <i class="fa fa-times"></i>
            </button>
            <button 
                id="shareVideoButton" 
                onclick="shareCurrentVideo()"
                class="hidden md:flex absolute top-4 right-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="åˆ†äº«"
            >
                <i class="fa fa-share-alt"></i>
            </button>
            <button 
                id="likeVideoButton" 
                onclick="toggleCurrentVideoFavorite()"
                class="hidden md:flex absolute top-4 right-28 bg-gray-600 hover:bg-red-600 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="å–œæ¬¢"
            >
                <i class="fa fa-heart-o"></i>
            </button>
            
            <div id="dplayer" class="w-full flex-1 min-h-0"></div>
            <div id="episodePanel" class="hidden bg-black/70 px-4 py-3 border-t border-white/10">
                <div class="text-xs text-white/70 mb-2">é€‰é›†æ’­æ”¾</div>
                <div id="episodeList" class="flex flex-wrap gap-2 max-h-28 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Hostè®¾ç½®é¢æ¿ -->
    <div 
        id="hostModal" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">è®¾ç½®API Host</h3>
            <button onclick="toggleHostModal()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">å½“å‰APIï¼ˆ<span id="hostNameDisplay" class="text-xs text-gray-500">æœªè®¾ç½®</span>ï¼‰</label>
                    <input 
                        type="text" 
                        id="hostInput" 
                        class="input-primary w-full"
                        placeholder="è¯·è¾“å…¥API Hoståœ°å€"
                    >
                    <div class="mt-2 flex items-center justify-between">
                        <label class="block text-sm font-medium">æ¥å£ç±»å‹</label>
                        <select id="customTypeSelect" class="border rounded px-2 py-1 text-sm">
                            <option value="normal">æ™®é€š</option>
                            <option value="adult">æ‘©è¥¿</option>
                        </select>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="saveHost()" class="btn-primary flex-1">
                        <i class="fa fa-save mr-1"></i> ä¿å­˜
                    </button>
                    <button onclick="resetHost()" class="btn-secondary flex-1">
                        <i class="fa fa-refresh mr-1"></i> é‡ç½®
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">èšåˆæœç´¢</label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="aggregateSwitch" 
                            class="sr-only"
                            onchange="toggleAggregateSearch()"
                        >
                        <div class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 -mt-2">å¼€å¯åä¼šæœç´¢å®˜æ–¹æ¨èçš„æ‰€æœ‰æ¥å£</p>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">èšåˆæ¥å£é€‰æ‹©ï¼ˆğŸŒˆå·²é€‰ <span id="aggregateSelectedCount">0</span>ï¼‰</label>
                    <button 
                        type="button"
                        onclick="toggleAggregateApiSection()"
                        id="aggregateApiToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        å±•å¼€/æ”¶èµ·
                    </button>
                </div>
                <div id="aggregateApiSection" class="hidden space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="selectAllAggregateApis()" class="btn-secondary text-xs flex-1">å…¨é€‰</button>
                        <button onclick="clearAggregateApis()" class="btn-secondary text-xs flex-1">å…¨ä¸é€‰</button>
                        <button onclick="resetAggregateApis()" class="btn-secondary text-xs flex-1">æ¢å¤é»˜è®¤</button>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-500">
                            å®˜æ–¹æ¨èï¼ˆæ€»æ•° <span id="officialApiCount">0</span>ï¼‰
                        </div>
                    </div>
                    <div class="flex items-center bg-gray-100 rounded-lg p-1 text-xs">
                        <button id="aggregateTabAdult" type="button" onclick="switchAggregateTab('adult')" class="flex-1 px-2 py-1 rounded-md bg-white shadow text-gray-800">æ‘©è¥¿ï¼ˆ<span id="officialApiCountAdult">0</span>ï¼‰</button>
                        <button id="aggregateTabNormal" type="button" onclick="switchAggregateTab('normal')" class="flex-1 px-2 py-1 rounded-md text-gray-600">æ™®é€šï¼ˆ<span id="officialApiCountNormal">0</span>ï¼‰</button>
                    </div>
                    <div id="aggregateApiListAdult" class="space-y-2"></div>
                    <div id="aggregateApiListNormal" class="space-y-2 hidden"></div>
                    <button onclick="confirmAggregateSelection()" class="btn-primary text-xs w-full">
                        ç¡®è®¤å¹¶å…³é—­
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">å®˜æ–¹æ¨èï¼ˆæ€»æ•° <span id="officialApiCount2">0</span>ï¼‰</label>
                    <button 
                        type="button"
                        onclick="toggleOfficialApiSection(); fetchOfficialApis(false)"
                        id="officialApiToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        å±•å¼€/æ”¶èµ·
                    </button>
                </div>
                <div id="officialApiSection" class="hidden space-y-2">
                    <div class="flex items-center bg-gray-100 rounded-lg p-1 text-xs">
                        <button id="officialTabAdult" type="button" onclick="switchOfficialTab('adult')" class="flex-1 px-2 py-1 rounded-md bg-white shadow text-gray-800">æ‘©è¥¿ï¼ˆ<span id="officialApiCountAdult2">0</span>ï¼‰</button>
                        <button id="officialTabNormal" type="button" onclick="switchOfficialTab('normal')" class="flex-1 px-2 py-1 rounded-md text-gray-600">æ™®é€šï¼ˆ<span id="officialApiCountNormal2">0</span>ï¼‰</button>
                    </div>
                    <div id="officialApiListAdult" class="space-y-2"></div>
                    <div id="officialApiListNormal" class="space-y-2 hidden"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">å†å²Host</label>
                    <button 
                        type="button"
                        onclick="toggleHostHistory()"
                        id="hostHistoryToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        åˆ‡æ¢æ˜¾ç¤º
                    </button>
                </div>
                <div id="hostHistoryWrap" class="hidden space-y-2">
                    <div id="hostHistoryList" class="space-y-2"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">éšç§é®æŒ¡</label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="privacySwitch" 
                            class="sr-only"
                            onchange="togglePrivacyMode()"
                        >
                        <div class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 -mt-2">å¼€å¯åè§†é¢‘ç¼©ç•¥å›¾é»˜è®¤é®æŒ¡ï¼Œæ‚¬åœæ˜¾ç¤º</p>
                <p class="text-xs text-gray-400 -mt-2">å¿«æ·æ“ä½œï¼šè¿ç»­ç‚¹å‡»â€œè§†é¢‘æœç´¢â€2æ¬¡å…³é—­éšç§ï¼Œ3æ¬¡å¼€å¯éšç§</p>
                
            </div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div 
        id="loadingIndicator" 
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30"
    >
        <div class="glass-effect rounded-lg p-6 flex flex-col items-center space-y-3">
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p id="loadingText" class="text-gray-700">åŠ è½½ä¸­...</p>
        </div>
    </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let searchTerm = '';
        let host = '';
        let hostName = '';
        let dplayer = null;
        let isLoading = false;
        let hasMore = true;
        let currentVideoUrl = '';
        let currentVideoTitle = '';
        let currentVideoPic = '';
        let currentVideoSource = '';
        let currentVideoRawUrl = '';
        let currentEpisodeList = [];
        let currentEpisodeIndex = 0;
        let lastVisitAtStart = null;
        let aggregateNoMore = new Set();
        let renderedVideos = [];
        const FALLBACK_IMAGE = './loading.gif';
        const RESUME_STORAGE_KEY = 'playbackResume';
        const RESUME_MAX_ITEMS = 200;
        const RESUME_MIN_SECONDS = 5;
        const RESUME_SAVE_THROTTLE_MS = 3000;
        let resumeLastSaveAt = 0;
        let resumeLastUrl = '';
        const WATCH_TIME_KEY = 'videoWatchTimeDaily';
        const WATCH_TIME_MAX_DAYS = 60;
        const OFFICIAL_API_TYPE_KEY = 'officialApiType';
        const CUSTOM_API_TYPE_KEY = 'customApiType';
        const OFFICIAL_API_LIST_KEY = 'officialApiList';
        const OFFICIAL_API_LIST_SIGNATURE_KEY = 'officialApiListSignature';
        let lastWatchTime = 0;
        let lastWatchUrl = '';
        const loadedTotalCount = document.getElementById('loadedTotalCount');
        
        // DOMå…ƒç´ 
        const videoList = document.getElementById('videoList');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const emptyState = document.getElementById('emptyState');
        const historyPanel = document.getElementById('historyPanel');
        const historyContent = document.getElementById('historyContent');
        const favoritePanel = document.getElementById('favoritePanel');
        const favoriteContent = document.getElementById('favoriteContent');
        const uploadFavoritesButton = document.getElementById('uploadFavoritesButton');
        const sharePanel = document.getElementById('sharePanel');
        const shareContent = document.getElementById('shareContent');
        const userPanel = document.getElementById('userPanel');
        const userInfoContent = document.getElementById('userInfoContent');
        const aboutPanel = document.getElementById('aboutPanel');
        const overlay = document.getElementById('overlay');
        const floatingButtons = document.getElementById('floatingButtons');
        const videoPlayerModal = document.getElementById('videoPlayerModal');
        const hostModal = document.getElementById('hostModal');
        const hostInput = document.getElementById('hostInput');
        const customTypeSelect = document.getElementById('customTypeSelect');
        const hostNameDisplay = document.getElementById('hostNameDisplay');
        const hostHistoryWrap = document.getElementById('hostHistoryWrap');
        const hostHistoryList = document.getElementById('hostHistoryList');
        const officialApiListAdult = document.getElementById('officialApiListAdult');
        const officialApiListNormal = document.getElementById('officialApiListNormal');
        const aggregateApiListAdult = document.getElementById('aggregateApiListAdult');
        const aggregateApiListNormal = document.getElementById('aggregateApiListNormal');
        const aggregateSwitch = document.getElementById('aggregateSwitch');
        const aggregateApiSection = document.getElementById('aggregateApiSection');
        const officialApiSection = document.getElementById('officialApiSection');
        const aggregateApiToggleButton = document.getElementById('aggregateApiToggleButton');
        const officialApiToggleButton = document.getElementById('officialApiToggleButton');
        const hostHistoryToggleButton = document.getElementById('hostHistoryToggleButton');
        const aggregateSelectedCount = document.getElementById('aggregateSelectedCount');
        const officialApiCount = document.getElementById('officialApiCount');
        const officialApiCountAdult = document.getElementById('officialApiCountAdult');
        const officialApiCountNormal = document.getElementById('officialApiCountNormal');
        const officialApiCountAdult2 = document.getElementById('officialApiCountAdult2');
        const officialApiCountNormal2 = document.getElementById('officialApiCountNormal2');
        const officialApiCount2 = document.getElementById('officialApiCount2');
        const privacySwitch = document.getElementById('privacySwitch');
        const searchInput = document.getElementById('searchInput');
        const searchInputMobile = document.getElementById('searchInputMobile');
        const searchHistoryBox = document.getElementById('searchHistoryBox');
        const searchHistoryBoxMobile = document.getElementById('searchHistoryBoxMobile');
        const searchButtonMobile = document.getElementById('searchButtonMobile');
        let suppressHistoryClick = false;
        const transferHistoryList = document.getElementById('transferHistoryList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const shareModal = document.getElementById('shareModal');
        const shareExpireSelect = document.getElementById('shareExpireSelect');
        const shareEpisodeSection = document.getElementById('shareEpisodeSection');
        const shareEpisodeList = document.getElementById('shareEpisodeList');
        const shareConfirmButton = document.getElementById('shareConfirmButton');
        let currentShareUrl = '';
        let currentSharePayload = null;
        let currentShareId = '';
        let pendingShareEpisodes = [];
        let pendingShareCurrentIndex = 0;
        let isShareEditing = false;
        let shareListLoaded = false;
        const userAvatarImg = document.getElementById('userAvatarImg');
        const userAvatarText = document.getElementById('userAvatarText');
        const userAvatarPreview = document.getElementById('userAvatarPreview');
        const clearFavoritesModal = document.getElementById('clearFavoritesModal');
        const clearFavoritesPassword = document.getElementById('clearFavoritesPassword');
        const clearFavoritesError = document.getElementById('clearFavoritesError');

        function getResumeStore() {
            try {
                return JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '{}');
            } catch (error) {
                console.error('è¯»å–æ’­æ”¾è¿›åº¦å¤±è´¥:', error);
                return {};
            }
        }

        function setResumeStore(store) {
            try {
                localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify(store));
            } catch (error) {
                console.error('ä¿å­˜æ’­æ”¾è¿›åº¦å¤±è´¥:', error);
            }
        }

        function getEntryTime(entry) {
            if (!entry) return 0;
            const time = Number(entry.time);
            return Number.isFinite(time) ? time : 0;
        }

        function loadResumeTime(url) {
            if (!url) return 0;
            const store = getResumeStore();
            const entry = store[url];
            return getEntryTime(entry);
        }

        function resolveResumeTime(rawUrl) {
            if (!rawUrl) return 0;
            const url = String(rawUrl).trim();
            const store = getResumeStore();
            const direct = store[url];
            const directTime = getEntryTime(direct);
            if (directTime) return directTime;

            const decoded = (() => {
                try { return decodeURIComponent(url); } catch (e) { return url; }
            })();
            const decodedEntry = store[decoded];
            const decodedTime = getEntryTime(decodedEntry);
            if (decodedTime) return decodedTime;

            const stripQueryHash = (value) => value.split('#')[0].split('?')[0];
            const stripped = stripQueryHash(url);
            const strippedEntry = store[stripped];
            const strippedTime = getEntryTime(strippedEntry);
            if (strippedTime) return strippedTime;

            const strippedDecoded = stripQueryHash(decoded);
            const strippedDecodedEntry = store[strippedDecoded];
            const strippedDecodedTime = getEntryTime(strippedDecodedEntry);
            if (strippedDecodedTime) return strippedDecodedTime;

            const keys = Object.keys(store);
            if (keys.length === 0) return 0;
            const match = keys
                .map((key) => {
                    const base = stripQueryHash(key);
                    if (base === strippedDecoded || strippedDecoded.startsWith(base) || base.startsWith(strippedDecoded)) {
                        return { key, entry: store[key] };
                    }
                    return null;
                })
                .filter(Boolean)
                .sort((a, b) => (b.entry.updatedAt || 0) - (a.entry.updatedAt || 0))[0];
            if (match && match.entry) {
                const matchTime = getEntryTime(match.entry);
                if (matchTime) return matchTime;
            }
            return 0;
        }

        function getResumeTimeForHistory(item) {
            if (!item || !item.url) return 0;
            const raw = String(item.url).trim();
            const fromRaw = resolveResumeTime(raw);
            if (fromRaw) return fromRaw;
            const decoded = (() => {
                try { return decodeURIComponent(raw); } catch (e) { return raw; }
            })();
            const fromDecoded = resolveResumeTime(decoded);
            if (fromDecoded) return fromDecoded;
            const splitUrl = raw.split('$')[1] || raw;
            const fromSplit = resolveResumeTime(splitUrl);
            if (fromSplit) return fromSplit;
            const decodedSplit = decoded.split('$')[1] || decoded;
            return resolveResumeTime(decodedSplit);
        }

        function saveResumeTime(url, time, duration) {
            if (!url || !Number.isFinite(time) || !Number.isFinite(duration) || duration <= 0) return;
            if (time < 1) return;
            const now = Date.now();
            if (resumeLastUrl === url && now - resumeLastSaveAt < RESUME_SAVE_THROTTLE_MS) return;
            resumeLastSaveAt = now;
            resumeLastUrl = url;
            const store = getResumeStore();
            store[url] = { time, duration, updatedAt: now };
            const keys = Object.keys(store);
            if (keys.length > RESUME_MAX_ITEMS) {
                keys
                    .sort((a, b) => (store[a].updatedAt || 0) - (store[b].updatedAt || 0))
                    .slice(0, keys.length - RESUME_MAX_ITEMS)
                    .forEach((key) => delete store[key]);
            }
            setResumeStore(store);

            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                const index = history.findIndex(item => item.url === url);
                if (index >= 0) {
                    history[index].lastPosition = time;
                    history[index].lastPositionUpdatedAt = now;
                    localStorage.setItem('videoPlayHistory', JSON.stringify(history));
                }
            } catch (e) {
                // ignore history update errors
            }
        }

        function saveResumeNow(url) {
            if (!url || !dplayer || !dplayer.video) return;
            const current = dplayer.video.currentTime || 0;
            const duration = dplayer.video.duration || 0;
            saveResumeTime(url, current, duration);
        }

        function clearResumeTime(url) {
            if (!url) return;
            const store = getResumeStore();
            if (!store[url]) return;
            delete store[url];
            setResumeStore(store);
        }

        function getTodayKey() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWatchTimeStore() {
            try {
                return JSON.parse(localStorage.getItem(WATCH_TIME_KEY) || '{}');
            } catch (error) {
                console.error('è¯»å–è§‚çœ‹æ—¶é•¿å¤±è´¥:', error);
                return {};
            }
        }

        function setWatchTimeStore(store) {
            try {
                localStorage.setItem(WATCH_TIME_KEY, JSON.stringify(store));
            } catch (error) {
                console.error('ä¿å­˜è§‚çœ‹æ—¶é•¿å¤±è´¥:', error);
            }
        }

        function addWatchTime(seconds) {
            if (!Number.isFinite(seconds) || seconds <= 0) return;
            const store = getWatchTimeStore();
            const todayKey = getTodayKey();
            store[todayKey] = (store[todayKey] || 0) + seconds;
            const keys = Object.keys(store);
            if (keys.length > WATCH_TIME_MAX_DAYS) {
                keys
                    .sort()
                    .slice(0, keys.length - WATCH_TIME_MAX_DAYS)
                    .forEach((key) => delete store[key]);
            }
            setWatchTimeStore(store);
            scheduleUserStatsUpdate(3000);
        }

        function getTodayWatchTime() {
            const store = getWatchTimeStore();
            return store[getTodayKey()] || 0;
        }

        let statsUpdateTimer = null;
        const scheduleUserStatsUpdate = (delay = 1000) => {
            if (statsUpdateTimer) clearTimeout(statsUpdateTimer);
            statsUpdateTimer = setTimeout(() => {
                updateUserStats();
            }, delay);
        };

        async function updateUserStats() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return;
            const localFavorites = JSON.parse(localStorage.getItem('videoFavorites') || '[]');
            const remoteFavorites = Array.isArray(favoritesCache) ? favoritesCache : [];
            const localMap = new Map((localFavorites || []).filter(item => item && item.url).map(item => [item.url, item]));
            const remoteMap = new Map((remoteFavorites || []).filter(item => item && item.url).map(item => [item.url, item]));
            const unionUrls = Array.from(new Set([...localMap.keys(), ...remoteMap.keys()]));
            const favorites = unionUrls
                .map(url => {
                    const remoteItem = remoteMap.get(url);
                    const localItem = localMap.get(url);
                    const base = remoteItem || localItem || { url };
                    const inLocal = !!localItem;
                    const inRemote = !!remoteItem;
                    return {
                        ...base,
                        _status: inLocal && inRemote ? 'both' : (inLocal ? 'local' : 'remote')
                    };
                })
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            const searchHistory = getSearchHistory();
            const watchSeconds = getTodayWatchTime();
            try {
                const res = await fetch('/user/stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({
                        favoriteCount: favorites.length,
                        shareCount: getShareList().length,
                        historyCount: history.length,
                        searchCount: searchHistory.length,
                        watchSeconds
                    })
                });
                if (res && res.ok) {
                    currentUserStats = {
                        favoriteCount: favorites.length,
                        shareCount: getShareList().length,
                        historyCount: history.length,
                        searchCount: searchHistory.length,
                        watchSeconds
                    };
                    const favoriteCountEl = document.getElementById('userFavoriteCount');
                    const historyCountEl = document.getElementById('userHistoryCount');
                    const searchCountEl = document.getElementById('userSearchCount');
                    const watchTodayEl = document.getElementById('userWatchToday');
                    if (favoriteCountEl) favoriteCountEl.textContent = String(favorites.length);
                    if (historyCountEl) historyCountEl.textContent = String(history.length);
                    if (searchCountEl) searchCountEl.textContent = String(searchHistory.length);
                    if (watchTodayEl) watchTodayEl.textContent = formatDuration(watchSeconds);
                }
            } catch (e) {
                // ignore
            }
        }

        function refreshLocalStatsDisplay() {
            const favoriteCountEl = document.getElementById('userFavoriteCount');
            const shareCountEl = document.getElementById('userShareCount');
            const historyCountEl = document.getElementById('userHistoryCount');
            const searchCountEl = document.getElementById('userSearchCount');
            const watchTodayEl = document.getElementById('userWatchToday');
            const favorites = getFavorites();
            const shares = getShareList();
            const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            const searchHistory = getSearchHistory();
            const watchSeconds = getTodayWatchTime();
            if (favoriteCountEl) favoriteCountEl.textContent = String(favorites.length);
            if (shareCountEl) shareCountEl.textContent = String(shares.length);
            if (historyCountEl) historyCountEl.textContent = String(history.length);
            if (searchCountEl) searchCountEl.textContent = String(searchHistory.length);
            if (watchTodayEl) watchTodayEl.textContent = formatDuration(watchSeconds);
        }

        async function syncRemoteListsAndStats() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) {
                refreshLocalStatsDisplay();
                return;
            }
            await Promise.all([
                loadFavorites(true),
                loadRemoteShares(),
            ]);
            refreshLocalStatsDisplay();
            updateUserStats();
        }

        let visitHistoryFetched = false;
        let visitHistoryFetchPromise = null;
        async function fetchVisitHistoryOnce() {
            if (visitHistoryFetched) return null;
            if (visitHistoryFetchPromise) return visitHistoryFetchPromise;
            const token = getUserToken ? getUserToken() : '';
            if (!token) return null;
            visitHistoryFetchPromise = (async () => {
                try {
                    const res = await fetch('/user/visit-history', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (data && data.code === 200 && Array.isArray(data.data)) {
                        localStorage.setItem('visitHistory', JSON.stringify(data.data));
                        visitHistoryFetched = true;
                        return data.data;
                    }
                } catch (e) {
                    // ignore
                } finally {
                    visitHistoryFetchPromise = null;
                }
                return null;
            })();
            return visitHistoryFetchPromise;
        }

        function normalizeVisitEntry(entry) {
            if (entry && typeof entry === 'object') {
                const time = Number(entry.time ?? entry.timestamp ?? entry.lastSeenAt ?? '');
                if (!Number.isFinite(time)) return null;
                return {
                    time,
                    ip: String(entry.ip || ''),
                    userAgent: String(entry.userAgent || entry.ua || '')
                };
            }
            const time = Number(entry);
            if (!Number.isFinite(time)) return null;
            return { time, ip: '', userAgent: '' };
        }

        function normalizeVisitHistory(list) {
            const raw = Array.isArray(list) ? list : [];
            return raw.map(normalizeVisitEntry).filter(Boolean);
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatIp(value) {
            const raw = String(value || '').trim();
            if (!raw) return 'æœªçŸ¥';
            if (raw.startsWith('::ffff:')) return raw.slice(7);
            return raw;
        }

        function detectClientLabel(ua) {
            const text = String(ua || '').toLowerCase();
            if (!text) return 'æœªçŸ¥';
            if (text.includes('windows')) return 'Windows';
            if (text.includes('mac os') || text.includes('macintosh')) return 'macOS';
            if (text.includes('android')) return 'Android';
            if (text.includes('iphone') || text.includes('ipad') || text.includes('ios')) return 'iOS';
            if (text.includes('linux')) return 'Linux';
            return 'å…¶ä»–';
        }

        function formatDateOnly(timestamp) {
            if (!timestamp || !Number.isFinite(Number(timestamp))) return '';
            return new Date(Number(timestamp)).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function getVisitRangeDays() {
            const saved = localStorage.getItem('visitRangeDays');
            const value = Number(saved || '7');
            return Number.isFinite(value) ? value : 7;
        }

        function setVisitRangeDays(value) {
            const days = Number(value);
            if (!Number.isFinite(days)) return;
            localStorage.setItem('visitRangeDays', String(days));
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½ä¿å­˜çš„Host
            host = localStorage.getItem('apiHost') || '';
            hostName = localStorage.getItem('apiHostName') || '';
            updateHostNameDisplay(host);
            updateCustomTypeSelect();
            applyAvatarFromStorage();
            if (customTypeSelect) {
                customTypeSelect.addEventListener('change', () => {
                    const value = customTypeSelect.value;
                    if (value === 'normal' || value === 'adult') {
                        localStorage.setItem(CUSTOM_API_TYPE_KEY, value);
                        updateHostNameDisplay(host);
                    }
                });
            }
            const aggregateEnabled = isAggregateSearchEnabled();
            if (aggregateSwitch) {
                aggregateSwitch.checked = aggregateEnabled;
                updateAggregateSwitchUI(aggregateEnabled);
            }
            const privacyEnabled = isPrivacyModeEnabled();
            if (privacySwitch) {
                privacySwitch.checked = privacyEnabled;
                updatePrivacySwitchUI(privacyEnabled);
            }
            applyPrivacyMode(privacyEnabled);
            updateSearchButtonLabel(aggregateEnabled);
            
            // é¼ æ ‡ç§»å‡ºé¢æ¿è‡ªåŠ¨å…³é—­
            historyPanel.addEventListener('mouseleave', closeAllPanels);
            favoritePanel.addEventListener('mouseleave', closeAllPanels);
            if (sharePanel) {
                sharePanel.addEventListener('mouseleave', closeAllPanels);
            }
            if (userPanel) {
                userPanel.addEventListener('mouseleave', closeAllPanels);
            }
            if (aboutPanel) {
                aboutPanel.addEventListener('mouseleave', closeAllPanels);
            }
            hostModal.addEventListener('mouseleave', () => {
                if (!hostModal.classList.contains('translate-x-full')) {
                    toggleHostModal();
                }
            });

            if (aggregateApiToggleButton) {
                aggregateApiToggleButton.textContent = aggregateApiSection && aggregateApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
            if (officialApiToggleButton) {
                officialApiToggleButton.textContent = officialApiSection && officialApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
            switchAggregateTab('adult');
            switchOfficialTab(getDefaultOfficialTab());
            if (hostHistoryToggleButton) {
                hostHistoryToggleButton.textContent = hostHistoryWrap && hostHistoryWrap.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }

            const previousVisit = localStorage.getItem('lastVisit');
            const nowTs = Date.now();
            const rangeDays = getVisitRangeDays();
            const cutoff = nowTs - rangeDays * 24 * 60 * 60 * 1000;
            const visitHistory = normalizeVisitHistory(JSON.parse(localStorage.getItem('visitHistory') || '[]'))
                .filter((item) => item.time >= cutoff);
            if (previousVisit) {
                const time = Number(previousVisit);
                if (Number.isFinite(time)) {
                    visitHistory.unshift({ time, ip: '', userAgent: '' });
                }
            }
            const uniqueHistory = [];
            const seen = new Set();
            for (const item of visitHistory) {
                const key = String(item.time);
                if (seen.has(key)) continue;
                seen.add(key);
                uniqueHistory.push(item);
            }
            const trimmedHistory = uniqueHistory.slice(0, 200);
            localStorage.setItem('visitHistory', JSON.stringify(trimmedHistory));
            lastVisitAtStart = trimmedHistory[0] ? String(trimmedHistory[0].time) : null;
            localStorage.setItem('lastVisit', nowTs);

            renderTransferHistory();

            syncRemoteListsAndStats();
            
            // åŠ è½½åˆå§‹æ•°æ®
            loadInitialData();
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', handleScroll);

            // æœç´¢å†å²æç¤º
            bindSearchHistoryEvents();

            // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ›´å¤šèœå•
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('moreMenu');
                const button = document.getElementById('moreButton');
                if (!menu || !button) return;
                if (menu.contains(e.target) || button.contains(e.target)) return;
                menu.classList.add('hidden');
            });

            // ç§»åŠ¨ç«¯æœç´¢æ¡†æ‰“å¼€æ—¶ç‚¹å‡»å…¶ä»–ä½ç½®è‡ªåŠ¨å…³é—­
            document.addEventListener('click', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            });

            // ç§»åŠ¨ç«¯æœç´¢æ¡†æ‰“å¼€æ—¶ï¼Œæ»‘åŠ¨/è§¦æ‘¸å…¶ä»–ä½ç½®ä¹Ÿå…³é—­
            document.addEventListener('touchstart', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            }, { passive: true });

            // ç‚¹å‡»å¯¼èˆªæ ä»»æ„ä½ç½®å…³é—­é¢æ¿
            const header = document.getElementById('header');
            if (header) {
                header.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target && target.closest('button, input, select, textarea, a, label, #moreMenu')) {
                        return;
                    }
                    closeAllPanels();
                });
            }

            if (shareModal) {
                shareModal.addEventListener('click', (e) => {
                    if (e.target === shareModal) {
                        closeShareModal();
                    }
                });
            }
            if (shareExpireSelect) {
                shareExpireSelect.addEventListener('change', () => {
                    refreshShareUrlFromSelection();
                });
            }
            document.addEventListener('change', (e) => {
                const target = e.target;
                if (!(target instanceof HTMLInputElement)) return;
                if (target.name === 'shareEpisodeMode') {
                    toggleShareEpisodeList(target.value === 'custom');
                    if (target.value === 'custom') {
                        setShareEpisodeChecks(false);
                    }
                    setShareConfirmState('ready');
                    currentShareUrl = '';
                    return;
                }
                if (target.closest('#shareEpisodeList')) {
                    setShareConfirmState('ready');
                    currentShareUrl = '';
                }
            });
            if (shareEpisodeSection) {
                shareEpisodeSection.addEventListener('click', (e) => {
                    const target = e.target;
                    if (!(target instanceof HTMLElement)) return;
                    const action = target.getAttribute('data-action');
                    if (!action) return;
                    if (action === 'select-all') setShareEpisodeChecks(true);
                    if (action === 'clear-all') setShareEpisodeChecks(false);
                });
            }

            const siteTitle = document.getElementById('siteTitle');
            if (siteTitle) {
                let clickCount = 0;
                let clickTimer = null;
                const CLICK_WINDOW_MS = 600;

                siteTitle.addEventListener('click', () => {
                    clickCount += 1;
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        if (clickCount === 2) {
                            if (privacySwitch) {
                                privacySwitch.checked = false;
                                togglePrivacyMode();
                            } else {
                                localStorage.setItem('privacyMode', '0');
                                applyPrivacyMode(false);
                            }
                        } else if (clickCount >= 3) {
                            if (privacySwitch) {
                                privacySwitch.checked = true;
                                togglePrivacyMode();
                            } else {
                                localStorage.setItem('privacyMode', '1');
                                applyPrivacyMode(true);
                            }
                        }
                        clickCount = 0;
                        clickTimer = null;
                    }, CLICK_WINDOW_MS);
                });
            }

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState !== 'visible') {
                    saveResumeNow(currentVideoUrl);
                }
            }, { passive: true });

            window.addEventListener('pagehide', () => {
                saveResumeNow(currentVideoUrl);
            }, { passive: true });
        });

        const USER_TOKEN_KEY = 'userToken';
        const USER_TOKEN_EXPIRES_KEY = 'userTokenExpires';
        const USER_TOKEN_TTL_MS = 7 * 24 * 60 * 60 * 1000;
        const USER_AVATAR_KEY = 'userAvatarUrl';
        const USER_AVATAR_API = 'https://v2.xxapi.cn/api/head';

        function getUserToken() {
            const token = String(localStorage.getItem(USER_TOKEN_KEY) || '').trim();
            if (!token) return '';
            const expiresAt = Number(localStorage.getItem(USER_TOKEN_EXPIRES_KEY) || '0');
            if (!expiresAt) {
                localStorage.setItem(USER_TOKEN_EXPIRES_KEY, String(Date.now() + USER_TOKEN_TTL_MS));
                return token;
            }
            if (Date.now() > expiresAt) {
                clearUserToken();
                return '';
            }
            return token;
        }

        function setUserToken(token) {
            localStorage.setItem(USER_TOKEN_KEY, String(token || ''));
            localStorage.setItem(USER_TOKEN_EXPIRES_KEY, String(Date.now() + USER_TOKEN_TTL_MS));
        }

        function clearUserToken() {
            localStorage.removeItem(USER_TOKEN_KEY);
            localStorage.removeItem(USER_TOKEN_EXPIRES_KEY);
        }

        function revokeAccess() {
            window.location.href = '/login/index.html';
        }

        function applyAvatar(url) {
            const safe = String(url || '').trim();
            if (safe) {
                if (userAvatarImg) {
                    userAvatarImg.src = safe;
                    userAvatarImg.classList.remove('hidden');
                }
                if (userAvatarPreview) {
                    userAvatarPreview.src = safe;
                    userAvatarPreview.classList.remove('hidden');
                }
                if (userAvatarText) {
                    userAvatarText.classList.add('hidden');
                }
            } else {
                if (userAvatarImg) userAvatarImg.classList.add('hidden');
                if (userAvatarPreview) userAvatarPreview.classList.add('hidden');
                if (userAvatarText) userAvatarText.classList.remove('hidden');
            }
        }

        function applyAvatarFromStorage() {
            const url = localStorage.getItem(USER_AVATAR_KEY) || '';
            applyAvatar(url);
        }

        async function randomizeAvatar() {
            try {
                const res = await fetch(USER_AVATAR_API);
                const data = await res.json();
                if (data && data.code === 200 && data.data) {
                    const url = String(data.data).trim();
                    localStorage.setItem(USER_AVATAR_KEY, url);
                    applyAvatar(url);
                    const token = getUserToken ? getUserToken() : '';
                    if (token) {
                        fetch('/user/avatar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                            body: JSON.stringify({ avatar: url })
                        }).catch(() => {});
                    }
                    showToast('å¤´åƒå·²æ›´æ–°');
                } else {
                    showToast('è·å–å¤´åƒå¤±è´¥');
                }
            } catch (e) {
                showToast('è·å–å¤´åƒå¤±è´¥');
            }
        }

        let avatarClickCount = 0;
        let avatarClickTimer = null;
        function handleAvatarTripleClick() {
            avatarClickCount += 1;
            if (avatarClickCount === 1) {
                showToast('è¿ç»­ç‚¹å‡»å¤´åƒ3æ¬¡å¯éšæœºå¤´åƒ');
            }
            if (avatarClickTimer) {
                clearTimeout(avatarClickTimer);
            }
            avatarClickTimer = setTimeout(() => {
                avatarClickCount = 0;
                avatarClickTimer = null;
            }, 700);
            if (avatarClickCount >= 3) {
                avatarClickCount = 0;
                if (avatarClickTimer) {
                    clearTimeout(avatarClickTimer);
                    avatarClickTimer = null;
                }
                randomizeAvatar();
            }
        }

        function getOfficialApiUrl() {
            return '/apis/official';
        }
        
        // åŠ è½½åˆå§‹æ•°æ®
        function loadInitialData() {
            if (!host && !isAggregateSearchEnabled()) {
                // å¦‚æœæ²¡æœ‰è®¾ç½®Hostï¼Œæ˜¾ç¤ºè®¾ç½®æç¤º
                showHostModal();
                return;
            }
            
            hideEmptyState();
            showLoading('æ­£åœ¨åŠ è½½æ¨èè§†é¢‘...');
            hasMore = true;
            fetchData('', 1).finally(() => {
                hideLoading();
            });
        }
        
        // è·å–ä»£ç†URL
        function getProxyUrl(endpoint, params = {}) {
            const baseUrl = window.location.origin + '/proxy';
            const url = new URL(endpoint, baseUrl);
            
            // æ·»åŠ æŸ¥è¯¢å‚æ•°
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null) {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            return url.toString();
        }
        
        // è·å–æ•°æ®
        async function fetchData(keyword, page) {
            if (isAggregateSearchEnabled()) {
                return fetchAggregatedData(keyword, page);
            }
            try {
                const token = getUserToken ? getUserToken() : '';
                if (!token) {
                    showToast('è¯·å…ˆç™»å½•');
                    return [];
                }
                await ensureFavoritesLoaded();
                const params = {
                    wd: keyword,
                    pg: page,
                    url: host
                };
                
                const response = await fetch(getProxyUrl('', params), {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const rawText = await response.text();
                if (rawText && rawText.includes("æœç´¢å…³é—­")) {
                    if (page === 1) {
                        showErrorState("å½“å‰æ¥å£æ— æ³•æœç´¢", { showRetry: false });
                    } else {
                        showToast("å½“å‰æ¥å£æ— æ³•æœç´¢");
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                let data = {};
                try {
                    data = rawText ? JSON.parse(rawText) : {};
                } catch (e) {
                    data = {};
                }
                
                if (!data.list || data.list.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                const isNormalHost = normalizeCategory(getCurrentHostCategory()) === 'normal';
                // æ™®é€šæ¥å£ä¸å»é‡
                const deduped = isNormalHost ? data.list : (() => {
                    const seenTitles = new Set();
                    const filtered = [];
                    data.list.forEach(video => {
                        const title = (video.vod_name || '').trim();
                        if (!title) {
                            filtered.push(video);
                            return;
                        }
                        if (seenTitles.has(title)) return;
                        seenTitles.add(title);
                        filtered.push(video);
                    });
                    return filtered;
                })();
                const hostCategory = getCurrentHostCategory();
                const tagged = deduped.map(video => ({
                    ...video,
                    _sourceCategory: hostCategory
                }));
                
                // æ¸²æŸ“æ•°æ®
                if (page === 1) {
                    videoList.innerHTML = '';
                    renderedVideos = [];
                    updateLoadedCount(0);
                }
                
                hideEmptyState();
                renderVideos(tagged);
                updateLoadedCount(renderedVideos.length);
                
                // æ›´æ–°åˆ†é¡µçŠ¶æ€
                currentPage = page;
                searchTerm = keyword;
                
                // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
                if (data.list.length < 20) {
                    hideLoadMoreButton();
                    hasMore = false;
                } else {
                    showLoadMoreButton();
                    hasMore = true;
                }
                
                return tagged;
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                if (page === 1) {
                    showErrorState('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Hostè®¾ç½®');
                }
                return [];
            }
        }

        async function fetchAggregatedData(keyword, page) {
            try {
                if (page === 1) {
                    aggregateNoMore = new Set();
                }
                await ensureFavoritesLoaded();
                const apis = await getOfficialApis();
                const selectedUrls = resolveAggregateSelection(apis);
                const targetApis = selectedUrls.length > 0
                    ? apis.filter(item => selectedUrls.includes(item.url))
                    : apis;
                const activeApis = targetApis.filter(item => !aggregateNoMore.has(item.url));
                if (!activeApis || activeApis.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                let completed = 0;
                updateAggregateLoading(completed, activeApis.length);
                const results = await Promise.all(
                    activeApis.map(item => {
                        const params = {
                            wd: keyword,
                            pg: page,
                            url: item.url
                        };
                        const token = getUserToken ? getUserToken() : '';
                        return fetch(getProxyUrl('', params), {
                            headers: token ? { Authorization: `Bearer ${token}` } : {}
                        })
                            .then(res => res.json())
                            .then(data => ({
                                item,
                                list: Array.isArray(data.list) ? data.list : []
                            }))
                            .catch(() => ({ item, list: [] }))
                            .finally(() => {
                                completed += 1;
                                updateAggregateLoading(completed, activeApis.length);
                            });
                    })
                );
                
                const merged = [];
                results.forEach(({ item, list }) => {
                    if (!list || list.length === 0) {
                        aggregateNoMore.add(item.url);
                    }
                    const label = getOfficialLabel(item);
                    const normalizedCategory = normalizeCategory(item.category || getOfficialCategoryByUrl(item.url) || '');
                    list.forEach(video => {
                        merged.push({
                            ...video,
                            _sourceLabel: label,
                            _sourceCategory: normalizedCategory
                        });
                    });
                });

                // æ™®é€šæ¥å£ä¸å»é‡
                const seenTitles = new Set();
                const deduped = [];
                merged.forEach(video => {
                    const category = normalizeCategory(video._sourceCategory || '');
                    if (category === 'normal') {
                        deduped.push(video);
                        return;
                    }
                    const title = (video.vod_name || '').trim();
                    if (!title) {
                        deduped.push(video);
                        return;
                    }
                    if (seenTitles.has(title)) return;
                    seenTitles.add(title);
                    deduped.push(video);
                });
                
                if (page === 1) {
                    videoList.innerHTML = '';
                    renderedVideos = [];
                    updateLoadedCount(0);
                }
                
                hideEmptyState();
                if (deduped.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                renderVideos(deduped);
                updateLoadedCount(renderedVideos.length);
                
                currentPage = page;
                searchTerm = keyword;
                
                const anyHasMore = results.some(r => r.list && r.list.length >= 20);
                if (anyHasMore) {
                    showLoadMoreButton();
                    hasMore = true;
                } else {
                    hideLoadMoreButton();
                    hasMore = false;
                }
                
                return deduped;
            } catch (error) {
                console.error('èšåˆæœç´¢å¤±è´¥:', error);
                if (page === 1) {
                    showErrorState('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Hostè®¾ç½®');
                }
                return [];
            }
        }

        function updateAggregateLoading(done, total) {
            if (!isAggregateSearchEnabled()) return;
            const text = `èšåˆæœç´¢åŠ è½½ä¸­... (${done}/${total})`;
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        async function ensureFavoritesLoaded() {
            if (Array.isArray(favoritesCache)) return;
            await loadFavorites(true);
        }
        
        // æ¸²æŸ“è§†é¢‘å¡ç‰‡
        function updateVideoGridLayout(category) {
            if (!videoList) return;
            const isNormal = category === 'normal';
            const gridClasses = [
                'grid',
                'grid-cols-1',
                'sm:grid-cols-2',
                'md:grid-cols-3',
                'lg:grid-cols-4',
                'xl:grid-cols-5'
            ];
            const normalGridClasses = [
                'grid',
                'grid-cols-2',
                'sm:grid-cols-3',
                'md:grid-cols-4',
                'lg:grid-cols-5',
                'xl:grid-cols-6'
            ];
            gridClasses.concat(normalGridClasses).forEach((cls) => videoList.classList.remove(cls));
            (isNormal ? normalGridClasses : gridClasses).forEach((cls) => videoList.classList.add(cls));
        }

        function renderVideos(videos) {
            const resolveVideoCategory = (video) => {
                if (video && video._sourceCategory) return normalizeCategory(video._sourceCategory);
                return normalizeCategory(getCurrentHostCategory());
            };
            const categories = new Set((videos || []).map(resolveVideoCategory));
            const layoutCategory = categories.size === 1 ? Array.from(categories)[0] : 'adult';
            updateVideoGridLayout(layoutCategory);

            videos.forEach(video => {
                const favorited = isFavorited(video.vod_play_url);
                const sourceLabel = video._sourceLabel || getHostLabel();
                const category = resolveVideoCategory(video);
                const isNormal = category === 'normal';
                if (video.vod_play_url) {
                    renderedVideos.push({
                        url: video.vod_play_url,
                        title: video.vod_name || 'æœªå‘½å',
                        pic: video.vod_pic || '',
                        source: sourceLabel
                    });
                }
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg overflow-hidden shadow-md card-hover scroll-offset video-card ${isNormal ? 'video-card--normal max-w-[220px] w-full mx-auto' : 'video-card--adult'}`;
                card.setAttribute('data-video-url', video.vod_play_url || '');
                const thumbClass = isNormal
                    ? 'video-thumb relative aspect-[474/670] overflow-hidden cursor-pointer'
                    : 'video-thumb relative aspect-video overflow-hidden cursor-pointer';
                const titleClass = isNormal
                    ? 'font-semibold mb-2 line-clamp-1 text-sm'
                    : 'font-semibold mb-2 line-clamp-1';
                const actionClass = isNormal ? 'text-xs' : 'text-sm';
                const yearBadge = isNormal && video.vod_year
                    ? `<span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">${video.vod_year}</span>`
                    : '';
                const classText = isNormal && video.vod_class
                    ? String(video.vod_class).split(',').map(s => s.trim()).filter(Boolean).slice(0, 3).join(' / ')
                    : '';
                const actorText = isNormal && video.vod_actor
                    ? String(video.vod_actor).split(',').map(s => s.trim()).filter(Boolean).slice(0, 2).join(' / ')
                    : 'æœªçŸ¥';
                const cleanText = (value) => {
                    const raw = String(value || '');
                    if (!raw) return '';
                    return raw
                        .replace(/<[^>]+>/g, ' ')
                        .replace(/&nbsp;/gi, ' ')
                        .replace(/&amp;/gi, '&')
                        .replace(/&lt;/gi, '<')
                        .replace(/&gt;/gi, '>')
                        .replace(/&quot;/gi, '"')
                        .replace(/&#39;/gi, "'")
                        .replace(/\s+/g, ' ')
                        .trim();
                };
                const contentText = isNormal ? cleanText(video.vod_content) : '';
                const buttonClass = isNormal ? 'btn-primary text-xs' : 'btn-primary text-sm';
                card.innerHTML = `
                    <div class="${thumbClass}" data-preview-group="video" data-preview-url="${video.vod_pic || FALLBACK_IMAGE}" data-preview-title="${video.vod_name || ''}" data-preview-video-url="${video.vod_play_url || ''}" data-preview-source="${sourceLabel || ''}" data-preview-category="${category}" onclick="openPreviewFromGroup(this)">
                        <img 
                            src="${FALLBACK_IMAGE}" 
                            data-src="${video.vod_pic}" 
                            alt="${video.vod_name}" 
                            onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';"
                            loading="lazy"
                            class="w-full h-full object-cover lazy-image"
                        >
                        ${isNormal && video.vod_remarks ? `<div class="absolute top-2 left-2 bg-black/70 text-white text-[11px] px-2 py-1 rounded-full max-w-[85%] truncate">${video.vod_remarks}</div>` : ''}
                        <div class="privacy-mask"></div>
                        <div class="count-badge hidden absolute top-2 right-2 bg-black/70 text-white text-[11px] px-2 py-1 rounded-full"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end">
                            <div class="p-3 w-full">
                                <h3 class="text-white font-medium line-clamp-2">${video.vod_name}</h3>
                                ${isNormal && contentText ? `<p class="text-white/80 text-[11px] mt-1 line-clamp-3">${contentText}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        ${isNormal ? `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${sourceLabel}</span>
                                ${yearBadge}
                            </div>
                        ` : ''}
                        <h3 class="${titleClass}">
                            ${!isNormal ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded mr-2">${sourceLabel}</span>` : ''}
                            ${video.vod_name}
                        </h3>
                        ${isNormal && (classText || actorText) ? `
                            <div class="text-[11px] text-gray-500 space-y-0.5 mb-2">
                                ${classText ? `<div>ç±»å‹ï¼š${classText}</div>` : ''}
                                ${actorText ? `<div class="line-clamp-1">æ¼”å‘˜ï¼š${actorText}</div>` : ''}
                            </div>
                        ` : ''}
                        <div class="flex justify-between items-center">
                            <button 
                                onclick="openVideoPlayer('${video.vod_play_url}', '${video.vod_name}', '${video.vod_pic}', '${sourceLabel}', '${category}')"
                                class="${buttonClass}"
                            >
                                <i class="fa fa-play mr-1"></i> æ’­æ”¾
                            </button>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="toggleFavorite('${video.vod_name}', '${video.vod_play_url}', '${video.vod_pic}', this, '${sourceLabel}')"
                                    data-action="favorite"
                                    class="${actionClass} ${favorited ? 'text-red-500' : 'text-gray-500'} hover:text-red-500"
                                    title="å–œæ¬¢"
                                >
                                    <i class="fa ${favorited ? 'fa-heart' : 'fa-heart-o'} ${isNormal ? '' : 'mr-1'}"></i><span class="${isNormal ? 'hidden sm:inline' : ''} ${isNormal ? 'sm:ml-1' : ''}">å–œæ¬¢</span>
                                </button>
                                <button 
                                    onclick="shareVideo('${video.vod_play_url}', '${video.vod_name}', '${video.vod_pic}', '${sourceLabel}', 0)"
                                    class="${actionClass} text-gray-500 hover:text-blue-500"
                                    title="åˆ†äº«è§†é¢‘"
                                >
                                    <i class="fa fa-share-alt ${isNormal ? '' : 'mr-1'}"></i><span class="${isNormal ? 'hidden sm:inline' : ''} ${isNormal ? 'sm:ml-1' : ''}">åˆ†äº«</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const index = renderedVideos.length;
                card.dataset.index = String(index);
                const thumb = card.querySelector('.video-thumb');
                if (thumb) {
                    thumb.addEventListener('mouseenter', () => {
                        showCardCount(thumb, index);
                    });
                    thumb.addEventListener('mouseleave', () => {
                        hideCardCount(thumb);
                    });
                }
                videoList.appendChild(card);
            });
            
            // åˆå§‹åŒ–æ‡’åŠ è½½
            initLazyLoading();
        }

        function updateLoadedCount(totalCount) {
            let changed = false;
            if (loadedTotalCount && totalCount !== null && totalCount !== undefined) {
                loadedTotalCount.textContent = String(totalCount);
                changed = true;
            }
            if (!changed) return;
            const targets = [loadedTotalCount].filter(Boolean);
            targets.forEach((el) => el.classList.add('animate-pulse'));
            setTimeout(() => {
                targets.forEach((el) => el.classList.remove('animate-pulse'));
            }, 500);
        }

        function showCardCount(thumbEl, index) {
            if (!thumbEl) return;
            const badge = thumbEl.querySelector('.count-badge');
            if (!badge) return;
            const total = renderedVideos.length;
            badge.textContent = `${index}/${total}`;
            badge.classList.remove('hidden');
        }

        function hideCardCount(thumbEl) {
            if (!thumbEl) return;
            const badge = thumbEl.querySelector('.count-badge');
            if (!badge) return;
            badge.classList.add('hidden');
        }

        function playRandomVideo() {
            if (!renderedVideos || renderedVideos.length === 0) {
                showToast('æš‚æ— å¯æ’­æ”¾è§†é¢‘');
                return;
            }
            const index = Math.floor(Math.random() * renderedVideos.length);
            const target = renderedVideos[index];
            if (!target || !target.url) {
                showToast('æš‚æ— å¯æ’­æ”¾è§†é¢‘');
                return;
            }
            openVideoPlayer(target.url, target.title, target.pic, target.source || '');
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
        function initLazyLoading() {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy-image');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // å›é€€æ–¹æ¡ˆ
                lazyImages.forEach(img => {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy-image');
                });
            }
        }
        
        // æœç´¢åŠŸèƒ½
        function searchData() {
            suppressHistoryInteractions(200);
            const isMobile = window.matchMedia('(max-width: 767px)').matches;
            const desktopValue = document.getElementById('searchInput').value.trim();
            const mobileValue = document.getElementById('searchInputMobile').value.trim();
            const input = isMobile ? mobileValue : (desktopValue || mobileValue);
            
            if (!input) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (!host && !isAggregateSearchEnabled()) {
                showToast('è¯·å…ˆè®¾ç½®API Host');
                showHostModal();
                return;
            }
            
            searchTerm = input;
            currentPage = 1;
            hasMore = true;
            hideEmptyState();
            saveSearchHistory(input);
            hideSearchHistory();
            
            // æ›´æ–°ä¸¤ä¸ªæœç´¢æ¡†çš„å€¼
            document.getElementById('searchInput').value = input;
            document.getElementById('searchInputMobile').value = input;
            
            showLoading('æ­£åœ¨æœç´¢...');
            fetchData(input, 1).then((list) => {
                if (list && list.length > 0) {
                    if (window.matchMedia('(max-width: 767px)').matches) {
                        setTimeout(() => {
                            const mobileBox = document.getElementById('mobileSearchBox');
                            if (mobileBox && !mobileBox.classList.contains('hidden')) {
                                mobileBox.classList.add('hidden');
                            }
                        }, 200);
                    }
                    setTimeout(() => {
                        const firstCard = videoList.firstElementChild;
                        if (firstCard) {
                            scrollToElementWithHeaderOffset(firstCard, 12);
                        }
                    }, 50);
                }
            }).finally(() => {
                hideLoading();
            });
        }

        // æœç´¢å†å²è®°å½•
        function getSearchHistory() {
            return JSON.parse(localStorage.getItem('searchHistory') || '[]');
        }

        function saveSearchHistory(term) {
            if (!term) return;
            const history = getSearchHistory();
            const existingIndex = history.findIndex(item => item === term);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(term);
            if (history.length > 20) {
                history.splice(20);
            }
            localStorage.setItem('searchHistory', JSON.stringify(history));
            scheduleUserStatsUpdate();
        }

        function renderSearchHistory() {
            const history = getSearchHistory().slice(0, 12);
            const box = searchHistoryBox;
            const boxMobile = searchHistoryBoxMobile;
            const html = history.length === 0
                ? `<div class="px-3 py-2 text-xs text-gray-500">æš‚æ— æœç´¢å†å²</div>`
                : `
                    <div class="flex flex-wrap gap-2 p-2 max-h-[96px] overflow-hidden">
                        ${history.map(item => `
                            <button 
                                class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200"
                                onclick="selectSearchHistory('${item}')"
                                title="${item}"
                            >${item}</button>
                        `).join('')}
                    </div>
                `;
            if (box) box.innerHTML = html;
            if (boxMobile) boxMobile.innerHTML = html;
        }

        function showSearchHistory() {
            if (suppressHistoryClick) return;
            renderSearchHistory();
            if (searchHistoryBox) searchHistoryBox.classList.remove('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.remove('hidden');
        }

        function hideSearchHistory() {
            if (searchHistoryBox) searchHistoryBox.classList.add('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.add('hidden');
        }

        function selectSearchHistory(term) {
            if (suppressHistoryClick) return;
            if (!term) return;
            if (searchInput) searchInput.value = term;
            if (searchInputMobile) searchInputMobile.value = term;
            searchData();
        }

        function bindSearchHistoryEvents() {
            const bind = (input) => {
                if (!input) return;
                input.addEventListener('focus', showSearchHistory);
                input.addEventListener('blur', () => {
                    setTimeout(hideSearchHistory, 150);
                });
            };
            bind(searchInput);
            bind(searchInputMobile);

            // ç§»åŠ¨ç«¯ç‚¹å‡»è¾“å…¥æ¡†æ—¶æ¸…ç©ºä¸Šæ¬¡æœç´¢å†…å®¹
            if (searchInputMobile) {
                searchInputMobile.addEventListener('focus', () => {
                    searchInputMobile.value = '';
                });
            }
            if (searchButtonMobile) {
                const suppress = () => suppressHistoryInteractions(250);
                searchButtonMobile.addEventListener('mousedown', suppress);
                searchButtonMobile.addEventListener('pointerdown', suppress);
                searchButtonMobile.addEventListener('touchstart', suppress, { passive: true });
            }
        }

        function suppressHistoryInteractions(duration = 200) {
            suppressHistoryClick = true;
            hideSearchHistory();
            if (searchHistoryBox) searchHistoryBox.style.pointerEvents = 'none';
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = 'none';
            setTimeout(() => {
                suppressHistoryClick = false;
                if (searchHistoryBox) searchHistoryBox.style.pointerEvents = '';
                if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = '';
            }, duration);
        }

        // æ»šåŠ¨åˆ°å…ƒç´ å¹¶é¿å¼€å›ºå®šå¯¼èˆª
        function scrollToElementWithHeaderOffset(element, extraOffset = 0) {
            if (!element) return;
            const header = document.getElementById('header');
            const headerHeight = header ? header.offsetHeight : 0;
            const rect = element.getBoundingClientRect();
            const targetTop = rect.top + window.pageYOffset - headerHeight - extraOffset;
            window.scrollTo({ top: Math.max(targetTop, 0), behavior: 'smooth' });
        }
        
        let lastLoadMoreAt = 0;
        let mathChallengeAnswer = null;
        let mathChallengeResolver = null;

        function showMathChallengeModal() {
            if (videoPlayerModal && !videoPlayerModal.classList.contains('hidden')) {
                return Promise.resolve(false);
            }
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a = Math.floor(Math.random() * 9) + 1;
            let b = Math.floor(Math.random() * 9) + 1;
            if (op === '-' && a < b) {
                const tmp = a;
                a = b;
                b = tmp;
            }
            mathChallengeAnswer = op === '+' ? a + b : op === '-' ? a - b : a * b;
            const questionEl = document.getElementById('mathChallengeQuestion');
            const inputEl = document.getElementById('mathChallengeInput');
            const errorEl = document.getElementById('mathChallengeError');
            const modalEl = document.getElementById('mathChallengeModal');
            if (!questionEl || !inputEl || !errorEl || !modalEl) return Promise.resolve(false);
            questionEl.textContent = `${a} ${op} ${b} = ?`;
            inputEl.value = '';
            errorEl.classList.add('hidden');
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
            document.body.style.overflow = 'hidden';
            setTimeout(() => inputEl.focus(), 0);
            return new Promise(resolve => {
                mathChallengeResolver = resolve;
            });
        }

        function hideMathChallengeModal() {
            const modalEl = document.getElementById('mathChallengeModal');
            if (!modalEl) return;
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            document.body.style.overflow = '';
        }

        function submitMathChallenge() {
            const inputEl = document.getElementById('mathChallengeInput');
            const errorEl = document.getElementById('mathChallengeError');
            if (!inputEl || !errorEl) return;
            const answer = Number(String(inputEl.value).trim());
            if (!Number.isFinite(answer) || answer !== mathChallengeAnswer) {
                errorEl.classList.remove('hidden');
                inputEl.focus();
                return;
            }
            errorEl.classList.add('hidden');
            hideMathChallengeModal();
            if (typeof mathChallengeResolver === 'function') {
                mathChallengeResolver(true);
                mathChallengeResolver = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputEl = document.getElementById('mathChallengeInput');
            const submitEl = document.getElementById('mathChallengeSubmit');
            if (submitEl) submitEl.addEventListener('click', submitMathChallenge);
            if (inputEl) {
                inputEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') submitMathChallenge();
                });
            }
        });

        // åŠ è½½æ›´å¤š
        async function loadMoreData() {
            if (isLoading || (!host && !isAggregateSearchEnabled()) || !hasMore) return;
            if (videoPlayerModal && !videoPlayerModal.classList.contains('hidden')) return;

            const now = Date.now();
            if (now - lastLoadMoreAt < 5000) {
                const ok = await showMathChallengeModal();
                if (!ok) return;
            }
            lastLoadMoreAt = now;
            
            isLoading = true;
            showLoading('åŠ è½½æ›´å¤šå†…å®¹...');
            
            fetchData(searchTerm, currentPage + 1).finally(() => {
                hideLoading();
                isLoading = false;
            });
        }
        
        // å¤„ç†å›è½¦é”®æœç´¢
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchData();
            }
        }
        
        function openPreviewFromGroup(el) {
            if (!el || !el.dataset) return;
            const group = el.dataset.previewGroup || '';
            const nodes = group
                ? Array.from(document.querySelectorAll(`[data-preview-group="${group}"]`))
                : [];
            const list = nodes.length > 0
                ? nodes.map(node => ({
                    url: String(node.dataset.previewUrl || ''),
                    title: String(node.dataset.previewTitle || ''),
                    videoUrl: String(node.dataset.previewVideoUrl || ''),
                    source: String(node.dataset.previewSource || ''),
                    category: String(node.dataset.previewCategory || '')
                })).filter(item => item.url)
                : [{
                    url: String(el.dataset.previewUrl || ''),
                    title: String(el.dataset.previewTitle || ''),
                    videoUrl: String(el.dataset.previewVideoUrl || ''),
                    source: String(el.dataset.previewSource || ''),
                    category: String(el.dataset.previewCategory || '')
                }];
            const index = nodes.length > 0 ? Math.max(0, nodes.indexOf(el)) : 0;
            const current = list[index] || list[0];
            if (!current || !current.url) return;
            openFullScreenPreview(current.url, current.title, list, index);
        }

        // æ˜¾ç¤ºå…¨å±é¢„è§ˆ
        function openFullScreenPreview(imageUrl, title, list = [], startIndex = 0) {
            const items = Array.isArray(list) && list.length > 0
                ? list
                : [{ url: imageUrl, title }];
            let currentIndex = Math.min(Math.max(Number(startIndex) || 0, 0), items.length - 1);
            let currentEpisodeIndex = 0;
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let dragStartX = 0;
            let dragStartY = 0;
            let pinchStartDist = 0;
            let pinchStartScale = 1;
            let swipeStartX = 0;
            let swipeStartY = 0;
            let lastTapAt = 0;

            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="relative max-w-5xl max-h-[90vh] w-full flex items-center justify-center">
                    <button 
                        class="absolute -top-12 right-0 text-white hover:text-gray-300"
                        data-action="close"
                    >
                        <i class="fa fa-times text-xl"></i>
                    </button>
                    <button
                        class="absolute -top-12 left-0 text-white hover:text-white/80 bg-blue-600/80 hover:bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center hidden"
                        data-action="play"
                        title="æ’­æ”¾"
                    >
                        <i class="fa fa-play text-base"></i>
                    </button>
                    <button 
                        class="absolute left-0 md:-left-12 top-1/2 -translate-y-1/2 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center ${items.length > 1 ? '' : 'hidden'}"
                        data-action="prev"
                    >
                        <i class="fa fa-angle-left text-2xl"></i>
                    </button>
                    <button 
                        class="absolute right-0 md:-right-12 top-1/2 -translate-y-1/2 text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full w-10 h-10 flex items-center justify-center ${items.length > 1 ? '' : 'hidden'}"
                        data-action="next"
                    >
                        <i class="fa fa-angle-right text-2xl"></i>
                    </button>
                    <div class="relative max-w-full max-h-[90vh] flex flex-col items-center">
                        <img 
                            src="" 
                            alt="" 
                            onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';"
                            loading="lazy"
                            class="max-w-full max-h-[90vh] object-contain rounded-lg select-none touch-none"
                        >
                        <div class="preview-meta text-white/80 text-xs mt-2"></div>
                        <p class="preview-caption text-white text-center mt-2"></p>
                        <div class="preview-episodes hidden mt-3 w-full max-w-2xl">
                            <div class="text-xs text-white/70 mb-2">é€‰é›†æ’­æ”¾</div>
                            <div class="preview-episode-list flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);
            setModalScrollLock(true);

            const img = overlay.querySelector('img');
            const caption = overlay.querySelector('.preview-caption');
            const meta = overlay.querySelector('.preview-meta');
            const episodeWrap = overlay.querySelector('.preview-episodes');
            const episodeList = overlay.querySelector('.preview-episode-list');
            const prevBtn = overlay.querySelector('[data-action="prev"]');
            const nextBtn = overlay.querySelector('[data-action="next"]');
            const closeBtn = overlay.querySelector('[data-action="close"]');
            const playBtn = overlay.querySelector('[data-action="play"]');

            const parseEpisodes = (rawUrl) => {
                const text = String(rawUrl || '');
                if (!text) return [];
                const parts = text.split('#').map(part => part.trim()).filter(Boolean);
                return parts.map((part, index) => {
                    const splitIndex = part.indexOf('$');
                    if (splitIndex === -1) {
                        return { name: `ç¬¬${index + 1}é›†`, url: part };
                    }
                    const name = part.slice(0, splitIndex).trim() || `ç¬¬${index + 1}é›†`;
                    const url = part.slice(splitIndex + 1).trim();
                    return { name, url };
                }).filter(item => item.url);
            };

            const renderEpisodes = (item) => {
                if (!episodeWrap || !episodeList) return;
                const category = normalizeCategory(item.category || '');
                if (category !== 'normal') {
                    episodeWrap.classList.add('hidden');
                    episodeList.innerHTML = '';
                    currentEpisodeIndex = 0;
                    return;
                }
                const episodes = parseEpisodes(item.videoUrl);
                if (episodes.length <= 1) {
                    episodeWrap.classList.add('hidden');
                    episodeList.innerHTML = '';
                    currentEpisodeIndex = 0;
                    return;
                }
                episodeWrap.classList.remove('hidden');
                episodeList.innerHTML = episodes.map((ep, idx) => `
                    <button 
                        type="button"
                        class="px-3 py-1 rounded-full text-xs border ${idx === currentEpisodeIndex ? 'bg-blue-600 text-white border-blue-600' : 'bg-white/10 text-white border-white/20 hover:bg-white/20'}"
                        data-episode-index="${idx}"
                        data-episode-url="${ep.url}"
                        data-episode-name="${ep.name}"
                    >${ep.name}</button>
                `).join('');
            };

            const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
            const applyTransform = () => {
                img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            };
            const resetTransform = () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                applyTransform();
            };
            const renderImage = () => {
                const item = items[currentIndex] || items[0];
                img.src = item.url;
                img.alt = item.title || '';
                caption.textContent = item.title || '';
                if (meta) {
                    meta.textContent = `${currentIndex + 1}/${items.length}`;
                }
                if (playBtn) {
                    playBtn.classList.toggle('hidden', !item.videoUrl);
                }
                currentEpisodeIndex = 0;
                renderEpisodes(item);
                resetTransform();
            };
            const gotoIndex = (nextIndex) => {
                if (items.length <= 1) return;
                currentIndex = (nextIndex + items.length) % items.length;
                renderImage();
            };

            const handleClose = () => {
                overlay.remove();
                setModalScrollLock(false);
                document.removeEventListener('keydown', onKeyDown);
            };

            const onKeyDown = (e) => {
                if (e.key === 'Escape') handleClose();
                if (e.key === 'ArrowLeft') gotoIndex(currentIndex - 1);
                if (e.key === 'ArrowRight') gotoIndex(currentIndex + 1);
            };
            document.addEventListener('keydown', onKeyDown);

            if (closeBtn) closeBtn.addEventListener('click', handleClose);
            if (prevBtn) prevBtn.addEventListener('click', () => gotoIndex(currentIndex - 1));
            if (nextBtn) nextBtn.addEventListener('click', () => gotoIndex(currentIndex + 1));
            if (playBtn) {
                playBtn.addEventListener('click', () => {
                    const item = items[currentIndex] || items[0];
                    if (!item || !item.videoUrl) return;
                    const episodes = parseEpisodes(item.videoUrl);
                    const selected = episodes[currentEpisodeIndex];
                    handleClose();
                    openVideoPlayer(
                        item.videoUrl,
                        item.title || '',
                        item.url || '',
                        item.source || '',
                        item.category || '',
                        currentEpisodeIndex
                    );
                });
            }

            if (episodeList) {
                episodeList.addEventListener('click', (e) => {
                    const target = e.target;
                    if (!(target instanceof HTMLElement)) return;
                    const idx = Number(target.getAttribute('data-episode-index'));
                    const url = String(target.getAttribute('data-episode-url') || '');
                    const name = String(target.getAttribute('data-episode-name') || '');
                    if (!Number.isFinite(idx) || !url) return;
                    currentEpisodeIndex = idx;
                    const buttons = episodeList.querySelectorAll('button[data-episode-index]');
                    buttons.forEach((btn) => {
                        const isActive = Number(btn.getAttribute('data-episode-index')) === idx;
                        btn.classList.toggle('bg-blue-600', isActive);
                        btn.classList.toggle('text-white', isActive);
                        btn.classList.toggle('border-blue-600', isActive);
                        btn.classList.toggle('bg-white/10', !isActive);
                        btn.classList.toggle('text-white', !isActive);
                        btn.classList.toggle('border-white/20', !isActive);
                    });
                    handleClose();
                    const item = items[currentIndex] || {};
                    openVideoPlayer(
                        item.videoUrl || url,
                        item.title || (name || ''),
                        item.url || '',
                        item.source || '',
                        item.category || '',
                        idx
                    );
                });
            }

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) handleClose();
            });

            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.2 : 0.2;
                const nextScale = clamp(scale + delta, 1, 4);
                scale = nextScale;
                if (scale === 1) {
                    translateX = 0;
                    translateY = 0;
                }
                applyTransform();
            }, { passive: false });

            img.addEventListener('mousedown', (e) => {
                if (scale <= 1) return;
                isDragging = true;
                dragStartX = e.clientX - translateX;
                dragStartY = e.clientY - translateY;
            });
            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                translateX = e.clientX - dragStartX;
                translateY = e.clientY - dragStartY;
                applyTransform();
            });
            window.addEventListener('mouseup', () => {
                isDragging = false;
            });

            img.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    pinchStartDist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    pinchStartScale = scale;
                    return;
                }
                if (e.touches.length === 1) {
                    swipeStartX = e.touches[0].clientX;
                    swipeStartY = e.touches[0].clientY;
                    if (scale > 1) {
                        isDragging = true;
                        dragStartX = e.touches[0].clientX - translateX;
                        dragStartY = e.touches[0].clientY - translateY;
                    }
                }
            }, { passive: false });

            img.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const nextScale = clamp(pinchStartScale * (dist / (pinchStartDist || dist)), 1, 4);
                    scale = nextScale;
                    if (scale === 1) {
                        translateX = 0;
                        translateY = 0;
                    }
                    applyTransform();
                    return;
                }
                if (e.touches.length === 1 && isDragging) {
                    e.preventDefault();
                    translateX = e.touches[0].clientX - dragStartX;
                    translateY = e.touches[0].clientY - dragStartY;
                    applyTransform();
                }
            }, { passive: false });

            img.addEventListener('touchend', (e) => {
                if (e.touches.length === 0) {
                    isDragging = false;
                    const now = Date.now();
                    if (now - lastTapAt < 280) {
                        if (scale > 1) {
                            resetTransform();
                        } else {
                            scale = 2;
                            applyTransform();
                        }
                        lastTapAt = 0;
                        return;
                    }
                    lastTapAt = now;
                    if (scale <= 1.05 && items.length > 1) {
                        const endX = (e.changedTouches[0] || {}).clientX || swipeStartX;
                        const endY = (e.changedTouches[0] || {}).clientY || swipeStartY;
                        const deltaX = endX - swipeStartX;
                        const deltaY = endY - swipeStartY;
                        if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
                            gotoIndex(deltaX > 0 ? currentIndex - 1 : currentIndex + 1);
                        }
                    }
                }
            });

            renderImage();
        }
        
        // æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨
        function parsePlayUrls(rawUrl) {
            const text = String(rawUrl || '');
            if (!text) return [];
            const segments = text.split('$$$').map(part => part.trim()).filter(Boolean);
            const preferredSegment = segments.find(seg => seg.toLowerCase().includes('m3u8')) || segments[0] || '';
            const parts = preferredSegment.split('#').map(part => part.trim()).filter(Boolean);
            return parts.map((part, index) => {
                const splitIndex = part.indexOf('$');
                if (splitIndex === -1) {
                    return { name: `ç¬¬${index + 1}é›†`, url: part };
                }
                const name = part.slice(0, splitIndex).trim() || `ç¬¬${index + 1}é›†`;
                const url = part.slice(splitIndex + 1).trim();
                return { name, url };
            }).filter(item => item.url);
        }

        function isM3u8Url(url) {
            if (!url) return false;
            const cleaned = String(url).split('?')[0].split('#')[0].toLowerCase();
            return cleaned.endsWith('.m3u8');
        }

        function openVideoPlayer(videoUrl, videoTitle, imageUrl = '', sourceLabel = '', category = '', preferredEpisodeIndex = null) {
            if (!host) {
                if (!isAggregateSearchEnabled()) {
                    showToast('è¯·å…ˆè®¾ç½®API Host');
                    showHostModal();
                    return;
                }
            }

            showLoading('æ­£åœ¨åŠ è½½è§†é¢‘...');
            
            try {
                const resolvedCategory = normalizeCategory(category || getOfficialCategoryByName(sourceLabel) || getCurrentHostCategory());
                const baseTitle = String(videoTitle || '').trim();
                const episodes = parsePlayUrls(videoUrl);
                const hasEpisodeList = episodes.length > 1;
                const normalizedPreferred = Number.isFinite(Number(preferredEpisodeIndex)) ? Number(preferredEpisodeIndex) : null;
                const initialIndex = hasEpisodeList && normalizedPreferred !== null && normalizedPreferred >= 0 && normalizedPreferred < episodes.length
                    ? normalizedPreferred
                    : 0;
                const initialEpisode = episodes[initialIndex];
                const initialUrl = initialEpisode ? initialEpisode.url : (videoUrl.split('$')[1] || videoUrl);
                if (!isM3u8Url(initialUrl)) {
                    hideLoading();
                    showToast('ä»…æ”¯æŒ .m3u8 è§†é¢‘åœ°å€');
                    return;
                }
                const episodeTitle = hasEpisodeList && initialEpisode && initialEpisode.name ? initialEpisode.name : '';
                const displayTitle = baseTitle
                    ? (episodeTitle ? `${baseTitle} ${episodeTitle}` : baseTitle)
                    : (episodeTitle || 'è§†é¢‘æ’­æ”¾');
                currentVideoRawUrl = videoUrl;
                currentEpisodeList = episodes;
                currentEpisodeIndex = initialIndex;
                currentVideoUrl = initialUrl;
                currentVideoTitle = displayTitle || 'è§†é¢‘æ’­æ”¾';
                currentVideoPic = imageUrl || '';
                currentVideoSource = sourceLabel || getHostLabel();
                const episodePanel = document.getElementById('episodePanel');
                const episodeList = document.getElementById('episodeList');
                let activeEpisodeIndex = initialIndex;
                const setActiveEpisodeButton = () => {
                    if (!episodeList) return;
                    const buttons = episodeList.querySelectorAll('button[data-episode-index]');
                    buttons.forEach((btn) => {
                        const idx = Number(btn.getAttribute('data-episode-index'));
                        const isActive = Number.isFinite(idx) && idx === activeEpisodeIndex;
                        btn.classList.toggle('bg-blue-600', isActive);
                        btn.classList.toggle('text-white', isActive);
                        btn.classList.toggle('border-blue-600', isActive);
                        btn.classList.toggle('bg-white/10', !isActive);
                        btn.classList.toggle('text-white', !isActive);
                        btn.classList.toggle('border-white/20', !isActive);
                    });
                };
                const renderEpisodePanel = () => {
                    if (!episodePanel || !episodeList) return;
                    if (resolvedCategory !== 'normal' || !hasEpisodeList) {
                        episodePanel.classList.add('hidden');
                        episodeList.innerHTML = '';
                        return;
                    }
                    episodePanel.classList.remove('hidden');
                    episodeList.innerHTML = episodes.map((ep, idx) => `
                        <button 
                            type="button"
                            class="px-3 py-1 rounded-full text-xs border ${idx === activeEpisodeIndex ? 'bg-blue-600 text-white border-blue-600' : 'bg-white/10 text-white border-white/20 hover:bg-white/20'}"
                            data-episode-index="${idx}"
                        >${ep.name}</button>
                    `).join('');
                    setActiveEpisodeButton();
                };
                const updatePlayerTitle = (title) => {
                    const playerTitle = document.getElementById('playerTitle');
                    if (playerTitle) {
                        const label = currentVideoSource || 'æœªçŸ¥æ¥æº';
                        playerTitle.innerHTML = `<span class="bg-white/20 text-white/90 text-[10px] px-2 py-0.5 rounded mr-2">${label}</span>${title || ''}`;
                    }
                };
                updatePlayerLikeButtons(isFavorited(initialUrl));
                updatePlayerTitle(currentVideoTitle);
                
                // ä¿å­˜æ’­æ”¾å†å²
                saveToHistory(currentVideoTitle, initialUrl, imageUrl, currentVideoSource, episodeTitle || '', hasEpisodeList ? initialIndex : null);
                
                // æ˜¾ç¤ºæ’­æ”¾å™¨
                setModalScrollLock(true);
                videoPlayerModal.classList.remove('hidden');
                
                // åˆå§‹åŒ–DPlayer
                if (dplayer) {
                    dplayer.destroy();
                }
                
                const resumeTarget = loadResumeTime(initialUrl);
                let resumeApplied = false;

                dplayer = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: initialUrl,
                        type: 'hls',
                        pic: '',
                        thumbnails: '',
                        title: currentVideoTitle || 'è§†é¢‘æ’­æ”¾'
                    },
                    autoplay: true,
                    theme: '#3b82f6',
                    loop: false,
                    screenshot: true,
                    hotkey: true,
                    preload: 'auto',
                    contextmenu: [
                        {
                            text: 'åœ¨æ–°çª—å£æ‰“å¼€',
                            link: initialUrl,
                        }
                    ]
                });

                // æ·»åŠ çª—å£æ’­æ”¾æŒ‰é’®åˆ°æ§åˆ¶æ 
                setTimeout(() => {
                    const controller = document.querySelector('.dplayer-controller');
                    if (controller) {
                        const windowButton = document.createElement('button');
                        windowButton.className = 'dplayer-button dplayer-window-button';
                        windowButton.innerHTML = '<i class="fa fa-window-restore"></i>';
                        windowButton.title = 'çª—å£æ’­æ”¾';
                        windowButton.onclick = () => window.open(currentVideoUrl, '_blank');
                        
                        // æ’å…¥åˆ°å…¨å±æŒ‰é’®ä¹‹å‰
                        const fullscreenButton = controller.querySelector('.dplayer-fullscreen-toggle');
                        if (fullscreenButton) {
                            controller.insertBefore(windowButton, fullscreenButton);
                        } else {
                            controller.appendChild(windowButton);
                        }
                    }
                }, 100);
                
                dplayer.on('play', () => {
                    hideLoading();
                    isLoading = false;
                });

                dplayer.on('loadedmetadata', () => {
                    if (resumeApplied || !resumeTarget) return;
                    const duration = dplayer?.video?.duration || 0;
                    if (duration > 0 && resumeTarget < duration - RESUME_MIN_SECONDS) {
                        dplayer.seek(resumeTarget);
                        resumeApplied = true;
                        showToast('å·²æ¢å¤åˆ°ä¸Šæ¬¡æ’­æ”¾ä½ç½®');
                    }
                });

                dplayer.on('timeupdate', () => {
                    if (!dplayer || !dplayer.video) return;
                    const current = dplayer.video.currentTime || 0;
                    if (lastWatchUrl !== currentVideoUrl) {
                        lastWatchUrl = currentVideoUrl;
                        lastWatchTime = current;
                    }
                    const delta = current - lastWatchTime;
                    if (delta > 0 && delta <= 5) {
                        addWatchTime(delta);
                    }
                    lastWatchTime = current;
                    saveResumeTime(currentVideoUrl, dplayer.video.currentTime, dplayer.video.duration);
                });

                dplayer.on('pause', () => {
                    saveResumeNow(currentVideoUrl);
                });

                dplayer.on('seeked', () => {
                    saveResumeNow(currentVideoUrl);
                });

                dplayer.on('ended', () => {
                    clearResumeTime(currentVideoUrl);
                    lastWatchTime = 0;
                    lastWatchUrl = '';
                });

                renderEpisodePanel();

                if (episodeList) {
                    episodeList.onclick = (e) => {
                        const target = e.target;
                        if (!(target instanceof HTMLElement)) return;
                        const idx = Number(target.getAttribute('data-episode-index'));
                        if (!Number.isFinite(idx) || !episodes[idx]) return;
                        activeEpisodeIndex = idx;
                        setActiveEpisodeButton();
                        const ep = episodes[idx];
                        if (!isM3u8Url(ep.url)) {
                            showToast('ä»…æ”¯æŒ .m3u8 è§†é¢‘åœ°å€');
                            return;
                        }
                        const title = baseTitle
                            ? (ep.name ? `${baseTitle} ${ep.name}` : baseTitle)
                            : (ep.name || 'è§†é¢‘æ’­æ”¾');
                        currentVideoUrl = ep.url;
                        currentVideoTitle = title;
                        currentEpisodeIndex = idx;
                        updatePlayerTitle(title);
                        updatePlayerLikeButtons(isFavorited(ep.url));
                        saveToHistory(title, ep.url, imageUrl, currentVideoSource, ep.name || '', idx);
                        if (dplayer && typeof dplayer.switchVideo === 'function') {
                            dplayer.switchVideo({ url: ep.url, type: 'hls', pic: '', thumbnails: '', title });
                            dplayer.play();
                        } else if (dplayer && dplayer.video) {
                            dplayer.video.src = ep.url;
                            dplayer.video.play();
                        }
                        renderEpisodePanel();
                    };
                }
                
                dplayer.on('error', (e) => {
                    // åªæœ‰åœ¨åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ‰æ˜¾ç¤ºæç¤º
                    if (isLoading) {
                        hideLoading();
                        showToast('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–è§†é¢‘');
                    }
                    console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', e);
                });
            } catch (error) {
                hideLoading();
                showToast('è§†é¢‘åŠ è½½å¤±è´¥');
                console.error('è§†é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å…³é—­è§†é¢‘æ’­æ”¾å™¨
        function closeVideoPlayer() {
            if (dplayer) {
                saveResumeNow(currentVideoUrl);
                dplayer.destroy();
                dplayer = null;
            }
            
            videoPlayerModal.classList.add('hidden');
            setModalScrollLock(false);
            currentVideoUrl = '';
            currentVideoTitle = '';
            currentVideoPic = '';
            currentVideoSource = '';
            updatePlayerLikeButtons(false);
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = '';
            }
            
            // éšè—ç§»åŠ¨è®¾å¤‡å…³é—­æŒ‰é’®
            const mobileCloseButton = document.getElementById('closeVideoButtonMobile');
            if (mobileCloseButton) {
                // ä½¿ç”¨classNameé‡ç½®æ‰€æœ‰æ ·å¼ï¼Œç¡®ä¿ä¸‹æ¬¡èƒ½æ­£ç¡®æ˜¾ç¤º
                mobileCloseButton.className = 'md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg';
                mobileCloseButton.style.cssText = '';
            }
        }

        function setModalScrollLock(locked) {
            const body = document.body;
            const html = document.documentElement;
            const isLocked = body.classList.contains('modal-open');
            if (locked === isLocked) return;
            const app = document.getElementById('appContent');
            if (locked) {
                const scrollY = window.scrollY || window.pageYOffset || 0;
                const scrollbarWidth = window.innerWidth - html.clientWidth;
                body.dataset.scrollLockY = String(scrollY);
                body.dataset.scrollbarWidth = String(scrollbarWidth);
                if (app) {
                    app.style.position = 'fixed';
                    app.style.top = `-${scrollY}px`;
                    app.style.left = '0';
                    app.style.right = '0';
                    app.style.width = '100%';
                }
                body.style.overflow = 'hidden';
                if (scrollbarWidth > 0) {
                    body.style.paddingRight = `${scrollbarWidth}px`;
                }
            } else {
                const scrollY = Number(body.dataset.scrollLockY || 0);
                const scrollbarWidth = Number(body.dataset.scrollbarWidth || 0);
                if (app) {
                    app.style.position = '';
                    app.style.top = '';
                    app.style.left = '';
                    app.style.right = '';
                    app.style.width = '';
                }
                body.style.overflow = '';
                body.style.paddingRight = '';
                delete body.dataset.scrollLockY;
                delete body.dataset.scrollbarWidth;
                if (Number.isFinite(scrollY)) {
                    window.scrollTo(0, scrollY);
                }
            }
            body.classList.toggle('modal-open', locked);
            html.classList.toggle('modal-open', locked);
        }
        
        // ä¿å­˜åˆ°æ’­æ”¾å†å²
        function saveToHistory(title, url, pic, source, episodeName = '', episodeIndex = null) {
            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingIndex = history.findIndex(item => item.url === url);
                
                const historyItem = {
                    title,
                    url,
                    pic: pic || '',
                    source: source || '',
                    episodeName: episodeName || '',
                    episodeIndex: Number.isFinite(episodeIndex) ? Number(episodeIndex) : (existingIndex >= 0 ? (history[existingIndex].episodeIndex ?? null) : null),
                    timestamp: Date.now(),
                    playCount: existingIndex >= 0 ? (history[existingIndex].playCount || 0) + 1 : 1,
                    lastPosition: existingIndex >= 0 ? (history[existingIndex].lastPosition || 0) : 0,
                    lastPositionUpdatedAt: existingIndex >= 0 ? (history[existingIndex].lastPositionUpdatedAt || 0) : 0
                };
                
                // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
                if (existingIndex >= 0) {
                    history.splice(existingIndex, 1);
                }
                
                // æ·»åŠ åˆ°å¼€å¤´
                history.unshift(historyItem);
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (history.length > 50) {
                    history.splice(50);
                }
                
                localStorage.setItem('videoPlayHistory', JSON.stringify(history));
            } catch (error) {
                console.error('ä¿å­˜æ’­æ”¾å†å²å¤±è´¥:', error);
            }
            scheduleUserStatsUpdate();
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        function toggleHistory() {
            const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            
            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-history text-4xl mb-3"></i>
                        <p>æš‚æ— æ’­æ”¾å†å²</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = history.map(item => {
                    const resumeFromStore = getResumeTimeForHistory(item);
                    const resumeFromHistory = Number(item.lastPosition || 0);
                    const resumeTime = resumeFromStore > 0 ? resumeFromStore : resumeFromHistory;
                    const resumeLabelText = resumeTime > 0 ? formatDuration(resumeTime) : 'æš‚æ— ';
                    const resumeLabel = resumeTime > 0 ? `ä¸Šæ¬¡æ’­æ”¾: ${resumeLabelText}` : '';
                    return `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0 cursor-pointer" data-preview-group="history" data-preview-url="${item.pic || FALLBACK_IMAGE}" data-preview-title="${item.title || ''}" data-preview-video-url="${item.url || ''}" data-preview-source="${item.source || ''}" data-preview-category="${normalizeCategory(getOfficialCategoryByName(item.source) || '')}" onclick="openPreviewFromGroup(this)">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';" loading="lazy" class="w-full h-full object-cover">`
                                        : `<img src="${FALLBACK_IMAGE}" alt="loading" loading="lazy" class="w-full h-full object-cover">`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || 'æœªçŸ¥æ¥æº'}</span>
                                    ${item.title}
                                </h4>
                                ${item.episodeName ? `<div class="text-[11px] text-gray-500 mb-1">é€‰é›†ï¼š${item.episodeName}</div>` : ''}
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                                    <span>æ’­æ”¾æ¬¡æ•°: ${item.playCount}</span>
                                    ${resumeLabel ? `<span>${resumeLabel}</span>` : ''}
                                    <span>${formatDate(item.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button 
                                onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}', '', ${Number.isFinite(item.episodeIndex) ? item.episodeIndex : 'null'})"
                                class="btn-primary text-xs py-1 px-2 flex-1"
                            >
                                <i class="fa fa-play mr-1"></i> æ’­æ”¾
                            </button>
                            <button 
                                onclick="removeFromHistory('${item.url}')"
                                class="text-gray-500 hover:text-red-500 p-1"
                            >
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const willOpen = historyPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(historyPanel);
            historyPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        // å–œæ¬¢åŠŸèƒ½
        let favoritesCache = null;
        let favoritesLoadingPromise = null;
        const FAVORITES_REMOTE_LOADED_KEY = 'videoFavoritesRemoteLoaded';

        function getFavorites() {
            if (Array.isArray(favoritesCache)) return favoritesCache;
            return [];
        }

        function ensureFavoritesCacheImmediate() {
            if (!Array.isArray(favoritesCache)) {
                favoritesCache = JSON.parse(localStorage.getItem('videoFavorites') || '[]');
            }
        }

        function setFavoritesCache(list) {
            favoritesCache = Array.isArray(list) ? list : [];
            try {
                localStorage.setItem('videoFavorites', JSON.stringify(favoritesCache));
            } catch (e) {
                // ignore storage errors
            }
        }

        async function loadFavorites(force = false) {
            if (favoritesLoadingPromise) return favoritesLoadingPromise;
            const token = getUserToken ? getUserToken() : '';
            const alreadyLoaded = localStorage.getItem(FAVORITES_REMOTE_LOADED_KEY) === '1';
            if (!force && (alreadyLoaded || !token)) {
                setFavoritesCache(getFavorites());
                refreshLocalStatsDisplay();
                return;
            }
            favoritesLoadingPromise = (async () => {
                try {
                    const res = await fetch('/user/favorites', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (data && data.code === 200 && Array.isArray(data.data)) {
                        setFavoritesCache(data.data);
                        localStorage.setItem(FAVORITES_REMOTE_LOADED_KEY, '1');
                        refreshLocalStatsDisplay();
                    }
                } catch (e) {
                    // ignore
                } finally {
                    favoritesLoadingPromise = null;
                }
            })();
            return favoritesLoadingPromise;
        }

        async function mergeLocalFavoritesToMongo() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return;
            const local = JSON.parse(localStorage.getItem('videoFavorites') || '[]');
            if (!Array.isArray(local) || local.length === 0) return;
            try {
                await Promise.all(local.map(item => {
                    return fetch('/user/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify({
                            title: item.title,
                            url: item.url,
                            pic: item.pic || '',
                            source: item.source || '',
                            timestamp: item.timestamp || Date.now()
                        })
                    });
                }));
            } catch (e) {
                // ignore
            }
        }

        async function uploadLocalFavorites() {
            showToast('å·²å…³é—­ä¸€é”®åŒæ­¥ï¼šå–œæ¬¢åªä¼šä»çº¿ä¸Šè¯»å–ä¸€æ¬¡å¹¶ä¿å­˜åˆ°æœ¬åœ°');
        }

        function isFavorited(videoUrl) {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const favorites = getFavorites();
            return favorites.some(item => item.url === realVideoUrl);
        }

        async function toggleFavorite(title, videoUrl, pic, buttonEl, sourceLabel = '') {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const token = getUserToken ? getUserToken() : '';
            ensureFavoritesCacheImmediate();
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === realVideoUrl);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                setFavoritesCache(favorites);
                showToast('å·²å–æ¶ˆå–œæ¬¢');
                updateFavoriteButton(buttonEl, false);
                scheduleUserStatsUpdate();
                if (token) {
                    fetch('/user/favorites', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify({ url: realVideoUrl })
                    }).catch(() => {});
                }
            } else {
                const source = sourceLabel || getHostLabel();
                const item = {
                    title,
                    url: realVideoUrl,
                    pic: pic || '',
                    source: source || '',
                    timestamp: Date.now()
                };
                favorites.unshift(item);
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                setFavoritesCache(favorites);
                showToast('å·²åŠ å…¥å–œæ¬¢');
                updateFavoriteButton(buttonEl, true);
                scheduleUserStatsUpdate();
                if (token) {
                    fetch('/user/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify(item)
                    }).then(async () => {
                        try {
                            if (!Array.isArray(favoritesCache)) {
                                await loadFavorites();
                            } else if (!favoritesCache.some(f => f && f.url === realVideoUrl)) {
                                favoritesCache.unshift(item);
                                if (favoritesCache.length > 100) favoritesCache.splice(100);
                            }
                            if (!favoritePanel.classList.contains('translate-x-full')) {
                                renderFavoriteContent(buildFavoriteStatusList());
                            }
                        } catch (e) {
                            // ignore
                        }
                    }).catch(() => {});
                }
            }
        }

        function updateFavoriteButton(buttonEl, isLiked) {
            if (!buttonEl) return;
            buttonEl.classList.toggle('text-red-500', isLiked);
            buttonEl.classList.toggle('text-gray-500', !isLiked);
            const icon = buttonEl.querySelector('i');
            if (icon) {
                icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'} mr-1`;
            }
        }

        function buildFavoriteStatusList() {
            const remoteFavorites = Array.isArray(favoritesCache) ? favoritesCache : [];
            return remoteFavorites
                .filter(item => item && item.url)
                .map(item => ({ ...item, _status: 'remote' }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        }

        function renderFavoriteContent(list) {
            const favorites = Array.isArray(list) ? list : [];
            if (favorites.length === 0) {
                favoriteContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-heart text-4xl mb-3"></i>
                        <p>æš‚æ— å–œæ¬¢å†…å®¹</p>
                    </div>
                `;
                return;
            }
            favoriteContent.innerHTML = favorites.map(item => `
                <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                    <div class="flex space-x-3">
                        <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0 cursor-pointer" data-preview-group="favorite" data-preview-url="${item.pic || FALLBACK_IMAGE}" data-preview-title="${item.title || ''}" data-preview-video-url="${item.url || ''}" data-preview-source="${item.source || ''}" onclick="openPreviewFromGroup(this)">
                            ${
                                item.pic
                                    ? `<img src="${item.pic}" alt="${item.title}" onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';" loading="lazy" class="w-full h-full object-cover">`
                                    : `<img src="${FALLBACK_IMAGE}" alt="loading" loading="lazy" class="w-full h-full object-cover">`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || 'æœªçŸ¥æ¥æº'}</span>
                                <span class="mr-1">${item._status === 'both' ? 'ğŸŸ¢' : (item._status === 'local' ? 'ğŸ”´' : 'ğŸŸ¡')}</span>
                                ${item.title}
                            </h4>
                            <div class="text-xs text-gray-500">
                                <span>æ”¶è—æ—¶é—´: ${formatDate(item.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button 
                            onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                            class="btn-primary text-xs py-1 px-2 flex-1"
                        >
                            <i class="fa fa-play mr-1"></i> æ’­æ”¾
                        </button>
                        <button 
                            onclick="removeFavoriteWithSpin(this, '${item.url}')"
                            class="text-gray-500 hover:text-red-500 p-1"
                        >
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function toggleFavorites() {
            const willOpen = favoritePanel.classList.contains('translate-x-full');
            if (!willOpen) {
                favoritePanel.classList.add('translate-x-full');
                updateOverlayForPanels();
                return;
            }
            favoriteContent.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="inline-flex items-center space-x-2">
                        <span class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></span>
                        <span>åŠ è½½ä¸­...</span>
                    </span>
                </div>
            `;
            if (uploadFavoritesButton) {
                uploadFavoritesButton.classList.add('hidden');
            }
            closePanelsExcept(favoritePanel);
            favoritePanel.classList.remove('translate-x-full');
            updateOverlayForPanels();
            if (!Array.isArray(favoritesCache)) {
                await loadFavorites();
            }
            const favorites = buildFavoriteStatusList();
            renderFavoriteContent(favorites);
        }

        async function removeFavorite(url) {
            try {
                const token = getUserToken ? getUserToken() : '';
                if (token) {
                    await fetch('/user/favorites', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify({ url })
                    });
                }
                const favorites = getFavorites().filter(item => item.url !== url);
                setFavoritesCache(favorites);
                toggleFavorites();
                toggleFavorites();
                scheduleUserStatsUpdate();
            } catch (error) {
                console.error('ç§»é™¤å–œæ¬¢å¤±è´¥:', error);
            }
        }

        async function removeFavoriteWithSpin(button, url) {
            if (button) {
                button.disabled = true;
                button.classList.add('opacity-60', 'cursor-not-allowed');
                const icon = button.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-trash');
                    icon.classList.add('fa-refresh', 'fa-spin');
                }
            }
            await removeFavorite(url);
        }

        function openClearFavoritesConfirm() {
            if (!clearFavoritesModal) return;
            clearFavoritesModal.classList.remove('hidden');
            clearFavoritesModal.classList.add('flex');
            if (clearFavoritesPassword) clearFavoritesPassword.value = '';
            if (clearFavoritesError) clearFavoritesError.classList.add('hidden');
            if (clearFavoritesPassword) clearFavoritesPassword.focus();
        }

        function closeClearFavoritesModal() {
            if (!clearFavoritesModal) return;
            clearFavoritesModal.classList.add('hidden');
            clearFavoritesModal.classList.remove('flex');
        }

        async function confirmClearFavorites() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) {
                showToast('è¯·å…ˆç™»å½•');
                return;
            }
            const password = clearFavoritesPassword ? clearFavoritesPassword.value.trim() : '';
            if (!password) {
                if (clearFavoritesError) {
                    clearFavoritesError.textContent = 'è¯·è¾“å…¥å¯†ç ';
                    clearFavoritesError.classList.remove('hidden');
                }
                return;
            }
            try {
                const verifyRes = await fetch('/user/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ password })
                });
                const verifyData = await verifyRes.json();
                if (!verifyData || verifyData.code !== 200 || verifyData.data !== true) {
                    if (clearFavoritesError) {
                        clearFavoritesError.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                        clearFavoritesError.classList.remove('hidden');
                    }
                    return;
                }
                await fetch('/user/favorites/all', {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                });
                setFavoritesCache([]);
                toggleFavorites();
                toggleFavorites();
                closeClearFavoritesModal();
                showToast('å–œæ¬¢å†…å®¹å·²æ¸…ç©º');
                scheduleUserStatsUpdate();
            } catch (e) {
                if (clearFavoritesError) {
                    clearFavoritesError.textContent = 'éªŒè¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    clearFavoritesError.classList.remove('hidden');
                }
            }
        }
        
        // ä»å†å²è®°å½•ä¸­ç§»é™¤
        function removeFromHistory(url) {
            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                const filteredHistory = history.filter(item => item.url !== url);
                localStorage.setItem('videoPlayHistory', JSON.stringify(filteredHistory));
                
                // é‡æ–°æ¸²æŸ“å†å²è®°å½•
                toggleHistory();
                toggleHistory();
                scheduleUserStatsUpdate();
            } catch (error) {
                console.error('ç§»é™¤å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’­æ”¾å†å²å—ï¼Ÿ')) {
                localStorage.removeItem('videoPlayHistory');
                toggleHistory();
                toggleHistory();
                showToast('å†å²è®°å½•å·²æ¸…ç©º');
                scheduleUserStatsUpdate();
            }
        }
        
        // åˆ‡æ¢Hostè®¾ç½®æ¨¡æ€æ¡†
        function toggleHostModal() {
            const willOpen = hostModal.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(hostModal);
            hostModal.classList.toggle('translate-x-full');
            updateOverlayForPanels();

            if (willOpen) {
                hostInput.value = host;
                updateHostNameDisplay(host);
                updateCustomTypeSelect();
                hostInput.focus();
                fetchOfficialApis(false);
                renderHostHistory();
                renderTransferHistory();
            }
        }

        function showHostModal() {
            if (!hostModal) return;
            if (hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
        }
        
        // ä¿å­˜Hostè®¾ç½®
        function saveHost() {
            const input = hostInput.value.trim();
            
            if (!input) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„Hoståœ°å€');
                return;
            }
            
            // éªŒè¯URLæ ¼å¼
            try {
                new URL(input);
            } catch (e) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„URLæ ¼å¼');
                return;
            }
            
            host = input;
            localStorage.setItem('apiHost', host);
            hostName = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            const rawCategory = getOfficialCategoryByUrl(host);
            if (rawCategory) {
                const officialCategory = normalizeCategory(rawCategory);
                if (officialCategory === 'normal' || officialCategory === 'adult') {
                    localStorage.setItem(OFFICIAL_API_TYPE_KEY, officialCategory);
                    switchOfficialTab(officialCategory);
                }
            } else if (customTypeSelect) {
                const manualType = customTypeSelect.value;
                if (manualType === 'normal' || manualType === 'adult') {
                    localStorage.setItem(CUSTOM_API_TYPE_KEY, manualType);
                }
            }
            saveHostHistory(host);
            updateHostNameDisplay(host);
            updateCustomTypeSelect();
            
            toggleHostModal();
            showToast('Hostè®¾ç½®å·²ä¿å­˜');
            
            // å¦‚æœä¹‹å‰å› ä¸ºæ²¡æœ‰Hostè€Œæ— æ³•åŠ è½½æ•°æ®ï¼Œç°åœ¨é‡æ–°åŠ è½½
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }
        
        // é‡ç½®Hostè®¾ç½®
        function resetHost() {
            host = '';
            hostName = '';
            hostInput.value = '';
            localStorage.removeItem('apiHost');
            localStorage.removeItem('apiHostName');
            updateHostNameDisplay('');
            updateCustomTypeSelect();
            showToast('Hostå·²é‡ç½®');
        }

        // èšåˆæœç´¢å¼€å…³
        function isAggregateSearchEnabled() {
            return localStorage.getItem('aggregateSearch') === '1';
        }

        function toggleAggregateSearch() {
            if (!aggregateSwitch) return;
            const enabled = !!aggregateSwitch.checked;
            if (enabled) {
                const selected = getAggregateApiSelection();
                if (selected.length < 2) {
                    aggregateSwitch.checked = false;
                    updateAggregateSwitchUI(false);
                    showToast('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ¥å£åå†å¼€å¯èšåˆæœç´¢');
                    return;
                }
            }
            localStorage.setItem('aggregateSearch', enabled ? '1' : '0');
            updateAggregateSwitchUI(enabled);
            if (enabled) {
                fetchOfficialApis(false);
                renderAggregateApiSelection(officialApiCache ? officialApiCache.data : []);
                if (aggregateApiSection && aggregateApiSection.classList.contains('hidden')) {
                    aggregateApiSection.classList.remove('hidden');
                    if (aggregateApiToggleButton) {
                        aggregateApiToggleButton.textContent = 'æ”¶èµ·';
                    }
                }
                showToast('å·²å¼€å¯èšåˆæœç´¢');
            } else {
                showToast('å·²å…³é—­èšåˆæœç´¢');
            }
        }

        function confirmAggregateSelection() {
            const selected = getAggregateApiSelection();
            if (selected.length < 2) {
                showToast('è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ¥å£åå†ä¿å­˜');
                if (aggregateApiSection && aggregateApiSection.classList.contains('hidden')) {
                    aggregateApiSection.classList.remove('hidden');
                }
                return;
            }
            showToast('èšåˆæ¥å£å·²ä¿å­˜');
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
        }

        function toggleAggregateApiSection() {
            if (!aggregateApiSection) return;
            fetchOfficialApis(false);
            aggregateApiSection.classList.toggle('hidden');
            if (aggregateApiToggleButton) {
                aggregateApiToggleButton.textContent = aggregateApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function switchAggregateTab(type) {
            const adultTab = document.getElementById('aggregateTabAdult');
            const normalTab = document.getElementById('aggregateTabNormal');
            if (aggregateApiListAdult) aggregateApiListAdult.classList.toggle('hidden', type !== 'adult');
            if (aggregateApiListNormal) aggregateApiListNormal.classList.toggle('hidden', type !== 'normal');
            if (adultTab) {
                adultTab.classList.toggle('bg-white', type === 'adult');
                adultTab.classList.toggle('shadow', type === 'adult');
                adultTab.classList.toggle('text-gray-800', type === 'adult');
                adultTab.classList.toggle('text-gray-600', type !== 'adult');
            }
            if (normalTab) {
                normalTab.classList.toggle('bg-white', type === 'normal');
                normalTab.classList.toggle('shadow', type === 'normal');
                normalTab.classList.toggle('text-gray-800', type === 'normal');
                normalTab.classList.toggle('text-gray-600', type !== 'normal');
            }
        }

        function toggleOfficialApiSection() {
            if (!officialApiSection) return;
            officialApiSection.classList.toggle('hidden');
            if (officialApiToggleButton) {
                officialApiToggleButton.textContent = officialApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function switchOfficialTab(type) {
            const adultTab = document.getElementById('officialTabAdult');
            const normalTab = document.getElementById('officialTabNormal');
            if (officialApiListAdult) officialApiListAdult.classList.toggle('hidden', type !== 'adult');
            if (officialApiListNormal) officialApiListNormal.classList.toggle('hidden', type !== 'normal');
            if (adultTab) {
                adultTab.classList.toggle('bg-white', type === 'adult');
                adultTab.classList.toggle('shadow', type === 'adult');
                adultTab.classList.toggle('text-gray-800', type === 'adult');
                adultTab.classList.toggle('text-gray-600', type !== 'adult');
            }
            if (normalTab) {
                normalTab.classList.toggle('bg-white', type === 'normal');
                normalTab.classList.toggle('shadow', type === 'normal');
                normalTab.classList.toggle('text-gray-800', type === 'normal');
                normalTab.classList.toggle('text-gray-600', type !== 'normal');
            }
        }

        function getDefaultOfficialTab() {
            const savedType = localStorage.getItem(OFFICIAL_API_TYPE_KEY);
            if (savedType === 'normal' || savedType === 'adult') return savedType;
            const category = getCurrentHostCategory();
            return category === 'normal' ? 'normal' : 'adult';
        }

        function updateAggregateSwitchUI(enabled) {
            if (!aggregateSwitch) return;
            const track = aggregateSwitch.nextElementSibling;
            if (!track) return;
            const thumb = track.firstElementChild;
            track.classList.toggle('bg-primary', enabled);
            track.classList.toggle('bg-gray-300', !enabled);
            if (thumb) {
                thumb.classList.toggle('translate-x-4', enabled);
                thumb.classList.toggle('translate-x-0', !enabled);
            }
            updateSearchButtonLabel(enabled);
        }

        function isPrivacyModeEnabled() {
            const value = localStorage.getItem('privacyMode');
            if (value === null) return true;
            return value === '1';
        }

        function togglePrivacyMode() {
            if (!privacySwitch) return;
            const enabled = !!privacySwitch.checked;
            localStorage.setItem('privacyMode', enabled ? '1' : '0');
            updatePrivacySwitchUI(enabled);
            applyPrivacyMode(enabled);
            showToast(enabled ? 'å·²å¼€å¯éšç§é®æŒ¡' : 'å·²å…³é—­éšç§é®æŒ¡');
        }

        function updatePrivacySwitchUI(enabled) {
            if (!privacySwitch) return;
            const track = privacySwitch.nextElementSibling;
            if (!track) return;
            const thumb = track.firstElementChild;
            track.classList.toggle('bg-primary', enabled);
            track.classList.toggle('bg-gray-300', !enabled);
            if (thumb) {
                thumb.classList.toggle('translate-x-4', enabled);
                thumb.classList.toggle('translate-x-0', !enabled);
            }
        }

        function applyPrivacyMode(enabled) {
            document.body.classList.toggle('privacy-on', !!enabled);
        }

        function updateSearchButtonLabel(aggregateEnabled) {
            const label = aggregateEnabled ? 'èšåˆæœç´¢' : 'æœç´¢';
            const desktopLabel = document.getElementById('searchButtonLabel');
            const mobileLabel = document.getElementById('searchButtonLabelMobile');
            if (desktopLabel) desktopLabel.textContent = label;
            if (mobileLabel) mobileLabel.textContent = label;
        }

        function toggleMobileSearch() {
            const box = document.getElementById('mobileSearchBox');
            if (!box) return;
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                if (searchInputMobile) searchInputMobile.focus();
            }
        }

        // å¯¼å‡º/å¯¼å…¥å–œæ¬¢ã€å†å²ã€æ˜µç§°ä¸æœç´¢è®°å½•
        function exportUserData() {
            const favorites = JSON.parse(localStorage.getItem('videoFavorites') || '[]');
            const playHistory = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const userNickname = localStorage.getItem('userNickname') || '';
            const playbackResume = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '{}');
            const payload = {
                favorites,
                playHistory,
                searchHistory,
                userNickname,
                playbackResume
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            a.download = `video-data-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            addTransferHistory('å¯¼å‡º', a.download);
            showToast('å¯¼å‡ºæˆåŠŸ');
        }

        function importUserData(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result || '{}');
                    if (data.favorites && Array.isArray(data.favorites)) {
                        setFavoritesCache(data.favorites);
                    } else {
                        setFavoritesCache([]);
                    }
                    if (data.playHistory && Array.isArray(data.playHistory)) {
                        localStorage.setItem('videoPlayHistory', JSON.stringify(data.playHistory));
                    } else {
                        localStorage.setItem('videoPlayHistory', JSON.stringify([]));
                    }
                    if (data.searchHistory && Array.isArray(data.searchHistory)) {
                        localStorage.setItem('searchHistory', JSON.stringify(data.searchHistory));
                    } else {
                        localStorage.setItem('searchHistory', JSON.stringify([]));
                    }
                    // ç”¨æˆ·æ˜µç§°å·²æ”¹ä¸ºè´¦å·èµ„æ–™ï¼Œä¸å†æœ¬åœ°ä¿å­˜
                    if (data.playbackResume && typeof data.playbackResume === 'object') {
                        localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify(data.playbackResume));
                    } else {
                        localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify({}));
                    }
                    renderUserInfo({ skipStatsFetch: true });
                    addTransferHistory('å¯¼å…¥', file.name);
                    showToast('å¯¼å…¥æˆåŠŸ');
                    scheduleUserStatsUpdate();
                } catch (e) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function getTransferHistory() {
            return JSON.parse(localStorage.getItem('transferHistory') || '[]');
        }

        function addTransferHistory(type, filename) {
            const history = getTransferHistory();
            history.unshift({
                type,
                filename: filename || '',
                timestamp: Date.now()
            });
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('transferHistory', JSON.stringify(history));
            renderTransferHistory();
        }

        function renderTransferHistory() {
            if (!transferHistoryList) return;
            const history = getTransferHistory();
            if (history.length === 0) {
                transferHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— è®°å½•</div>
                `;
                return;
            }
            transferHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.type} Â· ${formatDate(item.timestamp)}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.filename || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function handleActionSelect(value) {
            if (!value) return;
            if (value === 'favorite') {
                toggleFavorites();
            } else if (value === 'share') {
                toggleSharePanel();
            } else if (value === 'history') {
                toggleHistory();
            } else if (value === 'user') {
                toggleUserInfo();
            } else if (value === 'setting') {
                toggleHostModal();
            } else if (value === 'about') {
                toggleAboutPanel();
            }
            const select = document.getElementById('actionSelect');
            if (select) select.value = '';
        }

        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            if (!menu) return;
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                menu.addEventListener('mouseleave', handleMoreMenuMouseLeave, { once: true });
            }
        }

        function handleMoreAction(action) {
            if (action === 'favorite') {
                toggleFavorites();
            } else if (action === 'share') {
                toggleSharePanel();
            } else if (action === 'history') {
                toggleHistory();
            } else if (action === 'user') {
                toggleUserInfo();
            } else if (action === 'setting') {
                toggleHostModal();
            } else if (action === 'about') {
                toggleAboutPanel();
            }
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        function handleMoreMenuMouseLeave() {
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        let currentUserProfile = null;
        let currentUserStats = null;

        async function fetchUserProfile() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return null;
            try {
                const res = await fetch('/user/profile', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                if (data && data.code === 200 && data.data) {
                    currentUserProfile = data.data;
                    if (Array.isArray(currentUserProfile.visitHistory)) {
                        localStorage.setItem('visitHistory', JSON.stringify(currentUserProfile.visitHistory));
                    }
                    return currentUserProfile;
                }
            } catch (e) {
                // ignore
            }
            return null;
        }

        async function fetchUserStats() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return null;
            try {
                const res = await fetch('/user/stats', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                if (data && data.code === 200 && data.data) {
                    currentUserStats = data.data;
                    return currentUserStats;
                }
            } catch (e) {
                // ignore
            }
            return null;
        }

        async function renderUserInfo(options = {}) {
            if (!userInfoContent) return;
            const nicknameDisplay = document.getElementById('userNicknameDisplay');
            const nicknameButton = document.getElementById('userNicknameButton');
            const nicknameInput = document.getElementById('userNicknameInput');
            const nicknameEditor = document.getElementById('userNicknameEditor');
            const noteDisplay = document.getElementById('userNoteDisplay');
            const noteInput = document.getElementById('userNoteInput');
            const logoutBtn = document.querySelector('[data-action="logout"]');
            const rangeSelect = document.getElementById('visitRangeSelect');
            const skipStatsFetch = !!options.skipStatsFetch;
            if (nicknameDisplay) {
                nicknameDisplay.innerHTML = `
                    <span class="inline-flex items-center space-x-2 text-gray-500">
                        <span class="w-3 h-3 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></span>
                        <span>åŠ è½½ä¸­...</span>
                    </span>
                `;
            }
            if (nicknameButton) {
                nicknameButton.textContent = 'åŠ è½½ä¸­...';
            }
            if (nicknameEditor) {
                nicknameEditor.classList.add('hidden');
            }
            if (nicknameInput) {
                nicknameInput.disabled = true;
            }
            if (noteInput) {
                noteInput.disabled = true;
            }
            if (logoutBtn) {
                logoutBtn.disabled = true;
            }
            let profile = currentUserProfile;
            let stats = currentUserStats;
            if (!profile) {
                const token = getUserToken ? getUserToken() : '';
                if (token) {
                    profile = await fetchUserProfile();
                    if (!skipStatsFetch) {
                        // stats fetch disabled; keep cached stats
                    }
                }
            }
            const nicknameText = profile ? (profile.nickname || profile.username || 'æœªç™»å½•') : 'æœªç™»å½•';
            if (nicknameDisplay) {
                nicknameDisplay.textContent = nicknameText;
            }
            if (nicknameButton) {
                nicknameButton.textContent = nicknameText;
            }
            if (profile && profile.avatar) {
                localStorage.setItem(USER_AVATAR_KEY, String(profile.avatar));
            }
            applyAvatarFromStorage();
            if (nicknameInput) {
                nicknameInput.value = profile ? (profile.nickname || profile.username || '') : '';
                nicknameInput.disabled = false;
            }
            const noteValue = profile ? (profile.profileNote || profile.note || '') : '';
            if (noteInput) {
                noteInput.value = noteValue;
                noteInput.disabled = false;
            }
            if (noteDisplay) {
                noteDisplay.textContent = noteValue || 'ç‚¹å‡»å¡«å†™å¤‡æ³¨';
            }
            if (logoutBtn) {
                logoutBtn.disabled = !profile;
            }
            if (rangeSelect) {
                rangeSelect.onchange = () => {
                    setVisitRangeDays(rangeSelect.value);
                    renderUserInfo({ skipStatsFetch: true });
                };
            }
            const favoriteCountEl = document.getElementById('userFavoriteCount');
            const shareCountEl = document.getElementById('userShareCount');
            const historyCountEl = document.getElementById('userHistoryCount');
            const searchCountEl = document.getElementById('userSearchCount');
            const watchTodayEl = document.getElementById('userWatchToday');
            let favoriteCount = Math.max(0, Number(stats?.favoriteCount || 0));
            let shareCount = Math.max(0, Number(stats?.shareCount || 0));
            let historyCount = Math.max(0, Number(stats?.historyCount || 0));
            let searchCount = Math.max(0, Number(stats?.searchCount || 0));
            let watchSeconds = Math.max(0, Number(stats?.watchSeconds || 0));
            const lastVisitEl = document.getElementById('userLastVisit');
            if (lastVisitEl) {
                const historyList = Array.isArray(profile?.visitHistory) && profile.visitHistory.length > 0
                    ? normalizeVisitHistory(profile.visitHistory)
                    : normalizeVisitHistory(JSON.parse(localStorage.getItem('visitHistory') || '[]'));
                const rangeDays = getVisitRangeDays();
                if (rangeSelect) {
                    rangeSelect.value = String(rangeDays);
                }
                const cutoff = Date.now() - rangeDays * 24 * 60 * 60 * 1000;
                const filteredHistory = historyList.filter((item) => item.time >= cutoff);
                if (!filteredHistory || filteredHistory.length === 0) {
                    lastVisitEl.textContent = 'é¦–æ¬¡è®¿é—®';
                } else {
                    const groups = new Map();
                    filteredHistory.forEach((entry) => {
                        const dayKey = formatDateOnly(entry.time) || 'æœªçŸ¥æ—¥æœŸ';
                        if (!groups.has(dayKey)) groups.set(dayKey, []);
                        groups.get(dayKey).push(entry);
                    });
                    const html = Array.from(groups.entries()).map(([day, entries]) => {
                        const itemsHtml = entries.map((entry) => {
                            const timeText = formatDate(Number(entry.time));
                            const ipText = escapeHtml(formatIp(entry.ip));
                            const uaText = escapeHtml(detectClientLabel(entry.userAgent));
                            return `<div class="text-[11px] text-gray-600 leading-5">${timeText} Â· ${ipText} Â· ${uaText}</div>`;
                        }).join('');
                        return `
                            <div class="space-y-1">
                                <div class="text-xs text-gray-500">${day}</div>
                                ${itemsHtml}
                            </div>
                        `;
                    }).join('');
                    lastVisitEl.innerHTML = html;
                }
            }
            if (skipStatsFetch) {
                refreshLocalStatsDisplay();
                return;
            }
            if (favoriteCountEl) favoriteCountEl.textContent = String(favoriteCount);
            if (shareCountEl) shareCountEl.textContent = String(shareCount);
            if (historyCountEl) historyCountEl.textContent = String(historyCount);
            if (searchCountEl) searchCountEl.textContent = String(searchCount);
            if (watchTodayEl) watchTodayEl.textContent = formatDuration(watchSeconds);
        }

        async function saveUserNickname() {
            const nicknameInput = document.getElementById('userNicknameInput');
            const saveButton = document.getElementById('userNicknameSave');
            const nicknameEditor = document.getElementById('userNicknameEditor');
            if (!nicknameInput) return;
            const value = nicknameInput.value.trim();
            const token = getUserToken ? getUserToken() : '';
            if (!token) {
                showToast('è¯·å…ˆç™»å½•');
                return;
            }
            if (!currentUserProfile) {
                await fetchUserProfile();
            }
            if (!currentUserProfile || !currentUserProfile._id) {
                showToast('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            const currentName = String(currentUserProfile.nickname || currentUserProfile.username || '').trim();
            if (value === currentName) {
                showToast('æ˜µç§°æœªä¿®æ”¹');
                return;
            }
            const originalText = saveButton ? saveButton.textContent : '';
            if (saveButton) {
                saveButton.innerHTML = '<span class="inline-flex items-center space-x-2"><span class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span><span>ä¿å­˜ä¸­...</span></span>';
                saveButton.disabled = true;
            }
            let success = false;
            try {
                const res = await fetch(`/user/${currentUserProfile._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ nickname: value })
                });
                const data = await res.json();
                if (data && data.code === 200) {
                    success = true;
                }
            } catch (e) {
                success = false;
            }
            if (success) {
                if (currentUserProfile) {
                    currentUserProfile.nickname = value;
                }
                await renderUserInfo({ skipStatsFetch: true });
                showToast('æ˜µç§°å·²ä¿å­˜');
            } else {
                nicknameInput.value = currentName || '';
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.textContent = originalText || 'ä¿å­˜';
            }
            if (nicknameEditor) {
                nicknameEditor.classList.add('hidden');
            }
        }

        async function saveUserNote() {
            const noteInput = document.getElementById('userNoteInput');
            const noteDisplay = document.getElementById('userNoteDisplay');
            if (!noteInput) return;
            const value = noteInput.value.trim();
            const token = getUserToken ? getUserToken() : '';
            if (!token) {
                showToast('è¯·å…ˆç™»å½•');
                return;
            }
            if (!currentUserProfile) {
                await fetchUserProfile();
            }
            if (!currentUserProfile || !currentUserProfile._id) {
                showToast('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            const currentNote = String(currentUserProfile.profileNote || '').trim();
            if (value === currentNote) {
                return;
            }
            const res = await fetch(`/user/${currentUserProfile._id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                body: JSON.stringify({ profileNote: value })
            });
            try {
                const data = await res.json();
                if (data && data.code === 200 && data.data) {
                    currentUserProfile = data.data;
                } else if (currentUserProfile) {
                    currentUserProfile.profileNote = value;
                }
            } catch (e) {
                if (currentUserProfile) currentUserProfile.profileNote = value;
            }
            if (noteInput) noteInput.value = value;
            await renderUserInfo({ skipStatsFetch: true });
            showToast('å¤‡æ³¨å·²ä¿å­˜');
            if (noteInput) noteInput.classList.add('hidden');
            if (noteDisplay) noteDisplay.classList.remove('hidden');
        }

        function generateRandomNickname() {
            const adjectives = ['æ¸…é£', 'æ˜Ÿæ²³', 'æ™¨æ›¦', 'å¤œèˆª', 'è¿œå±±', 'æ˜¥é›¨', 'è“é²¸', 'å¾®å…‰', 'ç™½éœ²', 'æ™šæ™´'];
            const nouns = ['æ—…äºº', 'è§‚å½±è€…', 'æ¢è·¯è€…', 'è¿½å…‰è€…', 'å°å±‹', 'ç”µå°', 'é£é“ƒ', 'å²›å±¿', 'é•¿æ­Œ', 'ç¢ç‰‡'];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 900) + 100;
            return `${adjective}${noun}${number}`;
        }

        async function setRandomNickname() {
            const nicknameInput = document.getElementById('userNicknameInput');
            if (!nicknameInput) return;
            const value = generateRandomNickname();
            nicknameInput.value = value;
            await saveUserNickname();
        }

        let noteSaveTimer = null;
        const handleUserNoteBlur = () => {
            if (noteSaveTimer) clearTimeout(noteSaveTimer);
            noteSaveTimer = setTimeout(() => {
                const noteInput = document.getElementById('userNoteInput');
                const noteDisplay = document.getElementById('userNoteDisplay');
                if (!noteInput) return;
                const value = noteInput.value.trim();
                const currentNote = String(currentUserProfile?.profileNote || currentUserProfile?.note || '').trim();
                if (value === currentNote) {
                    noteInput.classList.add('hidden');
                    if (noteDisplay) {
                        noteDisplay.textContent = value || 'ç‚¹å‡»å¡«å†™å¤‡æ³¨';
                        noteDisplay.classList.remove('hidden');
                    }
                    return;
                }
                saveUserNote();
            }, 200);
        };

        const bindUserNoteAutoSave = () => {
            const noteInput = document.getElementById('userNoteInput');
            if (!noteInput || noteInput.dataset.bound === '1') return;
            noteInput.addEventListener('blur', handleUserNoteBlur);
            noteInput.dataset.bound = '1';
        };

        const bindUserNicknameAutoSave = () => {
            const nicknameInput = document.getElementById('userNicknameInput');
            if (!nicknameInput || nicknameInput.dataset.bound === '1') return;
            nicknameInput.addEventListener('blur', () => {
                const value = nicknameInput.value.trim();
                const currentName = String(currentUserProfile?.nickname || currentUserProfile?.username || '').trim();
                if (value === currentName) {
                    hideNicknameEditor();
                    return;
                }
                saveUserNickname();
            });
            nicknameInput.dataset.bound = '1';
        };

        function showNicknameEditor() {
            const nicknameEditor = document.getElementById('userNicknameEditor');
            if (nicknameEditor) nicknameEditor.classList.remove('hidden');
        }

        function hideNicknameEditor() {
            const nicknameEditor = document.getElementById('userNicknameEditor');
            if (nicknameEditor) nicknameEditor.classList.add('hidden');
        }

        function showNoteEditor() {
            const noteInput = document.getElementById('userNoteInput');
            const noteDisplay = document.getElementById('userNoteDisplay');
            if (noteInput) noteInput.classList.remove('hidden');
            if (noteDisplay) noteDisplay.classList.add('hidden');
            if (noteInput) noteInput.focus();
        }

        async function logoutUser() {
            const logoutBtn = document.querySelector('[data-action="logout"]');
            const originalHtml = logoutBtn ? logoutBtn.innerHTML : '';
            if (logoutBtn) {
                logoutBtn.innerHTML = '<span class="inline-flex items-center space-x-2"><span class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin"></span><span>é€€å‡ºä¸­...</span></span>';
                logoutBtn.disabled = true;
            }
            const token = getUserToken ? getUserToken() : '';
            if (token) {
                try {
                    await fetch('/user/logout', {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${token}` }
                    });
                } catch (e) {
                    // ignore
                }
            }
            if (typeof revokeAccess === 'function') {
                revokeAccess('å·²é€€å‡ºï¼Œè¯·é‡æ–°ç™»å½•');
            } else if (typeof clearUserToken === 'function') {
                clearUserToken();
            }
            localStorage.removeItem(USER_AVATAR_KEY);
            applyAvatarFromStorage();
            currentUserProfile = null;
            renderUserInfo({ skipStatsFetch: true });
            if (logoutBtn) {
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = originalHtml;
            }
        }

        bindUserNoteAutoSave();
        bindUserNicknameAutoSave();

        function toggleUserInfo() {
            if (!userPanel) return;
            renderUserInfo({ skipStatsFetch: true });
            fetchVisitHistoryOnce().then(() => {
                renderUserInfo({ skipStatsFetch: true });
            });
            const willOpen = userPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(userPanel);
            userPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        function toggleAboutPanel() {
            if (!aboutPanel) return;
            const willOpen = aboutPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(aboutPanel);
            aboutPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        // å®˜æ–¹æ¨èæ¥å£
        let officialApiCache = null;

        function setOfficialApiLoading(messageHtml) {
            if (officialApiListAdult) officialApiListAdult.innerHTML = messageHtml;
            if (officialApiListNormal) officialApiListNormal.innerHTML = messageHtml;
        }

        function getOfficialListSignature(list) {
            if (!Array.isArray(list)) return '';
            const normalized = list
                .filter(item => item && (item.url || item.name))
                .map(item => ({
                    name: String(item.name || '').trim(),
                    url: String(item.url || '').trim(),
                    category: normalizeCategory(item.category || ''),
                    type: String(item.type || '').trim()
                }))
                .sort((a, b) => {
                    const keyA = `${a.url}||${a.name}`;
                    const keyB = `${b.url}||${b.name}`;
                    return keyA.localeCompare(keyB);
                });
            return JSON.stringify(normalized);
        }

        function syncOfficialApiListCache(remoteList) {
            if (!Array.isArray(remoteList)) return;
            const remoteSignature = getOfficialListSignature(remoteList);
            let localSignature = '';
            try {
                localSignature = localStorage.getItem(OFFICIAL_API_LIST_SIGNATURE_KEY) || '';
            } catch (e) {
                localSignature = '';
            }
            if (remoteSignature && remoteSignature !== localSignature) {
                try {
                    localStorage.setItem(OFFICIAL_API_LIST_KEY, JSON.stringify(remoteList));
                    localStorage.setItem(OFFICIAL_API_LIST_SIGNATURE_KEY, remoteSignature);
                } catch (e) {
                    // ignore storage errors
                }
            }
        }

        function fetchOfficialApis(force) {
            if (!officialApiListAdult && !officialApiListNormal) return;
            if (officialApiCache && !force) {
                renderOfficialApis(officialApiCache);
                return;
            }
            
            setOfficialApiLoading(`<div class="text-xs text-gray-500">æ­£åœ¨è·å–å®˜æ–¹æ¨è...</div>`);
            
            const userToken = getUserToken ? getUserToken() : '';
            fetch(getOfficialApiUrl(), {
                headers: userToken ? { Authorization: `Bearer ${userToken}` } : {}
            })
                .then(res => {
                    if (res.status === 401) {
                        setOfficialApiLoading(`<div class="text-xs text-red-500">è®¿é—®å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯</div>`);
                        revokeAccess('è®¿é—®å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                        throw new Error('unauthorized');
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || data.code !== 200 || !Array.isArray(data.data)) {
                        throw new Error('å®˜æ–¹æ¥å£è¿”å›å¼‚å¸¸');
                    }
                    syncOfficialApiListCache(data.data);
                    officialApiCache = data;
                    renderOfficialApis(data);
                })
                .catch(err => {
                    if (err && err.message === 'unauthorized') {
                        return;
                    }
                    console.error('è·å–å®˜æ–¹æ¥å£å¤±è´¥:', err);
                    setOfficialApiLoading(`<div class="text-xs text-red-500">è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>`);
                });
        }

        function renderOfficialApis(data) {
            if (!data || !Array.isArray(data.data)) {
                setOfficialApiLoading(`<div class="text-xs text-gray-500">æš‚æ— å®˜æ–¹æ¨è</div>`);
                if (officialApiCount) {
                    officialApiCount.textContent = '0';
                }
                if (officialApiCountAdult) {
                    officialApiCountAdult.textContent = '0';
                }
                if (officialApiCountNormal) {
                    officialApiCountNormal.textContent = '0';
                }
                if (officialApiCountAdult2) {
                    officialApiCountAdult2.textContent = '0';
                }
                if (officialApiCountNormal2) {
                    officialApiCountNormal2.textContent = '0';
                }
                if (officialApiCount2) {
                    officialApiCount2.textContent = '0';
                }
                if (aggregateApiList) {
                    aggregateApiList.innerHTML = `
                        <div class="text-xs text-gray-500">æš‚æ— å¯é€‰æ¥å£</div>
                    `;
                }
                return;
            }

            syncOfficialApiListCache(data.data);
            
            const metaText = [data.title, data.subtitle].filter(Boolean).join(' Â· ');
            const metaHtml = metaText
                ? `<div class="text-xs text-gray-500 mb-2">${metaText}</div>`
                : '';

            const grouped = data.data.reduce((acc, item) => {
                const category = normalizeCategory(item.category);
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});

            const renderItems = (list) => list.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.name || 'å®˜æ–¹æ¨è'}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                    </div>
                    <button 
                        onclick="selectHost('${item.url || ''}', '${item.name || ''}')"
                        class="text-xs text-primary hover:underline whitespace-nowrap shrink-0 ml-2 inline-flex items-center"
                    >ä½¿ç”¨</button>
                </div>
            `).join('');

            const adultList = grouped.adult || [];
            const normalList = grouped.normal || [];

            if (officialApiCount) {
                officialApiCount.textContent = String(data.data.length);
            }
                if (officialApiCountAdult) {
                    officialApiCountAdult.textContent = String(adultList.length);
                }
                if (officialApiCountNormal) {
                    officialApiCountNormal.textContent = String(normalList.length);
                }
                if (officialApiCountAdult2) {
                    officialApiCountAdult2.textContent = String(adultList.length);
                }
                if (officialApiCountNormal2) {
                    officialApiCountNormal2.textContent = String(normalList.length);
                }
                if (officialApiCount2) {
                    officialApiCount2.textContent = String(data.data.length);
                }

            if (officialApiListAdult) {
                officialApiListAdult.innerHTML = `
                    ${metaHtml}
                    ${adultList.length ? renderItems(adultList) : '<div class="text-xs text-gray-500">æš‚æ— æ‘©è¥¿æ¥å£</div>'}
                `;
            }
            if (officialApiListNormal) {
                officialApiListNormal.innerHTML = `
                    ${metaHtml}
                    ${normalList.length ? renderItems(normalList) : '<div class="text-xs text-gray-500">æš‚æ— æ™®é€šæ¥å£</div>'}
                `;
            }

            renderAggregateApiSelection(data.data);
            const latestOfficialName = getOfficialNameByUrl(host);
            if (host && latestOfficialName) {
                const savedName = localStorage.getItem('apiHostName') || '';
                if (latestOfficialName !== savedName) {
                    hostName = latestOfficialName;
                    localStorage.setItem('apiHostName', latestOfficialName);
                }
            }
            updateHostNameDisplay(host);
            updateCustomTypeSelect();
        }

        async function getOfficialApis() {
            if (officialApiCache && Array.isArray(officialApiCache.data)) {
                const cached = officialApiCache.data.filter(item => item && item.url);
                ensureDefaultAggregateSelection(cached);
                return cached;
            }
            const token = getUserToken ? getUserToken() : '';
            const res = await fetch(getOfficialApiUrl(), {
                headers: token ? { Authorization: `Bearer ${token}` } : {}
            });
            const data = await res.json();
            if (data && data.code === 200 && Array.isArray(data.data)) {
                syncOfficialApiListCache(data.data);
                officialApiCache = data;
                ensureDefaultAggregateSelection(data.data);
                renderAggregateApiSelection(data.data);
                return data.data.filter(item => item && item.url);
            }
            return [];
        }

        function getOfficialLabel(item) {
            if (item && item.name) return item.name;
            if (item && item.url) return getHostNameFromUrl(item.url);
            return 'å®˜æ–¹æ¨è';
        }

        function getAggregateApiSelection() {
            try {
                const raw = localStorage.getItem('aggregateApiSelection');
                const list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function getAggregateApiSelectionNames() {
            try {
                const raw = localStorage.getItem('aggregateApiSelectionNames');
                const list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function setAggregateApiSelection(urls) {
            const unique = Array.from(new Set((urls || []).filter(Boolean)));
            localStorage.setItem('aggregateApiSelection', JSON.stringify(unique));
            if (aggregateSelectedCount) {
                aggregateSelectedCount.textContent = String(unique.length);
            }
        }

        function setAggregateApiSelectionNames(names) {
            const unique = Array.from(new Set((names || []).filter(Boolean)));
            localStorage.setItem('aggregateApiSelectionNames', JSON.stringify(unique));
        }

        function setAggregateSelectionCleared(cleared) {
            localStorage.setItem('aggregateSelectionCleared', cleared ? '1' : '0');
        }

        function isAggregateSelectionCleared() {
            return localStorage.getItem('aggregateSelectionCleared') === '1';
        }

        function resolveAggregateSelection(apis) {
            const selectedUrls = getAggregateApiSelection();
            const list = (apis || []).filter(item => item && item.url);
            if (selectedUrls.length > 0) {
                setAggregateSelectionCleared(false);
                const urlSet = new Set(list.map(item => item.url));
                const matched = selectedUrls.filter(url => urlSet.has(url));
                if (matched.length > 0) {
                    if (matched.length !== selectedUrls.length) {
                        setAggregateApiSelection(matched);
                    }
                    return matched;
                }
            }
            if (isAggregateSelectionCleared()) return [];
            const names = getAggregateApiSelectionNames();
            if (!names.length) return [];
            if (list.length === 0) return [];
            const nameMap = new Map(list.map(item => [item.name || '', item.url]));
            const resolved = names.map(name => nameMap.get(name)).filter(Boolean);
            if (resolved.length > 0) {
                setAggregateApiSelection(resolved);
            }
            return resolved;
        }

        function ensureDefaultAggregateSelection(apis) {
            const current = resolveAggregateSelection(apis);
            if (current.length > 0) return current;
            if (isAggregateSelectionCleared()) return [];
            const list = (apis || []).filter(item => item && item.url);
            const defaults = list.slice(0, 3).map(item => item.url).filter(Boolean);
            const defaultNames = list.slice(0, 3).map(item => item.name).filter(Boolean);
            setAggregateApiSelection(defaults);
            setAggregateApiSelectionNames(defaultNames);
            return defaults;
        }

        function renderAggregateApiSelection(apis) {
            if (!aggregateApiListAdult || !aggregateApiListNormal) return;
            const list = (apis || []).filter(item => item && item.url);
            if (list.length === 0) {
                const emptyHtml = `<div class="text-xs text-gray-500">æš‚æ— å¯é€‰æ¥å£</div>`;
                aggregateApiListAdult.innerHTML = emptyHtml;
                aggregateApiListNormal.innerHTML = emptyHtml;
                if (aggregateSelectedCount) {
                    aggregateSelectedCount.textContent = '0';
                }
                return;
            }
            const selected = ensureDefaultAggregateSelection(list);
            if (aggregateSelectedCount) {
                aggregateSelectedCount.textContent = String(selected.length);
            }
            const grouped = list.reduce((acc, item) => {
                const category = normalizeCategory(item.category);
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});
            const renderItems = (items) => items.map(item => {
                const checked = selected.includes(item.url) ? 'checked' : '';
                return `
                    <label class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                        <div class="min-w-0 mr-2">
                            <div class="text-xs text-gray-700 truncate">${item.name || 'å®˜æ–¹æ¨è'}</div>
                            <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                        </div>
                        <input 
                            type="checkbox" 
                            class="w-4 h-4"
                            ${checked}
                            onchange="toggleAggregateApi('${item.url}', '${item.name || ''}')"
                        >
                    </label>
                `;
            }).join('');
            const adultList = grouped.adult || [];
            const normalList = grouped.normal || [];
            aggregateApiListAdult.innerHTML = adultList.length ? renderItems(adultList) : `<div class="text-xs text-gray-500">æš‚æ— æ‘©è¥¿æ¥å£</div>`;
            aggregateApiListNormal.innerHTML = normalList.length ? renderItems(normalList) : `<div class="text-xs text-gray-500">æš‚æ— æ™®é€šæ¥å£</div>`;
        }

        function toggleAggregateApi(url, name = '') {
            const selected = getAggregateApiSelection();
            const selectedNames = getAggregateApiSelectionNames();
            const index = selected.indexOf(url);
            if (index >= 0) {
                selected.splice(index, 1);
                const nameIndex = selectedNames.indexOf(name);
                if (nameIndex >= 0) selectedNames.splice(nameIndex, 1);
            } else {
                selected.push(url);
                if (name) selectedNames.push(name);
            }
            setAggregateSelectionCleared(false);
            setAggregateApiSelection(selected);
            setAggregateApiSelectionNames(selectedNames);
        }

        function selectAllAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const urls = list.map(item => item.url).filter(Boolean);
            const names = list.map(item => item.name).filter(Boolean);
            setAggregateSelectionCleared(false);
            setAggregateApiSelection(urls);
            setAggregateApiSelectionNames(names);
            renderAggregateApiSelection(list);
        }

        function clearAggregateApis() {
            setAggregateSelectionCleared(true);
            setAggregateApiSelection([]);
            setAggregateApiSelectionNames([]);
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            renderAggregateApiSelection(list);
        }

        function resetAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const defaults = list.slice(0, 3).map(item => item.url).filter(Boolean);
            const defaultNames = list.slice(0, 3).map(item => item.name).filter(Boolean);
            setAggregateSelectionCleared(false);
            setAggregateApiSelection(defaults);
            setAggregateApiSelectionNames(defaultNames);
            renderAggregateApiSelection(list);
        }

        // Hostå†å²è®°å½•
        function getHostHistory() {
            return JSON.parse(localStorage.getItem('hostHistory') || '[]');
        }

        function saveHostHistory(value) {
            const history = getHostHistory();
            const existingIndex = history.findIndex(item => item === value);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(value);
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('hostHistory', JSON.stringify(history));
        }

        function renderHostHistory() {
            const history = getHostHistory();
            if (history.length === 0) {
                hostHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— å†å²è®°å½•</div>
                `;
                return;
            }
            hostHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="text-xs text-gray-700 truncate mr-2">${item}</div>
                    <div class="flex items-center space-x-2">
                        <button 
                            onclick="selectHost('${item}', '')"
                            class="text-xs text-primary hover:underline"
                        >ä½¿ç”¨</button>
                        <button 
                            onclick="removeHostHistory('${item}')"
                            class="text-xs text-gray-500 hover:text-red-500"
                        >åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleHostHistory() {
            hostHistoryWrap.classList.toggle('hidden');
            if (!hostHistoryWrap.classList.contains('hidden')) {
                renderHostHistory();
            }
            if (hostHistoryToggleButton) {
                hostHistoryToggleButton.textContent = hostHistoryWrap.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function getManualHostType() {
            const value = localStorage.getItem(CUSTOM_API_TYPE_KEY);
            return value === 'normal' || value === 'adult' ? value : 'adult';
        }

        function updateCustomTypeSelect() {
            if (!customTypeSelect) return;
            const officialName = getOfficialNameByUrl(host);
            const rawCategory = getOfficialCategoryByUrl(host);
            const isOfficial = !!officialName || !!rawCategory;
            if (isOfficial) {
                const officialCategory = normalizeCategory(rawCategory);
                if (officialCategory === 'normal' || officialCategory === 'adult') {
                    customTypeSelect.value = officialCategory;
                } else {
                    const savedType = localStorage.getItem(OFFICIAL_API_TYPE_KEY);
                    customTypeSelect.value = savedType === 'normal' || savedType === 'adult' ? savedType : 'adult';
                }
                customTypeSelect.disabled = true;
                customTypeSelect.classList.add('opacity-60', 'cursor-not-allowed');
                return;
            }
            customTypeSelect.disabled = false;
            customTypeSelect.classList.remove('opacity-60', 'cursor-not-allowed');
            customTypeSelect.value = getManualHostType();
        }

        function selectHost(value, name = '') {
            hostInput.value = value;
            host = value;
            localStorage.setItem('apiHost', host);
            hostName = name || getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            const rawCategory = getOfficialCategoryByUrl(host);
            const officialCategory = normalizeCategory(rawCategory);
            if (rawCategory && (officialCategory === 'normal' || officialCategory === 'adult')) {
                localStorage.setItem(OFFICIAL_API_TYPE_KEY, officialCategory);
                switchOfficialTab(officialCategory);
            } else if (customTypeSelect) {
                const manualType = customTypeSelect.value;
                if (manualType === 'normal' || manualType === 'adult') {
                    localStorage.setItem(CUSTOM_API_TYPE_KEY, manualType);
                }
            }
            updateHostNameDisplay(host);
            updateCustomTypeSelect();
            saveHostHistory(host);
            showToast('å·²åˆ‡æ¢Host');
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }

        function getCurrentHostDisplayName(url) {
            if (!url) return 'æœªè®¾ç½®';
            const officialName = getOfficialNameByUrl(url);
            if (officialName) {
                const category = normalizeCategory(getOfficialCategoryByUrl(url));
                const savedType = localStorage.getItem(OFFICIAL_API_TYPE_KEY);
                const typeValue = category === 'normal' || category === 'adult'
                    ? category
                    : (savedType === 'normal' || savedType === 'adult' ? savedType : '');
                const typeLabel = typeValue === 'normal' ? 'æ™®é€š' : (typeValue === 'adult' ? 'æ‘©è¥¿' : '');
                return typeLabel ? `${officialName}Â·${typeLabel}` : officialName;
            }
            const savedName = hostName || localStorage.getItem('apiHostName') || '';
            if (savedName) {
                const savedType = localStorage.getItem(CUSTOM_API_TYPE_KEY) || localStorage.getItem(OFFICIAL_API_TYPE_KEY);
                const typeLabel = savedType === 'normal' ? 'æ™®é€š' : (savedType === 'adult' ? 'æ‘©è¥¿' : '');
                return typeLabel ? `${savedName}Â·${typeLabel}` : savedName;
            }
            return 'è‡ªå®šä¹‰';
        }

        function updateHostNameDisplay(url) {
            if (!hostNameDisplay) return;
            hostNameDisplay.textContent = getCurrentHostDisplayName(url);
        }

        function getHostNameFromUrl(url) {
            try {
                const hostname = new URL(url).hostname;
                return hostname.replace(/^www\./, '');
            } catch (e) {
                return '';
            }
        }

        function getHostLabel() {
            if (hostName) return hostName;
            const name = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            return name || 'æœªçŸ¥æ¥æº';
        }

        function normalizeCategory(value) {
            const raw = String(value || '').toLowerCase();
            if (!raw) return 'adult';
            if (raw.includes('normal') || raw.includes('common') || raw.includes('æ™®é€š')) return 'normal';
            if (raw.includes('adult') || raw.includes('18') || raw.includes('sex') || raw.includes('æˆäºº')) return 'adult';
            return raw === 'vod' ? 'adult' : raw;
        }

        function getOfficialCategoryByUrl(url) {
            if (!url) return '';
            const list = officialApiCache && Array.isArray(officialApiCache.data)
                ? officialApiCache.data
                : (() => {
                    try {
                        const raw = localStorage.getItem(OFFICIAL_API_LIST_KEY);
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                })();
            const match = (list || []).find(item => item && item.url === url);
            return match && match.category ? match.category : '';
        }

        function getOfficialCategoryByName(name) {
            if (!name) return '';
            const list = officialApiCache && Array.isArray(officialApiCache.data)
                ? officialApiCache.data
                : (() => {
                    try {
                        const raw = localStorage.getItem(OFFICIAL_API_LIST_KEY);
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                })();
            const match = (list || []).find(item => item && item.name === name);
            return match && match.category ? match.category : '';
        }

        function getCurrentHostCategory() {
            const rawCategory = getOfficialCategoryByUrl(host);
            if (rawCategory) {
                const category = normalizeCategory(rawCategory);
                if (category === 'normal' || category === 'adult') return category;
            }
            const customType = localStorage.getItem(CUSTOM_API_TYPE_KEY);
            if (customType === 'normal' || customType === 'adult') return customType;
            const savedType = localStorage.getItem(OFFICIAL_API_TYPE_KEY);
            return savedType === 'normal' || savedType === 'adult' ? savedType : 'adult';
        }

        function getOfficialNameByUrl(url) {
            if (!url) return '';
            const list = officialApiCache && Array.isArray(officialApiCache.data)
                ? officialApiCache.data
                : (() => {
                    try {
                        const raw = localStorage.getItem(OFFICIAL_API_LIST_KEY);
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                })();
            const match = (list || []).find(item => item && item.url === url);
            return match && match.name ? match.name : '';
        }

        function removeHostHistory(value) {
            const history = getHostHistory().filter(item => item !== value);
            localStorage.setItem('hostHistory', JSON.stringify(history));
            renderHostHistory();
        }
        

        
        // åˆ†äº«è§†é¢‘
        const SHARE_LIST_KEY = 'videoShareList';
        const SHARE_LIST_MAX = 100;

        function getShareList() {
            try {
                const raw = localStorage.getItem(SHARE_LIST_KEY);
                const list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function setShareList(list) {
            const safe = Array.isArray(list) ? list : [];
            try {
                localStorage.setItem(SHARE_LIST_KEY, JSON.stringify(safe));
            } catch (e) {
                // ignore storage errors
            }
        }

        async function loadRemoteShares() {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return null;
            try {
                const res = await fetch('/user/shares', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                if (data && data.code === 200 && Array.isArray(data.data)) {
                    const mapped = data.data.map(item => ({
                        id: item.shareId,
                        url: item.url,
                        title: item.title,
                        pic: item.pic || '',
                        source: item.source || '',
                        viewCount: Number(item.viewCount || 0),
                        lastViewAt: Number(item.lastViewAt || 0),
                        expireSeconds: Number(item.expireSeconds || 0),
                        expiresAt: Number(item.expiresAt || 0),
                        createdAt: Number(item.createdAt || Date.now()),
                        updatedAt: Number(item.updatedAt || Date.now())
                    }));
                    setShareList(mapped);
                    shareListLoaded = true;
                    refreshLocalStatsDisplay();
                    return mapped;
                }
            } catch (e) {
                // ignore
            }
            return null;
        }

        function base64Url(value) {
            try {
                return btoa(unescape(encodeURIComponent(String(value || ''))))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/g, '');
            } catch (e) {
                return String(Date.now());
            }
        }

        function getShareId(url, title, source = '') {
            return `s_${base64Url(`${title || ''}|${source || ''}`)}`;
        }

        function normalizeShareItem(item) {
            if (!item) return null;
            const url = String(item.url || '').trim();
            if (!url) return null;
            const title = String(item.title || 'æœªå‘½å').trim();
            const pic = String(item.pic || '').trim();
            const source = String(item.source || '').trim();
            const id = item.id || getShareId(url, title, source);
            const createdAt = Number(item.createdAt || item.timestamp || Date.now());
            const expireSeconds = Number.isFinite(item.expireSeconds) ? item.expireSeconds : 0;
            const expiresAt = Number.isFinite(item.expiresAt)
                ? item.expiresAt
                : (expireSeconds > 0 ? createdAt + expireSeconds * 1000 : 0);
            const viewCountRaw = Number(item.viewCount);
            const viewCount = Number.isFinite(viewCountRaw) ? viewCountRaw : undefined;
            const lastViewAtRaw = Number(item.lastViewAt);
            const lastViewAt = Number.isFinite(lastViewAtRaw) && lastViewAtRaw > 0 ? lastViewAtRaw : undefined;
            const shareUrl = item.shareUrl || buildShareUrl(url, title, pic, source, expireSeconds, id);
            return {
                id,
                url,
                title,
                pic,
                source,
                createdAt,
                updatedAt: Number(item.updatedAt || createdAt),
                viewCount,
                lastViewAt,
                expireSeconds,
                expiresAt,
                shareUrl
            };
        }

        function saveShareItem(payload, options = {}) {
            const item = normalizeShareItem(payload);
            if (!item) return;
            let list = getShareList().map(normalizeShareItem).filter(Boolean);
            list = list.filter(entry => entry.id !== item.id && entry.url !== item.url);
            const index = list.findIndex(entry => entry.id === item.id);
            if (index >= 0) {
                list[index] = { ...list[index], ...item, updatedAt: Date.now() };
            } else {
                list.unshift({ ...item, updatedAt: Date.now() });
            }
            if (list.length > SHARE_LIST_MAX) {
                list.splice(SHARE_LIST_MAX);
            }
            setShareList(list);
            if (sharePanel && !sharePanel.classList.contains('translate-x-full')) {
                renderShareContent(list);
            }
            const token = getUserToken ? getUserToken() : '';
            if (token && !options.skipRemote) {
                fetch('/user/shares', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({
                        shareId: item.id,
                        url: item.url,
                        title: item.title,
                        pic: item.pic || '',
                        source: item.source || '',
                        expireSeconds: item.expireSeconds || 0,
                        expiresAt: item.expiresAt || 0
                    })
                }).catch(() => {});
            }
        }

        function encodeSharePayload(fields) {
            const payload = (fields || [])
                .map(value => encodeURIComponent(value || ''))
                .join('|');
            return btoa(payload);
        }

        function getShareExpireSeconds() {
            if (!shareExpireSelect) return 0;
            const value = Number(shareExpireSelect.value || 0);
            return Number.isFinite(value) ? value : 0;
        }

        function buildShareUrl(videoUrl, videoTitle, videoPic, sourceLabel, expireSeconds, shareId = '') {
            const now = Date.now();
            const expiresAt = expireSeconds > 0 ? now + expireSeconds * 1000 : 0;
            const pathname = window.location.pathname || '/';
            const isFilePath = pathname.split('/').pop().includes('.');
            const basePath = pathname.endsWith('/')
                ? pathname
                : (isFilePath ? pathname.replace(/[^/]*$/, '') : `${pathname}/`);
            const url = new URL(window.location.origin);
            url.pathname = `${basePath}play.html`;
            if (shareId) {
                url.searchParams.set('sid', shareId);
            }
            return url.toString();
        }

        function setShareCopyLabel(label) {
            const btn = shareModal ? shareModal.querySelector('button[onclick="copyShareUrl()"]') : null;
            if (btn) {
                btn.innerHTML = `<i class="fa fa-${label.includes('å¤åˆ¶') ? 'copy' : 'link'} mr-1"></i> ${label}`;
            }
        }

        function setShareConfirmState(state) {
            if (!shareConfirmButton) return;
            if (state === 'ready') {
                shareConfirmButton.disabled = false;
                shareConfirmButton.classList.remove('opacity-60');
                shareConfirmButton.innerHTML = '<i class="fa fa-check mr-1"></i> ç¡®è®¤ç”Ÿæˆåˆ†äº«';
            } else if (state === 'done') {
                shareConfirmButton.disabled = true;
                shareConfirmButton.classList.add('opacity-60');
                shareConfirmButton.innerHTML = '<i class="fa fa-check mr-1"></i> å·²ç”Ÿæˆ';
            } else if (state === 'loading') {
                shareConfirmButton.disabled = true;
                shareConfirmButton.classList.add('opacity-60');
                shareConfirmButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> ç”Ÿæˆä¸­...';
            }
        }

        function getShareEpisodeMode() {
            const radios = document.querySelectorAll('input[name="shareEpisodeMode"]');
            for (const radio of radios) {
                if (radio.checked) return radio.value;
            }
            return 'all';
        }

        function renderShareEpisodeList(episodes) {
            if (!shareEpisodeList) return;
            shareEpisodeList.innerHTML = episodes.map((ep, idx) => `
                <label class="flex items-center space-x-2 text-xs w-full">
                    <input type="checkbox" value="${idx}">
                    <span class="truncate">${ep.name || `ç¬¬${idx + 1}é›†`}</span>
                </label>
            `).join('');
        }

        function toggleShareEpisodeList(show) {
            if (!shareEpisodeList) return;
            shareEpisodeList.classList.toggle('hidden', !show);
            const actions = document.getElementById('shareEpisodeActions');
            if (actions) actions.classList.toggle('hidden', !show);
        }

        function setShareEpisodeChecks(checked) {
            if (!shareEpisodeList) return;
            shareEpisodeList.querySelectorAll('input[type="checkbox"]').forEach((input) => {
                input.checked = !!checked;
            });
        }

        function prepareShareSelection(episodes, currentIndex) {
            if (!shareEpisodeSection || !shareEpisodeList) return;
            pendingShareEpisodes = episodes || [];
            pendingShareCurrentIndex = Number.isFinite(currentIndex) ? currentIndex : 0;
            if (pendingShareEpisodes.length <= 1) {
                shareEpisodeSection.classList.add('hidden');
                shareEpisodeList.innerHTML = '';
                return;
            }
            shareEpisodeSection.classList.remove('hidden');
            renderShareEpisodeList(pendingShareEpisodes);
            toggleShareEpisodeList(false);
            const radios = document.querySelectorAll('input[name="shareEpisodeMode"]');
            radios.forEach((radio) => {
                if (radio.value === 'all') radio.checked = true;
            });
            setShareConfirmState('ready');
            currentShareUrl = '';
        }

        function setShareMode(value) {
            const radios = document.querySelectorAll('input[name="shareEpisodeMode"]');
            radios.forEach((radio) => {
                radio.checked = radio.value === value;
            });
            toggleShareEpisodeList(value === 'custom');
        }

        function collectSelectedEpisodes() {
            const mode = getShareEpisodeMode();
            if (pendingShareEpisodes.length <= 1) return pendingShareEpisodes;
            if (mode === 'current') {
                return pendingShareEpisodes[pendingShareCurrentIndex] ? [pendingShareEpisodes[pendingShareCurrentIndex]] : [];
            }
            if (mode === 'custom') {
                if (!shareEpisodeList) return [];
                const checks = Array.from(shareEpisodeList.querySelectorAll('input[type="checkbox"]'));
                const indices = checks.filter(c => c.checked).map(c => Number(c.value));
                return indices.map(idx => pendingShareEpisodes[idx]).filter(Boolean);
            }
            return pendingShareEpisodes;
        }

        function buildEpisodeUrl(episodes) {
            if (!episodes || episodes.length === 0) return '';
            if (episodes.length === 1) return episodes[0].url || '';
            return episodes.map(ep => `${ep.name || ''}$${ep.url || ''}`).join('#');
        }

        function openShareModal(shareUrl) {
            if (!shareModal) return;
            currentShareUrl = shareUrl;
            shareModal.classList.remove('hidden');
            shareModal.classList.add('flex');
            setShareCopyLabel(currentShareUrl ? 'ç‚¹å‡»å¤åˆ¶åœ°å€' : 'ç”Ÿæˆåˆ†äº«é“¾æ¥');
            setShareConfirmState(currentShareUrl ? 'done' : 'ready');
            showToast('åˆ†äº«é¢æ¿å·²æ‰“å¼€');
        }

        function closeShareModal() {
            if (!shareModal) return;
            shareModal.classList.add('hidden');
            shareModal.classList.remove('flex');
        }

        async function copyShareUrl() {
            if (!currentShareUrl) {
                showToast('è¯·å…ˆç‚¹å‡»â€œç¡®è®¤ç”Ÿæˆåˆ†äº«â€');
                return;
            }
            try {
                navigator.clipboard.writeText(currentShareUrl).then(() => {
                    showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', currentShareUrl);
                });
            } catch (err) {
                prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', currentShareUrl);
            }
        }

        async function createShortShare(payload) {
            const token = getUserToken ? getUserToken() : '';
            if (!token) return '';
            try {
                const res = await fetch('/user/shares', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data && data.code === 200 && data.data && data.data.shareId) {
                    return String(data.data.shareId);
                }
            } catch (e) {
                // ignore
            }
            return '';
        }

        async function createShareFromSelection() {
            if (!currentSharePayload) return false;
            const expireSeconds = getShareExpireSeconds();
            const selected = collectSelectedEpisodes();
            if (pendingShareEpisodes.length > 1 && selected.length === 0) {
                showToast('è¯·é€‰æ‹©è¦åˆ†äº«çš„é›†æ•°');
                return false;
            }
            const url = selected.length > 0 ? buildEpisodeUrl(selected) : currentSharePayload.url;
            const baseTitle = String(currentSharePayload.title || '').trim();
            const singleEp = selected.length === 1 ? selected[0] : null;
            const shouldAppendEpisode = pendingShareEpisodes.length > 1;
            const title = singleEp && singleEp.name && shouldAppendEpisode
                ? (baseTitle ? `${baseTitle} ${singleEp.name}` : singleEp.name)
                : baseTitle || 'åˆ†äº«è§†é¢‘';
            setShareConfirmState('loading');
            const shareId = currentShareId || getShareId(url, title, currentSharePayload.source || '');
            const shortId = await createShortShare({
                shareId,
                url,
                title,
                pic: currentSharePayload.pic || '',
                source: currentSharePayload.source || '',
                expireSeconds,
                expiresAt: expireSeconds > 0 ? Date.now() + expireSeconds * 1000 : 0
            });
            if (!shortId) {
                showToast('ç”ŸæˆçŸ­é“¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                setShareConfirmState('ready');
                return false;
            }
            currentShareId = shortId;
            currentShareUrl = buildShareUrl(url, title, currentSharePayload.pic || '', currentSharePayload.source || '', expireSeconds, shortId);
            saveShareItem({
                id: currentShareId,
                url,
                title,
                pic: currentSharePayload.pic || '',
                source: currentSharePayload.source || '',
                expireSeconds,
                expiresAt: expireSeconds > 0 ? Date.now() + expireSeconds * 1000 : 0,
                shareUrl: currentShareUrl,
                createdAt: Date.now()
            }, { skipRemote: true });
            setShareCopyLabel('ç‚¹å‡»å¤åˆ¶åœ°å€');
            setShareConfirmState('done');
            return true;
        }

        async function confirmShareSelection() {
            if (currentShareUrl) {
                showToast('å·²ç”Ÿæˆåˆ†äº«é“¾æ¥');
                return;
            }
            await createShareFromSelection();
        }

        async function shareVideo(videoUrl, videoTitle, videoPic = '', sourceLabel = '', currentIndex = 0) {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const expireSeconds = getShareExpireSeconds();
            const token = getUserToken ? getUserToken() : '';
            if (!token) {
                showToast('åˆ†äº«éœ€ç™»å½•åä½¿ç”¨');
                openAuthModal();
                return;
            }
            currentSharePayload = {
                url: realVideoUrl,
                title: videoTitle,
                pic: videoPic || '',
                source: sourceLabel || ''
            };
            const episodes = parsePlayUrls(videoUrl);
            prepareShareSelection(episodes, currentIndex);
            currentShareUrl = '';
            currentShareId = '';
            isShareEditing = false;
            openShareModal('');
        }

        function refreshShareUrlFromSelection() {
            if (!currentSharePayload || !currentShareId) return;
            const expireSeconds = getShareExpireSeconds();
            currentShareUrl = buildShareUrl(
                currentSharePayload.url,
                currentSharePayload.title,
                currentSharePayload.pic || '',
                currentSharePayload.source || '',
                expireSeconds,
                currentShareId
            );
            if (currentShareId) {
                updateShareExpire(currentShareId, expireSeconds);
            }
        }

        function openShareEditModal(itemId) {
            const list = getShareList().map(normalizeShareItem).filter(Boolean);
            const item = list.find(entry => entry.id === itemId);
            if (!item) {
                showToast('åˆ†äº«è®°å½•ä¸å­˜åœ¨');
                return;
            }
            currentSharePayload = {
                url: item.url,
                title: item.title,
                pic: item.pic || '',
                source: item.source || ''
            };
            currentShareId = item.id;
            currentShareUrl = '';
            isShareEditing = true;
            if (shareExpireSelect) {
                const value = String(item.expireSeconds || 0);
                Array.from(shareExpireSelect.options).forEach(opt => {
                    opt.selected = opt.value === value;
                });
            }
            const episodes = parsePlayUrls(item.url);
            prepareShareSelection(episodes, 0);
            if (episodes.length > 1) {
                setShareMode('custom');
                setShareEpisodeChecks(true);
            }
            openShareModal('');
        }

        // æ’­æ”¾å™¨å†…åˆ†äº«å½“å‰è§†é¢‘
        async function shareCurrentVideo() {
            if (!currentVideoUrl) {
                showToast('æš‚æ— å¯åˆ†äº«çš„è§†é¢‘');
                return;
            }
            const rawUrl = currentVideoRawUrl || currentVideoUrl;
            await shareVideo(rawUrl, currentVideoTitle || 'è§†é¢‘æ’­æ”¾', currentVideoPic || '', currentVideoSource || getHostLabel(), currentEpisodeIndex);
        }

        // æ’­æ”¾å™¨å†…å–œæ¬¢/å–æ¶ˆå–œæ¬¢
        async function toggleCurrentVideoFavorite() {
            if (!currentVideoUrl) {
                showToast('æš‚æ— å¯æ“ä½œçš„è§†é¢‘');
                return;
            }
            const token = getUserToken ? getUserToken() : '';
            ensureFavoritesCacheImmediate();
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === currentVideoUrl);

            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                setFavoritesCache(favorites);
                showToast('å·²å–æ¶ˆå–œæ¬¢');
                updatePlayerLikeButtons(false);
                updateCardFavoriteByUrl(currentVideoUrl, false);
                if (token) {
                    fetch('/user/favorites', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify({ url: currentVideoUrl })
                    }).catch(() => {});
                }
            } else {
                const source = currentVideoSource || getHostLabel();
                const item = {
                    title: currentVideoTitle || 'è§†é¢‘æ’­æ”¾',
                    url: currentVideoUrl,
                    pic: currentVideoPic || '',
                    source: source || '',
                    timestamp: Date.now()
                };
                favorites.unshift(item);
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                setFavoritesCache(favorites);
                showToast('å·²åŠ å…¥å–œæ¬¢');
                updatePlayerLikeButtons(true);
                updateCardFavoriteByUrl(currentVideoUrl, true);
                if (token) {
                    fetch('/user/favorites', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                        body: JSON.stringify(item)
                    }).catch(() => {});
                }
            }
        }

        function updateCardFavoriteByUrl(rawUrl, isLiked) {
            if (!rawUrl) return;
            const realUrl = rawUrl.split('$')[1] || rawUrl;
            const cards = document.querySelectorAll('.video-card');
            cards.forEach(card => {
                if (!card) return;
                const cardUrl = card.getAttribute('data-video-url');
                if (!cardUrl) return;
                const normalized = cardUrl.split('$')[1] || cardUrl;
                if (normalized !== realUrl) return;
                const btn = card.querySelector('[data-action="favorite"]');
                if (btn) updateFavoriteButton(btn, isLiked);
            });
        }

        function updatePlayerLikeButtons(isLiked) {
            const desktopBtn = document.getElementById('likeVideoButton');
            const mobileBtn = document.getElementById('likeVideoButtonMobile');
            [desktopBtn, mobileBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.toggle('bg-red-600', isLiked);
                btn.classList.toggle('bg-gray-600', !isLiked);
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'}${btn.id === 'likeVideoButtonMobile' ? ' text-xl' : ''}`;
                }
            });
        }
        
        // åˆ†äº«å›é€€æ–¹æ¡ˆ
        function fallbackShare(url) {
            try {
                // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(url).then(() => {
                    showToast('è§†é¢‘é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
                    prompt('è¯·å¤åˆ¶è§†é¢‘é“¾æ¥:', url);
                });
            } catch (err) {
                prompt('è¯·å¤åˆ¶è§†é¢‘é“¾æ¥:', url);
            }
        }
        
        // åˆ‡æ¢ç”»ä¸­ç”»æ¨¡å¼
        function togglePictureInPicture() {
            if (!dplayer || !dplayer.video) return;
            
            if (document.pictureInPictureElement) {
                // é€€å‡ºç”»ä¸­ç”»æ¨¡å¼
                document.exitPictureInPicture().then(() => {
                    showToast('å·²é€€å‡ºç”»ä¸­ç”»æ¨¡å¼');
                }).catch(err => {
                    console.error('é€€å‡ºç”»ä¸­ç”»å¤±è´¥:', err);
                    showToast('é€€å‡ºç”»ä¸­ç”»å¤±è´¥');
                });
            } else {
                // è¿›å…¥ç”»ä¸­ç”»æ¨¡å¼
                if (document.pictureInPictureEnabled) {
                    dplayer.video.requestPictureInPicture().then(() => {
                        showToast('å·²è¿›å…¥ç”»ä¸­ç”»æ¨¡å¼');
                    }).catch(err => {
                        console.error('è¿›å…¥ç”»ä¸­ç”»å¤±è´¥:', err);
                        showToast('è¿›å…¥ç”»ä¸­ç”»å¤±è´¥');
                    });
                } else {
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç”»ä¸­ç”»åŠŸèƒ½');
                }
            }
        }
        
        // æ»šåŠ¨å¤„ç†
        let loadMoreDelayTimer = null;
        let loadMoreCountdownTimer = null;
        function handleScroll() {
            // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
            if (window.scrollY > 300) {
                floatingButtons.classList.remove('hidden');
            } else {
                floatingButtons.classList.add('hidden');
            }
            
            // æ— é™æ»šåŠ¨åŠ è½½æ›´å¤š
            if (window.innerHeight + window.scrollY >= document.body.scrollHeight - 200) {
                if (hasMore && !isLoading) {
                    showLoadMoreButton();
                    if (loadMoreDelayTimer) return;
                    let countdown = 3;
                    setLoadMoreButtonCountdown(countdown);
                    loadMoreCountdownTimer = setInterval(() => {
                        countdown -= 1;
                        if (countdown > 0) {
                            setLoadMoreButtonCountdown(countdown);
                        }
                    }, 1000);
                    loadMoreDelayTimer = setTimeout(() => {
                        loadMoreDelayTimer = null;
                        if (loadMoreCountdownTimer) {
                            clearInterval(loadMoreCountdownTimer);
                            loadMoreCountdownTimer = null;
                        }
                        loadMoreButton.innerHTML = `
                            <span>åŠ è½½ä¸­...</span>
                            <i class="fa fa-refresh fa-spin"></i>
                        `;
                        if (!hasMore || isLoading) return;
                        if (window.innerHeight + window.scrollY >= document.body.scrollHeight - 200) {
                            loadMoreData();
                        }
                    }, 3000);
                }
            } else if (loadMoreDelayTimer) {
                clearTimeout(loadMoreDelayTimer);
                loadMoreDelayTimer = null;
                if (loadMoreCountdownTimer) {
                    clearInterval(loadMoreCountdownTimer);
                    loadMoreCountdownTimer = null;
                }
                setLoadMoreButtonCountdown(0);
            }
        }
        
        // å›åˆ°é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(text = 'åŠ è½½ä¸­...') {
            loadingText.textContent = text;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            videoList.innerHTML = '';
            emptyState.classList.remove('hidden');
            hideLoadMoreButton();
        }

        function hideEmptyState() {
            emptyState.classList.add('hidden');
        }
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showErrorState(message, options = {}) {
            hideEmptyState();
            const showRetry = options.showRetry !== false;
            const retryHtml = showRetry
                ? `<button onclick="loadInitialData()" class="btn-primary">
                        <i class="fa fa-refresh mr-1"></i> é‡è¯•
                    </button>`
                : '';
            videoList.innerHTML = `
                <div class="col-span-full text-center py-16">
                    <i class="fa fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">åŠ è½½å¤±è´¥</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    ${retryHtml}
                </div>
            `;
            hideLoadMoreButton();
        }
        
        // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
        function showLoadMoreButton() {
            loadMoreButton.classList.remove('hidden');
        }

        function setLoadMoreButtonCountdown(seconds) {
            if (!loadMoreButton) return;
            if (!Number.isFinite(seconds) || seconds <= 0) {
                loadMoreButton.innerHTML = `
                    <span>åŠ è½½æ›´å¤š</span>
                    <i class="fa fa-refresh"></i>
                `;
                return;
            }
            loadMoreButton.innerHTML = `
                <span>å€’è®¡æ—¶ ${seconds}s</span>
                <i class="fa fa-refresh fa-spin"></i>
            `;
        }
        
        // éšè—åŠ è½½æ›´å¤šæŒ‰é’®
        function hideLoadMoreButton() {
            loadMoreButton.classList.add('hidden');
        }
        
        function getPanels() {
            return [historyPanel, favoritePanel, sharePanel, userPanel, aboutPanel, hostModal].filter(Boolean);
        }

        function updateOverlayForPanels() {
            const anyOpen = getPanels().some(panel => !panel.classList.contains('translate-x-full'));
            overlay.classList.toggle('hidden', !anyOpen);
        }

        function closePanelsExcept(activePanel) {
            getPanels().forEach(panel => {
                if (panel !== activePanel) panel.classList.add('translate-x-full');
            });
        }

        // å…³é—­æ‰€æœ‰é¢æ¿
        function closeAllPanels() {
            getPanels().forEach(panel => panel.classList.add('translate-x-full'));
            overlay.classList.add('hidden');
        }

        function getShareExpireLabel(expiresAt) {
            if (!expiresAt || expiresAt === 0) return 'æ°¸ä¹…';
            const diff = expiresAt - Date.now();
            if (diff <= 0) return 'å·²è¿‡æœŸ';
            const minutes = Math.ceil(diff / 60000);
            if (minutes < 60) return `${minutes}åˆ†é’Ÿåè¿‡æœŸ`;
            const hours = Math.ceil(diff / 3600000);
            if (hours < 24) return `${hours}å°æ—¶åè¿‡æœŸ`;
            const days = Math.ceil(diff / 86400000);
            return `${days}å¤©åè¿‡æœŸ`;
        }

        function renderShareContent(list) {
            if (!shareContent) return;
            const shares = Array.isArray(list) ? list.map(normalizeShareItem).filter(Boolean) : [];
            shares.sort((a, b) => {
                const aLast = Number(a.lastViewAt || 0);
                const bLast = Number(b.lastViewAt || 0);
                if (bLast !== aLast) return bLast - aLast;
                return Number(b.createdAt || 0) - Number(a.createdAt || 0);
            });
            if (shares.length === 0) {
                shareContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-share-alt text-4xl mb-3"></i>
                        <p>æš‚æ— åˆ†äº«å†…å®¹</p>
                    </div>
                `;
                return;
            }
            shareContent.innerHTML = shares.map(item => {
                const statusText = getShareExpireLabel(item.expiresAt);
                const statusClass = statusText === 'å·²è¿‡æœŸ' ? 'text-red-500' : 'text-gray-500';
                return `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0 cursor-pointer" data-preview-group="share" data-preview-url="${item.pic || FALLBACK_IMAGE}" data-preview-title="${item.title || ''}" data-preview-video-url="${item.url || ''}" data-preview-source="${item.source || ''}" onclick="openPreviewFromGroup(this)">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';" loading="lazy" class="w-full h-full object-cover">`
                                    : `<img src="${FALLBACK_IMAGE}" alt="loading" loading="lazy" class="w-full h-full object-cover">`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || 'æœªçŸ¥æ¥æº'}</span>
                                    ${item.title}
                                </h4>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                                    <span>åˆ†äº«æ—¶é—´: ${formatDate(item.createdAt)}</span>
                                    <span>æŸ¥çœ‹æ¬¡æ•°: ${Number.isFinite(item.viewCount) ? item.viewCount : 0}</span>
                                    <span>æœ€è¿‘æŸ¥çœ‹: ${item.lastViewAt ? formatDate(item.lastViewAt) : '-'}</span>
                                    <span class="${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 space-y-2">
                            <label class="block text-xs text-gray-500">æœ‰æ•ˆæ—¶é—´</label>
                            <div class="flex items-center space-x-2">
                                <select class="input-primary flex-[2] text-xs" onchange="updateShareExpire('${item.id}', this.value)">
                                    <option value="1800" ${Number(item.expireSeconds) === 1800 ? 'selected' : ''}>30åˆ†é’Ÿ</option>
                                    <option value="7200" ${Number(item.expireSeconds) === 7200 ? 'selected' : ''}>2å°æ—¶</option>
                                    <option value="86400" ${Number(item.expireSeconds) === 86400 ? 'selected' : ''}>1å¤©</option>
                                    <option value="604800" ${Number(item.expireSeconds) === 604800 ? 'selected' : ''}>7å¤©</option>
                                    <option value="0" ${Number(item.expireSeconds) === 0 ? 'selected' : ''}>æ°¸ä¹…</option>
                                </select>
                                <button onclick="copyShareLink('${item.id}')" class="btn-secondary text-xs px-3 flex-[1]">
                                    <i class="fa fa-copy mr-1"></i> å¤åˆ¶
                                </button>
                                <button onclick="openShareEditModal('${item.id}')" class="btn-secondary text-xs px-3 flex-[1]">
                                    <i class="fa fa-edit mr-1"></i> ä¿®æ”¹
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <button 
                                    onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                                    class="btn-primary text-xs py-1 px-2 flex-1"
                                >
                                    <i class="fa fa-play mr-1"></i> æ’­æ”¾
                                </button>
                                <button 
                                    onclick="cancelShare('${item.id}')"
                                    class="text-gray-500 hover:text-red-500 p-1 ml-2"
                                    title="å–æ¶ˆåˆ†äº«"
                                >
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleSharePanel() {
            if (!sharePanel) return;
            const willOpen = sharePanel.classList.contains('translate-x-full');
            if (!willOpen) {
                sharePanel.classList.add('translate-x-full');
                updateOverlayForPanels();
                return;
            }
            shareContent.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="inline-flex items-center space-x-2">
                        <span class="w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"></span>
                        <span>åŠ è½½ä¸­...</span>
                    </span>
                </div>
            `;
            closePanelsExcept(sharePanel);
            sharePanel.classList.remove('translate-x-full');
            updateOverlayForPanels();
            let remote = null;
            if (!shareListLoaded) {
                remote = await loadRemoteShares();
            }
            const shares = (remote || getShareList()).map(normalizeShareItem).filter(Boolean);
            renderShareContent(shares);
        }

        function updateShareExpire(id, seconds) {
            const list = getShareList().map(normalizeShareItem).filter(Boolean);
            const target = list.find(item => item.id === id);
            if (!target) return;
            const expireSeconds = Number(seconds || 0);
            const now = Date.now();
            target.expireSeconds = Number.isFinite(expireSeconds) ? expireSeconds : 0;
            target.expiresAt = target.expireSeconds > 0 ? now + target.expireSeconds * 1000 : 0;
            target.shareUrl = buildShareUrl(target.url, target.title, target.pic, target.source, target.expireSeconds, target.id);
            target.updatedAt = now;
            setShareList(list);
            renderShareContent(list);
            showToast('å·²æ›´æ–°åˆ†äº«æœ‰æ•ˆæœŸ');
            const token = getUserToken ? getUserToken() : '';
            if (token) {
                fetch(`/user/shares/${encodeURIComponent(id)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
                    body: JSON.stringify({ expireSeconds: target.expireSeconds })
                }).catch(() => {});
            }
        }

        function copyShareLink(id) {
            const list = getShareList().map(normalizeShareItem).filter(Boolean);
            const target = list.find(item => item.id === id);
            if (!target || !target.shareUrl) return;
            try {
                navigator.clipboard.writeText(target.shareUrl).then(() => {
                    showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', target.shareUrl);
                });
            } catch (err) {
                prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', target.shareUrl);
            }
        }

        function cancelShare(id) {
            const list = getShareList().map(normalizeShareItem).filter(Boolean);
            const next = list.filter(item => item.id !== id);
            setShareList(next);
            renderShareContent(next);
            showToast('å·²å–æ¶ˆåˆ†äº«');
            const token = getUserToken ? getUserToken() : '';
            if (token) {
                fetch(`/user/shares/${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${token}` }
                }).catch(() => {});
            }
        }

        
        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-[90]';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // å°äº1å°æ—¶
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return minutes <= 1 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`;
            }
            
            // å°äº24å°æ—¶
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}å°æ—¶å‰`;
            }
            
            // å°äº7å¤©
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days}å¤©å‰`;
            }
            
            // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå…·ä½“æ—¥æœŸ
            return date.toLocaleDateString('zh-CN');
        }

        function formatDuration(seconds) {
            if (!Number.isFinite(seconds) || seconds <= 0) return '00:00';
            const total = Math.floor(seconds);
            const hours = Math.floor(total / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            const secs = total % 60;
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        

    </script>
    <script src="/assets/login-guard.js"></script>
  <script src="/assets/page-permission.js"></script>
  </body>
</html>
