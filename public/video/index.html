<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æœç´¢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">
    <!-- hls.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#f59e0b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {

            .glass-effect {
                @apply backdrop-blur-md bg-white/80 border border-white/20;
            }
            
            .card-hover {
                @apply transition-all duration-300 hover:shadow-xl hover:-translate-y-1;
            }
            
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .btn-accent {
                @apply bg-accent hover:bg-accent/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
            }
            
            .input-primary {
                @apply bg-white/80 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary;
            }
            
            .blurred-bg {
                @apply filter blur-md pointer-events-none;
            }
            
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .scroll-offset {
                scroll-margin-top: 140px;
            }

            .privacy-mask {
                @apply absolute inset-0 bg-black/80 opacity-0 transition-opacity duration-200;
            }
        }
    </style>

    <style>
        body.privacy-on .video-thumb img {
            filter: blur(12px);
            transform: scale(1.05);
            transition: filter 200ms ease, transform 200ms ease;
        }

        body.privacy-on .video-thumb:hover img {
            filter: blur(0);
            transform: scale(1);
        }

        body.privacy-on .video-thumb .privacy-mask {
            opacity: 1;
        }

        body.privacy-on .video-thumb:hover .privacy-mask {
            opacity: 0;
        }

        .access-granted #accessGate {
            display: none !important;
        }

        .access-granted #appContent {
            display: block !important;
        }

    </style>

    <script>
        try {
            const grantedUntil = Number(localStorage.getItem('accessGrantedUntil') || '0');
            const token = String(localStorage.getItem('officialApiToken') || '');
            if (grantedUntil && Date.now() < grantedUntil && token) {
                document.documentElement.classList.add('access-granted');
            }
        } catch (e) {
            // ignore storage errors
        }
    </script>
</head>
<body class="bg-gray-100 transition-colors duration-300">
    <!-- è®¿é—®å¯†ç éªŒè¯ -->
    <div 
        id="accessGate" 
        class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60"
    >
        <div class="bg-white rounded-xl shadow-2xl w-[90%] max-w-sm p-6 space-y-4">
            <div class="flex items-center space-x-2">
                <i class="fa fa-lock text-primary text-xl"></i>
                <h2 class="text-lg font-semibold text-gray-800">è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            </div>
            <p class="text-sm text-gray-500">éªŒè¯é€šè¿‡åæ‰ä¼šæ˜¾ç¤ºé¡µé¢å†…å®¹</p>
            <div class="space-y-2">
                <input 
                    id="accessPasswordInput" 
                    type="password" 
                    placeholder="è®¿é—®å¯†ç " 
                    class="input-primary w-full"
                    autocomplete="current-password"
                >
                <div id="accessError" class="text-xs text-red-500 hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
            </div>
            <button 
                id="accessSubmitButton"
                onclick="verifyAccessPassword()"
                class="btn-primary w-full"
            >
                éªŒè¯è¿›å…¥
            </button>
            <div class="text-xs text-gray-400">æç¤ºï¼šå¯†ç åœ¨ä»£ç é‡Œé…ç½®ï¼Œå¯è‡ªè¡Œä¿®æ”¹</div>
        </div>
    </div>

    <div id="appContent" class="hidden">
    <!-- å¯¼èˆªå¤´ -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 glass-effect shadow-lg">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- å·¦ä¾§ï¼šåº”ç”¨æ ‡é¢˜ -->
                <div class="flex items-center space-x-2">
                    <i class="fa fa-play-circle text-primary text-2xl"></i>
                    <h1 id="siteTitle" class="text-xl font-bold text-primary cursor-pointer select-none">è§†é¢‘æœç´¢</h1>
                </div>
                
                <!-- ä¸­é—´ï¼šæœç´¢æ¡† -->
                <div class="hidden md:flex items-center bg-white rounded-lg shadow-md max-w-xl w-full mx-4 relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="æœç´¢è§†é¢‘..." 
                        class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                        onkeypress="handleKeyPress(event)"
                    >
                    <button 
                        id="searchButton" 
                        onclick="searchData()"
                        class="btn-primary rounded-l-none"
                    >
                        <i class="fa fa-search mr-1"></i> <span id="searchButtonLabel">æœç´¢</span>
                    </button>
                    <div 
                        id="searchHistoryBox" 
                        class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    ></div>
                </div>
                
                <!-- å³ä¾§ï¼šæ›´å¤šä¸‹æ‹‰ -->
                <div class="flex items-center space-x-3 relative">
                    <button
                        id="mobileSearchToggle"
                        onclick="toggleMobileSearch()"
                        class="md:hidden btn-primary text-sm"
                        title="æœç´¢"
                    >
                        <i class="fa fa-search"></i>
                    </button>
                    <button 
                        id="moreButton"
                        onclick="toggleMoreMenu()"
                        class="btn-secondary text-sm"
                        title="æ›´å¤š"
                    >
                        <i class="fa fa-ellipsis-h mr-1"></i> æ›´å¤š
                    </button>
                    <div 
                        id="moreMenu"
                        class="absolute right-0 top-full mt-2 w-36 bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                    >
                        <button 
                            onclick="handleMoreAction('favorite')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-heart text-red-500"></i>
                            <span class="text-right flex-1">å–œæ¬¢</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('history')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-history text-gray-600"></i>
                            <span class="text-right flex-1">å†å²</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('user')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-user text-gray-600"></i>
                            <span class="text-right flex-1">ç”¨æˆ·ä¿¡æ¯</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('setting')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-cog text-gray-600"></i>
                            <span class="text-right flex-1">è®¾ç½®</span>
                        </button>
                        <button 
                            onclick="handleMoreAction('about')"
                            class="w-full px-3 py-2 text-sm hover:bg-blue-50 flex items-center justify-between rounded-lg"
                        >
                            <i class="fa fa-info-circle text-gray-600"></i>
                            <span class="text-right flex-1">å…³äº</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯æœç´¢æ¡† -->
            <div id="mobileSearchBox" class="md:hidden mt-3 flex items-center bg-white rounded-lg shadow-md relative hidden">
                <input 
                    type="text" 
                    id="searchInputMobile" 
                    placeholder="æœç´¢è§†é¢‘..." 
                    class="flex-1 border-none outline-none bg-transparent px-4 py-2"
                    onkeypress="handleKeyPress(event)"
                >
                <button 
                    id="searchButtonMobile" 
                    onclick="searchData()"
                    class="btn-primary rounded-l-none"
                >
                    <i class="fa fa-search"></i> <span id="searchButtonLabelMobile">æœç´¢</span>
                </button>
                <div 
                    id="searchHistoryBoxMobile" 
                    class="absolute left-0 top-full mt-2 w-full bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50"
                ></div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 pt-20 pb-20">
        <!-- è§†é¢‘åˆ—è¡¨ -->
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- è§†é¢‘å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div class="flex justify-center mt-8">
            <button 
                id="loadMoreButton" 
                onclick="loadMoreData()"
                class="btn-primary flex items-center space-x-2 hidden"
            >
                <span>åŠ è½½æ›´å¤š</span>
                <i class="fa fa-refresh"></i>
            </button>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
            <i class="fa fa-search text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">æš‚æ— æœç´¢ç»“æœ</h3>
            <p class="text-gray-600">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</p>
        </div>
    </main>

    <!-- æ’­æ”¾å†å²é¢æ¿ -->
    <div 
        id="historyPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">æ’­æ”¾å†å²</h3>
            <button onclick="toggleHistory()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="historyContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearHistory()" class="w-full btn-secondary">
                <i class="fa fa-trash mr-1"></i> æ¸…ç©ºå†å²
            </button>
        </div>
    </div>

    <!-- å–œæ¬¢é¢æ¿ -->
    <div 
        id="favoritePanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">æˆ‘çš„å–œæ¬¢</h3>
            <button onclick="toggleFavorites()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div id="favoriteContent" class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <!-- å–œæ¬¢å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="clearFavorites()" class="w-full btn-secondary">
                <i class="fa fa-trash mr-1"></i> æ¸…ç©ºå–œæ¬¢
            </button>
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
    <div 
        id="userPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">ç”¨æˆ·ä¿¡æ¯</h3>
            <button onclick="toggleUserInfo()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="userInfoContent" class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-4">
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-3">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-500">æ˜µç§°</span>
                    <span id="userNicknameDisplay" class="font-medium text-gray-800">æœªè®¾ç½®</span>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <input 
                        id="userNicknameInput" 
                        type="text" 
                        placeholder="è¾“å…¥æ˜µç§°" 
                        class="input-primary w-full sm:flex-1 text-sm"
                        maxlength="20"
                    >
                    <button 
                        id="userNicknameSave" 
                        onclick="saveUserNickname()" 
                        class="btn-primary text-xs px-3 py-2 w-full sm:w-auto"
                    >
                        ä¿å­˜
                    </button>
                    <button 
                        id="userNicknameRandom" 
                        onclick="setRandomNickname()" 
                        class="btn-secondary text-xs px-3 py-2 w-full sm:w-auto"
                    >
                        éšæœº
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æ”¶è—æ•°é‡</span>
                    <span id="userFavoriteCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æ’­æ”¾å†å²</span>
                    <span id="userHistoryCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">æœç´¢å†å²</span>
                    <span id="userSearchCount" class="font-medium text-gray-800">0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-500">ä»Šæ—¥è§‚çœ‹æ—¶é•¿</span>
                    <span id="userWatchToday" class="font-medium text-gray-800">00:00</span>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2 text-sm">
                <div class="flex items-start justify-between">
                    <span class="text-gray-500">æœ€è¿‘è®¿é—®</span>
                    <div id="userLastVisit" class="text-right text-xs text-gray-700 space-y-1">-</div>
                </div>
                <div class="text-xs text-gray-500">ç”¨æˆ·ä¿¡æ¯ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-3">
                <div class="text-sm font-medium">å¯¼å…¥å¯¼å‡º</div>
                <div class="flex space-x-3">
                    <button onclick="exportUserData()" class="btn-secondary flex-1 text-sm">
                        <i class="fa fa-download mr-1"></i> å¯¼å‡º
                    </button>
                    <label class="btn-primary flex-1 text-center cursor-pointer text-sm">
                        <i class="fa fa-upload mr-1"></i> å¯¼å…¥
                        <input id="importFileInput" type="file" accept="application/json" class="hidden" onchange="importUserData(event)">
                    </label>
                </div>
                <p class="text-xs text-gray-500">å¯¼å‡º/å¯¼å…¥ï¼šåŒ…å«å–œæ¬¢ã€æ’­æ”¾å†å²ã€æœç´¢å†å²ã€æ’­æ”¾è¿›åº¦ä¸æ˜µç§°</p>
                <div>
                    <label class="block text-sm font-medium mb-2">å¯¼å…¥å¯¼å‡ºå†å²è®°å½•</label>
                    <div id="transferHistoryList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³äºé¢æ¿ -->
    <div 
        id="aboutPanel" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">å…³äºæœ¬ç½‘ç«™</h3>
            <button onclick="toggleAboutPanel()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-4 text-sm">
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">åŠŸèƒ½æ¦‚è§ˆ</div>
                <div class="text-gray-600">è¿™æ˜¯ä¸€ä¸ªè§†é¢‘æœç´¢ä¸æ’­æ”¾å·¥å…·ï¼Œæ”¯æŒå¤šæ¥å£èšåˆã€æ”¶è—ä¸å†å²è®°å½•ã€è§‚çœ‹è¿›åº¦ç»­æ’­ã€éšç§æ¨¡å¼ä¸åˆ†äº«ã€‚</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">ä½¿ç”¨æ–¹æ³•</div>
                <div class="space-y-1 text-gray-600">
                    <div>1. åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢ã€‚</div>
                    <div>2. ç‚¹â€œè®¾ç½®â€é€‰æ‹©æˆ–å¡«å†™æ¥å£åœ°å€ã€‚</div>
                    <div>3. â€œå®˜æ–¹æ¨èâ€éœ€è¦é€šè¿‡è®¿é—®å¯†ç éªŒè¯ã€‚</div>
                    <div>4. å¯å¼€å¯â€œèšåˆæœç´¢â€ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªæ¥å£ã€‚</div>
                    <div>5. è¿›å…¥è§†é¢‘åæ”¯æŒæ–­ç‚¹ç»­æ’­ä¸æ’­æ”¾å†å²è®°å½•ã€‚</div>
                    <div>6. â€œå–œæ¬¢â€å’Œâ€œå†å²â€å¯åœ¨æ›´å¤šèœå•ä¸­æŸ¥çœ‹ã€‚</div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">å°è´´å£«</div>
                <div class="text-gray-600">éšç§æ¨¡å¼ä¼šå¯¹ç¼©ç•¥å›¾æ‰“ç ï¼›åˆ†äº«é“¾æ¥å¯è®¾ç½®æœ‰æ•ˆæœŸã€‚</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm space-y-2">
                <div class="text-base font-medium text-gray-800">æ•°æ®è¯´æ˜</div>
                <div class="text-gray-600">æ”¶è—ã€å†å²ã€æœç´¢è®°å½•ç­‰ä¿¡æ¯åªä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚</div>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯é®ç½© -->
    <div 
        id="overlay" 
        class="fixed inset-0 bg-black/50 z-30 hidden"
        onclick="closeAllPanels()"
    ></div>

    <!-- åˆ†äº«å¼¹çª— -->
    <div id="shareModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-5 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">åˆ†äº«è§†é¢‘</h3>
                <button onclick="closeShareModal()" class="p-2 hover:bg-gray-100 rounded-full">
                    <i class="fa fa-times text-gray-500"></i>
                </button>
            </div>
            <div class="flex flex-col items-center">
                <div class="w-full mt-2">
                    <label class="block text-xs text-gray-500 mb-2">åˆ†äº«é“¾æ¥æœ‰æ•ˆæ—¶é—´</label>
                    <select id="shareExpireSelect" class="input-primary w-full text-sm">
                        <option value="1800">30åˆ†é’Ÿ</option>
                        <option value="7200">2å°æ—¶</option>
                        <option value="86400">1å¤©</option>
                        <option value="604800">7å¤©</option>
                        <option value="0">æ°¸ä¹…</option>
                    </select>
                </div>
                <button onclick="copyShareUrl()" class="btn-primary w-full mt-4">
                    <i class="fa fa-copy mr-1"></i> ç‚¹å‡»å¤åˆ¶åœ°å€
                </button>
            </div>
        </div>
    </div>

    <!-- è®¡ç®—éªŒè¯å¼¹çª— -->
    <div id="mathChallengeModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-black/60 p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl">
            <div class="text-lg font-semibold text-gray-800 mb-2">æ“ä½œè¿‡å¿«ï¼Œè¯·å®Œæˆè®¡ç®—</div>
            <div id="mathChallengeQuestion" class="text-2xl font-bold text-center text-gray-900 my-4">0 + 0 = ?</div>
            <input
                id="mathChallengeInput"
                type="text"
                inputmode="numeric"
                placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                class="input-primary w-full text-center text-lg"
                autocomplete="off"
            >
            <div id="mathChallengeError" class="text-xs text-red-500 mt-2 hidden">ç­”æ¡ˆé”™è¯¯ï¼Œè¯·é‡è¯•</div>
            <button
                id="mathChallengeSubmit"
                class="btn-primary w-full mt-4"
            >
                æäº¤ç­”æ¡ˆ
            </button>
        </div>
    </div>

    <!-- æ‚¬æµ®æ§åˆ¶æŒ‰é’® -->
    <div 
        id="floatingButtons" 
        class="fixed bottom-6 right-6 glass-effect rounded-lg shadow-lg p-2 hidden"
    >
        <div class="flex flex-col space-y-2">
            <div class="text-xs text-gray-600 text-center px-2 py-1 bg-white/80 rounded-full">
                æ€»æ•° <span id="loadedTotalCount" class="font-semibold text-gray-800">0</span>
            </div>
            <button 
                onclick="playRandomVideo()" 
                class="p-3 rounded-full hover:bg-gray-200 transition-colors"
                title="éšæœºæ’­æ”¾"
            >
                <i class="fa fa-random"></i>
            </button>
            <button 
                onclick="scrollToTop()" 
                class="p-3 rounded-full hover:bg-gray-200 transition-colors"
                title="å›åˆ°é¡¶éƒ¨"
            >
                <i class="fa fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
    <div 
        id="videoPlayerModal" 
        class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
    >
        <div class="relative w-full max-w-4xl h-[70vh] bg-black rounded-lg overflow-hidden">
            <div 
                id="playerTitle"
                class="absolute top-4 left-4 z-10 px-3 py-1.5 bg-black/60 text-white text-sm rounded-full max-w-[70%] truncate"
            ></div>
            <!-- ç§»åŠ¨è®¾å¤‡ä¸“ç”¨å…³é—­æŒ‰é’® -->
            <button 
                id="closeVideoButtonMobile" 
                onclick="closeVideoPlayer()"
                class="md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
            >
                <i class="fa fa-times text-xl"></i>
            </button>
            <button 
                id="shareVideoButtonMobile" 
                onclick="shareCurrentVideo()"
                class="md:hidden fixed top-4 right-20 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="åˆ†äº«"
            >
                <i class="fa fa-share-alt text-xl"></i>
            </button>
            <button 
                id="likeVideoButtonMobile" 
                onclick="toggleCurrentVideoFavorite()"
                class="md:hidden fixed top-4 right-36 bg-gray-600 hover:bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg"
                title="å–œæ¬¢"
            >
                <i class="fa fa-heart-o text-xl"></i>
            </button>
            
            <!-- æ¡Œé¢ç«¯å…³é—­æŒ‰é’® -->
            <button 
                id="closeVideoButton" 
                onclick="closeVideoPlayer()"
                class="hidden md:flex absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
            >
                <i class="fa fa-times"></i>
            </button>
            <button 
                id="shareVideoButton" 
                onclick="shareCurrentVideo()"
                class="hidden md:flex absolute top-4 right-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="åˆ†äº«"
            >
                <i class="fa fa-share-alt"></i>
            </button>
            <button 
                id="likeVideoButton" 
                onclick="toggleCurrentVideoFavorite()"
                class="hidden md:flex absolute top-4 right-28 bg-gray-600 hover:bg-red-600 text-white rounded-full w-10 h-10 items-center justify-center z-10"
                title="å–œæ¬¢"
            >
                <i class="fa fa-heart-o"></i>
            </button>
            
            <div id="dplayer" class="w-full h-full"></div>
        </div>
    </div>

    <!-- Hostè®¾ç½®é¢æ¿ -->
    <div 
        id="hostModal" 
        class="fixed top-0 right-0 bottom-0 w-4/5 md:w-96 glass-effect shadow-xl transform translate-x-full transition-transform duration-300 z-40 overflow-hidden flex flex-col"
    >
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">è®¾ç½®API Host</h3>
            <button onclick="toggleHostModal()" class="p-2 hover:bg-gray-200 rounded-full">
                <i class="fa fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto scrollbar-hide p-4">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">å½“å‰API</label>
                    <input 
                        type="text" 
                        id="hostInput" 
                        class="input-primary w-full"
                        placeholder="è¯·è¾“å…¥API Hoståœ°å€"
                    >
                </div>
                <div class="flex space-x-3">
                    <button onclick="saveHost()" class="btn-primary flex-1">
                        <i class="fa fa-save mr-1"></i> ä¿å­˜
                    </button>
                    <button onclick="resetHost()" class="btn-secondary flex-1">
                        <i class="fa fa-refresh mr-1"></i> é‡ç½®
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">èšåˆæœç´¢</label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="aggregateSwitch" 
                            class="sr-only"
                            onchange="toggleAggregateSearch()"
                        >
                        <div class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 -mt-2">å¼€å¯åä¼šæœç´¢å®˜æ–¹æ¨èçš„æ‰€æœ‰æ¥å£</p>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">èšåˆæ¥å£é€‰æ‹©ï¼ˆğŸŒˆå·²é€‰ <span id="aggregateSelectedCount">0</span>ï¼‰</label>
                    <button 
                        type="button"
                        onclick="toggleAggregateApiSection()"
                        id="aggregateApiToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        å±•å¼€/æ”¶èµ·
                    </button>
                </div>
                <div id="aggregateApiSection" class="hidden space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="selectAllAggregateApis()" class="btn-secondary text-xs flex-1">å…¨é€‰</button>
                        <button onclick="clearAggregateApis()" class="btn-secondary text-xs flex-1">å…¨ä¸é€‰</button>
                        <button onclick="resetAggregateApis()" class="btn-secondary text-xs flex-1">æ¢å¤é»˜è®¤</button>
                    </div>
                    <div id="aggregateApiList" class="space-y-2"></div>
                    <button onclick="confirmAggregateSelection()" class="btn-primary text-xs w-full">
                        ç¡®è®¤å¹¶å…³é—­
                    </button>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">å®˜æ–¹æ¨èï¼ˆğŸŒˆæ•°é‡ <span id="officialApiCount">0</span>ï¼‰</label>
                    <button 
                        type="button"
                        onclick="toggleOfficialApiSection(); fetchOfficialApis(true)"
                        id="officialApiToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        å±•å¼€/æ”¶èµ·
                    </button>
                </div>
                <div id="officialApiSection" class="hidden space-y-2">
                    <div id="officialApiList" class="space-y-2"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">å†å²Host</label>
                    <button 
                        type="button"
                        onclick="toggleHostHistory()"
                        id="hostHistoryToggleButton"
                        class="text-xs text-gray-600 hover:text-gray-800"
                    >
                        åˆ‡æ¢æ˜¾ç¤º
                    </button>
                </div>
                <div id="hostHistoryWrap" class="hidden space-y-2">
                    <div id="hostHistoryList" class="space-y-2"></div>
                </div>

                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium">éšç§é®æŒ¡</label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="privacySwitch" 
                            class="sr-only"
                            onchange="togglePrivacyMode()"
                        >
                        <div class="w-10 h-6 bg-gray-300 rounded-full relative transition-colors">
                            <div class="w-5 h-5 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform"></div>
                        </div>
                    </label>
                </div>
                <p class="text-xs text-gray-500 -mt-2">å¼€å¯åè§†é¢‘ç¼©ç•¥å›¾é»˜è®¤é®æŒ¡ï¼Œæ‚¬åœæ˜¾ç¤º</p>
                <p class="text-xs text-gray-400 -mt-2">å¿«æ·æ“ä½œï¼šè¿ç»­ç‚¹å‡»â€œè§†é¢‘æœç´¢â€2æ¬¡å…³é—­éšç§ï¼Œ3æ¬¡å¼€å¯éšç§</p>
                
            </div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div 
        id="loadingIndicator" 
        class="fixed inset-0 z-50 hidden items-center justify-center bg-black/30"
    >
        <div class="glass-effect rounded-lg p-6 flex flex-col items-center space-y-3">
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p id="loadingText" class="text-gray-700">åŠ è½½ä¸­...</p>
        </div>
    </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let searchTerm = '';
        let host = '';
        let hostName = '';
        let dplayer = null;
        let isLoading = false;
        let hasMore = true;
        let currentVideoUrl = '';
        let currentVideoTitle = '';
        let currentVideoPic = '';
        let currentVideoSource = '';
        let lastVisitAtStart = null;
        let aggregateNoMore = new Set();
        let renderedVideos = [];
        const FALLBACK_IMAGE = './loading.gif';
        const RESUME_STORAGE_KEY = 'playbackResume';
        const RESUME_MAX_ITEMS = 200;
        const RESUME_MIN_SECONDS = 5;
        const RESUME_SAVE_THROTTLE_MS = 3000;
        let resumeLastSaveAt = 0;
        let resumeLastUrl = '';
        const WATCH_TIME_KEY = 'videoWatchTimeDaily';
        const WATCH_TIME_MAX_DAYS = 60;
        let lastWatchTime = 0;
        let lastWatchUrl = '';
        const loadedTotalCount = document.getElementById('loadedTotalCount');
        
        // DOMå…ƒç´ 
        const videoList = document.getElementById('videoList');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const emptyState = document.getElementById('emptyState');
        const historyPanel = document.getElementById('historyPanel');
        const historyContent = document.getElementById('historyContent');
        const favoritePanel = document.getElementById('favoritePanel');
        const favoriteContent = document.getElementById('favoriteContent');
        const userPanel = document.getElementById('userPanel');
        const userInfoContent = document.getElementById('userInfoContent');
        const aboutPanel = document.getElementById('aboutPanel');
        const overlay = document.getElementById('overlay');
        const floatingButtons = document.getElementById('floatingButtons');
        const videoPlayerModal = document.getElementById('videoPlayerModal');
        const hostModal = document.getElementById('hostModal');
        const hostInput = document.getElementById('hostInput');
        const hostHistoryWrap = document.getElementById('hostHistoryWrap');
        const hostHistoryList = document.getElementById('hostHistoryList');
        const officialApiList = document.getElementById('officialApiList');
        const aggregateApiList = document.getElementById('aggregateApiList');
        const aggregateSwitch = document.getElementById('aggregateSwitch');
        const aggregateApiSection = document.getElementById('aggregateApiSection');
        const officialApiSection = document.getElementById('officialApiSection');
        const aggregateApiToggleButton = document.getElementById('aggregateApiToggleButton');
        const officialApiToggleButton = document.getElementById('officialApiToggleButton');
        const hostHistoryToggleButton = document.getElementById('hostHistoryToggleButton');
        const aggregateSelectedCount = document.getElementById('aggregateSelectedCount');
        const officialApiCount = document.getElementById('officialApiCount');
        const privacySwitch = document.getElementById('privacySwitch');
        const searchInput = document.getElementById('searchInput');
        const searchInputMobile = document.getElementById('searchInputMobile');
        const searchHistoryBox = document.getElementById('searchHistoryBox');
        const searchHistoryBoxMobile = document.getElementById('searchHistoryBoxMobile');
        const searchButtonMobile = document.getElementById('searchButtonMobile');
        let suppressHistoryClick = false;
        const transferHistoryList = document.getElementById('transferHistoryList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingText = document.getElementById('loadingText');
        const accessGate = document.getElementById('accessGate');
        const appContent = document.getElementById('appContent');
        const accessPasswordInput = document.getElementById('accessPasswordInput');
        const accessError = document.getElementById('accessError');
        const accessSubmitButton = document.getElementById('accessSubmitButton');
        const shareModal = document.getElementById('shareModal');
        const shareExpireSelect = document.getElementById('shareExpireSelect');
        let currentShareUrl = '';

        function getResumeStore() {
            try {
                return JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '{}');
            } catch (error) {
                console.error('è¯»å–æ’­æ”¾è¿›åº¦å¤±è´¥:', error);
                return {};
            }
        }

        function setResumeStore(store) {
            try {
                localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify(store));
            } catch (error) {
                console.error('ä¿å­˜æ’­æ”¾è¿›åº¦å¤±è´¥:', error);
            }
        }

        function getEntryTime(entry) {
            if (!entry) return 0;
            const time = Number(entry.time);
            return Number.isFinite(time) ? time : 0;
        }

        function loadResumeTime(url) {
            if (!url) return 0;
            const store = getResumeStore();
            const entry = store[url];
            return getEntryTime(entry);
        }

        function resolveResumeTime(rawUrl) {
            if (!rawUrl) return 0;
            const url = String(rawUrl).trim();
            const store = getResumeStore();
            const direct = store[url];
            const directTime = getEntryTime(direct);
            if (directTime) return directTime;

            const decoded = (() => {
                try { return decodeURIComponent(url); } catch (e) { return url; }
            })();
            const decodedEntry = store[decoded];
            const decodedTime = getEntryTime(decodedEntry);
            if (decodedTime) return decodedTime;

            const stripQueryHash = (value) => value.split('#')[0].split('?')[0];
            const stripped = stripQueryHash(url);
            const strippedEntry = store[stripped];
            const strippedTime = getEntryTime(strippedEntry);
            if (strippedTime) return strippedTime;

            const strippedDecoded = stripQueryHash(decoded);
            const strippedDecodedEntry = store[strippedDecoded];
            const strippedDecodedTime = getEntryTime(strippedDecodedEntry);
            if (strippedDecodedTime) return strippedDecodedTime;

            const keys = Object.keys(store);
            if (keys.length === 0) return 0;
            const match = keys
                .map((key) => {
                    const base = stripQueryHash(key);
                    if (base === strippedDecoded || strippedDecoded.startsWith(base) || base.startsWith(strippedDecoded)) {
                        return { key, entry: store[key] };
                    }
                    return null;
                })
                .filter(Boolean)
                .sort((a, b) => (b.entry.updatedAt || 0) - (a.entry.updatedAt || 0))[0];
            if (match && match.entry) {
                const matchTime = getEntryTime(match.entry);
                if (matchTime) return matchTime;
            }
            return 0;
        }

        function getResumeTimeForHistory(item) {
            if (!item || !item.url) return 0;
            const raw = String(item.url).trim();
            const fromRaw = resolveResumeTime(raw);
            if (fromRaw) return fromRaw;
            const decoded = (() => {
                try { return decodeURIComponent(raw); } catch (e) { return raw; }
            })();
            const fromDecoded = resolveResumeTime(decoded);
            if (fromDecoded) return fromDecoded;
            const splitUrl = raw.split('$')[1] || raw;
            const fromSplit = resolveResumeTime(splitUrl);
            if (fromSplit) return fromSplit;
            const decodedSplit = decoded.split('$')[1] || decoded;
            return resolveResumeTime(decodedSplit);
        }

        function saveResumeTime(url, time, duration) {
            if (!url || !Number.isFinite(time) || !Number.isFinite(duration) || duration <= 0) return;
            if (time < 1) return;
            const now = Date.now();
            if (resumeLastUrl === url && now - resumeLastSaveAt < RESUME_SAVE_THROTTLE_MS) return;
            resumeLastSaveAt = now;
            resumeLastUrl = url;
            const store = getResumeStore();
            store[url] = { time, duration, updatedAt: now };
            const keys = Object.keys(store);
            if (keys.length > RESUME_MAX_ITEMS) {
                keys
                    .sort((a, b) => (store[a].updatedAt || 0) - (store[b].updatedAt || 0))
                    .slice(0, keys.length - RESUME_MAX_ITEMS)
                    .forEach((key) => delete store[key]);
            }
            setResumeStore(store);

            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                const index = history.findIndex(item => item.url === url);
                if (index >= 0) {
                    history[index].lastPosition = time;
                    history[index].lastPositionUpdatedAt = now;
                    localStorage.setItem('videoPlayHistory', JSON.stringify(history));
                }
            } catch (e) {
                // ignore history update errors
            }
        }

        function saveResumeNow(url) {
            if (!url || !dplayer || !dplayer.video) return;
            const current = dplayer.video.currentTime || 0;
            const duration = dplayer.video.duration || 0;
            saveResumeTime(url, current, duration);
        }

        function clearResumeTime(url) {
            if (!url) return;
            const store = getResumeStore();
            if (!store[url]) return;
            delete store[url];
            setResumeStore(store);
        }

        function getTodayKey() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getWatchTimeStore() {
            try {
                return JSON.parse(localStorage.getItem(WATCH_TIME_KEY) || '{}');
            } catch (error) {
                console.error('è¯»å–è§‚çœ‹æ—¶é•¿å¤±è´¥:', error);
                return {};
            }
        }

        function setWatchTimeStore(store) {
            try {
                localStorage.setItem(WATCH_TIME_KEY, JSON.stringify(store));
            } catch (error) {
                console.error('ä¿å­˜è§‚çœ‹æ—¶é•¿å¤±è´¥:', error);
            }
        }

        function addWatchTime(seconds) {
            if (!Number.isFinite(seconds) || seconds <= 0) return;
            const store = getWatchTimeStore();
            const todayKey = getTodayKey();
            store[todayKey] = (store[todayKey] || 0) + seconds;
            const keys = Object.keys(store);
            if (keys.length > WATCH_TIME_MAX_DAYS) {
                keys
                    .sort()
                    .slice(0, keys.length - WATCH_TIME_MAX_DAYS)
                    .forEach((key) => delete store[key]);
            }
            setWatchTimeStore(store);
        }

        function getTodayWatchTime() {
            const store = getWatchTimeStore();
            return store[getTodayKey()] || 0;
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initAccessGate();

            // åŠ è½½ä¿å­˜çš„Host
            host = localStorage.getItem('apiHost') || '';
            hostName = localStorage.getItem('apiHostName') || '';
            const aggregateEnabled = isAggregateSearchEnabled();
            if (aggregateSwitch) {
                aggregateSwitch.checked = aggregateEnabled;
                updateAggregateSwitchUI(aggregateEnabled);
            }
            const privacyEnabled = isPrivacyModeEnabled();
            if (privacySwitch) {
                privacySwitch.checked = privacyEnabled;
                updatePrivacySwitchUI(privacyEnabled);
            }
            applyPrivacyMode(privacyEnabled);
            updateSearchButtonLabel(aggregateEnabled);
            
            // é¼ æ ‡ç§»å‡ºé¢æ¿è‡ªåŠ¨å…³é—­
            historyPanel.addEventListener('mouseleave', closeAllPanels);
            favoritePanel.addEventListener('mouseleave', closeAllPanels);
            if (userPanel) {
                userPanel.addEventListener('mouseleave', closeAllPanels);
            }
            if (aboutPanel) {
                aboutPanel.addEventListener('mouseleave', closeAllPanels);
            }
            hostModal.addEventListener('mouseleave', () => {
                if (!hostModal.classList.contains('translate-x-full')) {
                    toggleHostModal();
                }
            });

            if (aggregateApiToggleButton) {
                aggregateApiToggleButton.textContent = aggregateApiSection && aggregateApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
            if (officialApiToggleButton) {
                officialApiToggleButton.textContent = officialApiSection && officialApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
            if (hostHistoryToggleButton) {
                hostHistoryToggleButton.textContent = hostHistoryWrap && hostHistoryWrap.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }

            const previousVisit = localStorage.getItem('lastVisit');
            const visitHistory = JSON.parse(localStorage.getItem('visitHistory') || '[]');
            if (previousVisit) {
                visitHistory.unshift(Number(previousVisit));
            }
            const filteredHistory = visitHistory.filter((item) => Number.isFinite(item));
            const uniqueHistory = [];
            for (const item of filteredHistory) {
                if (!uniqueHistory.includes(item)) uniqueHistory.push(item);
            }
            const trimmedHistory = uniqueHistory.slice(0, 5);
            localStorage.setItem('visitHistory', JSON.stringify(trimmedHistory));
            lastVisitAtStart = trimmedHistory[0] ? String(trimmedHistory[0]) : null;
            localStorage.setItem('lastVisit', Date.now());

            renderTransferHistory();

            
            // åŠ è½½åˆå§‹æ•°æ®
            loadInitialData();
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', handleScroll);

            // æœç´¢å†å²æç¤º
            bindSearchHistoryEvents();

            // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ›´å¤šèœå•
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('moreMenu');
                const button = document.getElementById('moreButton');
                if (!menu || !button) return;
                if (menu.contains(e.target) || button.contains(e.target)) return;
                menu.classList.add('hidden');
            });

            // ç§»åŠ¨ç«¯æœç´¢æ¡†æ‰“å¼€æ—¶ç‚¹å‡»å…¶ä»–ä½ç½®è‡ªåŠ¨å…³é—­
            document.addEventListener('click', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            });

            // ç§»åŠ¨ç«¯æœç´¢æ¡†æ‰“å¼€æ—¶ï¼Œæ»‘åŠ¨/è§¦æ‘¸å…¶ä»–ä½ç½®ä¹Ÿå…³é—­
            document.addEventListener('touchstart', (e) => {
                const box = document.getElementById('mobileSearchBox');
                const toggle = document.getElementById('mobileSearchToggle');
                if (!box || !toggle) return;
                if (box.classList.contains('hidden')) return;
                if (box.contains(e.target) || toggle.contains(e.target)) return;
                box.classList.add('hidden');
            }, { passive: true });

            // ç‚¹å‡»å¯¼èˆªæ ä»»æ„ä½ç½®å…³é—­é¢æ¿
            const header = document.getElementById('header');
            if (header) {
                header.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target && target.closest('button, input, select, textarea, a, label, #moreMenu')) {
                        return;
                    }
                    closeAllPanels();
                });
            }

            if (shareModal) {
                shareModal.addEventListener('click', (e) => {
                    if (e.target === shareModal) {
                        closeShareModal();
                    }
                });
            }

            const siteTitle = document.getElementById('siteTitle');
            if (siteTitle) {
                let clickCount = 0;
                let clickTimer = null;
                const CLICK_WINDOW_MS = 600;

                siteTitle.addEventListener('click', () => {
                    clickCount += 1;
                    if (clickTimer) clearTimeout(clickTimer);
                    clickTimer = setTimeout(() => {
                        if (clickCount === 2) {
                            if (privacySwitch) {
                                privacySwitch.checked = false;
                                togglePrivacyMode();
                            } else {
                                localStorage.setItem('privacyMode', '0');
                                applyPrivacyMode(false);
                            }
                        } else if (clickCount >= 3) {
                            if (privacySwitch) {
                                privacySwitch.checked = true;
                                togglePrivacyMode();
                            } else {
                                localStorage.setItem('privacyMode', '1');
                                applyPrivacyMode(true);
                            }
                        }
                        clickCount = 0;
                        clickTimer = null;
                    }, CLICK_WINDOW_MS);
                });
            }

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState !== 'visible') {
                    saveResumeNow(currentVideoUrl);
                }
            }, { passive: true });

            window.addEventListener('pagehide', () => {
                saveResumeNow(currentVideoUrl);
            }, { passive: true });
        });

        const ACCESS_GRANT_KEY = 'accessGrantedUntil';
        const ACCESS_GRANT_DURATION = 30 * 24 * 60 * 60 * 1000;
        const OFFICIAL_API_TOKEN_KEY = 'officialApiToken';

        function revokeAccess(message) {
            try {
                localStorage.removeItem(ACCESS_GRANT_KEY);
                localStorage.removeItem(OFFICIAL_API_TOKEN_KEY);
            } catch (e) {
                // ignore storage errors
            }
            if (accessGate && appContent) {
                accessGate.classList.remove('hidden');
                appContent.classList.add('hidden');
                document.documentElement.classList.remove('access-granted');
            }
            if (accessPasswordInput) {
                accessPasswordInput.value = '';
                accessPasswordInput.focus();
            }
            if (message) {
                showToast(message);
            }
        }

        function initAccessGate() {
            if (!accessGate || !appContent) return;
            const grantedUntil = Number(localStorage.getItem(ACCESS_GRANT_KEY) || '0');
            const token = String(localStorage.getItem(OFFICIAL_API_TOKEN_KEY) || '');
            if (grantedUntil && Date.now() < grantedUntil && token) {
                accessGate.classList.add('hidden');
                appContent.classList.remove('hidden');
                document.documentElement.classList.add('access-granted');
                return;
            }
            localStorage.removeItem(ACCESS_GRANT_KEY);
            localStorage.removeItem(OFFICIAL_API_TOKEN_KEY);
            appContent.classList.add('hidden');
            accessGate.classList.remove('hidden');
            document.documentElement.classList.remove('access-granted');
            if (accessPasswordInput) {
                accessPasswordInput.focus();
                accessPasswordInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        verifyAccessPassword();
                    }
                });
            }
        }

        function verifyAccessPassword() {
            if (!accessPasswordInput || !accessGate || !appContent) return;
            const value = accessPasswordInput.value.trim();
            if (!value) {
                if (accessError) accessError.classList.remove('hidden');
                return;
            }
            if (accessSubmitButton) accessSubmitButton.disabled = true;
            fetch(`/apis/video/pass?password=${encodeURIComponent(value)}`)
                .then((res) => res.json())
                .then((data) => {
                    if (data && data.code === 200 && data.data === true && data.token) {
                        localStorage.setItem(ACCESS_GRANT_KEY, String(Date.now() + ACCESS_GRANT_DURATION));
                        localStorage.setItem(OFFICIAL_API_TOKEN_KEY, String(data.token));
                        accessGate.classList.add('hidden');
                        appContent.classList.remove('hidden');
                        document.documentElement.classList.add('access-granted');
                        accessPasswordInput.value = '';
                        if (accessError) accessError.classList.add('hidden');
                        return;
                    }
                    if (data && data.code === 200 && data.data === true && !data.token) {
                        revokeAccess('æœåŠ¡æœªè¿”å›è®¿é—®ä»¤ç‰Œï¼Œè¯·ç¨åé‡è¯•');
                        return;
                    }
                    if (accessError) accessError.classList.remove('hidden');
                })
                .catch(() => {
                    if (accessError) accessError.classList.remove('hidden');
                })
                .finally(() => {
                    if (accessSubmitButton) accessSubmitButton.disabled = false;
                });
        }

        function getOfficialApiUrl() {
            const token = localStorage.getItem(OFFICIAL_API_TOKEN_KEY) || '';
            if (!token) return '/apis/official';
            return `/apis/official?token=${encodeURIComponent(token)}`;
        }
        
        // åŠ è½½åˆå§‹æ•°æ®
        function loadInitialData() {
            if (!host && !isAggregateSearchEnabled()) {
                // å¦‚æœæ²¡æœ‰è®¾ç½®Hostï¼Œæ˜¾ç¤ºè®¾ç½®æç¤º
                showHostModal();
                return;
            }
            
            showLoading('æ­£åœ¨åŠ è½½æ¨èè§†é¢‘...');
            hasMore = true;
            fetchData('', 1).finally(() => {
                hideLoading();
            });
        }
        
        // è·å–ä»£ç†URL
        function getProxyUrl(endpoint, params = {}) {
            const baseUrl = window.location.origin + '/proxy';
            const url = new URL(endpoint, baseUrl);
            
            // æ·»åŠ æŸ¥è¯¢å‚æ•°
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== null) {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            return url.toString();
        }
        
        // è·å–æ•°æ®
        async function fetchData(keyword, page) {
            if (isAggregateSearchEnabled()) {
                return fetchAggregatedData(keyword, page);
            }
            try {
                const params = {
                    wd: keyword,
                    pg: page,
                    url: host
                };
                
                const response = await fetch(getProxyUrl('', params));
                const data = await response.json();
                
                if (!data.list || data.list.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                // æ™®é€šæœç´¢å»é‡ï¼šç›¸åŒæ ‡é¢˜åªä¿ç•™ä¸€æ¡
                const seenTitles = new Set();
                const deduped = [];
                data.list.forEach(video => {
                    const title = (video.vod_name || '').trim();
                    if (!title) {
                        deduped.push(video);
                        return;
                    }
                    if (seenTitles.has(title)) return;
                    seenTitles.add(title);
                    deduped.push(video);
                });
                
                // æ¸²æŸ“æ•°æ®
                if (page === 1) {
                    videoList.innerHTML = '';
                    renderedVideos = [];
                    updateLoadedCount(0);
                }
                
                renderVideos(deduped);
                updateLoadedCount(renderedVideos.length);
                
                // æ›´æ–°åˆ†é¡µçŠ¶æ€
                currentPage = page;
                searchTerm = keyword;
                
                // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
                if (data.list.length < 20) {
                    hideLoadMoreButton();
                    hasMore = false;
                } else {
                    showLoadMoreButton();
                    hasMore = true;
                }
                
                return deduped;
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                if (page === 1) {
                    showErrorState('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Hostè®¾ç½®');
                }
                return [];
            }
        }

        async function fetchAggregatedData(keyword, page) {
            try {
                if (page === 1) {
                    aggregateNoMore = new Set();
                }
                const apis = await getOfficialApis();
                const selectedUrls = getAggregateApiSelection();
                const targetApis = selectedUrls.length > 0
                    ? apis.filter(item => selectedUrls.includes(item.url))
                    : apis;
                const activeApis = targetApis.filter(item => !aggregateNoMore.has(item.url));
                if (!activeApis || activeApis.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                let completed = 0;
                updateAggregateLoading(completed, activeApis.length);
                const results = await Promise.all(
                    activeApis.map(item => {
                        const params = {
                            wd: keyword,
                            pg: page,
                            url: item.url
                        };
                        return fetch(getProxyUrl('', params))
                            .then(res => res.json())
                            .then(data => ({
                                item,
                                list: Array.isArray(data.list) ? data.list : []
                            }))
                            .catch(() => ({ item, list: [] }))
                            .finally(() => {
                                completed += 1;
                                updateAggregateLoading(completed, activeApis.length);
                            });
                    })
                );
                
                const merged = [];
                results.forEach(({ item, list }) => {
                    if (!list || list.length === 0) {
                        aggregateNoMore.add(item.url);
                    }
                    const label = getOfficialLabel(item);
                    list.forEach(video => {
                        merged.push({
                            ...video,
                            _sourceLabel: label
                        });
                    });
                });

                // å»é‡ï¼šç›¸åŒæ ‡é¢˜åªä¿ç•™ä¸€æ¡
                const seenTitles = new Set();
                const deduped = [];
                merged.forEach(video => {
                    const title = (video.vod_name || '').trim();
                    if (!title) {
                        deduped.push(video);
                        return;
                    }
                    if (seenTitles.has(title)) return;
                    seenTitles.add(title);
                    deduped.push(video);
                });
                
                if (page === 1) {
                    videoList.innerHTML = '';
                    renderedVideos = [];
                    updateLoadedCount(0);
                }
                
                if (deduped.length === 0) {
                    if (page === 1) {
                        showEmptyState();
                    } else {
                        showToast('æ•°æ®åŠ è½½å®Œæ¯•');
                    }
                    hideLoadMoreButton();
                    hasMore = false;
                    return [];
                }
                
                renderVideos(deduped);
                updateLoadedCount(renderedVideos.length);
                
                currentPage = page;
                searchTerm = keyword;
                
                const anyHasMore = results.some(r => r.list && r.list.length >= 20);
                if (anyHasMore) {
                    showLoadMoreButton();
                    hasMore = true;
                } else {
                    hideLoadMoreButton();
                    hasMore = false;
                }
                
                return deduped;
            } catch (error) {
                console.error('èšåˆæœç´¢å¤±è´¥:', error);
                if (page === 1) {
                    showErrorState('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–Hostè®¾ç½®');
                }
                return [];
            }
        }

        function updateAggregateLoading(done, total) {
            if (!isAggregateSearchEnabled()) return;
            const text = `èšåˆæœç´¢åŠ è½½ä¸­... (${done}/${total})`;
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        
        // æ¸²æŸ“è§†é¢‘å¡ç‰‡
        function renderVideos(videos) {
            videos.forEach(video => {
                const favorited = isFavorited(video.vod_play_url);
                const sourceLabel = video._sourceLabel || getHostLabel();
                if (video.vod_play_url) {
                    renderedVideos.push({
                        url: video.vod_play_url,
                        title: video.vod_name || 'æœªå‘½å',
                        pic: video.vod_pic || '',
                        source: sourceLabel
                    });
                }
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg overflow-hidden shadow-md card-hover scroll-offset';
                card.innerHTML = `
                    <div class="video-thumb relative aspect-video overflow-hidden cursor-pointer" onclick="openFullScreenPreview('${video.vod_pic}', '${video.vod_name}')">
                        <img 
                            src="${FALLBACK_IMAGE}" 
                            data-src="${video.vod_pic}" 
                            alt="${video.vod_name}" 
                            onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';"
                            loading="lazy"
                            class="w-full h-full object-cover lazy-image"
                        >
                        <div class="privacy-mask"></div>
                        <div class="count-badge hidden absolute top-2 right-2 bg-black/70 text-white text-[11px] px-2 py-1 rounded-full"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-end">
                            <div class="p-3 w-full">
                                <h3 class="text-white font-medium line-clamp-2">${video.vod_name}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold mb-2 line-clamp-1">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded mr-2">${sourceLabel}</span>
                            ${video.vod_name}
                        </h3>
                        <div class="flex justify-between items-center">
                            <button 
                                onclick="openVideoPlayer('${video.vod_play_url}', '${video.vod_name}', '${video.vod_pic}', '${sourceLabel}')"
                                class="btn-primary text-sm"
                            >
                                <i class="fa fa-play mr-1"></i> æ’­æ”¾
                            </button>
                            <div class="flex items-center space-x-2">
                                <button 
                                    onclick="toggleFavorite('${video.vod_name}', '${video.vod_play_url}', '${video.vod_pic}', this, '${sourceLabel}')"
                                    class="text-sm ${favorited ? 'text-red-500' : 'text-gray-500'} hover:text-red-500"
                                    title="å–œæ¬¢"
                                >
                                    <i class="fa ${favorited ? 'fa-heart' : 'fa-heart-o'} mr-1"></i> å–œæ¬¢
                                </button>
                                <button 
                                    onclick="shareVideo('${video.vod_play_url}', '${video.vod_name}', '${video.vod_pic}', '${sourceLabel}')"
                                    class="text-sm text-gray-500 hover:text-blue-500"
                                    title="åˆ†äº«è§†é¢‘"
                                >
                                    <i class="fa fa-share-alt mr-1"></i> åˆ†äº«
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const index = renderedVideos.length;
                card.dataset.index = String(index);
                const thumb = card.querySelector('.video-thumb');
                if (thumb) {
                    thumb.addEventListener('mouseenter', () => {
                        showCardCount(thumb, index);
                    });
                    thumb.addEventListener('mouseleave', () => {
                        hideCardCount(thumb);
                    });
                }
                videoList.appendChild(card);
            });
            
            // åˆå§‹åŒ–æ‡’åŠ è½½
            initLazyLoading();
        }

        function updateLoadedCount(totalCount) {
            let changed = false;
            if (loadedTotalCount && totalCount !== null && totalCount !== undefined) {
                loadedTotalCount.textContent = String(totalCount);
                changed = true;
            }
            if (!changed) return;
            const targets = [loadedTotalCount].filter(Boolean);
            targets.forEach((el) => el.classList.add('animate-pulse'));
            setTimeout(() => {
                targets.forEach((el) => el.classList.remove('animate-pulse'));
            }, 500);
        }

        function showCardCount(thumbEl, index) {
            if (!thumbEl) return;
            const badge = thumbEl.querySelector('.count-badge');
            if (!badge) return;
            const total = renderedVideos.length;
            badge.textContent = `${index}/${total}`;
            badge.classList.remove('hidden');
        }

        function hideCardCount(thumbEl) {
            if (!thumbEl) return;
            const badge = thumbEl.querySelector('.count-badge');
            if (!badge) return;
            badge.classList.add('hidden');
        }

        function playRandomVideo() {
            if (!renderedVideos || renderedVideos.length === 0) {
                showToast('æš‚æ— å¯æ’­æ”¾è§†é¢‘');
                return;
            }
            const index = Math.floor(Math.random() * renderedVideos.length);
            const target = renderedVideos[index];
            if (!target || !target.url) {
                showToast('æš‚æ— å¯æ’­æ”¾è§†é¢‘');
                return;
            }
            openVideoPlayer(target.url, target.title, target.pic, target.source || '');
        }
        
        // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
        function initLazyLoading() {
            const lazyImages = document.querySelectorAll('.lazy-image');
            
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy-image');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                lazyImages.forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // å›é€€æ–¹æ¡ˆ
                lazyImages.forEach(img => {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy-image');
                });
            }
        }
        
        // æœç´¢åŠŸèƒ½
        function searchData() {
            suppressHistoryInteractions(200);
            const isMobile = window.matchMedia('(max-width: 767px)').matches;
            const desktopValue = document.getElementById('searchInput').value.trim();
            const mobileValue = document.getElementById('searchInputMobile').value.trim();
            const input = isMobile ? mobileValue : (desktopValue || mobileValue);
            
            if (!input) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (!host && !isAggregateSearchEnabled()) {
                showToast('è¯·å…ˆè®¾ç½®API Host');
                showHostModal();
                return;
            }
            
            searchTerm = input;
            currentPage = 1;
            hasMore = true;
            saveSearchHistory(input);
            hideSearchHistory();
            
            // æ›´æ–°ä¸¤ä¸ªæœç´¢æ¡†çš„å€¼
            document.getElementById('searchInput').value = input;
            document.getElementById('searchInputMobile').value = input;
            
            showLoading('æ­£åœ¨æœç´¢...');
            fetchData(input, 1).then((list) => {
                if (list && list.length > 0) {
                    if (window.matchMedia('(max-width: 767px)').matches) {
                        setTimeout(() => {
                            const mobileBox = document.getElementById('mobileSearchBox');
                            if (mobileBox && !mobileBox.classList.contains('hidden')) {
                                mobileBox.classList.add('hidden');
                            }
                        }, 200);
                    }
                    setTimeout(() => {
                        const firstCard = videoList.firstElementChild;
                        if (firstCard) {
                            scrollToElementWithHeaderOffset(firstCard, 12);
                        }
                    }, 50);
                }
            }).finally(() => {
                hideLoading();
            });
        }

        // æœç´¢å†å²è®°å½•
        function getSearchHistory() {
            return JSON.parse(localStorage.getItem('searchHistory') || '[]');
        }

        function saveSearchHistory(term) {
            if (!term) return;
            const history = getSearchHistory();
            const existingIndex = history.findIndex(item => item === term);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(term);
            if (history.length > 20) {
                history.splice(20);
            }
            localStorage.setItem('searchHistory', JSON.stringify(history));
        }

        function renderSearchHistory() {
            const history = getSearchHistory().slice(0, 12);
            const box = searchHistoryBox;
            const boxMobile = searchHistoryBoxMobile;
            const html = history.length === 0
                ? `<div class="px-3 py-2 text-xs text-gray-500">æš‚æ— æœç´¢å†å²</div>`
                : `
                    <div class="flex flex-wrap gap-2 p-2 max-h-[96px] overflow-hidden">
                        ${history.map(item => `
                            <button 
                                class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200"
                                onclick="selectSearchHistory('${item}')"
                                title="${item}"
                            >${item}</button>
                        `).join('')}
                    </div>
                `;
            if (box) box.innerHTML = html;
            if (boxMobile) boxMobile.innerHTML = html;
        }

        function showSearchHistory() {
            if (suppressHistoryClick) return;
            renderSearchHistory();
            if (searchHistoryBox) searchHistoryBox.classList.remove('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.remove('hidden');
        }

        function hideSearchHistory() {
            if (searchHistoryBox) searchHistoryBox.classList.add('hidden');
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.classList.add('hidden');
        }

        function selectSearchHistory(term) {
            if (suppressHistoryClick) return;
            if (!term) return;
            if (searchInput) searchInput.value = term;
            if (searchInputMobile) searchInputMobile.value = term;
            searchData();
        }

        function bindSearchHistoryEvents() {
            const bind = (input) => {
                if (!input) return;
                input.addEventListener('focus', showSearchHistory);
                input.addEventListener('blur', () => {
                    setTimeout(hideSearchHistory, 150);
                });
            };
            bind(searchInput);
            bind(searchInputMobile);

            // ç§»åŠ¨ç«¯ç‚¹å‡»è¾“å…¥æ¡†æ—¶æ¸…ç©ºä¸Šæ¬¡æœç´¢å†…å®¹
            if (searchInputMobile) {
                searchInputMobile.addEventListener('focus', () => {
                    searchInputMobile.value = '';
                });
            }
            if (searchButtonMobile) {
                const suppress = () => suppressHistoryInteractions(250);
                searchButtonMobile.addEventListener('mousedown', suppress);
                searchButtonMobile.addEventListener('pointerdown', suppress);
                searchButtonMobile.addEventListener('touchstart', suppress, { passive: true });
            }
        }

        function suppressHistoryInteractions(duration = 200) {
            suppressHistoryClick = true;
            hideSearchHistory();
            if (searchHistoryBox) searchHistoryBox.style.pointerEvents = 'none';
            if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = 'none';
            setTimeout(() => {
                suppressHistoryClick = false;
                if (searchHistoryBox) searchHistoryBox.style.pointerEvents = '';
                if (searchHistoryBoxMobile) searchHistoryBoxMobile.style.pointerEvents = '';
            }, duration);
        }

        // æ»šåŠ¨åˆ°å…ƒç´ å¹¶é¿å¼€å›ºå®šå¯¼èˆª
        function scrollToElementWithHeaderOffset(element, extraOffset = 0) {
            if (!element) return;
            const header = document.getElementById('header');
            const headerHeight = header ? header.offsetHeight : 0;
            const rect = element.getBoundingClientRect();
            const targetTop = rect.top + window.pageYOffset - headerHeight - extraOffset;
            window.scrollTo({ top: Math.max(targetTop, 0), behavior: 'smooth' });
        }
        
        let lastLoadMoreAt = 0;
        let mathChallengeAnswer = null;
        let mathChallengeResolver = null;

        function showMathChallengeModal() {
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a = Math.floor(Math.random() * 9) + 1;
            let b = Math.floor(Math.random() * 9) + 1;
            if (op === '-' && a < b) {
                const tmp = a;
                a = b;
                b = tmp;
            }
            mathChallengeAnswer = op === '+' ? a + b : op === '-' ? a - b : a * b;
            const questionEl = document.getElementById('mathChallengeQuestion');
            const inputEl = document.getElementById('mathChallengeInput');
            const errorEl = document.getElementById('mathChallengeError');
            const modalEl = document.getElementById('mathChallengeModal');
            if (!questionEl || !inputEl || !errorEl || !modalEl) return Promise.resolve(false);
            questionEl.textContent = `${a} ${op} ${b} = ?`;
            inputEl.value = '';
            errorEl.classList.add('hidden');
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
            document.body.style.overflow = 'hidden';
            setTimeout(() => inputEl.focus(), 0);
            return new Promise(resolve => {
                mathChallengeResolver = resolve;
            });
        }

        function hideMathChallengeModal() {
            const modalEl = document.getElementById('mathChallengeModal');
            if (!modalEl) return;
            modalEl.classList.add('hidden');
            modalEl.classList.remove('flex');
            document.body.style.overflow = '';
        }

        function submitMathChallenge() {
            const inputEl = document.getElementById('mathChallengeInput');
            const errorEl = document.getElementById('mathChallengeError');
            if (!inputEl || !errorEl) return;
            const answer = Number(String(inputEl.value).trim());
            if (!Number.isFinite(answer) || answer !== mathChallengeAnswer) {
                errorEl.classList.remove('hidden');
                inputEl.focus();
                return;
            }
            errorEl.classList.add('hidden');
            hideMathChallengeModal();
            if (typeof mathChallengeResolver === 'function') {
                mathChallengeResolver(true);
                mathChallengeResolver = null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const inputEl = document.getElementById('mathChallengeInput');
            const submitEl = document.getElementById('mathChallengeSubmit');
            if (submitEl) submitEl.addEventListener('click', submitMathChallenge);
            if (inputEl) {
                inputEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') submitMathChallenge();
                });
            }
        });

        // åŠ è½½æ›´å¤š
        async function loadMoreData() {
            if (isLoading || (!host && !isAggregateSearchEnabled()) || !hasMore) return;

            const now = Date.now();
            if (now - lastLoadMoreAt < 5000) {
                const ok = await showMathChallengeModal();
                if (!ok) return;
            }
            lastLoadMoreAt = now;
            
            isLoading = true;
            showLoading('åŠ è½½æ›´å¤šå†…å®¹...');
            
            fetchData(searchTerm, currentPage + 1).finally(() => {
                hideLoading();
                isLoading = false;
            });
        }
        
        // å¤„ç†å›è½¦é”®æœç´¢
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchData();
            }
        }
        
        // æ˜¾ç¤ºå…¨å±é¢„è§ˆ
        function openFullScreenPreview(imageUrl, title) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="relative max-w-4xl max-h-[90vh]">
                    <button 
                        onclick="this.closest('.fixed').remove()"
                        class="absolute -top-12 right-0 text-white hover:text-gray-300"
                    >
                        <i class="fa fa-times text-xl"></i>
                    </button>
                    <img 
                        src="${imageUrl}" 
                        alt="${title}" 
                        onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';"
                        loading="lazy"
                        class="max-w-full max-h-[90vh] object-contain rounded-lg"
                    >
                    <p class="text-white text-center mt-4">${title}</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            
            // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    document.body.style.overflow = '';
                }
            });
        }
        
        // æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨
        function openVideoPlayer(videoUrl, videoTitle, imageUrl = '', sourceLabel = '') {
            if (!host) {
                if (!isAggregateSearchEnabled()) {
                    showToast('è¯·å…ˆè®¾ç½®API Host');
                    showHostModal();
                    return;
                }
            }
            
            showLoading('æ­£åœ¨åŠ è½½è§†é¢‘...');
            
            try {
                // è§£æçœŸå®è§†é¢‘URL
                const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
                currentVideoUrl = realVideoUrl;
                currentVideoTitle = videoTitle || 'è§†é¢‘æ’­æ”¾';
                currentVideoPic = imageUrl || '';
                currentVideoSource = sourceLabel || getHostLabel();
                updatePlayerLikeButtons(isFavorited(realVideoUrl));
                const playerTitle = document.getElementById('playerTitle');
                if (playerTitle) {
                    const label = currentVideoSource || 'æœªçŸ¥æ¥æº';
                    playerTitle.innerHTML = `<span class="bg-white/20 text-white/90 text-[10px] px-2 py-0.5 rounded mr-2">${label}</span>${currentVideoTitle}`;
                }
                
                // ä¿å­˜æ’­æ”¾å†å²
                saveToHistory(videoTitle, realVideoUrl, imageUrl, currentVideoSource);
                
                // æ˜¾ç¤ºæ’­æ”¾å™¨
                videoPlayerModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // åˆå§‹åŒ–DPlayer
                if (dplayer) {
                    dplayer.destroy();
                }
                
                const resumeTarget = loadResumeTime(realVideoUrl);
                let resumeApplied = false;

                dplayer = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: realVideoUrl,
                        type: 'hls',
                        pic: '',
                        thumbnails: '',
                        title: videoTitle || 'è§†é¢‘æ’­æ”¾'
                    },
                    autoplay: true,
                    theme: '#3b82f6',
                    loop: false,
                    screenshot: true,
                    hotkey: true,
                    preload: 'auto',
                    contextmenu: [
                        {
                            text: 'åœ¨æ–°çª—å£æ‰“å¼€',
                            link: realVideoUrl,
                        }
                    ]
                });
                
                // æ·»åŠ çª—å£æ’­æ”¾æŒ‰é’®åˆ°æ§åˆ¶æ 
                setTimeout(() => {
                    const controller = document.querySelector('.dplayer-controller');
                    if (controller) {
                        const windowButton = document.createElement('button');
                        windowButton.className = 'dplayer-button dplayer-window-button';
                        windowButton.innerHTML = '<i class="fa fa-window-restore"></i>';
                        windowButton.title = 'çª—å£æ’­æ”¾';
                        windowButton.onclick = () => window.open(realVideoUrl, '_blank');
                        
                        // æ’å…¥åˆ°å…¨å±æŒ‰é’®ä¹‹å‰
                        const fullscreenButton = controller.querySelector('.dplayer-fullscreen-toggle');
                        if (fullscreenButton) {
                            controller.insertBefore(windowButton, fullscreenButton);
                        } else {
                            controller.appendChild(windowButton);
                        }
                    }
                }, 100);
                
                dplayer.on('play', () => {
                    hideLoading();
                    isLoading = false;
                });

                dplayer.on('loadedmetadata', () => {
                    if (resumeApplied || !resumeTarget) return;
                    const duration = dplayer?.video?.duration || 0;
                    if (duration > 0 && resumeTarget < duration - RESUME_MIN_SECONDS) {
                        dplayer.seek(resumeTarget);
                        resumeApplied = true;
                        showToast('å·²æ¢å¤åˆ°ä¸Šæ¬¡æ’­æ”¾ä½ç½®');
                    }
                });

                dplayer.on('timeupdate', () => {
                    if (!dplayer || !dplayer.video) return;
                    const current = dplayer.video.currentTime || 0;
                    if (lastWatchUrl !== realVideoUrl) {
                        lastWatchUrl = realVideoUrl;
                        lastWatchTime = current;
                    }
                    const delta = current - lastWatchTime;
                    if (delta > 0 && delta <= 5) {
                        addWatchTime(delta);
                    }
                    lastWatchTime = current;
                    saveResumeTime(realVideoUrl, dplayer.video.currentTime, dplayer.video.duration);
                });

                dplayer.on('pause', () => {
                    saveResumeNow(realVideoUrl);
                });

                dplayer.on('seeked', () => {
                    saveResumeNow(realVideoUrl);
                });

                dplayer.on('ended', () => {
                    clearResumeTime(realVideoUrl);
                    lastWatchTime = 0;
                    lastWatchUrl = '';
                });
                
                dplayer.on('error', (e) => {
                    // åªæœ‰åœ¨åŠ è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ‰æ˜¾ç¤ºæç¤º
                    if (isLoading) {
                        hideLoading();
                        showToast('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–è§†é¢‘');
                    }
                    console.error('è§†é¢‘æ’­æ”¾é”™è¯¯:', e);
                });
            } catch (error) {
                hideLoading();
                showToast('è§†é¢‘åŠ è½½å¤±è´¥');
                console.error('è§†é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
        
        // å…³é—­è§†é¢‘æ’­æ”¾å™¨
        function closeVideoPlayer() {
            if (dplayer) {
                saveResumeNow(currentVideoUrl);
                dplayer.destroy();
                dplayer = null;
            }
            
            videoPlayerModal.classList.add('hidden');
            document.body.style.overflow = '';
            currentVideoUrl = '';
            currentVideoTitle = '';
            currentVideoPic = '';
            currentVideoSource = '';
            updatePlayerLikeButtons(false);
            const playerTitle = document.getElementById('playerTitle');
            if (playerTitle) {
                playerTitle.textContent = '';
            }
            
            // éšè—ç§»åŠ¨è®¾å¤‡å…³é—­æŒ‰é’®
            const mobileCloseButton = document.getElementById('closeVideoButtonMobile');
            if (mobileCloseButton) {
                // ä½¿ç”¨classNameé‡ç½®æ‰€æœ‰æ ·å¼ï¼Œç¡®ä¿ä¸‹æ¬¡èƒ½æ­£ç¡®æ˜¾ç¤º
                mobileCloseButton.className = 'md:hidden fixed top-4 right-4 bg-red-600 text-white rounded-full w-12 h-12 flex items-center justify-center z-50 shadow-lg';
                mobileCloseButton.style.cssText = '';
            }
        }
        
        // ä¿å­˜åˆ°æ’­æ”¾å†å²
        function saveToHistory(title, url, pic, source) {
            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingIndex = history.findIndex(item => item.url === url);
                
                const historyItem = {
                    title,
                    url,
                    pic: pic || '',
                    source: source || '',
                    timestamp: Date.now(),
                    playCount: existingIndex >= 0 ? (history[existingIndex].playCount || 0) + 1 : 1,
                    lastPosition: existingIndex >= 0 ? (history[existingIndex].lastPosition || 0) : 0,
                    lastPositionUpdatedAt: existingIndex >= 0 ? (history[existingIndex].lastPositionUpdatedAt || 0) : 0
                };
                
                // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
                if (existingIndex >= 0) {
                    history.splice(existingIndex, 1);
                }
                
                // æ·»åŠ åˆ°å¼€å¤´
                history.unshift(historyItem);
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (history.length > 50) {
                    history.splice(50);
                }
                
                localStorage.setItem('videoPlayHistory', JSON.stringify(history));
            } catch (error) {
                console.error('ä¿å­˜æ’­æ”¾å†å²å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå†å²è®°å½•
        function toggleHistory() {
            const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            
            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-history text-4xl mb-3"></i>
                        <p>æš‚æ— æ’­æ”¾å†å²</p>
                    </div>
                `;
            } else {
                historyContent.innerHTML = history.map(item => {
                    const resumeFromStore = getResumeTimeForHistory(item);
                    const resumeFromHistory = Number(item.lastPosition || 0);
                    const resumeTime = resumeFromStore > 0 ? resumeFromStore : resumeFromHistory;
                    const resumeLabelText = resumeTime > 0 ? formatDuration(resumeTime) : 'æš‚æ— ';
                    const resumeLabel = resumeTime > 0 ? `ä¸Šæ¬¡æ’­æ”¾: ${resumeLabelText}` : '';
                    return `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';" loading="lazy" class="w-full h-full object-cover">`
                                        : `<img src="${FALLBACK_IMAGE}" alt="loading" loading="lazy" class="w-full h-full object-cover">`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || 'æœªçŸ¥æ¥æº'}</span>
                                    ${item.title}
                                </h4>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-500">
                                    <span>æ’­æ”¾æ¬¡æ•°: ${item.playCount}</span>
                                    ${resumeLabel ? `<span>${resumeLabel}</span>` : ''}
                                    <span>${formatDate(item.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button 
                                onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                                class="btn-primary text-xs py-1 px-2 flex-1"
                            >
                                <i class="fa fa-play mr-1"></i> æ’­æ”¾
                            </button>
                            <button 
                                onclick="removeFromHistory('${item.url}')"
                                class="text-gray-500 hover:text-red-500 p-1"
                            >
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            const willOpen = historyPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(historyPanel);
            historyPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        // å–œæ¬¢åŠŸèƒ½
        function getFavorites() {
            return JSON.parse(localStorage.getItem('videoFavorites') || '[]');
        }

        function isFavorited(videoUrl) {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const favorites = getFavorites();
            return favorites.some(item => item.url === realVideoUrl);
        }

        function toggleFavorite(title, videoUrl, pic, buttonEl, sourceLabel = '') {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === realVideoUrl);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                showToast('å·²å–æ¶ˆå–œæ¬¢');
                updateFavoriteButton(buttonEl, false);
            } else {
                const source = sourceLabel || getHostLabel();
                favorites.unshift({
                    title,
                    url: realVideoUrl,
                    pic: pic || '',
                    source: source || '',
                    timestamp: Date.now()
                });
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                showToast('å·²åŠ å…¥å–œæ¬¢');
                updateFavoriteButton(buttonEl, true);
            }
            
            localStorage.setItem('videoFavorites', JSON.stringify(favorites));
        }

        function updateFavoriteButton(buttonEl, isLiked) {
            if (!buttonEl) return;
            buttonEl.classList.toggle('text-red-500', isLiked);
            buttonEl.classList.toggle('text-gray-500', !isLiked);
            const icon = buttonEl.querySelector('i');
            if (icon) {
                icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'} mr-1`;
            }
        }

        function toggleFavorites() {
            const favorites = getFavorites();
            
            if (favorites.length === 0) {
                favoriteContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa fa-heart text-4xl mb-3"></i>
                        <p>æš‚æ— å–œæ¬¢å†…å®¹</p>
                    </div>
                `;
            } else {
                favoriteContent.innerHTML = favorites.map(item => `
                    <div class="bg-white rounded-lg p-3 mb-3 shadow-sm">
                        <div class="flex space-x-3">
                            <div class="w-20 h-12 rounded-md overflow-hidden bg-gray-200 flex-shrink-0">
                                ${
                                    item.pic
                                        ? `<img src="${item.pic}" alt="${item.title}" onerror="this.onerror=null;this.src='${FALLBACK_IMAGE}';" loading="lazy" class="w-full h-full object-cover">`
                                        : `<img src="${FALLBACK_IMAGE}" alt="loading" loading="lazy" class="w-full h-full object-cover">`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-medium text-sm mb-2 line-clamp-1">
                                    <span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded mr-1">${item.source || 'æœªçŸ¥æ¥æº'}</span>
                                    ${item.title}
                                </h4>
                                <div class="text-xs text-gray-500">
                                    <span>æ”¶è—æ—¶é—´: ${formatDate(item.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex space-x-2">
                            <button 
                                onclick="openVideoPlayer('${item.url}', '${item.title}', '${item.pic || ''}', '${item.source || ''}')"
                                class="btn-primary text-xs py-1 px-2 flex-1"
                            >
                                <i class="fa fa-play mr-1"></i> æ’­æ”¾
                            </button>
                            <button 
                                onclick="removeFavorite('${item.url}')"
                                class="text-gray-500 hover:text-red-500 p-1"
                            >
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            const willOpen = favoritePanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(favoritePanel);
            favoritePanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        function removeFavorite(url) {
            try {
                const favorites = getFavorites().filter(item => item.url !== url);
                localStorage.setItem('videoFavorites', JSON.stringify(favorites));
                toggleFavorites();
                toggleFavorites();
            } catch (error) {
                console.error('ç§»é™¤å–œæ¬¢å¤±è´¥:', error);
            }
        }

        function clearFavorites() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å–œæ¬¢å†…å®¹å—ï¼Ÿ')) {
                localStorage.removeItem('videoFavorites');
                toggleFavorites();
                toggleFavorites();
                showToast('å–œæ¬¢å†…å®¹å·²æ¸…ç©º');
            }
        }
        
        // ä»å†å²è®°å½•ä¸­ç§»é™¤
        function removeFromHistory(url) {
            try {
                const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
                const filteredHistory = history.filter(item => item.url !== url);
                localStorage.setItem('videoPlayHistory', JSON.stringify(filteredHistory));
                
                // é‡æ–°æ¸²æŸ“å†å²è®°å½•
                toggleHistory();
                toggleHistory();
            } catch (error) {
                console.error('ç§»é™¤å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ’­æ”¾å†å²å—ï¼Ÿ')) {
                localStorage.removeItem('videoPlayHistory');
                toggleHistory();
                toggleHistory();
                showToast('å†å²è®°å½•å·²æ¸…ç©º');
            }
        }
        
        // åˆ‡æ¢Hostè®¾ç½®æ¨¡æ€æ¡†
        function toggleHostModal() {
            const willOpen = hostModal.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(hostModal);
            hostModal.classList.toggle('translate-x-full');
            updateOverlayForPanels();

            if (willOpen) {
                hostInput.value = host;
                hostInput.focus();
                fetchOfficialApis(false);
                renderHostHistory();
                renderTransferHistory();
            }
        }

        function showHostModal() {
            if (!hostModal) return;
            if (hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
        }
        
        // ä¿å­˜Hostè®¾ç½®
        function saveHost() {
            const input = hostInput.value.trim();
            
            if (!input) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„Hoståœ°å€');
                return;
            }
            
            // éªŒè¯URLæ ¼å¼
            try {
                new URL(input);
            } catch (e) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„URLæ ¼å¼');
                return;
            }
            
            host = input;
            localStorage.setItem('apiHost', host);
            hostName = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            saveHostHistory(host);
            
            toggleHostModal();
            showToast('Hostè®¾ç½®å·²ä¿å­˜');
            
            // å¦‚æœä¹‹å‰å› ä¸ºæ²¡æœ‰Hostè€Œæ— æ³•åŠ è½½æ•°æ®ï¼Œç°åœ¨é‡æ–°åŠ è½½
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }
        
        // é‡ç½®Hostè®¾ç½®
        function resetHost() {
            host = '';
            hostName = '';
            hostInput.value = '';
            localStorage.removeItem('apiHost');
            localStorage.removeItem('apiHostName');
            showToast('Hostå·²é‡ç½®');
        }

        // èšåˆæœç´¢å¼€å…³
        function isAggregateSearchEnabled() {
            return localStorage.getItem('aggregateSearch') === '1';
        }

        function toggleAggregateSearch() {
            if (!aggregateSwitch) return;
            const enabled = !!aggregateSwitch.checked;
            localStorage.setItem('aggregateSearch', enabled ? '1' : '0');
            updateAggregateSwitchUI(enabled);
            if (enabled) {
                fetchOfficialApis(false);
                renderAggregateApiSelection(officialApiCache ? officialApiCache.data : []);
                if (aggregateApiSection && aggregateApiSection.classList.contains('hidden')) {
                    aggregateApiSection.classList.remove('hidden');
                    if (aggregateApiToggleButton) {
                        aggregateApiToggleButton.textContent = 'æ”¶èµ·';
                    }
                }
                showToast('å·²å¼€å¯èšåˆæœç´¢');
            } else {
                showToast('å·²å…³é—­èšåˆæœç´¢');
            }
        }

        function confirmAggregateSelection() {
            showToast('èšåˆæ¥å£å·²ä¿å­˜');
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
        }

        function toggleAggregateApiSection() {
            if (!aggregateApiSection) return;
            fetchOfficialApis(false);
            aggregateApiSection.classList.toggle('hidden');
            if (aggregateApiToggleButton) {
                aggregateApiToggleButton.textContent = aggregateApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function toggleOfficialApiSection() {
            if (!officialApiSection) return;
            officialApiSection.classList.toggle('hidden');
            if (officialApiToggleButton) {
                officialApiToggleButton.textContent = officialApiSection.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function updateAggregateSwitchUI(enabled) {
            if (!aggregateSwitch) return;
            const track = aggregateSwitch.nextElementSibling;
            if (!track) return;
            const thumb = track.firstElementChild;
            track.classList.toggle('bg-primary', enabled);
            track.classList.toggle('bg-gray-300', !enabled);
            if (thumb) {
                thumb.classList.toggle('translate-x-4', enabled);
                thumb.classList.toggle('translate-x-0', !enabled);
            }
            updateSearchButtonLabel(enabled);
        }

        function isPrivacyModeEnabled() {
            const value = localStorage.getItem('privacyMode');
            if (value === null) return true;
            return value === '1';
        }

        function togglePrivacyMode() {
            if (!privacySwitch) return;
            const enabled = !!privacySwitch.checked;
            localStorage.setItem('privacyMode', enabled ? '1' : '0');
            updatePrivacySwitchUI(enabled);
            applyPrivacyMode(enabled);
            showToast(enabled ? 'å·²å¼€å¯éšç§é®æŒ¡' : 'å·²å…³é—­éšç§é®æŒ¡');
        }

        function updatePrivacySwitchUI(enabled) {
            if (!privacySwitch) return;
            const track = privacySwitch.nextElementSibling;
            if (!track) return;
            const thumb = track.firstElementChild;
            track.classList.toggle('bg-primary', enabled);
            track.classList.toggle('bg-gray-300', !enabled);
            if (thumb) {
                thumb.classList.toggle('translate-x-4', enabled);
                thumb.classList.toggle('translate-x-0', !enabled);
            }
        }

        function applyPrivacyMode(enabled) {
            document.body.classList.toggle('privacy-on', !!enabled);
        }

        function updateSearchButtonLabel(aggregateEnabled) {
            const label = aggregateEnabled ? 'èšåˆæœç´¢' : 'æœç´¢';
            const desktopLabel = document.getElementById('searchButtonLabel');
            const mobileLabel = document.getElementById('searchButtonLabelMobile');
            if (desktopLabel) desktopLabel.textContent = label;
            if (mobileLabel) mobileLabel.textContent = label;
        }

        function toggleMobileSearch() {
            const box = document.getElementById('mobileSearchBox');
            if (!box) return;
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                if (searchInputMobile) searchInputMobile.focus();
            }
        }

        // å¯¼å‡º/å¯¼å…¥å–œæ¬¢ã€å†å²ã€æ˜µç§°ä¸æœç´¢è®°å½•
        function exportUserData() {
            const favorites = JSON.parse(localStorage.getItem('videoFavorites') || '[]');
            const playHistory = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const userNickname = localStorage.getItem('userNickname') || '';
            const playbackResume = JSON.parse(localStorage.getItem(RESUME_STORAGE_KEY) || '{}');
            const payload = {
                favorites,
                playHistory,
                searchHistory,
                userNickname,
                playbackResume
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const pad = (n) => String(n).padStart(2, '0');
            const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
            a.download = `video-data-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            addTransferHistory('å¯¼å‡º', a.download);
            showToast('å¯¼å‡ºæˆåŠŸ');
        }

        function importUserData(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result || '{}');
                    if (data.favorites && Array.isArray(data.favorites)) {
                        localStorage.setItem('videoFavorites', JSON.stringify(data.favorites));
                    } else {
                        localStorage.setItem('videoFavorites', JSON.stringify([]));
                    }
                    if (data.playHistory && Array.isArray(data.playHistory)) {
                        localStorage.setItem('videoPlayHistory', JSON.stringify(data.playHistory));
                    } else {
                        localStorage.setItem('videoPlayHistory', JSON.stringify([]));
                    }
                    if (data.searchHistory && Array.isArray(data.searchHistory)) {
                        localStorage.setItem('searchHistory', JSON.stringify(data.searchHistory));
                    } else {
                        localStorage.setItem('searchHistory', JSON.stringify([]));
                    }
                    if (typeof data.userNickname === 'string' && data.userNickname.trim()) {
                        localStorage.setItem('userNickname', data.userNickname.trim());
                    } else {
                        localStorage.removeItem('userNickname');
                    }
                    if (data.playbackResume && typeof data.playbackResume === 'object') {
                        localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify(data.playbackResume));
                    } else {
                        localStorage.setItem(RESUME_STORAGE_KEY, JSON.stringify({}));
                    }
                    renderUserInfo();
                    addTransferHistory('å¯¼å…¥', file.name);
                    showToast('å¯¼å…¥æˆåŠŸ');
                } catch (e) {
                    showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function getTransferHistory() {
            return JSON.parse(localStorage.getItem('transferHistory') || '[]');
        }

        function addTransferHistory(type, filename) {
            const history = getTransferHistory();
            history.unshift({
                type,
                filename: filename || '',
                timestamp: Date.now()
            });
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('transferHistory', JSON.stringify(history));
            renderTransferHistory();
        }

        function renderTransferHistory() {
            if (!transferHistoryList) return;
            const history = getTransferHistory();
            if (history.length === 0) {
                transferHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— è®°å½•</div>
                `;
                return;
            }
            transferHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.type} Â· ${formatDate(item.timestamp)}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.filename || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function handleActionSelect(value) {
            if (!value) return;
            if (value === 'favorite') {
                toggleFavorites();
            } else if (value === 'history') {
                toggleHistory();
            } else if (value === 'user') {
                toggleUserInfo();
            } else if (value === 'setting') {
                toggleHostModal();
            } else if (value === 'about') {
                toggleAboutPanel();
            }
            const select = document.getElementById('actionSelect');
            if (select) select.value = '';
        }

        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            if (!menu) return;
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                menu.addEventListener('mouseleave', handleMoreMenuMouseLeave, { once: true });
            }
        }

        function handleMoreAction(action) {
            if (action === 'favorite') {
                toggleFavorites();
            } else if (action === 'history') {
                toggleHistory();
            } else if (action === 'user') {
                toggleUserInfo();
            } else if (action === 'setting') {
                toggleHostModal();
            } else if (action === 'about') {
                toggleAboutPanel();
            }
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        function handleMoreMenuMouseLeave() {
            const menu = document.getElementById('moreMenu');
            if (menu) menu.classList.add('hidden');
        }

        function renderUserInfo() {
            if (!userInfoContent) return;
            const nickname = localStorage.getItem('userNickname') || '';
            const nicknameDisplay = document.getElementById('userNicknameDisplay');
            const nicknameInput = document.getElementById('userNicknameInput');
            if (nicknameDisplay) {
                nicknameDisplay.textContent = nickname ? nickname : 'æœªè®¾ç½®';
            }
            if (nicknameInput) {
                nicknameInput.value = nickname;
            }
            const favorites = getFavorites();
            const history = JSON.parse(localStorage.getItem('videoPlayHistory') || '[]');
            const searchHistory = getSearchHistory();
            const favoriteCountEl = document.getElementById('userFavoriteCount');
            const historyCountEl = document.getElementById('userHistoryCount');
            const searchCountEl = document.getElementById('userSearchCount');
            const watchTodayEl = document.getElementById('userWatchToday');
            if (favoriteCountEl) favoriteCountEl.textContent = String(favorites.length);
            if (historyCountEl) historyCountEl.textContent = String(history.length);
            if (searchCountEl) searchCountEl.textContent = String(searchHistory.length);
            if (watchTodayEl) watchTodayEl.textContent = formatDuration(getTodayWatchTime());

            const lastVisitEl = document.getElementById('userLastVisit');
            if (lastVisitEl) {
                const historyList = JSON.parse(localStorage.getItem('visitHistory') || '[]');
                if (!historyList || historyList.length === 0) {
                    lastVisitEl.textContent = 'é¦–æ¬¡è®¿é—®';
                } else {
                    lastVisitEl.innerHTML = historyList
                        .slice(0, 5)
                        .map((timestamp) => `<div>${formatDate(Number(timestamp))}</div>`)
                        .join('');
                }
            }
        }

        function saveUserNickname() {
            const nicknameInput = document.getElementById('userNicknameInput');
            if (!nicknameInput) return;
            const value = nicknameInput.value.trim();
            if (!value) {
                localStorage.removeItem('userNickname');
                renderUserInfo();
                showToast('å·²æ¸…ç©ºæ˜µç§°');
                return;
            }
            localStorage.setItem('userNickname', value);
            renderUserInfo();
            showToast('æ˜µç§°å·²ä¿å­˜');
        }

        function generateRandomNickname() {
            const adjectives = ['æ¸…é£', 'æ˜Ÿæ²³', 'æ™¨æ›¦', 'å¤œèˆª', 'è¿œå±±', 'æ˜¥é›¨', 'è“é²¸', 'å¾®å…‰', 'ç™½éœ²', 'æ™šæ™´'];
            const nouns = ['æ—…äºº', 'è§‚å½±è€…', 'æ¢è·¯è€…', 'è¿½å…‰è€…', 'å°å±‹', 'ç”µå°', 'é£é“ƒ', 'å²›å±¿', 'é•¿æ­Œ', 'ç¢ç‰‡'];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const number = Math.floor(Math.random() * 900) + 100;
            return `${adjective}${noun}${number}`;
        }

        function setRandomNickname() {
            const nicknameInput = document.getElementById('userNicknameInput');
            if (!nicknameInput) return;
            const value = generateRandomNickname();
            nicknameInput.value = value;
            localStorage.setItem('userNickname', value);
            renderUserInfo();
            showToast('éšæœºæ˜µç§°å·²ç”Ÿæˆ');
        }

        function toggleUserInfo() {
            if (!userPanel) return;
            renderUserInfo();
            const willOpen = userPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(userPanel);
            userPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        function toggleAboutPanel() {
            if (!aboutPanel) return;
            const willOpen = aboutPanel.classList.contains('translate-x-full');
            if (willOpen) closePanelsExcept(aboutPanel);
            aboutPanel.classList.toggle('translate-x-full');
            updateOverlayForPanels();
        }

        // å®˜æ–¹æ¨èæ¥å£
        let officialApiCache = null;

        function fetchOfficialApis(force) {
            if (!officialApiList) return;
            if (officialApiCache && !force) {
                renderOfficialApis(officialApiCache);
                return;
            }
            
            officialApiList.innerHTML = `
                <div class="text-xs text-gray-500">æ­£åœ¨è·å–å®˜æ–¹æ¨è...</div>
            `;
            
            fetch(getOfficialApiUrl())
                .then(res => {
                    if (res.status === 401) {
                        officialApiList.innerHTML = `
                            <div class="text-xs text-red-500">è®¿é—®å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯</div>
                        `;
                        revokeAccess('è®¿é—®å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯');
                        throw new Error('unauthorized');
                    }
                    return res.json();
                })
                .then(data => {
                    if (!data || data.code !== 200 || !Array.isArray(data.data)) {
                        throw new Error('å®˜æ–¹æ¥å£è¿”å›å¼‚å¸¸');
                    }
                    officialApiCache = data;
                    try {
                        localStorage.setItem('officialApiList', JSON.stringify(data.data));
                    } catch (e) {
                        // ignore storage errors
                    }
                    renderOfficialApis(data);
                })
                .catch(err => {
                    if (err && err.message === 'unauthorized') {
                        return;
                    }
                    console.error('è·å–å®˜æ–¹æ¥å£å¤±è´¥:', err);
                    officialApiList.innerHTML = `
                        <div class="text-xs text-red-500">è·å–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•</div>
                    `;
                });
        }

        function renderOfficialApis(data) {
            if (!data || !Array.isArray(data.data)) {
                officialApiList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— å®˜æ–¹æ¨è</div>
                `;
                if (officialApiCount) {
                    officialApiCount.textContent = '0';
                }
                if (aggregateApiList) {
                    aggregateApiList.innerHTML = `
                        <div class="text-xs text-gray-500">æš‚æ— å¯é€‰æ¥å£</div>
                    `;
                }
                return;
            }
            
            const metaText = [data.title, data.subtitle].filter(Boolean).join(' Â· ');
            const metaHtml = metaText
                ? `<div class="text-xs text-gray-500 mb-2">${metaText}</div>`
                : '';
            
            const itemsHtml = data.data.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="min-w-0 mr-2">
                        <div class="text-xs text-gray-700 truncate">${item.name || 'å®˜æ–¹æ¨è'}</div>
                        <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                    </div>
                    <button 
                        onclick="selectHost('${item.url || ''}', '${item.name || ''}')"
                        class="text-xs text-primary hover:underline"
                    >ä½¿ç”¨</button>
                </div>
            `).join('');

            if (officialApiCount) {
                officialApiCount.textContent = String(data.data.length);
            }
            officialApiList.innerHTML = `
                ${metaHtml}
                ${itemsHtml || '<div class="text-xs text-gray-500">æš‚æ— å®˜æ–¹æ¨è</div>'}
            `;

            renderAggregateApiSelection(data.data);
        }

        async function getOfficialApis() {
            if (officialApiCache && Array.isArray(officialApiCache.data)) {
                return officialApiCache.data.filter(item => item && item.url);
            }
            try {
                const cached = localStorage.getItem('officialApiList');
                if (cached) {
                    const list = JSON.parse(cached);
                    if (Array.isArray(list)) {
                        return list.filter(item => item && item.url);
                    }
                }
            } catch (e) {
                // ignore cache errors
            }
            const res = await fetch(getOfficialApiUrl());
            const data = await res.json();
            if (data && data.code === 200 && Array.isArray(data.data)) {
                officialApiCache = data;
                try {
                    localStorage.setItem('officialApiList', JSON.stringify(data.data));
                } catch (e) {
                    // ignore storage errors
                }
                renderAggregateApiSelection(data.data);
                return data.data.filter(item => item && item.url);
            }
            return [];
        }

        function getOfficialLabel(item) {
            if (item && item.name) return item.name;
            if (item && item.url) return getHostNameFromUrl(item.url);
            return 'å®˜æ–¹æ¨è';
        }

        function getAggregateApiSelection() {
            try {
                const raw = localStorage.getItem('aggregateApiSelection');
                const list = raw ? JSON.parse(raw) : [];
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function setAggregateApiSelection(urls) {
            const unique = Array.from(new Set((urls || []).filter(Boolean)));
            localStorage.setItem('aggregateApiSelection', JSON.stringify(unique));
            if (aggregateSelectedCount) {
                aggregateSelectedCount.textContent = String(unique.length);
            }
        }

        function ensureDefaultAggregateSelection(apis) {
            const current = getAggregateApiSelection();
            if (current.length > 0) return current;
            const defaults = (apis || []).slice(0, 3).map(item => item.url).filter(Boolean);
            setAggregateApiSelection(defaults);
            return defaults;
        }

        function renderAggregateApiSelection(apis) {
            if (!aggregateApiList) return;
            const list = (apis || []).filter(item => item && item.url);
            if (list.length === 0) {
                aggregateApiList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— å¯é€‰æ¥å£</div>
                `;
                if (aggregateSelectedCount) {
                    aggregateSelectedCount.textContent = '0';
                }
                return;
            }
            const selected = ensureDefaultAggregateSelection(list);
            if (aggregateSelectedCount) {
                aggregateSelectedCount.textContent = String(selected.length);
            }
            aggregateApiList.innerHTML = list.map(item => {
                const checked = selected.includes(item.url) ? 'checked' : '';
                return `
                    <label class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                        <div class="min-w-0 mr-2">
                            <div class="text-xs text-gray-700 truncate">${item.name || 'å®˜æ–¹æ¨è'}</div>
                            <div class="text-[11px] text-gray-500 truncate">${item.url || ''}</div>
                        </div>
                        <input 
                            type="checkbox" 
                            class="w-4 h-4"
                            ${checked}
                            onchange="toggleAggregateApi('${item.url}')"
                        >
                    </label>
                `;
            }).join('');
        }

        function toggleAggregateApi(url) {
            const selected = getAggregateApiSelection();
            const index = selected.indexOf(url);
            if (index >= 0) {
                selected.splice(index, 1);
            } else {
                selected.push(url);
            }
            setAggregateApiSelection(selected);
        }

        function selectAllAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const urls = list.map(item => item.url).filter(Boolean);
            setAggregateApiSelection(urls);
            renderAggregateApiSelection(list);
        }

        function clearAggregateApis() {
            setAggregateApiSelection([]);
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            renderAggregateApiSelection(list);
        }

        function resetAggregateApis() {
            const list = (officialApiCache && officialApiCache.data) ? officialApiCache.data : [];
            const defaults = list.slice(0, 3).map(item => item.url).filter(Boolean);
            setAggregateApiSelection(defaults);
            renderAggregateApiSelection(list);
        }

        // Hostå†å²è®°å½•
        function getHostHistory() {
            return JSON.parse(localStorage.getItem('hostHistory') || '[]');
        }

        function saveHostHistory(value) {
            const history = getHostHistory();
            const existingIndex = history.findIndex(item => item === value);
            if (existingIndex >= 0) {
                history.splice(existingIndex, 1);
            }
            history.unshift(value);
            if (history.length > 10) {
                history.splice(10);
            }
            localStorage.setItem('hostHistory', JSON.stringify(history));
        }

        function renderHostHistory() {
            const history = getHostHistory();
            if (history.length === 0) {
                hostHistoryList.innerHTML = `
                    <div class="text-xs text-gray-500">æš‚æ— å†å²è®°å½•</div>
                `;
                return;
            }
            hostHistoryList.innerHTML = history.map(item => `
                <div class="flex items-center justify-between bg-white/70 rounded-lg px-3 py-2">
                    <div class="text-xs text-gray-700 truncate mr-2">${item}</div>
                    <div class="flex items-center space-x-2">
                        <button 
                            onclick="selectHost('${item}', '')"
                            class="text-xs text-primary hover:underline"
                        >ä½¿ç”¨</button>
                        <button 
                            onclick="removeHostHistory('${item}')"
                            class="text-xs text-gray-500 hover:text-red-500"
                        >åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleHostHistory() {
            hostHistoryWrap.classList.toggle('hidden');
            if (!hostHistoryWrap.classList.contains('hidden')) {
                renderHostHistory();
            }
            if (hostHistoryToggleButton) {
                hostHistoryToggleButton.textContent = hostHistoryWrap.classList.contains('hidden') ? 'å±•å¼€' : 'æ”¶èµ·';
            }
        }

        function selectHost(value, name = '') {
            hostInput.value = value;
            host = value;
            localStorage.setItem('apiHost', host);
            hostName = name || getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            localStorage.setItem('apiHostName', hostName);
            saveHostHistory(host);
            showToast('å·²åˆ‡æ¢Host');
            if (!hostModal.classList.contains('translate-x-full')) {
                toggleHostModal();
            }
            if (videoList.children.length === 0) {
                loadInitialData();
            }
        }

        function getHostNameFromUrl(url) {
            try {
                const hostname = new URL(url).hostname;
                return hostname.replace(/^www\./, '');
            } catch (e) {
                return '';
            }
        }

        function getHostLabel() {
            if (hostName) return hostName;
            const name = getOfficialNameByUrl(host) || getHostNameFromUrl(host);
            return name || 'æœªçŸ¥æ¥æº';
        }

        function getOfficialNameByUrl(url) {
            if (!url) return '';
            const list = officialApiCache && Array.isArray(officialApiCache.data)
                ? officialApiCache.data
                : (() => {
                    try {
                        const raw = localStorage.getItem('officialApiList');
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        return [];
                    }
                })();
            const match = (list || []).find(item => item && item.url === url);
            return match && match.name ? match.name : '';
        }

        function removeHostHistory(value) {
            const history = getHostHistory().filter(item => item !== value);
            localStorage.setItem('hostHistory', JSON.stringify(history));
            renderHostHistory();
        }
        

        
        // åˆ†äº«è§†é¢‘
        function encodeSharePayload(fields) {
            const payload = (fields || [])
                .map(value => encodeURIComponent(value || ''))
                .join('|');
            return btoa(payload);
        }

        function getShareExpireSeconds() {
            if (!shareExpireSelect) return 0;
            const value = Number(shareExpireSelect.value || 0);
            return Number.isFinite(value) ? value : 0;
        }

        function buildShareUrl(videoUrl, videoTitle, videoPic, sourceLabel, expireSeconds) {
            const now = Date.now();
            const expiresAt = expireSeconds > 0 ? now + expireSeconds * 1000 : 0;
            const payload = encodeSharePayload([videoUrl, videoTitle, videoPic, sourceLabel, String(expiresAt)]);
            const pathname = window.location.pathname || '/';
            const isFilePath = pathname.split('/').pop().includes('.');
            const basePath = pathname.endsWith('/')
                ? pathname
                : (isFilePath ? pathname.replace(/[^/]*$/, '') : `${pathname}/`);
            const url = new URL(window.location.origin);
            url.pathname = `${basePath}play.html`;
            url.searchParams.set('key', payload);
            return url.toString();
        }

        function openShareModal(shareUrl) {
            if (!shareModal) return;
            currentShareUrl = shareUrl;
            shareModal.classList.remove('hidden');
            shareModal.classList.add('flex');
            showToast('åˆ†äº«é¢æ¿å·²æ‰“å¼€');
        }

        function closeShareModal() {
            if (!shareModal) return;
            shareModal.classList.add('hidden');
            shareModal.classList.remove('flex');
        }

        function copyShareUrl() {
            if (!currentShareUrl) return;
            try {
                navigator.clipboard.writeText(currentShareUrl).then(() => {
                    showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', currentShareUrl);
                });
            } catch (err) {
                prompt('è¯·å¤åˆ¶åˆ†äº«é“¾æ¥:', currentShareUrl);
            }
        }

        function shareVideo(videoUrl, videoTitle, videoPic = '', sourceLabel = '') {
            const realVideoUrl = videoUrl.split('$')[1] || videoUrl;
            const expireSeconds = getShareExpireSeconds();
            const shareUrl = buildShareUrl(realVideoUrl, videoTitle, videoPic, sourceLabel, expireSeconds);
            openShareModal(shareUrl);
        }

        // æ’­æ”¾å™¨å†…åˆ†äº«å½“å‰è§†é¢‘
        function shareCurrentVideo() {
            if (!currentVideoUrl) {
                showToast('æš‚æ— å¯åˆ†äº«çš„è§†é¢‘');
                return;
            }
            shareVideo(currentVideoUrl, currentVideoTitle || 'è§†é¢‘æ’­æ”¾', currentVideoPic || '', currentVideoSource || getHostLabel());
        }

        // æ’­æ”¾å™¨å†…å–œæ¬¢/å–æ¶ˆå–œæ¬¢
        function toggleCurrentVideoFavorite() {
            if (!currentVideoUrl) {
                showToast('æš‚æ— å¯æ“ä½œçš„è§†é¢‘');
                return;
            }
            
            const favorites = getFavorites();
            const existingIndex = favorites.findIndex(item => item.url === currentVideoUrl);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                showToast('å·²å–æ¶ˆå–œæ¬¢');
                updatePlayerLikeButtons(false);
            } else {
                const source = currentVideoSource || getHostLabel();
                favorites.unshift({
                    title: currentVideoTitle || 'è§†é¢‘æ’­æ”¾',
                    url: currentVideoUrl,
                    pic: currentVideoPic || '',
                    source: source || '',
                    timestamp: Date.now()
                });
                if (favorites.length > 100) {
                    favorites.splice(100);
                }
                showToast('å·²åŠ å…¥å–œæ¬¢');
                updatePlayerLikeButtons(true);
            }
            
            localStorage.setItem('videoFavorites', JSON.stringify(favorites));
        }

        function updatePlayerLikeButtons(isLiked) {
            const desktopBtn = document.getElementById('likeVideoButton');
            const mobileBtn = document.getElementById('likeVideoButtonMobile');
            [desktopBtn, mobileBtn].forEach(btn => {
                if (!btn) return;
                btn.classList.toggle('bg-red-600', isLiked);
                btn.classList.toggle('bg-gray-600', !isLiked);
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = `fa ${isLiked ? 'fa-heart' : 'fa-heart-o'}${btn.id === 'likeVideoButtonMobile' ? ' text-xl' : ''}`;
                }
            });
        }
        
        // åˆ†äº«å›é€€æ–¹æ¡ˆ
        function fallbackShare(url) {
            try {
                // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(url).then(() => {
                    showToast('è§†é¢‘é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(() => {
                    // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
                    prompt('è¯·å¤åˆ¶è§†é¢‘é“¾æ¥:', url);
                });
            } catch (err) {
                prompt('è¯·å¤åˆ¶è§†é¢‘é“¾æ¥:', url);
            }
        }
        
        // åˆ‡æ¢ç”»ä¸­ç”»æ¨¡å¼
        function togglePictureInPicture() {
            if (!dplayer || !dplayer.video) return;
            
            if (document.pictureInPictureElement) {
                // é€€å‡ºç”»ä¸­ç”»æ¨¡å¼
                document.exitPictureInPicture().then(() => {
                    showToast('å·²é€€å‡ºç”»ä¸­ç”»æ¨¡å¼');
                }).catch(err => {
                    console.error('é€€å‡ºç”»ä¸­ç”»å¤±è´¥:', err);
                    showToast('é€€å‡ºç”»ä¸­ç”»å¤±è´¥');
                });
            } else {
                // è¿›å…¥ç”»ä¸­ç”»æ¨¡å¼
                if (document.pictureInPictureEnabled) {
                    dplayer.video.requestPictureInPicture().then(() => {
                        showToast('å·²è¿›å…¥ç”»ä¸­ç”»æ¨¡å¼');
                    }).catch(err => {
                        console.error('è¿›å…¥ç”»ä¸­ç”»å¤±è´¥:', err);
                        showToast('è¿›å…¥ç”»ä¸­ç”»å¤±è´¥');
                    });
                } else {
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç”»ä¸­ç”»åŠŸèƒ½');
                }
            }
        }
        
        // æ»šåŠ¨å¤„ç†
        function handleScroll() {
            // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
            if (window.scrollY > 300) {
                floatingButtons.classList.remove('hidden');
            } else {
                floatingButtons.classList.add('hidden');
            }
            
            // æ— é™æ»šåŠ¨åŠ è½½æ›´å¤š
            if (window.innerHeight + window.scrollY >= document.body.scrollHeight - 200) {
                if (hasMore && !isLoading) {
                    loadMoreData();
                }
            }
        }
        
        // å›åˆ°é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(text = 'åŠ è½½ä¸­...') {
            loadingText.textContent = text;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            videoList.innerHTML = '';
            emptyState.classList.remove('hidden');
            hideLoadMoreButton();
        }
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showErrorState(message) {
            videoList.innerHTML = `
                <div class="col-span-full text-center py-16">
                    <i class="fa fa-exclamation-circle text-6xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">åŠ è½½å¤±è´¥</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button onclick="loadInitialData()" class="btn-primary">
                        <i class="fa fa-refresh mr-1"></i> é‡è¯•
                    </button>
                </div>
            `;
            hideLoadMoreButton();
        }
        
        // æ˜¾ç¤ºåŠ è½½æ›´å¤šæŒ‰é’®
        function showLoadMoreButton() {
            loadMoreButton.classList.remove('hidden');
        }
        
        // éšè—åŠ è½½æ›´å¤šæŒ‰é’®
        function hideLoadMoreButton() {
            loadMoreButton.classList.add('hidden');
        }
        
        function getPanels() {
            return [historyPanel, favoritePanel, userPanel, aboutPanel, hostModal].filter(Boolean);
        }

        function updateOverlayForPanels() {
            const anyOpen = getPanels().some(panel => !panel.classList.contains('translate-x-full'));
            overlay.classList.toggle('hidden', !anyOpen);
        }

        function closePanelsExcept(activePanel) {
            getPanels().forEach(panel => {
                if (panel !== activePanel) panel.classList.add('translate-x-full');
            });
        }

        // å…³é—­æ‰€æœ‰é¢æ¿
        function closeAllPanels() {
            getPanels().forEach(panel => panel.classList.add('translate-x-full'));
            overlay.classList.add('hidden');
        }

        
        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 2000);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // å°äº1å°æ—¶
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return minutes <= 1 ? 'åˆšåˆš' : `${minutes}åˆ†é’Ÿå‰`;
            }
            
            // å°äº24å°æ—¶
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}å°æ—¶å‰`;
            }
            
            // å°äº7å¤©
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days}å¤©å‰`;
            }
            
            // å…¶ä»–æƒ…å†µæ˜¾ç¤ºå…·ä½“æ—¥æœŸ
            return date.toLocaleDateString('zh-CN');
        }

        function formatDuration(seconds) {
            if (!Number.isFinite(seconds) || seconds <= 0) return '00:00';
            const total = Math.floor(seconds);
            const hours = Math.floor(total / 3600);
            const minutes = Math.floor((total % 3600) / 60);
            const secs = total % 60;
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        

    </script>
</body>
</html>
