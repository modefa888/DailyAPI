<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 15c0 .6-.4 1-1 1H4c-.6 0-1-.4-1-1V6h18v12z'/%3E%3Cpath d='M8 15h2.5l1-3 1 3H16v-5H8v5z'/%3E%3C/svg%3E"
        type="image/x-icon" />
    <title>91 - 视频浏览</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        dark: '#1e293b',
                        light: '#f8fafc',
                        like: '#ef4444' // 新增：收藏颜色（红色）
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .glass-dark {
                background: rgba(30, 41, 59, 0.8);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .gradient-text {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .gradient-bg {
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>

    <style>
        body.page-loading {
            opacity: 0;
            visibility: hidden;
        }
        body.page-loaded {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out;
        }
        .site-watermark {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            opacity: 0.08;
            background-repeat: repeat;
            background-size: 260px 180px;
            transform: rotate(-18deg);
            transform-origin: center;
            mix-blend-mode: multiply;
        }
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }


        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 加载动画 */
        .loader {
            border-top-color: #6366f1;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 视频卡片图片过渡效果 */
        .video-card-img {
            transition: transform 0.5s ease;
        }

        .video-card:hover .video-card-img {
            transform: scale(1.05);
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
            background-image:
                radial-gradient(circle at 25% 25%, #6366f1 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, #8b5cf6 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 60s linear infinite;
        }

        @keyframes moveBackground {
            0% {
                background-position: 0 0, 50px 50px;
            }

            100% {
                background-position: 50px 50px, 0 0;
            }
        }

        /* 模糊背景效果 */
        .backdrop-blur {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        /* 收藏按钮过渡效果（无背景，仅保留过渡和光标） */
        .like-btn {
            transition: all 0.2s ease;
            cursor: pointer;
            /* 彻底删掉所有background相关代码，无任何背景 */
        }
        /* 可选：hover时仅变颜色，无背景 */
        .like-btn:hover {
            transform: scale(1.1); /* 可选：hover轻微放大，提升交互 */
        }

        /* 顶部设置相关面板统一样式 */
        .panel-shell {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.94), rgba(30, 41, 59, 0.9));
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.45);
            border-radius: 16px;
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            overflow: hidden;
        }
        .panel-entry {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.68rem 0.78rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }
        .panel-entry:hover {
            background: rgba(99, 102, 241, 0.22);
            border-color: rgba(129, 140, 248, 0.45);
            transform: translateX(2px);
        }
        .panel-titlebar {
            padding: 0.78rem 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.04);
        }
        .panel-clear-btn {
            color: rgba(255, 255, 255, 0.75);
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .panel-clear-btn:hover {
            color: #fda4af;
        }
        .panel-content > div {
            transition: all 0.2s ease;
        }
        .panel-content > div:hover {
            background: rgba(255, 255, 255, 0.04);
        }
    </style>
</head>

<body class="bg-light text-dark min-h-screen page-loading">
    <!-- 背景动画 -->
    <div class="bg-animation"></div>
    <div id="siteWatermark" class="site-watermark"></div>

    <!-- 导航头 -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 glass-dark text-white shadow-lg transition-transform duration-300">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center space-x-2">
                <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z">
                    </path>
                </svg>
                <h1 class="text-xl font-bold gradient-text">91</h1>
            </div>

            <!-- 搜索框 -->
            <div class="relative max-w-md w-full mx-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索视频..." onkeypress="handleKeyPress(event)"
                        class="w-full py-2 pl-10 pr-4 rounded-full bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary/50 text-white placeholder-white/60 transition-all">
                    <i class="fa fa-search absolute left-3 top-3 text-white/60"></i>
                </div>
                <button id="searchButton" onclick="searchData()"
                    class="absolute right-1 top-1 bg-primary hover:bg-primary/90 text-white w-9 h-9 rounded-full transition-all flex items-center justify-center">
                    <i class="fa fa-search"></i>
                </button>
            </div>

            <!-- 设置按钮 + 下拉面板 -->
            <div id="panelRoot" class="relative ml-4">
                <button id="settingsButton" onclick="toggleSettings()"
                    class="flex items-center justify-center bg-white/10 hover:bg-white/20 w-11 h-11 rounded-full border border-white/20 hover:border-indigo-300/70 transition-all shadow-lg hover:shadow-indigo-500/20">
                    <i class="fa fa-cog"></i>
                </button>

                <!-- 设置面板 -->
                <div id="settingsPanel"
                    class="absolute right-0 mt-3 w-72 hidden animate-fade-in p-3 space-y-2 panel-shell">
                    <button id="likeButton" onclick="showLikes()"
                        class="panel-entry">
                        <span class="flex items-center space-x-2">
                            <i class="fa fa-heart text-like"></i>
                            <span>我的喜欢</span>
                        </span>
                        <i class="fa fa-chevron-right text-white/60 text-xs"></i>
                    </button>
                    <button id="historyButton" onclick="showHistory()"
                        class="panel-entry">
                        <span class="flex items-center space-x-2">
                            <i class="fa fa-history"></i>
                            <span>历史记录</span>
                        </span>
                        <i class="fa fa-chevron-right text-white/60 text-xs"></i>
                    </button>
                    <button id="blockButton" onclick="showBlocks()"
                        class="panel-entry">
                        <span class="flex items-center space-x-2">
                            <i class="fa fa-ban"></i>
                            <span>黑名单</span>
                        </span>
                        <i class="fa fa-chevron-right text-white/60 text-xs"></i>
                    </button>
                    <div class="pt-2 border-t border-white/10">
                        <div class="text-white/70 text-xs mb-2">设置站点</div>
                        <div class="relative">
                            <select id="siteSelector" onchange="changeSite(this.value)"
                                class="w-full bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition-all border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary/50 appearance-none pr-10 cursor-pointer"
                                style="color: #6366f1 !important;">
                                <!-- 站点选项将通过JavaScript动态生成 -->
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white/60">
                                <i class="fa fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收藏列表容器 -->
                <div id="likeContainer"
                    class="absolute right-0 mt-3 w-80 max-h-96 overflow-y-auto scrollbar-hide hidden animate-fade-in panel-shell">
                    <div class="panel-titlebar">
                        <h3 class="font-medium text-white">我的收藏</h3>
                        <button onclick="clearLikes()" class="panel-clear-btn">
                            <i class="fa fa-trash-o mr-1"></i>清空
                        </button>
                    </div>
                    <div id="likeContent" class="divide-y divide-white/10 panel-content">
                        <!-- 收藏列表内容将通过JS动态添加 -->
                    </div>
                </div>

                <!-- 历史记录容器 -->
                <div id="historyContainer"
                    class="absolute right-0 mt-3 w-80 max-h-96 overflow-y-auto scrollbar-hide hidden animate-fade-in panel-shell">
                    <div class="panel-titlebar">
                        <h3 class="font-medium text-white">播放历史</h3>
                        <button onclick="clearHistory()" class="panel-clear-btn">
                            <i class="fa fa-trash-o mr-1"></i>清空
                        </button>
                    </div>
                    <div id="historyContent" class="divide-y divide-white/10 panel-content">
                        <!-- 历史记录内容将通过JS动态添加 -->
                    </div>
                </div>

                <!-- 拉黑列表容器 -->
                <div id="blockContainer"
                    class="absolute right-0 mt-3 w-80 max-h-96 overflow-y-auto scrollbar-hide hidden animate-fade-in panel-shell">
                    <div class="panel-titlebar">
                        <h3 class="font-medium text-white">黑名单</h3>
                        <button onclick="clearBlocks()" class="panel-clear-btn">
                            <i class="fa fa-trash-o mr-1"></i>清空
                        </button>
                    </div>
                    <div id="blockContent" class="divide-y divide-white/10 panel-content">
                        <!-- 拉黑列表内容将通过JS动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-24 pb-20">
        <!-- 加载指示器 -->
        <div id="loadingMessage"
            class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                <div class="loader w-10 h-10 border-4 border-gray-200 rounded-full"></div>
                <p class="mt-3 text-gray-700">正在搜索中...</p>
            </div>
        </div>

        <!-- 视频列表 -->
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- 视频卡片将通过JS动态添加 -->
        </div>

        <!-- 加载更多按钮 -->
        <div class="flex justify-center mt-10">
            <button id="loadMoreButton" onclick="loadMoreData()"
                class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-full shadow-lg hover:shadow-xl transition-all hidden animate-fade-in flex items-center space-x-2">
                <span>加载更多</span>
                <i class="fa fa-refresh"></i>
            </button>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
            <div class="text-6xl text-gray-300 mb-4">
                <i class="fa fa-film"></i>
            </div>
            <h3 class="text-xl font-medium text-gray-500 mb-2">暂无视频</h3>
            <p class="text-gray-400 text-center max-w-md">
                尝试使用不同的搜索关键词，或者刷新页面查看推荐内容。
            </p>
        </div>
    </main>

    <!-- 悬浮按钮 -->
    <div id="floatingButtonsContainer" class="fixed bottom-6 right-6 z-40 flex flex-col space-y-3 hidden animate-fade-in">
        <button onclick="loadMoreData()"
            class="bg-primary hover:bg-primary/90 text-white w-12 h-12 rounded-full shadow-lg hover:shadow-xl flex items-center justify-center transition-all"
            title="加载更多">
            <i class="fa fa-refresh"></i>
        </button>
        <button onclick="scrollToTopSmooth()"
            class="bg-white hover:bg-gray-100 text-dark w-12 h-12 rounded-full shadow-lg hover:shadow-xl flex items-center justify-center transition-all"
            title="回到顶部">
            <i class="fa fa-arrow-up"></i>
        </button>
    </div>

    <!-- 视频播放器 -->
    <div id="videoPlayerContainer"
        class="fixed inset-0 z-50 bg-black/80 flex flex-col items-center justify-center hidden">
        <!-- 关闭按钮 - 位于顶部居中 -->
        <button id="closeVideoButton" onclick="closeVideoPlayer()"
            class="absolute top-8 left-1/2 transform -translate-x-1/2 bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all z-10">
            <i class="fa fa-times"></i>
        </button>

        <!-- 视频播放器容器 - 在关闭按钮下方居中 -->
        <div class="w-full max-w-4xl mx-auto px-4 mt-16">
            <div class="aspect-video w-full">
                <!-- DPlayer容器 -->
                <div id="dplayer" class="rounded-lg overflow-hidden shadow-2xl w-full h-full"></div>
            </div>
        </div>
    </div>

    <!-- 全屏预览 -->
    <div id="fullscreenOverlay" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center hidden">
        <div class="relative max-w-6xl w-full max-h-[90vh] mx-auto">
            <button onclick="closeFullScreenPreview()"
                class="absolute -top-12 right-0 bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all">
                <i class="fa fa-times"></i>
            </button>
            <div id="fullscreenContent" class="relative">
                <img id="fullscreenImage" src="" alt="" class="w-full h-full object-contain rounded-lg">
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        const host = window.location.origin;
        let siteName = '91';  // 默认设置为91
        const siteOptions = [
            { value: '91', label: '91', color: '#6366f1' },
            { value: 'xvideos', label: 'XVideos', color: '#8b5cf6' },
            { value: 'hsex', label: 'HSEX', color: '#ec4899' },
            { value: 'jabletv', label: 'JableTV', color: '#06b6d4' },
            { value: 'madoutv', label: 'MadouTV', color: '#10b981' },
            { value: 'kanav', label: 'KanAV', color: '#ec4899' },
        ];

        console.log('当前站点:', siteName);

        let currentPage = 1;
        let currentSearchTerm = '';
        let dp = null; // DPlayer实例
        let isLikeContainerVisible = false; // 新增：收藏列表显示状态
        let isHistoryContainerVisible = false; // 原有：历史列表显示状态
        let isBlockContainerVisible = false; // 拉黑列表显示状态
        let isSettingsPanelVisible = false; // 设置面板显示状态
        let lastScrollTop = 0;
        let panelCloseTimer = null;

        const clearPanelCloseTimer = () => {
            if (panelCloseTimer) {
                clearTimeout(panelCloseTimer);
                panelCloseTimer = null;
            }
        };

        const closeAllTopPanels = () => {
            clearPanelCloseTimer();
            if (isHistoryContainerVisible) {
                isHistoryContainerVisible = false;
                document.getElementById('historyContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.removeEventListener('wheel', closeHistoryOnClickOutside, true);
            }
            if (isLikeContainerVisible) {
                isLikeContainerVisible = false;
                document.getElementById('likeContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.removeEventListener('wheel', closeLikeOnClickOutside, true);
            }
            if (isBlockContainerVisible) {
                isBlockContainerVisible = false;
                document.getElementById('blockContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.removeEventListener('wheel', closeBlockOnClickOutside, true);
            }
            if (isSettingsPanelVisible) {
                isSettingsPanelVisible = false;
                document.getElementById('settingsPanel').classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
        };

        const schedulePanelAutoClose = () => {
            clearPanelCloseTimer();
            panelCloseTimer = setTimeout(() => {
                closeAllTopPanels();
            }, 180);
        };

        const setupPanelAutoClose = () => {
            const panelRoot = document.getElementById('panelRoot');
            if (!panelRoot) return;

            panelRoot.addEventListener('mouseenter', clearPanelCloseTimer);
            panelRoot.addEventListener('mouseleave', schedulePanelAutoClose);
        };

        // 初始化页面
        window.onload = () => {
            // 动态生成站点选择器选项
            generateSiteOptions();
            setupPanelAutoClose();

            // 从localStorage加载上次选择的站点
            const savedSite = localStorage.getItem('selectedSite');
            if (savedSite && siteOptions.some(site => site.value === savedSite)) {
                siteName = savedSite;
                document.getElementById('siteSelector').value = savedSite;
                updateSiteSelectorColor(savedSite);
            }
            updateWatermark(siteName);
            fetchData('', currentPage);
            document.body.classList.remove('page-loading');
            document.body.classList.add('page-loaded');
        };

        // 滚动监听
        window.onscroll = () => {
            const container = document.getElementById('floatingButtonsContainer');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }

            const header = document.getElementById('header');
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScroll > lastScrollTop && currentScroll > 80) {
                header.classList.add('-translate-y-full');
            } else {
                header.classList.remove('-translate-y-full');
            }
            lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        };

        // 异步获取数据
        const fetchData = async (searchTerm, page) => {
            try {
                showLoadingMessage();
                // 确定要使用的搜索词
                const termToUse = searchTerm && searchTerm.trim() !== '' ? searchTerm : '空姐';
                // 构建URL
                var URL = `${host}/${siteName}/${encodeURIComponent(termToUse)}/${page}`;
                // 调用真实API获取数据
                const response = await fetch(URL);
                const responseData = await response.json();
                const data = responseData.data.data;

                if (data.length === 0) {
                    document.getElementById('loadMoreButton').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    document.getElementById('loadMoreButton').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                }

                if (page === 1) {
                    clearDataContainer();
                }

                renderData(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('加载数据失败，请稍后重试', 'error');
            } finally {
                hideLoadingMessage();
            }
        };

        // 渲染数据到页面
        // 渲染数据到页面 - 最终完整版（收藏按钮右上角+无背景+红心持久）
        const renderData = (data) => {
            const videoListContainer = document.getElementById('videoList');

            data.forEach((video, index) => {
                if (isBlocked(video.aid)) {
                    return;
                }
                // 判断当前视频是否已收藏（核心：渲染时直接显示红心/白心）
                const liked = isLiked(video.aid);
                const card = document.createElement('div');
                card.classList.add('video-card', 'bg-white', 'rounded-xl', 'overflow-hidden', 'shadow-lg', 'card-hover', 'animate-slide-up');
                card.style.animationDelay = `${index * 0.1}s`;
                card.dataset.aid = video.aid;
                card.dataset.title = video.title;
                card.dataset.img = video.img;
                card.dataset.href = video.href;
                card.dataset.videoUrl = video.video_url;

                card.innerHTML = `
                    <div class="relative overflow-hidden">
                        <img 
                            src="${video.img}" 
                            alt="${video.title}" 
                            onclick="openFullScreenPreview('${video.img}','${video.title}','${video.aid}','${video.video_url}')"
                            class="video-card-img w-full h-48 object-contain cursor-pointer bg-gray-100"
                        >
                        <!-- 收藏按钮：右上角+无背景+修复图标类名冲突 -->
                        <div class="like-btn absolute top-3 right-3 ${liked ? 'text-like' : 'text-white/90'} hover:text-like text-xl z-10" 
                            onclick="toggleLike('${video.aid}', '${video.title}', '${video.img}', '${video.href}', '${video.video_url}')"
                            data-aid="${video.aid}">
                            <i class="fa ${liked ? 'fa-heart' : 'fa-heart-o'}"></i>
                        </div>
                        <!-- 拉黑按钮：左上角 -->
                        <div class="absolute top-3 left-3 text-white/80 hover:text-white text-lg z-10 cursor-pointer"
                            onclick="toggleBlock('${video.aid}', '${video.title}', '${video.img}', '${video.href}', '${video.video_url}')">
                            <i class="fa fa-ban"></i>
                        </div>
                        <!-- 底部时长渐变层（无收藏按钮） -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end">
                            <span class="bg-primary/80 text-white text-xs px-2 py-1 rounded-full ml-3">${video.time}</span>
                        </div>
                        <!-- 播放按钮（右下角，无冲突） -->
                        <button 
                            class="playButton absolute bottom-3 right-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white w-10 h-10 rounded-full flex items-center justify-center transition-all z-10"
                            onclick="openVideoPlayer('${video.href}','${video.title}','${video.aid}','${video.video_url}','${siteName}','${video.img}')"
                        >
                            <i class="fa fa-play"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-medium text-lg mb-2 line-clamp-1">${video.title}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${video.desc}</p>
                        
                    </div>
                `;

                videoListContainer.appendChild(card);
                
            });
        };

        // 全屏预览图片
        const openFullScreenPreview = (imageUrl, title) => {
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');

            img.src = imageUrl;
            img.alt = title;
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // 关闭全屏预览
        const closeFullScreenPreview = () => {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        // 清空视频列表
        const clearDataContainer = () => {
            document.getElementById('videoList').innerHTML = '';
        };

        // 显示加载消息
        const showLoadingMessage = () => {
            document.getElementById('loadingMessage').classList.remove('hidden');
        };

        // 隐藏加载消息
        const hideLoadingMessage = () => {
            document.getElementById('loadingMessage').classList.add('hidden');
        };

        // 搜索功能
        const searchData = () => {
            const searchTerm = document.getElementById('searchInput').value.trim();

            if (searchTerm) {
                currentSearchTerm = searchTerm;
                currentPage = 1;
                fetchData(searchTerm, currentPage);
            } else {
                showToast('请输入搜索关键字', 'warning');
            }
        };

        // 加载更多数据
        const loadMoreData = () => {
            currentPage++;
            fetchData(currentSearchTerm, currentPage);
        };

        // 处理回车键搜索
        const handleKeyPress = (event) => {
            if (event.key === 'Enter') {
                searchData();
            }
        };

        // 平滑滚动到顶部
        const scrollToTopSmooth = () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };

        // 打开视频播放器 - 从视频卡片打开
        const openVideoPlayer = async (videoUrl, videoTitle, videoRid, video_url, siteKey, videoImg = null) => {
        
            try {
                showLoadingMessage(); // 保留加载提示，提升交互体验
                // 核心：拼接播放页地址（完全匹配规则：http://127.0.0.1:8800/J1/play.html?key=hsex&parm=视频Rid）
                const playPageUrl = `${host}/J1/play.html?key=${siteKey}&parm=${videoRid}`;
                // 新标签页打开播放页
                openInNewTab(playPageUrl);
                // 可选：保留播放历史记录（如需取消，直接删掉以下3行即可）
                const timestamp = Date.now();
                const saveUrl = video_url !== 'null' ? video_url : videoRid; // 兼容video_url为null的情况
                saveHistory(videoTitle, saveUrl, timestamp, videoRid, video_url, siteKey, videoImg);
                showToast(`正在打开播放页：${videoTitle}`, 'success');
            } catch (error) {
                console.error('打开播放页失败：', error);
                showToast('打开播放页失败，请稍后重试', 'error');
            } finally {
                hideLoadingMessage(); // 隐藏加载提示
            }
                };

        // 播放历史视频
        const playHistoryVideo = async (videoRid, videoTitle, videoUrl, siteKey, videoImg) => {
            const rid = videoRid;
            const url = videoUrl || 'null';
            const key = siteKey || siteName;
            await openVideoPlayer('', videoTitle, rid, url, key, videoImg);
        };

        // 新增：播放收藏的视频
        const playLikeVideo = async (videoAid, videoTitle, videoImg, videoHref, videoUrl, siteKey) => {
            const key = siteKey || siteName;
            await openVideoPlayer(videoHref, videoTitle, videoAid, videoUrl, key, videoImg);
            closeLikeOnClickOutside();
        };

        // 在新标签页打开URL
        const openInNewTab = (url) => {
            window.open(url, '_blank');
        };

        // 关闭视频播放器
        const closeVideoPlayer = () => {
            if (dp) {
                dp.destroy();
                dp = null;
            }

            document.getElementById('videoPlayerContainer').classList.add('hidden');
            document.body.style.overflow = '';
        };

        // 历史记录相关功能
        // 获取历史记录
        const getHistory = () => {
            const historyString = localStorage.getItem('playHistory');
            return historyString ? JSON.parse(historyString) : [];
        };

        // 保存历史记录
        const saveHistory = (title, url, timestamp, videoRid = null, videoUrl = null, siteKey = siteName, videoImg = null) => {
            const history = getHistory();

            // 查找是否存在相同的 url
            const existingIndex = history.findIndex(item => item.url === url);

            if (existingIndex !== -1) {
                // 更新时间戳和播放次数
                const playCount = (history[existingIndex]?.playCount || 0) + 1;
                // 先保存，再删除旧历史记录
                history.splice(existingIndex, 1);
                history.unshift({ title, url, timestamp, siteName: siteKey, playCount, rid: videoRid, video_url: videoUrl, img: videoImg })
            } else {
                // 如果不存在相同的 url，添加新的历史记录到最前面
                history.unshift({ title, url, timestamp, siteName: siteKey, playCount: 1, rid: videoRid, video_url: videoUrl, img: videoImg });
            }

            // 限制历史记录数量
            if (history.length > 20) {
                history.pop();
            }

            localStorage.setItem('playHistory', JSON.stringify(history));
        };

        // 清空历史记录
        const clearHistory = () => {
            if (confirm('确定要清空所有播放历史吗？')) {
                localStorage.removeItem('playHistory');
                showHistory(); // 重新显示历史记录以更新UI
                showToast('播放历史已清空', 'success');
            }
        };

        // 设置面板开关
        const toggleSettings = () => {
            clearPanelCloseTimer();
            const settingsPanel = document.getElementById('settingsPanel');
            isSettingsPanelVisible = !isSettingsPanelVisible;

            if (isSettingsPanelVisible) {
                settingsPanel.classList.remove('hidden');
                document.addEventListener('pointerdown', closeSettingsOnClickOutside, true);
            } else {
                settingsPanel.classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
        };

        // 点击设置面板外部关闭
        const closeSettingsOnClickOutside = (event) => {
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsButton = document.getElementById('settingsButton');

            if (!settingsPanel.contains(event.target) && !settingsButton.contains(event.target)) {
                isSettingsPanelVisible = false;
                settingsPanel.classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
        };

        // 显示历史记录
        const showHistory = () => {
            clearPanelCloseTimer();
            if (isSettingsPanelVisible) {
                isSettingsPanelVisible = false;
                document.getElementById('settingsPanel').classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
            if (isBlockContainerVisible) {
                isBlockContainerVisible = false;
                document.getElementById('blockContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.removeEventListener('wheel', closeBlockOnClickOutside, true);
            }
            // 先关闭收藏列表
            if (isLikeContainerVisible) {
                isLikeContainerVisible = false;
                document.getElementById('likeContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.removeEventListener('wheel', closeLikeOnClickOutside, true);
            }

            const historyContainer = document.getElementById('historyContainer');
            isHistoryContainerVisible = !isHistoryContainerVisible;

            const history = getHistory();

            // 清空历史内容
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '';

            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="p-4 text-center text-white/60">
                        <i class="fa fa-info-circle text-xl mb-2"></i>
                        <p>暂无播放历史</p>
                    </div>
                `;
            } else {
                // 显示历史记录（样式与我的喜欢一致）
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('p-3', 'hover:bg-white/5', 'transition-all', 'flex', 'items-center', 'space-x-3');

                    historyItem.innerHTML = `
                        ${item.img ? `
                            <img src="${item.img}" alt="${item.title}" class="w-20 h-12 object-cover rounded-lg">
                        ` : `
                            <div class="w-20 h-12 bg-white/10 rounded-lg flex items-center justify-center text-white/40 text-xs">
                                <i class="fa fa-history text-base"></i>
                            </div>
                        `}
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white text-sm font-medium line-clamp-2">${item.title}</h4>
                            <div class="flex items-center mt-1 text-xs text-white/60">
                                <span>观看时间: ${new Date(item.timestamp).toLocaleString()}</span>
                                <span class="mx-2">•</span>
                                <span>播放次数: ${item.playCount}</span>
                            </div>
                            <div class="flex items-center mt-2 space-x-2">
                                <button onclick="playHistoryVideo('${item.rid || item.url}', '${item.title}', '${item.video_url || 'null'}', '${item.siteName || siteName}', '${item.img || ''}')"
                                        class="bg-primary/80 hover:bg-primary text-white text-xs px-2 py-1 rounded">
                                    <i class="fa fa-play mr-1"></i>播放
                                </button>
                            </div>
                        </div>
                    `;

                    historyContent.appendChild(historyItem);
                });
            }

            if (isHistoryContainerVisible) {
                historyContainer.classList.remove('hidden');
                // 添加点击事件监听器
                document.addEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.addEventListener('wheel', closeHistoryOnClickOutside, true);
            } else {
                historyContainer.classList.add('hidden');
                // 移除点击事件监听器
                document.removeEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.removeEventListener('wheel', closeHistoryOnClickOutside, true);
            }
        };

        // 点击历史记录外部关闭
        const closeHistoryOnClickOutside = (event) => {
            const historyContainer = document.getElementById('historyContainer');
            const historyButton = document.getElementById('historyButton');

            // 检查点击的区域是否在历史记录容器之外
            if (!historyContainer.contains(event.target) && !historyButton.contains(event.target)) {
                isHistoryContainerVisible = false;
                historyContainer.classList.add('hidden');
                // 移除点击事件监听器
                document.removeEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.removeEventListener('wheel', closeHistoryOnClickOutside, true);
            }
        };

        // 新增：收藏功能核心方法 -------------------------- 开始
        // 判断视频是否已收藏（通过aid唯一标识）
        const isLiked = (videoAid) => {
            const likes = getLikes();
            return likes.some(item => item.aid === videoAid);
        };

        // 新增：拉黑功能核心方法 -------------------------- 开始
        const isBlocked = (videoAid) => {
            const blocks = getBlocks();
            return blocks.some(item => item.aid === videoAid);
        };

        const getBlocks = () => {
            const blockString = localStorage.getItem('videoBlocks');
            return blockString ? JSON.parse(blockString) : [];
        };

        const saveBlock = (videoAid, videoTitle, videoImg, videoHref, videoUrl) => {
            const blocks = getBlocks();
            if (isBlocked(videoAid)) return;
            const blockItem = {
                aid: videoAid,
                title: videoTitle,
                img: videoImg,
                href: videoHref,
                video_url: videoUrl,
                siteName: siteName,
                timestamp: Date.now()
            };
            blocks.unshift(blockItem);
            if (blocks.length > 100) blocks.pop();
            localStorage.setItem('videoBlocks', JSON.stringify(blocks));
            if (isBlockContainerVisible) renderBlocks();
            showToast('已加入黑名单', 'success');
        };

        const removeBlock = (videoAid) => {
            let blocks = getBlocks();
            blocks = blocks.filter(item => item.aid !== videoAid);
            localStorage.setItem('videoBlocks', JSON.stringify(blocks));
            if (isBlockContainerVisible) renderBlocks();
            showToast('已取消拉黑', 'info');
        };

        const toggleBlock = (videoAid, videoTitle, videoImg, videoHref, videoUrl) => {
            if (isBlocked(videoAid)) {
                removeBlock(videoAid);
            } else {
                saveBlock(videoAid, videoTitle, videoImg, videoHref, videoUrl);
            }
            currentPage = 1;
            fetchData(currentSearchTerm, currentPage);
        };

        const renderBlocks = () => {
            const blockContent = document.getElementById('blockContent');
            const blocks = getBlocks();
            blockContent.innerHTML = '';

            if (blocks.length === 0) {
                blockContent.innerHTML = `
                    <div class="p-4 text-center text-white/60">
                        <i class="fa fa-ban text-xl mb-2"></i>
                        <p>暂无拉黑视频</p>
                    </div>
                `;
                return;
            }

            blocks.forEach(item => {
                const blockItem = document.createElement('div');
                blockItem.classList.add('p-3', 'hover:bg-white/5', 'transition-all', 'flex', 'items-center', 'space-x-3');
                blockItem.innerHTML = `
                    <img src="${item.img}" alt="${item.title}" class="w-20 h-12 object-cover rounded-lg">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-white text-sm font-medium line-clamp-2">${item.title}</h4>
                        <div class="flex items-center mt-2 space-x-2">
                            <button onclick="openInNewTab('${item.href}')"
                                    class="bg-secondary/80 hover:bg-secondary text-white text-xs px-2 py-1 rounded">
                                <i class="fa fa-external-link mr-1"></i>详情
                            </button>
                            <button onclick="removeBlock('${item.aid}')"
                                    class="bg-white/10 hover:bg-white/20 text-white/80 text-xs px-2 py-1 rounded">
                                <i class="fa fa-ban mr-1"></i>取消拉黑
                            </button>
                        </div>
                    </div>
                `;
                blockContent.appendChild(blockItem);
            });
        };

        const showBlocks = () => {
            clearPanelCloseTimer();
            if (isSettingsPanelVisible) {
                isSettingsPanelVisible = false;
                document.getElementById('settingsPanel').classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
            if (isLikeContainerVisible) {
                isLikeContainerVisible = false;
                document.getElementById('likeContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.removeEventListener('wheel', closeLikeOnClickOutside, true);
            }
            if (isHistoryContainerVisible) {
                isHistoryContainerVisible = false;
                document.getElementById('historyContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.removeEventListener('wheel', closeHistoryOnClickOutside, true);
            }

            const blockContainer = document.getElementById('blockContainer');
            isBlockContainerVisible = !isBlockContainerVisible;
            renderBlocks();

            if (isBlockContainerVisible) {
                blockContainer.classList.remove('hidden');
                document.addEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.addEventListener('wheel', closeBlockOnClickOutside, true);
            } else {
                blockContainer.classList.add('hidden');
                document.removeEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.removeEventListener('wheel', closeBlockOnClickOutside, true);
            }
        };

        const closeBlockOnClickOutside = (event) => {
            const blockContainer = document.getElementById('blockContainer');
            const blockButton = document.getElementById('blockButton');

            if (!blockContainer.contains(event.target) && !blockButton.contains(event.target)) {
                isBlockContainerVisible = false;
                blockContainer.classList.add('hidden');
                document.removeEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.removeEventListener('wheel', closeBlockOnClickOutside, true);
            }
        };

        const clearBlocks = () => {
            if (confirm('确定要清空所有拉黑的视频吗？此操作不可恢复！')) {
                localStorage.removeItem('videoBlocks');
                renderBlocks();
                showToast('黑名单已清空', 'success');
            }
        };
        // 新增：拉黑功能核心方法 -------------------------- 结束

        // 获取收藏列表
        const getLikes = () => {
            const likeString = localStorage.getItem('videoLikes');
            return likeString ? JSON.parse(likeString) : [];
        };

        // 保存收藏（核心：包含img、title、所有播放所需参数）
        const saveLike = (videoAid, videoTitle, videoImg, videoHref, videoUrl) => {
            const likes = getLikes();
            // 避免重复收藏
            if (isLiked(videoAid)) return;
            // 收藏数据：必须包含img、title，其余为播放所需
            const likeItem = {
                aid: videoAid,
                title: videoTitle,
                img: videoImg,
                href: videoHref,
                video_url: videoUrl,
                siteName: siteName,
                timestamp: Date.now() // 收藏时间
            };
            likes.unshift(likeItem); // 最新收藏的在最前面
            // 限制收藏数量（可自定义，这里设30）
            if (likes.length > 30) likes.pop();
            localStorage.setItem('videoLikes', JSON.stringify(likes));
            showToast('已加入我的喜欢', 'success');
            // 刷新收藏列表显示
            if (isLikeContainerVisible) renderLikes();
        };

        // 取消收藏（补充：同步更新页面所有按钮样式）
        const removeLike = (videoAid) => {
            let likes = getLikes();
            likes = likes.filter(item => item.aid !== videoAid);
            localStorage.setItem('videoLikes', JSON.stringify(likes));
            // 同步更新页面中该视频的所有收藏按钮样式
            const allLikeBtns = document.querySelectorAll(`.like-btn[data-aid="${videoAid}"]`);
            allLikeBtns.forEach(btn => {
                btn.classList.remove('text-like');
                btn.querySelector('i').className = 'fa fa-heart-o';
            });
            // 刷新收藏列表（如果列表正打开）
            if (isLikeContainerVisible) renderLikes();
        };

        // 切换收藏状态（最终版：点击白空心→红实心永久，点击红实心→白空心，逻辑完全正确）
        const toggleLike = (videoAid, videoTitle, videoImg, videoHref, videoUrl) => {
            const isNowLiked = isLiked(videoAid); // 先判断当前是否已收藏
            // 1. 执行收藏/取消逻辑（本地存储）
            if (!isNowLiked) {
                // 未收藏 → 执行收藏：加红色实心
                saveLike(videoAid, videoTitle, videoImg, videoHref, videoUrl);
                showToast('已加入我的喜欢', 'success');
            } else {
                // 已收藏 → 执行取消：恢复白色空心
                removeLike(videoAid);
                showToast('已取消收藏', 'info');
            }
            // 2. 统一更新所有同视频按钮样式（核心：判断反转为 !isNowLiked）
            const allLikeBtns = document.querySelectorAll(`.like-btn[data-aid="${videoAid}"]`);
            allLikeBtns.forEach(btn => {
                const icon = btn.querySelector('i');
                if (!isNowLiked) {
                    // 收藏成功：强制加红色 + 实心红心
                    btn.classList.add('text-like');
                    icon.className = 'fa fa-heart';
                } else {
                    // 取消收藏：强制移除红色 + 空心白心
                    btn.classList.remove('text-like');
                    icon.className = 'fa fa-heart-o';
                }
            });
        };

        // 渲染收藏列表（核心：显示img、title，带播放/取消按钮）
        // 渲染收藏列表（新增：详情按钮，新标签页跳转href）
        const renderLikes = () => {
            const likeContent = document.getElementById('likeContent');
            const likes = getLikes();
            likeContent.innerHTML = '';

            if (likes.length === 0) {
                likeContent.innerHTML = `
                    <div class="p-4 text-center text-white/60">
                        <i class="fa fa-heart-o text-xl mb-2"></i>
                        <p>暂无收藏视频，点击视频卡片的❤️收藏</p>
                    </div>
                `;
                return;
            }

            // 遍历渲染收藏项，包含img、title + 播放/详情/取消按钮
            likes.forEach(item => {
                const likeItem = document.createElement('div');
                likeItem.classList.add('p-3', 'hover:bg-white/5', 'transition-all', 'flex', 'items-center', 'space-x-3');
                likeItem.innerHTML = `
                    <!-- 收藏视频封面图 -->
                    <img src="${item.img}" alt="${item.title}" class="w-20 h-12 object-cover rounded-lg">
                    <!-- 收藏视频标题 + 操作按钮（新增详情按钮） -->
                    <div class="flex-1 min-w-0">
                        <h4 class="text-white text-sm font-medium line-clamp-2">${item.title}</h4>
                        <div class="flex items-center mt-2 space-x-2">
                            <button onclick="playLikeVideo('${item.aid}', '${item.title}', '${item.img}', '${item.href}', '${item.video_url}', '${item.siteName || siteName}')"
                                    class="bg-primary/80 hover:bg-primary text-white text-xs px-2 py-1 rounded">
                                <i class="fa fa-play mr-1"></i>播放
                            </button>
                            <!-- 新增：详情按钮 - 新标签页跳转href地址 -->
                            <button onclick="openInNewTab('${item.href}')"
                                    class="bg-secondary/80 hover:bg-secondary text-white text-xs px-2 py-1 rounded">
                                <i class="fa fa-external-link mr-1"></i>详情
                            </button>
                            <button onclick="removeLike('${item.aid}')"
                                    class="bg-white/10 hover:bg-white/20 text-white/80 text-xs px-2 py-1 rounded">
                                <i class="fa fa-heart-o mr-1"></i>取消
                            </button>
                        </div>
                    </div>
                `;
                likeContent.appendChild(likeItem);
            });
        };
        // 显示收藏列表
        const showLikes = () => {
            clearPanelCloseTimer();
            if (isSettingsPanelVisible) {
                isSettingsPanelVisible = false;
                document.getElementById('settingsPanel').classList.add('hidden');
                document.removeEventListener('pointerdown', closeSettingsOnClickOutside, true);
            }
            if (isBlockContainerVisible) {
                isBlockContainerVisible = false;
                document.getElementById('blockContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeBlockOnClickOutside, true);
                document.removeEventListener('wheel', closeBlockOnClickOutside, true);
            }
            // 先关闭历史列表
            if (isHistoryContainerVisible) {
                isHistoryContainerVisible = false;
                document.getElementById('historyContainer').classList.add('hidden');
                document.removeEventListener('pointerdown', closeHistoryOnClickOutside, true);
                document.removeEventListener('wheel', closeHistoryOnClickOutside, true);
            }

            const likeContainer = document.getElementById('likeContainer');
            isLikeContainerVisible = !isLikeContainerVisible;
            // 渲染收藏列表
            renderLikes();

            if (isLikeContainerVisible) {
                likeContainer.classList.remove('hidden');
                document.addEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.addEventListener('wheel', closeLikeOnClickOutside, true);
            } else {
                likeContainer.classList.add('hidden');
                document.removeEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.removeEventListener('wheel', closeLikeOnClickOutside, true);
            }
        };

        // 清空所有收藏
        const clearLikes = () => {
            if (confirm('确定要清空所有收藏的视频吗？此操作不可恢复！')) {
                localStorage.removeItem('videoLikes');
                renderLikes();
                showToast('所有收藏已清空', 'success');
                // 重置页面所有收藏按钮样式
                document.querySelectorAll('.like-btn').forEach(btn => {
                    btn.classList.remove('text-like');
                    btn.querySelector('i').classList.remove('fa-solid');
                    btn.querySelector('i').classList.add('fa-regular');
                });
            }
        };

        // 点击收藏列表外部关闭
        const closeLikeOnClickOutside = (event) => {
            const likeContainer = document.getElementById('likeContainer');
            const likeButton = document.getElementById('likeButton');

            if (!likeContainer.contains(event.target) && !likeButton.contains(event.target)) {
                isLikeContainerVisible = false;
                likeContainer.classList.add('hidden');
                document.removeEventListener('pointerdown', closeLikeOnClickOutside, true);
                document.removeEventListener('wheel', closeLikeOnClickOutside, true);
            }
        };
        // 新增：收藏功能核心方法 -------------------------- 结束

        // 显示提示消息
        const showToast = (message, type = 'info') => {
            // 创建提示元素
            const toast = document.createElement('div');

            // 设置样式和内容
            let bgColor = 'bg-blue-500';
            let icon = 'fa-info-circle';

            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = 'fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = 'fa-exclamation-triangle';
            }

            toast.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in flex items-center`;
            toast.innerHTML = `
                <i class="fa ${icon} mr-2"></i>
                <span>${message}</span>
            `;

            // 添加到页面
            document.body.appendChild(toast);

            // 3秒后移除
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        };

        // 点击全屏预览外部关闭
        document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('fullscreenOverlay')) {
                closeFullScreenPreview();
            }
        });

        // 点击视频播放器外部关闭
        document.getElementById('videoPlayerContainer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('videoPlayerContainer')) {
                closeVideoPlayer();
            }
        });

        // ESC键关闭弹窗（新增：关闭收藏列表）
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullScreenPreview();
                closeVideoPlayer();

                // 关闭历史列表
                closeAllTopPanels();
            }
        });

        // 动态生成站点选择器选项
        const generateSiteOptions = () => {
            const selectElement = document.getElementById('siteSelector');
            selectElement.innerHTML = '';

            siteOptions.forEach(site => {
                const option = document.createElement('option');
                option.value = site.value;
                option.textContent = site.label;
                option.selected = site.value === siteName;
                option.style.backgroundColor = '#1e293b';
                option.style.color = site.color;
                selectElement.appendChild(option);
            });
        };

        // 更新站点选择器颜色
        const updateSiteSelectorColor = (selectedSite) => {
            const selectElement = document.getElementById('siteSelector');
            const selectedSiteInfo = siteOptions.find(site => site.value === selectedSite);
            if (selectedSiteInfo) {
                selectElement.style.color = selectedSiteInfo.color + ' !important';
            }
        };

        // 切换站点
        const changeSite = (newSite) => {
            if (newSite !== siteName && siteOptions.some(site => site.value === newSite)) {
                siteName = newSite;
                // 更新选择器颜色
                updateSiteSelectorColor(newSite);
                updateWatermark(newSite);
                // 保存选择到localStorage
                localStorage.setItem('selectedSite', newSite);
                // 重置搜索状态并重新加载数据
                currentSearchTerm = '';
                currentPage = 1;
                document.getElementById('searchInput').value = '';
                fetchData('', currentPage);

                const siteInfo = siteOptions.find(site => site.value === newSite);
                showToast(`已切换到${siteInfo.label}站点`, 'success');
            }
        };

        const updateWatermark = (siteValue) => {
            const watermark = document.getElementById('siteWatermark');
            if (!watermark) return;
            const siteInfo = siteOptions.find(site => site.value === siteValue);
            const label = siteInfo ? siteInfo.label : siteValue;
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="260" height="180">
                    <style>
                        text { font-family: Arial, sans-serif; font-size: 22px; fill: rgba(0,0,0,0.35); }
                    </style>
                    <text x="10" y="60">${label}</text>
                    <text x="60" y="130">${label}</text>
                </svg>
            `;
            const encoded = encodeURIComponent(svg).replace(/%0A/g, '');
            watermark.style.backgroundImage = `url("data:image/svg+xml,${encoded}")`;
        };
    </script>
</body>

</html>
