<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 15c0 .6-.4 1-1 1H4c-.6 0-1-.4-1-1V6h18v12z'/%3E%3Cpath d='M8 15h2.5l1-3 1 3H16v-5H8v5z'/%3E%3C/svg%3E"
        type="image/x-icon" />
    <title>91密 - 视频浏览</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- DPlayer -->
    <script src="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dplayer/dist/DPlayer.min.css">


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .glass-dark {
                background: rgba(30, 41, 59, 0.8);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .gradient-text {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .gradient-bg {
                background-image: linear-gradient(to right, #6366f1, #8b5cf6, #ec4899);
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>

    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }

        /* 加载动画 */
        .loader {
            border-top-color: #6366f1;
            animation: spinner 0.8s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 视频卡片图片过渡效果 */
        .video-card-img {
            transition: transform 0.5s ease;
        }

        .video-card:hover .video-card-img {
            transform: scale(1.05);
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
            background-image:
                radial-gradient(circle at 25% 25%, #6366f1 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, #8b5cf6 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 60s linear infinite;
        }

        @keyframes moveBackground {
            0% {
                background-position: 0 0, 50px 50px;
            }

            100% {
                background-position: 50px 50px, 0 0;
            }
        }



        /* 模糊背景效果 */
        .backdrop-blur {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
</head>

<body class="bg-light text-dark min-h-screen">
    <!-- 背景动画 -->
    <div class="bg-animation"></div>

    <!-- 导航头 -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 glass-dark text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center space-x-2">
                <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z">
                    </path>
                </svg>
                <h1 class="text-xl font-bold gradient-text">91密</h1>
            </div>

            <!-- 搜索框 -->
            <div class="relative max-w-md w-full mx-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索视频..." onkeypress="handleKeyPress(event)"
                        class="w-full py-2 pl-10 pr-4 rounded-full bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary/50 text-white placeholder-white/60 transition-all">
                    <i class="fa fa-search absolute left-3 top-3 text-white/60"></i>
                </div>
                <button id="searchButton" onclick="searchData()"
                    class="absolute right-1 top-1 bg-primary hover:bg-primary/90 text-white px-4 py-1 rounded-full transition-all">
                    搜索
                </button>
            </div>

            <!-- 站点选择器 -->
            <div class="relative">
                <select id="siteSelector" onchange="changeSite(this.value)"
                    class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full transition-all border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary/50 appearance-none pr-10 cursor-pointer"
                    style="color: #6366f1 !important;">
                    <!-- 站点选项将通过JavaScript动态生成 -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white/60">
                    <i class="fa fa-chevron-down text-xs"></i>
                </div>
            </div>

            <!-- 历史按钮 -->
            <div class="relative ml-4">
                <button id="historyButton" onclick="showHistory()"
                    class="flex items-center space-x-1 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full transition-all">
                    <i class="fa fa-history"></i>
                    <span class="hidden sm:inline">历史记录</span>
                </button>

                <!-- 历史记录容器 -->
                <div id="historyContainer"
                    class="absolute right-0 mt-2 w-80 max-h-96 overflow-y-auto scrollbar-hide glass-dark rounded-lg shadow-xl hidden animate-fade-in">
                    <div class="p-3 border-b border-white/10">
                        <h3 class="font-medium text-white">播放历史</h3>
                    </div>
                    <div id="historyContent" class="divide-y divide-white/10">
                        <!-- 历史记录内容将通过JS动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-24 pb-20">
        <!-- 加载指示器 -->
        <div id="loadingMessage"
            class="fixed inset-0 flex items-center justify-center z-50 bg-black/30 backdrop-blur hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                <div class="loader w-10 h-10 border-4 border-gray-200 rounded-full"></div>
                <p class="mt-3 text-gray-700">正在搜索中...</p>
            </div>
        </div>

        <!-- 视频列表 -->
        <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- 视频卡片将通过JS动态添加 -->
        </div>

        <!-- 加载更多按钮 -->
        <div class="flex justify-center mt-10">
            <button id="loadMoreButton" onclick="loadMoreData()"
                class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-full shadow-lg hover:shadow-xl transition-all hidden animate-fade-in flex items-center space-x-2">
                <span>加载更多</span>
                <i class="fa fa-refresh"></i>
            </button>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
            <div class="text-6xl text-gray-300 mb-4">
                <i class="fa fa-film"></i>
            </div>
            <h3 class="text-xl font-medium text-gray-500 mb-2">暂无视频</h3>
            <p class="text-gray-400 text-center max-w-md">
                尝试使用不同的搜索关键词，或者刷新页面查看推荐内容。
            </p>
        </div>
    </main>

    <!-- 悬浮按钮 -->
    <div id="floatingButtonsContainer" class="fixed bottom-6 right-6 flex flex-col space-y-3 hidden animate-fade-in">
        <button onclick="loadMoreData()"
            class="bg-primary hover:bg-primary/90 text-white w-12 h-12 rounded-full shadow-lg hover:shadow-xl flex items-center justify-center transition-all"
            title="加载更多">
            <i class="fa fa-refresh"></i>
        </button>
        <button onclick="scrollToTopSmooth()"
            class="bg-white hover:bg-gray-100 text-dark w-12 h-12 rounded-full shadow-lg hover:shadow-xl flex items-center justify-center transition-all"
            title="回到顶部">
            <i class="fa fa-arrow-up"></i>
        </button>
    </div>

    <!-- 视频播放器 -->
    <div id="videoPlayerContainer"
        class="fixed inset-0 z-50 bg-black/80 flex flex-col items-center justify-center hidden">
        <!-- 关闭按钮 - 位于顶部居中 -->
        <button id="closeVideoButton" onclick="closeVideoPlayer()"
            class="absolute top-8 left-1/2 transform -translate-x-1/2 bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all z-10">
            <i class="fa fa-times"></i>
        </button>

        <!-- 视频播放器容器 - 在关闭按钮下方居中 -->
        <div class="w-full max-w-4xl mx-auto px-4 mt-16">
            <div class="aspect-video w-full">
                <!-- DPlayer容器 -->
                <div id="dplayer" class="rounded-lg overflow-hidden shadow-2xl w-full h-full"></div>
            </div>
        </div>
    </div>

    <!-- 全屏预览 -->
    <div id="fullscreenOverlay" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center hidden">
        <div class="relative max-w-6xl w-full max-h-[90vh] mx-auto">
            <button onclick="closeFullScreenPreview()"
                class="absolute -top-12 right-0 bg-white/10 hover:bg-white/20 text-white w-10 h-10 rounded-full flex items-center justify-center transition-all">
                <i class="fa fa-times"></i>
            </button>
            <div id="fullscreenContent" class="relative">
                <img id="fullscreenImage" src="" alt="" class="w-full h-full object-contain rounded-lg">
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        const host = window.location.origin;
        let siteName = '91';  // 默认设置为91
        const siteOptions = [
            { value: '91', label: '91', color: '#6366f1' },
            { value: 'xvideos', label: 'XVideos', color: '#8b5cf6' },
            { value: 'hsex', label: 'HSEX', color: '#ec4899' },
            { value: 'jabletv', label: 'JableTV', color: '#06b6d4' },
            { value: 'madoutv', label: 'MadouTV', color: '#10b981' },
            { value: 'spankbang', label: 'SpankBang', color: '#06b6d4' },
        ];

        console.log('当前站点:', siteName);

        let currentPage = 1;
        let currentSearchTerm = '';
        let dp = null; // DPlayer实例

        // 初始化页面
        window.onload = () => {
            // 动态生成站点选择器选项
            generateSiteOptions();

            // 从localStorage加载上次选择的站点
            const savedSite = localStorage.getItem('selectedSite');
            if (savedSite && siteOptions.some(site => site.value === savedSite)) {
                siteName = savedSite;
                document.getElementById('siteSelector').value = savedSite;
                updateSiteSelectorColor(savedSite);
            }
            fetchData('', currentPage);
        };

        // 滚动监听
        window.onscroll = () => {
            const container = document.getElementById('floatingButtonsContainer');
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };

        // 异步获取数据
        const fetchData = async (searchTerm, page) => {
            try {
                showLoadingMessage();
                // 确定要使用的搜索词
                const termToUse = searchTerm && searchTerm.trim() !== '' ? searchTerm : '空姐';
                // 构建URL
                var URL = `${host}/${siteName}/${encodeURIComponent(termToUse)}/${page}`;
                // 调用真实API获取数据
                const response = await fetch(URL);
                const responseData = await response.json();
                const data = responseData.data.data;

                if (data.length === 0) {
                    document.getElementById('loadMoreButton').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    document.getElementById('loadMoreButton').classList.remove('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                }

                if (page === 1) {
                    clearDataContainer();
                }

                renderData(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('加载数据失败，请稍后重试', 'error');
            } finally {
                hideLoadingMessage();
            }
        };



        // 渲染数据到页面
        const renderData = (data) => {
            const videoListContainer = document.getElementById('videoList');

            data.forEach((video, index) => {
                const card = document.createElement('div');
                card.classList.add('video-card', 'bg-white', 'rounded-xl', 'overflow-hidden', 'shadow-lg', 'card-hover', 'animate-slide-up');
                card.style.animationDelay = `${index * 0.1}s`;

                card.innerHTML = `
                    <div class="relative overflow-hidden">
                        <img 
                            src="${video.img}" 
                            alt="${video.title}" 
                            onclick="openFullScreenPreview('${video.img}','${video.title}','${video.aid}','${video.video_url}')"
                            class="video-card-img w-full h-48 object-contain cursor-pointer bg-gray-100"
                        >
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end">
                            <div class="p-3 text-white">
                                <span class="bg-primary/80 text-white text-xs px-2 py-1 rounded-full">${video.time}</span>
                            </div>
                        </div>
                        <button 
                            class="playButton absolute bottom-3 right-3 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white w-10 h-10 rounded-full flex items-center justify-center transition-all"
                            onclick="openVideoPlayer('${video.href}','${video.title}','${video.aid}','${video.video_url}')"
                        >
                            <i class="fa fa-play"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <h3 class="font-medium text-lg mb-2 line-clamp-1">${video.title}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${video.desc}</p>
                        <div class="flex justify-between items-center">
                            <a 
                                href="${video.href}" 
                                target="_blank"
                                class="text-primary hover:text-primary/80 text-sm font-medium transition-all flex items-center"
                            >
                                <span>打开链接</span>
                                <i class="fa fa-external-link ml-1 text-xs"></i>
                            </a>
                            <button 
                                onclick="openVideoPlayer('${video.href}','${video.title}','${video.aid}','${video.video_url}')"
                                class="bg-primary hover:bg-primary/90 text-white text-sm px-3 py-1 rounded-full transition-all"
                            >
                                播放
                            </button>
                        </div>
                    </div>
                `;

                videoListContainer.appendChild(card);
            });
        };

        // 全屏预览图片
        const openFullScreenPreview = (imageUrl, title) => {
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');

            img.src = imageUrl;
            img.alt = title;
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        // 关闭全屏预览
        const closeFullScreenPreview = () => {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.add('hidden');
            document.body.style.overflow = '';
        };

        // 清空视频列表
        const clearDataContainer = () => {
            document.getElementById('videoList').innerHTML = '';
        };

        // 显示加载消息
        const showLoadingMessage = () => {
            document.getElementById('loadingMessage').classList.remove('hidden');
        };

        // 隐藏加载消息
        const hideLoadingMessage = () => {
            document.getElementById('loadingMessage').classList.add('hidden');
        };

        // 搜索功能
        const searchData = () => {
            const searchTerm = document.getElementById('searchInput').value.trim();

            if (searchTerm) {
                currentSearchTerm = searchTerm;
                currentPage = 1;
                fetchData(searchTerm, currentPage);
            } else {
                showToast('请输入搜索关键字', 'warning');
            }
        };

        // 加载更多数据
        const loadMoreData = () => {
            currentPage++;
            fetchData(currentSearchTerm, currentPage);
        };

        // 处理回车键搜索
        const handleKeyPress = (event) => {
            if (event.key === 'Enter') {
                searchData();
            }
        };

        // 平滑滚动到顶部
        const scrollToTopSmooth = () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };

        // 打开视频播放器 - 从视频卡片打开
        const openVideoPlayer = async (videoUrl, videoTitle, videoRid, video_url) => {
            try {
                showLoadingMessage();
                let realVideoUrl = video_url;

                if (video_url == 'null') {
                    // 获取真实视频地址
                    const response = await fetch(`/${siteName}/` + videoRid);
                    const responseData = await response.json();
                    realVideoUrl = responseData.data.m3u8;
                }

                // 保存播放历史
                const timestamp = Date.now();
                saveHistory(videoTitle, realVideoUrl, timestamp);

                // 创建DPlayer实例并播放
                await createAndPlayDPlayer(realVideoUrl, videoTitle, videoUrl);
            } catch (error) {
                console.error('Error fetching real video URL:', error);
                showToast('加载视频失败，请稍后重试', 'error');
            } finally {
                hideLoadingMessage();
            }
        };

        // 播放历史视频
        const playHistoryVideo = async (videoUrl, videoTitle) => {
            try {
                showLoadingMessage();

                // 历史记录中保存的已经是真实视频地址，直接使用
                const realVideoUrl = videoUrl;

                // 更新播放历史
                const timestamp = Date.now();
                saveHistory(videoTitle, realVideoUrl, timestamp);

                // 创建DPlayer实例并播放
                await createAndPlayDPlayer(realVideoUrl, videoTitle);
            } catch (error) {
                console.error('Error playing history video:', error);
                showToast('播放历史视频失败，请稍后重试', 'error');
            } finally {
                hideLoadingMessage();
            }
        };


        // 创建DPlayer实例并播放视频
        const createAndPlayDPlayer = async (videoUrl, videoTitle, originalUrl = null) => {
            try {
                await testVideoUrl(videoUrl)
                // 创建DPlayer实例
                if (dp) {
                    dp.destroy();
                }

                // 获取视频封面图
                let coverImage = '';
                if (originalUrl) {
                    // 从视频卡片获取封面图
                    try {
                        const cardElement = document.querySelector(`[onclick="openVideoPlayer('${originalUrl}','${videoTitle}','${video.aid}','${video.video_url}')"]`);
                        if (cardElement) {
                            const imgElement = cardElement.closest('.video-card').querySelector('img');
                            if (imgElement) {
                                coverImage = imgElement.src;
                            }
                        }
                    } catch (e) {
                        console.error('Error getting cover image:', e);
                    }
                }

                dp = new DPlayer({
                    container: document.getElementById('dplayer'),
                    video: {
                        url: videoUrl,
                        type: 'hls',
                        pic: coverImage,
                        thumbnails: coverImage,
                    },
                    danmaku: {
                        id: '999999',
                        api: 'https://api.prprpr.me/dplayer/',
                    },
                    contextmenu: [
                        {
                            text: '自定义菜单',
                            link: 'https://github.com/MoePlayer/DPlayer',
                        },
                    ],
                    highlight: [
                        {
                            time: 20,
                            text: '这是第20秒',
                        },
                        {
                            time: 40,
                            text: '这是第40秒',
                        },
                    ],
                    autoplay: true,
                    theme: '#6366f1',
                    loop: true,
                    lang: 'zh-cn',
                    screenshot: true,
                    hotkey: true,
                    preload: 'auto',
                    logo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236366f1"%3E%3Cpath d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 15c0 .6-.4 1-1 1H4c-.6 0-1-.4-1-1V6h18v12z"/%3E%3Cpath d="M8 15h2.5l1-3 1 3H16v-5H8v5z"/%3E%3C/svg%3E',
                });

                // 添加错误监听
                dp.on('error', (err) => {
                    console.error('DPlayer error:', err);
                    showToast('视频播放出错，正在尝试新的播放方式...', 'warning');
                    setTimeout(() => {
                        closeVideoPlayer();
                        openInNewTab(videoUrl);
                    }, 2000);
                });

                // 显示视频播放器
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // 确保播放器容器正确显示
                const playerContainer = document.getElementById('dplayer').parentElement;
                playerContainer.style.transform = '';
            } catch (error) {
                console.error('Video playback error:', error);
                showToast('检测到跨域问题，正在跳转新页面播放...', 'warning');
                setTimeout(() => {
                    closeVideoPlayer();
                    openInNewTab(videoUrl);
                }, 1500);
            }
        };

        /**
 * 判断视频是否真正可播放（m3u8 / mp4 通用）
 * @param {string} url
 * @param {number} timeout
 */
        const testVideoUrl = (url, timeout = 8000) => {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');

                let timer = setTimeout(() => {
                    cleanup();
                    reject(new Error('Video load timeout'));
                }, timeout);

                const cleanup = () => {
                    clearTimeout(timer);
                    video.pause();
                    video.removeAttribute('src');
                    video.load();
                    video.remove();
                };

                video.muted = true;
                video.preload = 'auto';
                video.crossOrigin = 'anonymous';

                // ✔ 能播放（m3u8 已成功解析）
                video.oncanplay = () => {
                    cleanup();
                    resolve(true);
                };

                // ❌ 播放失败（CORS / ts 被拦 / 403）
                video.onerror = () => {
                    cleanup();
                    reject(new Error('Video cannot be played'));
                };

                video.src = url;
                video.load();
            });
        };


        // 在新标签页打开URL
        const openInNewTab = (url) => {
            window.open(url, '_blank');
        };

        // 关闭视频播放器
        const closeVideoPlayer = () => {
            if (dp) {
                dp.destroy();
                dp = null;
            }

            document.getElementById('videoPlayerContainer').classList.add('hidden');
            document.body.style.overflow = '';
        };

        // 历史记录相关功能
        let isHistoryContainerVisible = false;

        // 获取历史记录
        const getHistory = () => {
            const historyString = localStorage.getItem('playHistory');
            return historyString ? JSON.parse(historyString) : [];
        };

        // 保存历史记录
        const saveHistory = (title, url, timestamp) => {
            const history = getHistory();

            // 查找是否存在相同的 url
            const existingIndex = history.findIndex(item => item.url === url);

            if (existingIndex !== -1) {
                // 更新时间戳和播放次数
                const playCount = (history[existingIndex]?.playCount || 0) + 1;
                // 先保存，再删除旧历史记录
                history.splice(existingIndex, 1);
                history.unshift({ title, url, timestamp, playCount })
            } else {
                // 如果不存在相同的 url，添加新的历史记录到最前面
                history.unshift({ title, url, timestamp, playCount: 1 });
            }

            // 限制历史记录数量
            if (history.length > 20) {
                history.pop();
            }

            localStorage.setItem('playHistory', JSON.stringify(history));
        };

        // 清空历史记录
        const clearHistory = () => {
            if (confirm('确定要清空所有播放历史吗？')) {
                localStorage.removeItem('playHistory');
                showHistory(); // 重新显示历史记录以更新UI
                showToast('播放历史已清空', 'success');
            }
        };

        // 显示历史记录
        const showHistory = () => {
            const historyContainer = document.getElementById('historyContainer');
            isHistoryContainerVisible = !isHistoryContainerVisible;

            const history = getHistory();

            // 清空历史内容
            const historyContent = document.getElementById('historyContent');
            historyContent.innerHTML = '';

            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="p-4 text-center text-white/60">
                        <i class="fa fa-info-circle text-xl mb-2"></i>
                        <p>暂无播放历史</p>
                    </div>
                `;
            } else {
                // 显示历史记录
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('p-3', 'hover:bg-white/5', 'transition-all');

                    historyItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-white text-sm font-medium line-clamp-1">${item.title}</h4>
                                <div class="flex items-center mt-1 text-xs text-white/60">
                                    <span>观看时间: ${new Date(item.timestamp).toLocaleString()}</span>
                                    <span class="mx-2">•</span>
                                    <span>播放次数: ${item.playCount}</span>
                                </div>
                            </div>
                            <button 
                                class="ml-2 bg-primary hover:bg-primary/90 text-white text-xs px-2 py-1 rounded transition-all"
                                onclick="playHistoryVideo('${item.url}', '${item.title}')"
                            >
                                播放
                            </button>
                        </div>
                    `;

                    historyContent.appendChild(historyItem);
                });
            }

            if (isHistoryContainerVisible) {
                historyContainer.classList.remove('hidden');
                // 添加点击事件监听器
                document.addEventListener('click', closeHistoryOnClickOutside);
            } else {
                historyContainer.classList.add('hidden');
                // 移除点击事件监听器
                document.removeEventListener('click', closeHistoryOnClickOutside);
            }
        };

        // 点击历史记录外部关闭
        const closeHistoryOnClickOutside = (event) => {
            const historyContainer = document.getElementById('historyContainer');
            const historyButton = document.getElementById('historyButton');

            // 检查点击的区域是否在历史记录容器之外
            if (!historyContainer.contains(event.target) && !historyButton.contains(event.target)) {
                isHistoryContainerVisible = false;
                historyContainer.classList.add('hidden');
                // 移除点击事件监听器
                document.removeEventListener('click', closeHistoryOnClickOutside);
            }
        };

        // 显示提示消息
        const showToast = (message, type = 'info') => {
            // 创建提示元素
            const toast = document.createElement('div');

            // 设置样式和内容
            let bgColor = 'bg-blue-500';
            let icon = 'fa-info-circle';

            if (type === 'success') {
                bgColor = 'bg-green-500';
                icon = 'fa-check-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                icon = 'fa-exclamation-triangle';
            }

            toast.className = `fixed top-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in flex items-center`;
            toast.innerHTML = `
                <i class="fa ${icon} mr-2"></i>
                <span>${message}</span>
            `;

            // 添加到页面
            document.body.appendChild(toast);

            // 3秒后移除
            setTimeout(() => {
                toast.classList.add('opacity-0', 'transition-opacity');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        };

        // 点击全屏预览外部关闭
        document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('fullscreenOverlay')) {
                closeFullScreenPreview();
            }
        });

        // 点击视频播放器外部关闭
        document.getElementById('videoPlayerContainer').addEventListener('click', (e) => {
            if (e.target === document.getElementById('videoPlayerContainer')) {
                closeVideoPlayer();
            }
        });

        // ESC键关闭弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFullScreenPreview();
                closeVideoPlayer();

                if (isHistoryContainerVisible) {
                    isHistoryContainerVisible = false;
                    document.getElementById('historyContainer').classList.add('hidden');
                    document.removeEventListener('click', closeHistoryOnClickOutside);
                }
            }
        });

        // 动态生成站点选择器选项
        const generateSiteOptions = () => {
            const selectElement = document.getElementById('siteSelector');
            selectElement.innerHTML = '';

            siteOptions.forEach(site => {
                const option = document.createElement('option');
                option.value = site.value;
                option.textContent = site.label;
                option.selected = site.value === siteName;
                option.style.backgroundColor = '#1e293b';
                option.style.color = site.color;
                selectElement.appendChild(option);
            });
        };

        // 更新站点选择器颜色
        const updateSiteSelectorColor = (selectedSite) => {
            const selectElement = document.getElementById('siteSelector');
            const selectedSiteInfo = siteOptions.find(site => site.value === selectedSite);
            if (selectedSiteInfo) {
                selectElement.style.color = selectedSiteInfo.color + ' !important';
            }
        };

        // 切换站点
        const changeSite = (newSite) => {
            if (newSite !== siteName && siteOptions.some(site => site.value === newSite)) {
                siteName = newSite;
                // 更新选择器颜色
                updateSiteSelectorColor(newSite);
                // 保存选择到localStorage
                localStorage.setItem('selectedSite', newSite);
                // 重置搜索状态并重新加载数据
                currentSearchTerm = '';
                currentPage = 1;
                document.getElementById('searchInput').value = '';
                fetchData('', currentPage);

                const siteInfo = siteOptions.find(site => site.value === newSite);
                showToast(`已切换到${siteInfo.label}站点`, 'success');
            }
        };
    </script>
</body>

</html>