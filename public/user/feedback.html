<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户建议聊天室</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html {
      scrollbar-gutter: stable;
    }
    body {
      overflow-y: scroll;
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-6 space-y-4">
    <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold">用户建议聊天室</h1>
        <div class="text-xs text-slate-500 mt-1">
          <span id="loginStatus">校验登录中...</span>
          <button id="loginBtn" class="ml-2 text-blue-600 hidden">去登录</button>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="clearBtn" class="px-3 py-1.5 rounded bg-slate-600 text-white text-sm">清空</button>
        <button id="exportBtn" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm">导出</button>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow p-4 space-y-2">
      <div class="flex items-center justify-between text-xs text-slate-500">
        <span id="serverMeta">历史反馈：未加载</span>
        <button id="refreshServerBtn" class="text-blue-600 hidden">刷新历史</button>
      </div>
      <div id="chatList" class="space-y-3 max-h-[60vh] overflow-y-auto pr-1"></div>
    </div>

    <div class="bg-white rounded-xl shadow p-4 space-y-3">
      <div class="flex flex-col sm:flex-row gap-2">
        <input id="nicknameInput" class="border rounded px-3 py-2 text-sm flex-1" placeholder="你的称呼（可选）">
        <select id="typeSelect" class="border rounded px-3 py-2 text-sm w-40">
          <option value="建议">建议</option>
          <option value="问题">问题</option>
          <option value="反馈">反馈</option>
        </select>
      </div>
      <textarea id="messageInput" rows="3" class="border rounded px-3 py-2 text-sm w-full" placeholder="请输入你的建议..."></textarea>
      <div class="flex items-center justify-between">
        <span class="text-xs text-slate-500">提交后会保存到后端</span>
        <button id="sendBtn" class="px-4 py-2 rounded bg-emerald-600 text-white text-sm">发送</button>
      </div>
      <div id="hint" class="text-xs text-slate-500 hidden">已发送</div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "feedbackChatMessages";
    const TOKEN_KEY = "userToken";

    const chatList = document.getElementById("chatList");
    const messageInput = document.getElementById("messageInput");
    const nicknameInput = document.getElementById("nicknameInput");
    const typeSelect = document.getElementById("typeSelect");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");
    const hint = document.getElementById("hint");
    const loginStatus = document.getElementById("loginStatus");
    const loginBtn = document.getElementById("loginBtn");
    const serverMeta = document.getElementById("serverMeta");
    const refreshServerBtn = document.getElementById("refreshServerBtn");
    let currentRole = "";

    const getToken = () => localStorage.getItem(TOKEN_KEY) || "";
    const authHeaders = () => {
      const token = getToken();
      return token ? { Authorization: "Bearer " + token } : {};
    };
    const redirectToLogin = () => {
      const redirect = encodeURIComponent("/user/feedback.html");
      window.location.href = `/login/index.html?redirect=${redirect}`;
    };

    const refreshLoginStatus = async () => {
      const token = getToken();
      if (!token) {
        loginStatus.textContent = "未登录，登录后可提交";
        loginBtn.classList.remove("hidden");
        refreshServerBtn.classList.add("hidden");
        sendBtn.disabled = true;
        sendBtn.classList.add("opacity-60", "cursor-not-allowed");
        return;
      }
      try {
        const res = await fetch("/user/profile", { headers: authHeaders() });
        const data = await res.json();
        if (data.code === 200) {
          loginStatus.textContent = "已登录";
          loginBtn.classList.add("hidden");
          refreshServerBtn.classList.remove("hidden");
          sendBtn.disabled = false;
          sendBtn.classList.remove("opacity-60", "cursor-not-allowed");
          currentRole = String(data.data?.role || "");
          await loadSelfFeedback();
          return;
        }
      } catch (e) {
        // ignore
      }
      loginStatus.textContent = "登录失效，请重新登录";
      loginBtn.classList.remove("hidden");
      refreshServerBtn.classList.add("hidden");
      sendBtn.disabled = true;
      sendBtn.classList.add("opacity-60", "cursor-not-allowed");
    };

    const loadMessages = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch (e) {
        return [];
      }
    };

    const saveMessages = (list) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    };

    const renderMessages = () => {
      const list = loadMessages();
      if (list.length === 0) {
        chatList.innerHTML = '<div class="text-sm text-slate-500 text-center py-6">暂无消息</div>';
        return;
      }
      chatList.innerHTML = list.map((item) => {
        const title = item.nickname ? `${item.nickname} · ${item.type}` : item.type;
        return `
          <div class="border rounded-lg p-3 bg-slate-50">
            <div class="text-xs text-slate-500 mb-1">${title} · ${new Date(item.time).toLocaleString()}</div>
            <div class="text-sm text-slate-800 whitespace-pre-wrap">${item.message}</div>
          </div>
        `;
      }).join("");
      chatList.scrollTop = chatList.scrollHeight;
    };

    const renderServerMessages = (list) => {
      if (!Array.isArray(list) || list.length === 0) {
        serverMeta.textContent = "历史反馈：暂无";
        renderMessages();
        return;
      }
      serverMeta.textContent = `历史反馈：共 ${list.length} 条`;
      chatList.innerHTML = list.map((item) => {
        const title = item.type ? item.type : "反馈";
        const replies = Array.isArray(item.replies) ? item.replies : [];
        const hasAdminReply = replies.some((reply) => reply && reply.role === "admin");
        const canReply = currentRole === "admin" || hasAdminReply;
        const repliesHtml = replies.length
          ? `<div class="mt-2 space-y-2">
              <div class="text-xs text-slate-500">回复</div>
              ${replies.map((reply) => {
              const roleLabel = reply.role === "admin" ? "管理员" : "你";
              return `
                <div class="rounded border px-2 py-1 text-xs ${reply.role === "admin" ? "bg-emerald-50 border-emerald-200" : "bg-white border-slate-200"} text-slate-600">
                  <span class="text-slate-500">${roleLabel} · ${new Date(reply.createdAt).toLocaleString()}</span>
                  <div class="text-slate-700 whitespace-pre-wrap mt-1">${reply.message || ""}</div>
                </div>
              `;
            }).join("")}
            </div>`
          : "";
        return `
          <div class="border rounded-lg p-3 bg-slate-50" data-feedback-id="${item.id || ""}">
            <div class="text-xs text-slate-500 mb-1">${title} · ${new Date(item.createdAt).toLocaleString()}</div>
            <div class="text-sm text-slate-800 whitespace-pre-wrap">${item.message || ""}</div>
            ${repliesHtml}
            ${
              canReply
                ? `<div class="mt-3 flex items-center gap-2">
                    <input class="reply-input flex-1 border rounded px-2 py-1 text-xs" placeholder="回复这条反馈">
                    <button class="reply-btn px-2 py-1 rounded bg-slate-800 text-white text-xs">回复</button>
                  </div>`
                : ""
            }
          </div>
        `;
      }).join("");
      chatList.scrollTop = chatList.scrollHeight;
    };

    const loadSelfFeedback = async () => {
      const token = getToken();
      if (!token) {
        serverMeta.textContent = "历史反馈：未登录";
        return;
      }
      try {
        const res = await fetch("/user/feedback/self?page=1&pageSize=50", { headers: authHeaders() });
        const data = await res.json();
        if (data.code !== 200) {
          serverMeta.textContent = data.message || "历史反馈：加载失败";
          return;
        }
        const list = Array.isArray(data.data) ? data.data : [];
        renderServerMessages(list);
      } catch (e) {
        serverMeta.textContent = "历史反馈：加载失败";
      }
    };

    const showHint = (text) => {
      hint.textContent = text;
      hint.classList.remove("hidden");
      setTimeout(() => hint.classList.add("hidden"), 1200);
    };

    const setBtnLoading = (btn, loading, label) => {
      if (!btn) return;
      if (loading) {
        btn.disabled = true;
        btn.classList.add("opacity-70", "cursor-not-allowed");
        btn.innerHTML = '<span class="inline-flex items-center gap-2"><span class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span><span>' + (label || "处理中...") + '</span></span>';
      } else {
        btn.disabled = false;
        btn.classList.remove("opacity-70", "cursor-not-allowed");
        btn.textContent = label || "完成";
      }
    };

    sendBtn.addEventListener("click", async () => {
      const message = (messageInput.value || "").trim();
      if (!message) return;
      const payload = {
        nickname: (nicknameInput.value || "").trim(),
        type: typeSelect.value || "建议",
        message,
        time: Date.now(),
        page: window.location.pathname
      };
      const token = getToken();
      if (!token) {
        redirectToLogin();
        return;
      }
      try {
        setBtnLoading(sendBtn, true, "发送中...");
        const res = await fetch("/user/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.code !== 200) {
          showHint(data.message || "提交失败");
          return;
        }
        const list = loadMessages();
        list.unshift(payload);
        if (list.length > 200) list.length = 200;
        saveMessages(list);
        renderMessages();
        messageInput.value = "";
        showHint("已发送");
        await loadSelfFeedback();
      } catch (e) {
        showHint("提交失败");
      } finally {
        setBtnLoading(sendBtn, false, "发送");
      }
    });

    clearBtn.addEventListener("click", () => {
      if (!confirm("确认清空所有消息？")) return;
      saveMessages([]);
      renderMessages();
    });

    exportBtn.addEventListener("click", () => {
      const list = loadMessages();
      const blob = new Blob([JSON.stringify(list, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "feedback-chat.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    loginBtn.addEventListener("click", () => {
      redirectToLogin();
    });
    refreshServerBtn.addEventListener("click", async () => {
      setBtnLoading(refreshServerBtn, true, "加载中...");
      try {
        await loadSelfFeedback();
      } finally {
        setBtnLoading(refreshServerBtn, false, "刷新历史");
      }
    });

    chatList.addEventListener("click", async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("reply-btn")) return;
      const card = target.closest("[data-feedback-id]");
      if (!card) return;
      const id = card.getAttribute("data-feedback-id");
      const input = card.querySelector(".reply-input");
      const message = input ? String(input.value || "").trim() : "";
      if (!id || !message) return;
      const token = getToken();
      if (!token) {
        redirectToLogin();
        return;
      }
      setBtnLoading(target, true, "发送中...");
      try {
        const res = await fetch(`/user/feedback/${id}/reply`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        if (data.code !== 200) {
          showHint(data.message || "回复失败");
          return;
        }
        if (input) input.value = "";
        showHint("已回复");
        await loadSelfFeedback();
      } catch (e2) {
        showHint("回复失败");
      } finally {
        setBtnLoading(target, false, "回复");
      }
    });

    refreshLoginStatus();
    renderMessages();
  </script>
</body>
</html>
